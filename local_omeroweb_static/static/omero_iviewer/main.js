(()=>{var e,t={4997:(e,t,i)=>{"use strict";i.d(t,{Z:()=>f});var n,s=i("aurelia-framework"),o=i("aurelia-event-aggregator"),r=i(9202),a=i(5222),l=i(3603),h=i(1230),d=i(8546),c=i(7037),g=i(7610),p=i(7674),u=i(1010);let f=(0,s.noView)(n=class{constructor(e=null,t={}){if(this.version="0.0.0",this.is_dev_server=!1,this.eventbus=null,this.sync_groups=new Map,this.prevent_event_notification=!1,this.server=null,this.prefixed_uris=new Map,this.image_configs=new Map,this.cached_image_settings={},this.initial_type=p.Qo.NONE,this.initial_ids=[],this.selected_config=null,this.useMDI=!1,this.selected_tab=p.G7.SETTINGS,this.interpolate=!0,this.key_listeners=new Map,this.luts=new Map,this.luts_png={image:null,url:"",height:0},typeof e instanceof o.h)throw"Invalid EventAggregator given!";this.eventbus=e,this.initParams=t;let i={};i[p.x2.ZT.CHAR]=!0,i[p.x2.VIEW.CHAR]=!0,i[p.x2.CHANNELS.CHAR]=!1,[1,2,3].map((e=>this.sync_groups.set("group"+e,{sync_locks:Object.assign({},i),members:[]}))),this.processInitialParameters(),this.readPrefixedURIs(),u.ajaxSetup({cache:!1,dataType:r.Z.useJsonp(this.server)?"jsonp":"json",beforeSend:(e,t)=>{r.Z.useJsonp(this.server)||/^(GET|HEAD|OPTIONS|TRACE)$/.test(t.type)||e.setRequestHeader("X-CSRFToken",r.Z.getCookie("csrftoken"))}}),this.setUpLuts(),l.Z.initOpenWith(),this.openWithInitialParams(),this.establishKeyDownListener(),this.hasHTML5HistoryFeatures()&&(window.onpopstate=e=>{if(null===e.state)return void window.history.go(0);let t=!0;if(this.useMDI){let i=this.getImageConfigsForGivenImage(e.state.image_id);if(0===i.length)t=!0;else{let n=!1;for(let t in i)if(i[t].id===e.state.config_id){n=!0;break}t=!1,this.selectConfig(n?e.state.config_id:i[0].id)}}t&&this.addImageConfig(e.state.image_id,p.Qo.IMAGES,e.state.parent_id)})}hasHTML5HistoryFeatures(){return window.history&&"function"==typeof window.history.pushState&&void 0!==window.onpopstate}setUpLuts(){this.luts_png.url=this.server+this.getPrefixedURI(p.YH,!0)+p.h6;let e=new Image;e.onload=t=>{this.luts_png.height=t.target.naturalHeight,this.luts_png.image=e;for(let[e,t]of this.image_configs)t.changed()},e.src=this.luts_png.url;let t=this.server,i=this.getPrefixedURI(p.YH);u.ajax({url:t+i+"/luts/",success:e=>{if("object"!=typeof e||null===e||!r.Z.isArray(e.luts))return;let t=0;e.luts.map((e=>{let i=-1!==p.pf.indexOf(e.name),n=Object.assign({nice_name:e.name.replace(/.lut/g,"").replace(/_/g," "),index:i?t:-1},e);this.luts.set(n.name,n),i&&t++}));for(let[e,t]of this.image_configs)t.changed()}})}openWithInitialParams(){let e,t;this.initParams[p.Yj.IMAGES]?(e=this.initParams[p.Yj.IMAGES],t=p.Qo.IMAGES):this.initParams[p.Yj.ROI]?(e=this.initParams[p.Yj.ROI],t=p.Qo.ROIS):this.initParams[p.Yj.SHAPE]&&(e=this.initParams[p.Yj.SHAPE],t=p.Qo.SHAPES),e&&(this.initial_ids=e.split(",").map((e=>parseInt(e))).filter((e=>!isNaN(e))),this.initial_ids.length>0&&(this.initial_type=t));let i=parseInt(this.getInitialRequestParam(p.Yj.DATASET_ID));("number"!=typeof i||isNaN(i))&&(i=null);let n=parseInt(this.getInitialRequestParam(p.Yj.WELL_ID));if(("number"!=typeof n||isNaN(n))&&(n=null),[p.Qo.IMAGES,p.Qo.ROIS,p.Qo.SHAPES].indexOf(this.initial_type)>-1){let e,t=i||n;t&&(e=null!==i?p.Qo.DATASET:p.Qo.WELL),this.addImageConfig(this.initial_ids[0],this.initial_type,t,e)}else n?(this.initial_type=p.Qo.WELL,this.initial_ids.push(n)):i&&(this.initial_type=p.Qo.DATASET,this.initial_ids.push(i))}hasLookupTableEntry(e){return"string"==typeof e&&"object"==typeof this.luts.get(e)}processInitialParameters(){let e=this.initParams[p.Yj.HOST];if("string"!=typeof e||0===e.length)e="";else{let t=e.indexOf("localhost")>=0||e.indexOf("127.0.0.1")>=0,i="http://".length,n=e.indexOf("localhost")>=i?e.indexOf("localhost"):e.indexOf("127.0.0.1");t&&n<i&&(e="http://"+e)}this.server=e,delete this.initParams[p.Yj.HOST];let t="string"==typeof this.initParams[p.Yj.INTERPOLATE]?this.initParams[p.Yj.INTERPOLATE].toLowerCase():"true";this.interpolate="true"===t,this.version=this.getInitialRequestParam(p.Yj.VERSION),this.roi_page_size=this.initParams[p.Yj.ROI_PAGE_SIZE]||500,this.max_projection_bytes=parseInt(this.initParams[p.Yj.MAX_PROJECTION_BYTES],10)||268435456,this.max_projection_bytes=parseInt(this.initParams[p.Yj.MAX_PROJECTION_BYTES],10)||268435456;let i="".concat(this.initParams[p.Yj.ROI_COLOR_PALETTE]);if(i){let e=i.match(/\[[^\[\]]*\]/g);if(e){this.roi_color_palette=[];let t=0;e.forEach((e=>{this.roi_color_palette[t]=e.match(/[A-Za-z#][A-Za-z0-9]*(\([^A-Za-z]*\))?/g),t++}))}}this.show_palette_only="False"!=this.initParams[p.Yj.SHOW_PALETTE_ONLY]||!1,this.enable_mirror="False"!=this.initParams[p.Yj.ENABLE_MIRROR]||!1}readPrefixedURIs(){let e="string"==typeof this.initParams[p.fg]?r.Z.prepareURI(this.initParams[p.fg]):"";this.prefixed_uris.set(p.fg,e),this.prefixed_uris.set(p.$R,e+"/"+p.iC),this.prefixed_uris.set(p.TQ,e+"/"+p.EW),[p.oD,p.YH,p.cM].map((e=>this.prefixed_uris.set(e,"string"==typeof this.initParams[e]?this.initParams[e]:"/"+e.toLowerCase())))}getPrefixedURI(e,t){"boolean"!=typeof t&&(t=!1);let i=r.Z.prepareURI(this.prefixed_uris.get(e,""));if(""===i)return i;if(t){let e=r.Z.prepareURI(this.prefixed_uris.get(p.fg,""));i=""!==e?e+"/static"+i.replace(e,""):"/static"+i}return i}establishKeyDownListener(){null===window.onkeydown&&(window.onkeydown=e=>{let t=r.Z.isApple()?"metaKey":"ctrlKey",i=this.key_listeners.get(e.key.toUpperCase());if(void 0===i||"INPUT"===e.target.nodeName.toUpperCase())return;let n=!0;try{for(let s in i){let o=i[s];o.ctrl&&!e[t]||o.action(e)||(n=!1)}}catch(e){}return n?void 0:(e.preventDefault(),e.stopPropagation(),!1)})}addKeyListener(e,t,i="global",n=!0){if("string"!=typeof e||"function"!=typeof t)return;e=e.toUpperCase();let s=this.key_listeners.get(e),o={ctrl:n,action:t};if(s)s[i]=o;else{let t={};t[i]=o,this.key_listeners.set(e,t)}}removeKeyListener(e,t="global"){if("string"!=typeof e)return;e=e.toUpperCase();let i=this.key_listeners.get(e);if(i){delete i[t];let n=!0;for(let e in i)if("function"==typeof i[e].action){n=!1;break}n&&this.key_listeners.delete(e)}}rememberImageConfigChange(e){if(!this.hasHTML5HistoryFeatures()||null===this.getSelectedImageConfig())return;let t=window.location.pathname,i=null,n=this.getSelectedImageConfig();if(null===n)return;let s=(this.initial_type===p.Qo.IMAGES?n.image_info.parent_type:this.initial_type)===p.Qo.WELL?"well":"dataset";if(-1!==t.indexOf("webclient/img_detail")){let o=n&&n.image_info?n.image_info.image_id:null;o&&(t=t.replace(o,e),i=this.initial_type===p.Qo.IMAGES?"number"==typeof n.image_info.parent_id?n.image_info.parent_id:null:this.initial_ids[0],i&&(t+="?"+s+"="+i))}else this.initial_type===p.Qo.IMAGES||this.initial_type===p.Qo.ROIS||this.initial_type===p.Qo.SHAPES?this.initial_ids.length>1?t+=window.location.search:(i=n.image_info.parent_id,t+="?images="+e+"&"+s+"="+i):(i=this.initial_ids[0],t+="?"+s+"="+i),this.is_dev_server&&(t+=-1===t.indexOf("?")?"?":"&",t+="haveMadeCrossOriginLogin_");window.history.pushState({image_id:e,parent_id:i,parent_type:s,config_id:n.id},"",t)}addImageConfig(e,t,i,n){if("number"!=typeof e||e<0)return;if(this.useMDI)for(let[e,t]of this.image_configs)t.show_controls&&this.publish(g.Dk,{config_id:this.selected_config,flag:!1});else for(let[e,t]of this.image_configs)this.removeImageConfig(e,t);let s=new h.Z(this,e,t,i,n);this.image_configs.set(s.id,s),this.selectConfig(s.id),s.bind()}getParentTypeAndId(){let e=this.getSelectedImageConfig(),t=null;this.initial_type===p.Qo.DATASET||this.initial_type===p.Qo.WELL?t=this.initial_ids[0]:this.initial_type===p.Qo.IMAGES&&1===this.initial_ids.length&&null!==e&&"number"==typeof e.image_info.parent_id&&(t=e.image_info.parent_id);let i=p.Qo.NONE;return t&&(i=this.initial_type===p.Qo.IMAGES?e.image_info.parent_type:this.initial_type),{type:i,id:t}}onClicks(e,t=!1,i){let n=this.getSelectedImageConfig(),s=()=>{this.rememberImageConfigChange(e);let s=this.getParentTypeAndId(),o=s.id,r=s.type;!this.useMDI||t||i||(i=n);let a=p.Qo.IMAGES;if(i){let t=Object.assign({},i.position),n=Object.assign({},i.size);this.removeImageConfig(i,!0),this.addImageConfig(e,a,o,r);let s=this.getSelectedImageConfig();null!==s&&(s.position=t,s.size=n)}else this.addImageConfig(e,a,o,r)},o=this.useMDI?this.findConfigsWithModifiedRegionsForGivenImage(e):[],l=this.getSelectedImageConfig(),h=l&&l.image_info.image_id===e;if(n&&n.regions_info&&(n.regions_info.hasBeenModified()||o.length>0)&&(!t||t&&!h)&&!r.Z.useJsonp(this.server)&&n.regions_info.image_info.can_annotate){let e=!this.useMDI||n.regions_info.hasBeenModified()?"You have new/deleted/modified ROI(s).<br>Do you want to save your changes?":"You have changed ROI(s) on an image that's been opened multiple times.<br>Do you want to save now to avoid inconsistence (and a potential loss of some of your changes)?",i=!this.useMDI||!t&&n.regions_info.hasBeenModified()?()=>{let e=this.eventbus.subscribe(g.XN,((t={})=>{e.dispose(),t.omit_client_update&&s()}));setTimeout((()=>this.publish(g.q0,{config_id:n.id,omit_client_update:!0})),20)}:()=>{this.publish(g.q0,{config_id:n.regions_info.hasBeenModified()?n.id:o[0],omit_client_update:!1}),s()};a.Z.showConfirmationDialog("Save ROIs?",e,i,(()=>s()))}else s()}removeImageConfig(e,t=!1){let i=null;if(e instanceof h.Z?i=e:"number"==typeof e&&(i=this.image_configs.get(e)),!(i instanceof h.Z))return;this.image_configs.delete(i.id);let n=this.getSelectedImageConfig();(n&&n===i.id||null===n)&&(this.selected_config=null);let s=this.image_configs.size;this.useMDI&&(i.toggleSyncGroup(null),s>0&&(this.selected_config=this.image_configs.keys().next().value,t||1!==s||(this.publish(g.Dk,{config_id:this.selected_config,flag:!0}),this.useMDI=!1))),i.unbind(),i=null}selectConfig(e=null){return"number"==typeof e&&e>0&&this.image_configs.get(e)instanceof h.Z&&this.selected_config!==e&&(this.selected_config=e),!0}getImageConfig(e,t=!1){if("number"!=typeof e||e<0)return null;let i=this.image_configs.get(e);return i instanceof h.Z&&null!==i?(i&&t&&i.image_info.requestData(),i):null}getSelectedImageConfig(){return"number"!=typeof this.selected_config?null:this.getImageConfig(this.selected_config)}getImageConfigsAtPosition(e,t){let i=[];for(let[n,s]of this.image_configs){if(null===s.position)continue;let n=parseInt(s.position.left),o=parseInt(s.position.top),r=parseInt(s.size.width),a=parseInt(s.size.height);n<e&&n+r>e&&o<t&&o+a>t&&i.push(s)}return i}setCachedImageSettings(e,t){const i=this.cached_image_settings[e]||{};this.cached_image_settings[e]=Object.assign({},i,t)}getCachedImageSettings(e){if(this.cached_image_settings[e])return this.cached_image_settings[e]}clearCachedImageSettings(e){r.Z.isArray(e)?e.forEach((e=>{this.cached_image_settings[e]&&delete this.cached_image_settings[e]})):this.cached_image_settings={}}publish(){this.prevent_event_notification||this.eventbus.publish.apply(this.eventbus,arguments)}getInitialRequestParam(e){return"string"!=typeof e||"object"!=typeof this.initParams?null:(e=e.toUpperCase(),void 0===this.initParams[e]||null===typeof this.initParams[e]?null:this.initParams[e])}isRoisTabActive(){return this.selected_tab===p.G7.ROIS}resetInitParams(){let e=this.getInitialRequestParam(p.Yj.OMERO_VERSION);this.initParams={},this.initParams[p.Yj.OMERO_VERSION]=e,this.prefixed_uris.forEach(((e,t)=>this.initParams[t]=e))}getVersion(){return"v"+this.getInitialRequestParam(p.Yj.VERSION)}getImageConfigsForGivenImage(e,t=-1){if("number"!=typeof e||isNaN(e))return[];("number"!=typeof t||isNaN(t))&&(t=-1);let i=[];for(let[n,s]of this.image_configs)n!==t&&s.image_info instanceof d.Z&&s.image_info.image_id===e&&i.push(s);return i}findConfigsWithModifiedRegionsForGivenImage(e){return this.findModifiedImageConfigsForGivenImage(e,!0)}findConfigsWithModifiedImageSettingsForGivenImage(e){return this.findModifiedImageConfigsForGivenImage(e)}findModifiedImageConfigsForGivenImage(e,t=!1){let i=[],n=this.getImageConfigsForGivenImage(e);for(let e in n){let s=n[e];(t&&s.regions_info&&s.regions_info.hasBeenModified()||!t&&s.image_info.can_annotate&&s.canUndo())&&i.push(s.id)}return i}reloadImageConfigsGivenParent(e,t,i=-1){("number"!=typeof i||isNaN(i))&&(i=-1);for(let[n,s]of this.image_configs)n!==i&&s.image_info instanceof d.Z&&s.image_info.parent_type===t&&s.image_info.parent_id===e&&this.reloadImageConfig(s,p.Iz.IMAGE)}reloadImageConfigForGivenImage(e,t,i=-1,n=null){let s=this.getImageConfigsForGivenImage(e,i);for(let e in s)this.reloadImageConfig(s[e],t,n)}reloadImageConfig(e,t,i=null){if(null==e||"number"!=typeof t||isNaN(t)||t!==p.Iz.IMAGE&&t!==p.Iz.REGIONS)return;let n=null;if(e instanceof h.Z?n=e:"number"==typeof e&&(n=this.getImageConfig(e)),null!==n&&n.image_info instanceof d.Z&&(t!==p.Iz.REGIONS||n.regions_info instanceof c.Z&&n.regions_info.ready))switch(t){case p.Iz.IMAGE:n.image_info.refresh=!0,n.resetHistory(),n.image_info.requestData(!0);break;case p.Iz.REGIONS:r.Z.isArray(i)?n.regions_info.setData(i):n.regions_info.requestData(!0)}}saveAllImageSettings(){let e=[],t=[],i=0;for(let[n,s]of this.image_configs){if(!s.image_info.ready||!s.image_info.can_annotate||!s.canUndo())continue;let n=s.image_info.image_id;this.findConfigsWithModifiedImageSettingsForGivenImage(n).length>1?-1===e.indexOf(s.image_info.image_name)&&e.push(s.image_info.image_name):(t.push(n),s.saveImageSettings((()=>{i++,s.resetHistory(),this.publish(g.FQ,{config_id:s.id}),this.useMDI&&this.reloadImageConfigForGivenImage(n,p.Iz.IMAGE,s.id),t.length===i&&this.publish(g.gw,{ids:t})})))}return e}})||n},"app/header":(e,t,i)=>{"use strict";i.r(t),i.d(t,{Header:()=>f});var n,s=i("aurelia-framework"),o=i(4997),r=i(6997),a=i(1488),l=i.n(a),h=i(9025),d=i(9202),c=i(5222),g=i(7610),p=i(7674),u=i(1010);let f=(0,s.customElement)("header")(n=(0,s.inject)(o.Z,s.BindingEngine)(n=class{attached(){u(".fixed-header .dropdown").on("show.bs.dropdown",(()=>this.checkIfAnyImageSettingsHasBeenModified()))}detached(){u(".fixed-header .dropdown").off()}bind(){this.onImageConfigChange(),this.image_config_observer=this.bindingEngine.propertyObserver(this.context,"selected_config").subscribe(((e,t)=>this.onImageConfigChange()))}constructor(e,t){this.PROJECTION=p.PO,this.image_config=null,this.hasModifiedImageSettings=!1,this.image_config_observer=null,this.observers=[],this.webclient_link=null,this.selected_can_delete=!0,this.context=e,this.bindingEngine=t,this.webclient_link=this.context.getPrefixedURI(p.cM)}onImageConfigChange(){if(this.image_config=this.context.getSelectedImageConfig(),this.unregisterObservers(!0),null===this.image_config)return void(document.title=p.XI);let e=p.XI;""!==this.image_config.image_info.short_image_name&&(e=this.image_config.image_info.short_image_name),document.title=e,this.observers.push(this.bindingEngine.propertyObserver(this.image_config.regions_info,"ready").subscribe(((e,t)=>this.listenToRegionsSelections())))}listenToRegionsSelections(){this.observers.push(this.bindingEngine.collectionObserver(this.image_config.regions_info.selected_shapes).subscribe(((e,t)=>{if(0===this.image_config.regions_info.selected_shapes.length)return;let i=this.image_config.regions_info.getLastSelectedShape("canDelete");this.selected_can_delete=this.image_config.regions_info.checkShapeForPermission(i,"canDelete")})))}showAbout(){let e=u(".modal-about");0!==e.length&&e.modal()}saveProjectedImage(){if(null===this.image_config||this.image_config.image_info.projection===p.PO.NORMAL)return;let e=this.image_config.image_info,t=this.context.server+this.context.getPrefixedURI(p.$R)+"/save_projection/?image="+e.image_id+"&projection="+e.projection+"&start="+e.projection_opts.start+"&end="+e.projection_opts.end;this.context.initial_type!==p.Qo.WELL&&"number"==typeof e.parent_id&&(t+="&dataset="+e.parent_id),u.ajax({url:t,success:t=>{let i="";if("number"==typeof t.id){let n=this.context.server+this.context.getPrefixedURI(p.cM)+"/?show=image-"+t.id,s=this.context.server+this.context.getPrefixedURI(p.$R)+"/?images="+t.id;this.context.initial_type!==p.Qo.WELL&&"number"==typeof e.parent_id&&(s+="&dataset="+e.parent_id),i="<a href='"+n+"' target='_blank'>Navigate to Image in Webclient</a><br><br><a href='"+s+"' target='_blank'>Open Image in iviewer</a>"}else i="Failed to create projected image","string"==typeof t.error&&console.error(t.error);c.Z.showModalMessage(i,"Close")}})}copyShapes(){null!==this.image_config&&this.image_config.regions_info.copyShapes()}pasteShapes(){null!==this.image_config&&this.image_config.regions_info.pasteShapes()}deleteShapes(){null!==this.image_config&&this.image_config.regions_info.deleteShapes()}saveRoiMeasurements(e=!1){if(null===this.image_config||0===this.image_config.regions_info.selected_shapes.length)return;let t=this.image_config.regions_info,i=t.selected_shapes.filter((e=>-1==e.indexOf("-")));this.image_config.image_info.tiled||0===i.length||0===t.image_info.getActiveChannels().length?this.writeCsv(t.selected_shapes,e):t.requestStats(i,(()=>this.writeCsv(t.selected_shapes,e)))}writeCsv(e,t=!1){if(!d.Z.isArray(e)||0===e.length)return;let i=this.image_config.regions_info,n=i.image_info.getActiveChannels(),s=i.image_info.image_pixels_size.symbol_x||"px",o=i.image_info.image_id,a=i.image_info.short_image_name,l=i.image_info.channels,c=["image_id","image_name","roi_id","shape_id","type","z","t","channel","area ("+s+"²)","length ("+s+")","points","min","max","sum","mean","std_dev"],g=["X","Y","Width","Height","RadiusX","RadiusY","X1","Y1","X2","Y2","Points"],u={polygon:["Points"],polyline:["Points"],line:["X1","Y1","X2","Y2"],rectangle:["X","Y","Width","Height"],ellipse:["X","Y","RadiusX","RadiusY"],label:["X","Y"],point:["X","Y"]},f=e.map((e=>i.getShape(e).type)).reduce(((e,t)=>(u[t]&&u[t].forEach((t=>e[t]=!0)),e)),{});g=g.filter((e=>f[e])),g.unshift("Text"),c=c.concat(g);let _=c.map((e=>d.Z.quoteCsvCellValue(e))).join(",");_+=p.Fp;for(let t=0;t<e.length;t++){let s=e[t],r=i.getShape(s);if(null===r)continue;let h=s.substring(0,s.indexOf(":")),c=-1!==s.indexOf("-"),u=o+","+d.Z.quoteCsvCellValue(a)+","+(c?"-":h)+","+(c?"-":r["@id"])+","+d.Z.quoteCsvCellValue(r.type)+","+(-1===r.TheZ?"":r.TheZ+1)+","+(-1===r.TheT?"":r.TheT+1)+",",f=","+(r.Area<0?"":r.Area)+","+(r.Length<0?"":r.Length)+",",m=g.map((e=>null!=r[e]?'"'.concat(r[e],'"'):"")).join(","),v=",,,,,";if("object"==typeof r.stats&&null!==r.stats&&0!==n.length)for(let e in r.stats){let t=r.stats[e];if(-1!==n.indexOf(t.index)){if(0===t.points){_+=u+","+v+p.Fp;break}_+=u+d.Z.quoteCsvCellValue(l[t.index].label)+f+t.points+","+t.min+","+t.max+","+t.sum+","+t.mean+","+t.std_dev+","+m+p.Fp}}else _+=u+f+v+","+m+p.Fp}let m=null,v=!0;try{let e=t?"utf-8":"windows-1252",i="text/csv; charset="+e,n=new h.TextEncoder(e,{NONSTANDARD_allowLegacyEncoding:!t});v=!1,m=new Blob([n.encode(_)],{type:i})}catch(e){}m instanceof Blob?r.saveAs(m,i.image_info.short_image_name+"_roi_measurements.csv",!0):console.error(v?"Error encoding csv":"Blob not supported")}captureViewport(){if(null===this.image_config)return;let e={},t=this.context.image_configs.size;t>1?(e.all_configs=!0,e.count=t,e.zip=new(l())):e.config_id=this.image_config.id,this.context.eventbus.publish(g.xf,e)}getKeyboardShortCutPrefix(){return d.Z.isApple()?"⌘":"Ctrl+"}unregisterObservers(e=!1){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],e||this.image_config_observer&&(this.image_config_observer.dispose(),this.image_config_observer=null)}unbind(){this.unregisterObserver()}checkIfAnyImageSettingsHasBeenModified(){for(let[e,t]of this.context.image_configs)if(t.image_info.can_annotate&&t.canUndo())return void(this.hasModifiedImageSettings=!0);this.hasModifiedImageSettings=!1}saveAllImageSettings(){let e=this.context.saveAllImageSettings(),t=e.length;if(t>0){let i="The following image"+(t>1?"s were":" was")+" not saved (multiple/conflicting edits):<ul class='skipped-list-files'>";for(let t in e)i+="<li>"+e[t]+"</li>";i+="</ul>",c.Z.showModalMessage(i,"Close")}}})||n)||n},"app/index":(e,t,i)=>{"use strict";i.r(t),i.d(t,{Index:()=>g});var n,s=i("aurelia-framework"),o=i(4997),r=i(9202),a=i(3603),l=i(5222),h=i(7674),d=i(7610),c=i(1010);i(7924),i(5220),i(1550),i(818),i(1351);let g=(0,s.inject)(o.Z)(n=class{constructor(e){this.resizeHandle=null,this.full_screen_api_prefix=null,this.restoreMDI=!1,this.sync_locks=[h.x2.ZT,h.x2.VIEW,h.x2.CHANNELS],this.context=e}attached(){let e=()=>this.context.publish(d.D3,{config_id:-1,window_resize:!0});window.onresize=()=>{null!==typeof this.resizeHandle&&(clearTimeout(this.resizeHandle),this.resizeHandle=null),this.resizeHandle=setTimeout(e,50)},window.onbeforeunload=()=>{if(r.Z.useJsonp(this.context.server))return null;let e=!1;for(var[t,i]of this.context.image_configs)if(i&&i.regions_info&&i.regions_info.hasBeenModified()&&i.regions_info.image_info.can_annotate){e=!0;break}return e?"You have new/deleted/modified ROI(s).\nIf you leave you'll lose your changes.":null},l.Z.registerSidePanelHandlers(this.context.eventbus,this.context.getPrefixedURI(h.TQ,!0)),this.full_screen_api_prefix=l.Z.getFullScreenApiPrefix(),this.full_screen_api_prefix&&"function"!=typeof document["on"+this.full_screen_api_prefix+"fullscreenchange"]&&(document["on"+this.full_screen_api_prefix+"fullscreenchange"]=()=>this.onFullScreenChange()),a.Z.fetchOpenWithScripts(this.context.server+this.context.getPrefixedURI(h.YH))}closeViewerInMDI(e){if(!this.context.useMDI)return;let t=this.context.getImageConfig(e);null!==t&&null!==t.regions_info&&t.regions_info.hasBeenModified()&&!r.Z.useJsonp(this.context.server)&&t.regions_info.image_info.can_annotate?l.Z.showConfirmationDialog("Save ROIs?","You have new/deleted/modified ROI(s).<br>Do you want to save your changes?",(()=>{let i=this.context.eventbus.subscribe(d.XN,((t={})=>{i.dispose(),this.context.removeImageConfig(e)}));setTimeout((()=>this.context.publish(d.q0,{config_id:t.id,omit_client_update:!0})),20)}),(()=>this.context.removeImageConfig(e))):this.context.removeImageConfig(e)}toggleSyncGroup(e,t=null){let i=this.context.getImageConfig(e);null!==i&&(i.toggleSyncGroup(t),this.context)}highlightSyncGroup(e=[],t){for(let i in e)c("#"+e[i]).css("border-color",t?"yellow":"")}toggleSyncLock(e,t="c",i){let n=this.context.getImageConfig(e);if(null===n||null===n.sync_group)return;let s=this.context.sync_groups.get(n.sync_group);s&&(s.sync_locks[t]=i)}toggleViewerControlsInMDI(e){let t=this.context.getImageConfig(e);null!==t&&this.context.publish(d.Dk,{config_id:t.id,flag:!t.show_controls})}onFullScreenChange(){document[this.full_screen_api_prefix+"isFullScreen"]||document[this.full_screen_api_prefix+"FullScreen"]||document[this.full_screen_api_prefix+"FullscreenElement"]?(this.restoreMDI=this.context.useMDI,this.restoreMDI&&(this.context.useMDI=!1)):this.restoreMDI&&(this.context.useMDI=!0),c(".viewer-context-menu").hide()}handleDrop(e){var t=parseInt(e.dataTransfer.getData("id"),10);this.context.useMDI=!0,this.context.onClicks(t,!0)}handleDragover(e){e.preventDefault()}detached(){window.onresize=null,window.onbeforeunload=null,null!==this.full_screen_api_prefix&&document["on"+this.full_screen_api_prefix+"fullscreenchange"]&&(document["on"+this.full_screen_api_prefix+"fullscreenchange"]=null)}})||n},"app/right-hand-panel":(e,t,i)=>{"use strict";i.r(t),i.d(t,{RightHandPanel:()=>l});var n,s=i("aurelia-framework"),o=i(4997),r=i(7674),a=(i(1413),i(1010));let l=(0,s.customElement)("right-hand-panel")(n=(0,s.inject)(o.Z,s.BindingEngine)(n=class{constructor(e,t){this.TABS=r.G7,this.image_config=null,this.observer=null,this.context=e,this.bindingEngine=t,this.image_config=this.context.getSelectedImageConfig()}bind(){this.observer=this.bindingEngine.propertyObserver(this.context,"selected_config").subscribe(((e,t)=>{this.image_config=this.context.getSelectedImageConfig(),this.makeInitialRoisRequestIfRoisTabIsActive()}))}unbind(){this.observer&&(this.observer.dispose(),this.observer=null)}attached(){a("#panel-tabs").find("a").click((e=>{e.preventDefault(),this.context.selected_tab=e.currentTarget.hash.substring(1),this.makeInitialRoisRequestIfRoisTabIsActive(),a(e.currentTarget).tab("show")})),this.image_config&&this.image_config.image_info&&(this.image_config.image_info.initial_roi_id||this.image_config.image_info.initial_shape_id)&&(this.context.selected_tab=r.G7.ROIS)}makeInitialRoisRequestIfRoisTabIsActive(){if(this.context.isRoisTabActive()){if(null===this.image_config||!this.image_config.image_info.ready||null===this.image_config.regions_info)return;this.image_config.regions_info.requestData()}}detached(){a("#panel-tabs").find("a").unbind("click")}})||n)||n},"app/thumbnail-slider":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var n,s=i("aurelia-framework"),o=i(4997),r=i(9202),a=i(5222),l=i(7674),h=i(7610),d=i(1010);let c=(0,s.customElement)("thumbnail-slider")(n=(0,s.inject)(o.Z,Element,s.BindingEngine,s.TaskQueue)(n=class extends h.nb{constructor(e,t,i,n){super(e.eventbus),this.initialized=!1,this.click_handle=null,this.image_config=null,this.web_api_base="",this.webclient_prefix="",this.selected_image_observer=null,this.image_info_ready_observer=null,this.thumbnails=[],this.thumbnails_request_size=10,this.thumbnail_size=90,this.slider_height=90,this.updateHandle=null,this.requesting_thumbnail_data=!1,this.sub_list=[[h.gw,(e={})=>this.updateThumbnails(e)],[h.D3,(e={})=>this.resizeViewer(e)]],this.context=e,this.element=t,this.bindingEngine=i,this.taskQueue=n,this.web_api_base=this.context.getPrefixedURI(l.oD),this.webclient_prefix=this.context.getPrefixedURI(l.cM),this.webgateway_prefix=this.context.getPrefixedURI(l.YH)}bind(){this.onImageConfigChange(),this.selected_image_observer=this.bindingEngine.propertyObserver(this.context,"selected_config").subscribe(((e,t)=>this.onImageConfigChange())),this.subscribe()}attached(){this.slider_height=document.querySelector(".thumbnail-scroll-panel").clientHeight}resizeViewer(){this.slider_height=document.querySelector(".thumbnail-scroll-panel").clientHeight}onImageConfigChange(){if(this.image_config=this.context.getSelectedImageConfig(),this.initialized){if(null===this.image_config)return;return void a.Z.scrollContainer("img-thumb-"+this.image_config.image_info.image_id,".thumbnail-scroll-panel")}if(this.context.initial_type===l.Qo.NONE)return this.hideMe(),void setTimeout((()=>a.Z.showModalMessage("Viewer opened without images, rois, dataset or well id!","OK")),100);let e=()=>{this.initializeThumbnails(),this.unregisterObservers(!0)};if(this.context.initial_type!==l.Qo.IMAGES&&this.context.initial_type!==l.Qo.ROIS&&this.context.initial_type!==l.Qo.SHAPES||1!==this.context.initial_ids.length||"number"===this.image_config.image_info.parent_id)e();else{if(this.image_config.image_info.ready)return this.initialized=!0,void this.hideMe();this.image_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((t,i)=>e()))}}unregisterObservers(e=!1){this.image_info_ready_observer&&(this.image_info_ready_observer.dispose(),this.image_info_ready_observer=null),e||this.selected_image_observer&&(this.selected_image_observer.dispose(),this.selected_image_observer=null)}unbind(){this.updateHandle&&clearInterval(this.updateHandle),this.unsubscribe(),this.unregisterObservers()}initializeThumbnails(e=!1){this.context.initial_type===l.Qo.IMAGES||this.context.initial_type===l.Qo.ROIS||this.context.initial_type===l.Qo.SHAPES?this.context.initial_ids.length>1?this.setThumbnailsFromIds(this.context.initial_ids):this.gatherThumbnailMetaInfo():this.context.initial_type!==l.Qo.DATASET&&this.context.initial_type!==l.Qo.WELL||this.requestMoreThumbnails(!0,e),this.initialized=!0}gatherThumbnailMetaInfo(){let e=this.context.server+this.webclient_prefix+"/api/paths_to_object/";this.context.initial_type===l.Qo.IMAGES?e+="?image="+this.context.initial_ids[0]:this.context.initial_type===l.Qo.ROIS?e+="?roi="+this.context.initial_ids[0]:this.context.initial_type===l.Qo.SHAPES&&(e+="?shape="+this.context.initial_ids[0]),e+="&page_size="+this.thumbnails_request_size,d.ajax({url:e,success:e=>{if("object"!=typeof e||null===e||!r.Z.isArray(e.paths)||0===e.paths.length)return void("number"==typeof this.image_config.image_info.parent_id&&!isNaN(this.image_config.image_info.parent_id)&&this.image_config.image_info.parent_id>0?this.requestMoreThumbnails(!0):this.hideMe());let t=this.image_config.image_info.parent_id,i=e.paths.map((e=>{let i=e.filter((e=>"well"===e.type||"dataset"===e.type&&e.id===t));return i.length>0?i[0]:null})).filter((e=>e)),n=i.length?i[0]:null,s=this.image_config.image_info;if(n&&("dataset"===n.type?(s.parent_type=l.Qo.DATASET,s.parent_id=n.id):"well"===n.type&&(s.parent_type=l.Qo.WELL,s.parent_id=n.id)),null===s.parent_id)return void this.hideMe();let o=0;n&&(o=n.childIndex),this.requestMoreThumbnails(!0,!1,o)},error:e=>this.requestMoreThumbnails(!0)})}setThumbnailsFromIds(e){this.setThumbnailsCount(e.length);let t=e.map((e=>({"@id":e,Name:"Image: "+e})));this.addThumbnails(t,0)}loadVisibleThumbnails(e,t=!1,i=!1){if(void 0===e){const t=document.querySelector(".thumbnail-scroll-panel");t&&(e=t.scrollTop)}let n=parseInt(e/this.thumbnail_size),s=parseInt((e+this.slider_height)/this.thumbnail_size),o=[];for(var r=n;r<=s;r++)r<this.thumbnails.length&&!this.thumbnails[r].id&&o.push(r);o.length>0&&(n=o[0],s=o[o.length-1]+1,this.requestMoreThumbnails(t,i,n,s))}requestMoreThumbnails(e=!1,t=!1,i=0,n){let s=this.context.initial_type,o=s===l.Qo.DATASET||s===l.Qo.WELL?this.context.initial_ids[0]:this.image_config.image_info.parent_id,a=s===l.Qo.IMAGES||s===l.Qo.ROIS||s===l.Qo.SHAPES?this.image_config.image_info.parent_type:s,h=parseInt(i/this.thumbnails_request_size)*this.thumbnails_request_size,c=this.thumbnails_request_size;void 0!==n&&(c=(n=Math.ceil(n/this.thumbnails_request_size)*this.thumbnails_request_size)-h);let g=this.context.server,p=s===l.Qo.IMAGES||s===l.Qo.ROIS||s===l.Qo.SHAPES;s===l.Qo.DATASET||p&&a===l.Qo.DATASET?g+=this.web_api_base+l.DT+"/"+o+"/images/?":(this.context.initial_type===l.Qo.WELL||p&&a===l.Qo.WELL)&&(g+=this.context.getPrefixedURI(l.$R)+"/well_images/?id="+o+"&"),g+="offset="+h+"&limit="+c,d.ajax({url:g,success:n=>{if(this.requesting_thumbnail_data=!1,e){if("object"!=typeof n||null===n||"object"!=typeof n.meta||null===n.meta)return void this.hideMe();this.setThumbnailsCount(n.meta.totalCount),0===this.thumbnails.length&&this.hideMe()}0!==this.thumbnails.length&&r.Z.isArray(n.data)&&0!==n.data.length&&(this.addThumbnails(n.data,h),e&&(i>0?this.scrollToThumbnail(i):this.loadVisibleThumbnails()),!e||t||this.context.initial_type!==l.Qo.DATASET&&this.context.initial_type!==l.Qo.WELL||this.onClick(n.data[0]["@id"]))},error:t=>{this.requesting_thumbnail_data=!1,e&&this.hideMe()}})}addThumbnails(e,t){let i=(""!==this.context.server?this.context.server+"/":"")+this.webclient_prefix+"/render_thumbnail/",n=0;this.thumbnails=this.thumbnails.map(((s,o)=>{if(o===t+n&&n<e.length){let t=e[n];return n++,{id:t["@id"],url:i+t["@id"]+"/",title:"string"==typeof t.Name?t.Name:t["@id"],revision:0}}return s}))}scrollToThumbnail(e){this.taskQueue.queueMicroTask((()=>{const t=e*this.thumbnail_size;let i=document.querySelector(".thumbnail-scroll-panel");i&&(i.scrollTop=t)}))}hideMe(){d(this.element).hide(),d(".col-splitter.left-split").css("visibility","hidden"),d(".frame").addClass("left-hand-panel-hidden"),d(".frame").css("margin-left",""),d(".frame").css("padding-left",""),this.context.eventbus.publish(h.D3,{config_id:-1})}onClick(e){this.click_handle&&(clearTimeout(this.click_handle),this.click_handle=null),this.click_handle=setTimeout((()=>this.context.onClicks(e)),250)}onDoubleClick(e,t){return t.stopPropagation(),this.click_handle&&(clearTimeout(this.click_handle),this.click_handle=null),this.context.useMDI=!0,this.context.onClicks(e,!0),!1}handleScrollEvent(e){this.loadVisibleThumbnails(e.target.scrollTop)}updateThumbnails(e={}){if("object"!=typeof e||!r.Z.isArray(e.ids)&&e.ids.length>0)return;let t={};e.ids.forEach((e=>t[e]=null));let i=0;this.updateHandle=setInterval((()=>{let n=!1;try{let n=0;for(;i<this.thumbnails.length&&n<this.thumbnails_request_size&&n<e.ids.length;){let e=this.thumbnails[i++];void 0!==t[e.id]&&(e.revision++,n+=1)}}catch(e){n=!0}(i>=this.thumbnails.length||n)&&clearInterval(this.updateHandle)}),2e3)}setThumbnailsCount(e){"number"!=typeof e&&(e=0),this.thumbnails.length=e;for(let t=0;t<e;t++)this.thumbnails[t]={version:0,title:"unloaded"}}handleDragStart(e){return e.dataTransfer.setData("id",e.target.dataset.id),!0}refreshThumbnails(){this.requesting_thumbnail_data||null===this.context.selected_config||(this.initialized=!1,this.setThumbnailsCount(0),this.initializeThumbnails(!0))}})||n)||n},"controls/dimension-slider":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n,s,o,r,a,l=i(4997),h=i("aurelia-framework"),d=i(9202),c=i(5222),g=i(4783),p=(i(432),i(7674)),u=i(7610),f=i(1010);function _(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function m(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let v=(0,h.customElement)("dimension-slider")(n=(0,h.inject)(l.Z,Element,h.BindingEngine)((o=m((s=class{constructor(e,t,i){this.INTMAX=p.PO.INTMAX,_(this,"image_config",o,this),this.elSelector=null,_(this,"dim",r,this),_(this,"player_info",a,this),this.observers=[],this.image_info_ready_observer=null,this.last_player_start=null,this.add_projection_history=!1,this.context=e,this.element=t,this.bindingEngine=i}playDimension(e){let t=this.image_config;if("z"===this.dim&&t.image_info.projection===p.PO.INTMAX)return;let i=null!==this.player_info.dim&&this.player_info.dim===this.dim&&this.player_info.forwards===e;i?t.addHistory({prop:["image_info","dimensions",this.dim],old_val:this.last_player_start,new_val:t.image_info.dimensions[this.dim],type:"number"}):this.last_player_start=t.image_info.dimensions[this.dim],this.context.publish(u.r7,{config_id:t.id,dim:this.dim,forwards:e,stop:i})}bind(){this.elSelector="#"+this.image_config.id+" [dim='"+this.dim+"'] [name='dim']"}attached(){let e=()=>{this.image_config.image_info.refresh||(this.registerObservers(),this.initSlider())};this.image_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((t,i)=>{!i&&t&&e()}))}detached(){try{f(this.elSelector).slider("destroy")}catch(e){}f(this.element).hide()}unregisterObservers(){this.observers.map((e=>e.dispose())),this.observers=[],this.image_info_ready_observer&&(this.image_info_ready_observer.dispose(),this.image_info_ready_observer=null)}registerObservers(){this.observers.push(this.bindingEngine.propertyObserver(this.image_config.image_info.dimensions,this.dim).subscribe(((e,t)=>{f(this.elSelector).slider("option","value",e),this.context.publish(u.Fs,{config_id:this.image_config.id,sync_group:this.image_config.sync_group,projection:this.image_config.image_info.projection,dim:this.dim,value:[e]})}))),"z"===this.dim&&(this.observers.push(this.bindingEngine.propertyObserver(this.image_config.image_info,"projection").subscribe(((e,t)=>this.initSlider(!0)))),this.observers.push(this.bindingEngine.propertyObserver(this.image_config.image_info.projection_opts,"start").subscribe(((e,t)=>{this.changeProjection([e,this.image_config.image_info.projection_opts.end],!1)}))),this.observers.push(this.bindingEngine.propertyObserver(this.image_config.image_info.projection_opts,"end").subscribe(((e,t)=>{this.changeProjection([this.image_config.image_info.projection_opts.start,e],!1)}))))}onChange(e,t=!1){e=Math.round(parseFloat(e));let i=this.image_config.image_info,n=i.dimensions[this.dim];e!==n&&(t&&this.image_config.addHistory({prop:["image_info","dimensions",this.dim],old_val:n,new_val:e,type:"number"}),i.dimensions[this.dim]=e)}initSlider(e=!1){this.detached();let t=this.image_config.image_info;if(t.dimensions["max_"+this.dim]<=1)return;let i={orientation:"z"===this.dim?"vertical":"horizontal",min:0,max:t.dimensions["max_"+this.dim]-1,step:.01,slide:(e,i)=>{if(null!==this.player_info.handle)return!1;if(d.Z.isArray(i.values)){let e=i.values[0]===i.value?0:i.values[1]===i.value?1:-1;if(0===e&&i.value>=i.values[1]||1===e&&i.value<=i.values[0])return!1}if("number"==typeof e.keyCode){let t=38===e.keyCode||39===e.keyCode,n=37===e.keyCode||40===e.keyCode,s=i.value;return t?s=Math.ceil(s):n&&(s=Math.floor(s)),f(this.elSelector).slider("value",s),!1}let n=f(this.elSelector+" .slider-value"),s=Math.round(i.value),o=this.dim.toUpperCase()+":"+(s+1);"t"===this.dim&&t.image_delta_t.length>0&&s<t.image_delta_t.length&&(o+=" ["+t.formatDeltaT(t.image_delta_t[s])+"]"),n.text(o);let r=i.value/(t.dimensions["max_"+this.dim]-1)*100;"z"===this.dim?n.css({bottom:r+"%"}):n.css({left:r+"%"}),n.show()},stop:(e,t)=>{let i=f(this.elSelector+" .slider-value");i.text(""),i.hide()}};"z"===this.dim&&t.projection===p.PO.INTMAX?(i.range=!0,i.change=(e,i)=>{if(e.originalEvent){if(!this.checkForUnsavedRoiLoss())return void f(this.elSelector).slider({values:[t.projection_opts.start,t.projection_opts.end]});this.add_projection_history=!0,t.projection_opts.synced=!1,this.changeProjection(i.values)}},i.values=[t.projection_opts.start,t.projection_opts.end]):(i.value=t.dimensions[this.dim],i.change=(e,i)=>{!e.originalEvent||this.checkForUnsavedRoiLoss()?this.onChange(i.value,!!e.originalEvent):f(this.elSelector).slider({value:t.dimensions[this.dim]})}),f(this.elSelector).slider(i),f(this.element).show(),this.changeProjection(i.values,e)}changeProjection(e,t=!1){let i=this.image_config,n=[{prop:["image_info","projection_opts","synced"],old_val:!1,new_val:!1,type:"boolean"}];if(d.Z.isArray(e)){e[0]=Math.round(parseFloat(e[0])),e[1]=Math.round(parseFloat(e[1]));let s=Object.assign({},i.image_info.projection_opts);i.image_info.projection_opts.start=e[0],i.image_info.projection_opts.end=e[1];let o=i.image_info.dimensions.max_z-1;i.image_info.projection_opts.start>o&&(i.image_info.projection_opts.start=o),i.image_info.projection_opts.end>o&&(i.image_info.projection_opts.end=o),f(this.elSelector).slider("option","values",[i.image_info.projection_opts.start,i.image_info.projection_opts.end]),this.add_projection_history&&(t?n.push({prop:["image_info","projection"],old_val:p.PO.NORMAL,new_val:p.PO.INTMAX,type:"string"}):n.push({prop:["image_info","projection_opts"],old_val:s,new_val:Object.assign({},i.image_info.projection_opts),type:"object"}),i.addHistory(n),this.add_projection_history=!1)}else t&&this.add_projection_history&&(n.push({prop:["image_info","projection"],old_val:p.PO.INTMAX,new_val:p.PO.NORMAL,type:"string"}),i.addHistory(n),this.add_projection_history=!1);i.image_info.projection_opts.synced||this.context.publish(u.h6,{config_id:i.id,sync_group:i.sync_group,projection:i.image_info.projection,projection_opts:Object.assign({},i.image_info.projection_opts)})}onArrowClick(e){if(null!==this.player_info.handle||!this.checkForUnsavedRoiLoss())return;let t=f(this.elSelector).slider("value");f(this.elSelector).slider("value",t+e)}unbind(){this.unregisterObservers(),this.image_config=null}toggleProjection(){if(this.getZProjectionDisabled(this.player_info.handle,this.player_info.forwards))return;if(!this.checkForUnsavedRoiLoss())return;let e=this.image_config.image_info;e.projection_opts.start=0;let t=0;e.projection_opts.end=e.dimensions["max_"+this.dim]-1,t=e.dimensions[this.dim]-5,t>0&&(e.projection_opts.start=t),t=e.dimensions[this.dim]+5,t<e.dimensions["max_"+this.dim]-1&&(e.projection_opts.end=t),this.add_projection_history=!0,e.projection_opts.synced=!1,e.projection=e.projection===p.PO.NORMAL?p.PO.INTMAX:p.PO.NORMAL}getZProjectionDisabled(e,t){let i=this.image_config.image_info.dimensions,n=i.max_x*i.max_y>g.y9,s=Math.ceil(Math.log2(this.image_config.image_info.range[1])/8),o=this.image_config.image_info.channels.length,r=i.max_x*i.max_y*i.max_z*s*o,a=this.context.max_projection_bytes;return null!==e&&t||n||r>a}checkForUnsavedRoiLoss(){return!this.image_config.regions_info.isRoiLoadingPaginatedByPlane()||!this.image_config.regions_info.hasBeenModified()||(c.Z.showModalMessage("You have unsaved ROI changes. Please Save or Undo before moving to a new plane.","OK"),!1)}}).prototype,"image_config",[h.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r=m(s.prototype,"dim",[h.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"t"}}),a=m(s.prototype,"player_info",[h.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{dim:null,forwards:null,handle:null}}}),n=s))||n)||n},7610:(e,t,i)=>{"use strict";i.d(t,{A3:()=>v,D3:()=>a,Dk:()=>r,Du:()=>s,F7:()=>R,FQ:()=>n,Fs:()=>c,I4:()=>l,IJ:()=>m,MF:()=>y,Md:()=>o,Ot:()=>E,P4:()=>P,Wp:()=>x,XN:()=>C,bX:()=>w,fo:()=>d,gO:()=>k,gw:()=>N,h6:()=>h,iw:()=>A,j1:()=>I,ko:()=>_,n2:()=>O,nS:()=>g,nb:()=>M,q0:()=>S,r7:()=>p,sU:()=>T,vN:()=>b,w3:()=>L,w5:()=>f,xf:()=>u});const n="IMAGE_SETTINGS_REFRESH",s="IMAGE_CANVAS_DATA",o="IMAGE_INTENSITY_QUERYING",r="IMAGE_VIEWER_CONTROLS_VISIBILITY",a="IMAGE_VIEWER_RESIZE",l="IMAGE_VIEWER_INTERACTION",h="IMAGE_SETTINGS_CHANGE",d="VIEWER_PROJECTIONS_SYNC",c="IMAGE_DIMENSION_CHANGE",g="IMAGE_COMMENT_CHANGE",p="IMAGE_DIMENSION_PLAY",u="IMAGE_VIEWPORT_CAPTURE",f="IMAGE_VIEWPORT_LINK",_="REGIONS_SET_PROPERTY",m="REGIONS_PROPERTY_CHANGED",v="REGIONS_DRAW_SHAPE",y="REGIONS_SHAPE_GENERATED",b="REGIONS_CHANGE_MODES",w="REGIONS_SHOW_COMMENTS",x="ENABLE_SHAPE_POPUP",I="REGIONS_GENERATE_SHAPES",S="REGIONS_STORE_SHAPES",C="REGIONS_STORED_SHAPES",T="REGIONS_MODIFY_SHAPES",E="VIEWER_IMAGE_SETTINGS",A="VIEWER_SET_SYNC_GROUP",R="REGIONS_HISTORY_ENTRY",P="REGIONS_HISTORY_ACTION",O="REGIONS_COPY_SHAPES",k="HISTOGRAM_RANGE_UPDATE",N="THUMBNAILS_UPDATE",L="SAVE_ACTIVE_IMAGE_SETTINGS";class M{constructor(e){this.subscriptions=[],this.sub_list=[],this.eventbus=e}subscribe(){this.unsubscribe(),this.sub_list.map((e=>this.subscriptions.push(this.eventbus.subscribe(e[0],e[1]))))}unsubscribe(){if(0!==this.subscriptions.length)for(;this.subscriptions.length>0;)this.subscriptions.pop().dispose()}}},"info/info":(e,t,i)=>{"use strict";i.r(t),i.d(t,{Info:()=>c});var n,s,o,r,a=i(4997),l=i(3603),h=i("aurelia-framework"),d=i(7674);let c=(0,h.customElement)("info")(n=(0,h.inject)(a.Z,h.BindingEngine)((r=class{constructor(e,t){!function(e,t,i,n){i&&Object.defineProperty(e,"image_info",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.open_with_links=[],this.dataset_info=null,this.observers=[],this.columns=null,this.context=e,this.bindingEngine=t}bind(){let e=()=>{null!==this.image_info&&(this.image_info.ready?this.onImageConfigChange():(this.observers.length>1&&"object"==typeof this.observers[1]&&null!==this.observers[1]&&this.observers.pop().dispose(),["ready","parent_type"].map((e=>{this.observers.push(this.bindingEngine.propertyObserver(this.image_info,e).subscribe(((e,t)=>this.onImageConfigChange())))}))))};this.observers.push(this.bindingEngine.propertyObserver(this,"image_info").subscribe(((t,i)=>e()))),e()}unbind(){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],this.columns=[]}onImageConfigChange(){if(null===this.image_info)return;let e="",t="Pixels Size (XYZ)";if("object"==typeof this.image_info.image_pixels_size&&null!==this.image_info.image_pixels_size){let i="µm",n=0,s=!1;"number"==typeof this.image_info.image_pixels_size.unit_x?(e+=this.image_info.image_pixels_size.unit_x.toFixed(2),i=this.image_info.image_pixels_size.symbol_x,s=!0):(e+="-",n++),e+=" x ","number"==typeof this.image_info.image_pixels_size.unit_y?(e+=this.image_info.image_pixels_size.unit_y.toFixed(2),s||(i=this.image_info.image_pixels_size.symbol_y,s=!0)):(e+="-",n++),e+=" x ","number"==typeof this.image_info.image_pixels_size.unit_z?(e+=this.image_info.image_pixels_size.unit_z.toFixed(2),s||(i=this.image_info.image_pixels_size.symbol_z,s=!0)):(e+="-",n++),3===n?e="Not available":s&&(t+=" ("+i+")")}t+=":";let i=this.image_info.dimensions.max_x+" x "+this.image_info.dimensions.max_y;if(this.columns=[{label:"Owner:",value:this.image_info.author}],this.image_info.acquisition_date&&this.columns.push({label:"Acquisition Date:",value:this.image_info.acquisition_date}),this.columns=this.columns.concat([{label:"Import Date:",value:this.image_info.import_date},{label:"Dimension (XY):",value:i},{label:"Pixels Type:",value:this.image_info.image_pixels_type},{label:t,value:e},{label:"Z-sections:",value:this.image_info.dimensions.max_z},{label:"Timepoints:",value:this.image_info.dimensions.max_t}]),"number"==typeof this.image_info.parent_id){let e=this.context.initial_type===d.Qo.WELL||this.image_info.parent_type===d.Qo.WELL;this.parent_info={title:e?"Well":"Dataset",url:this.context.server+this.context.getPrefixedURI(d.cM)+"/?show="+(e?"well":"dataset")+"-"+this.image_info.parent_id,name:e||"Multiple"===this.image_info.dataset_name?this.image_info.parent_id:this.image_info.dataset_name}}else this.parent_info=null;this.updateOpenWithLinks()}updateOpenWithLinks(){let e=this.image_info.image_id,t=this.image_info.image_name,i=this.image_info.context.getPrefixedURI(d.$R),n=this.image_info.context.getPrefixedURI(d.YH);this.open_with_links.splice(0,this.open_with_links.length,...l.Z.getOpenWithLinkParams(e,t,i,n))}},g=(s=r).prototype,p="image_info",u=[h.bindable],f={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},_={},Object.keys(f).forEach((function(e){_[e]=f[e]})),_.enumerable=!!_.enumerable,_.configurable=!!_.configurable,("value"in _||_.initializer)&&(_.writable=!0),void 0===(_=u.slice().reverse().reduce((function(e,t){return t(g,p,e)||e}),_)).initializer&&(Object.defineProperty(g,p,_),_=null),o=_,n=s))||n)||n;var g,p,u,f,_},5939:(e,t,i)=>{"use strict";var n=i(8604),s=i("aurelia-event-aggregator"),o=i(4997),r=(i("app/index"),i(9202),i(7674)),a=i(5582);i(6199),i(4969),i(2319),i(5740),i(8237),i(1354),i(1709),a.config({warnings:{wForgottenReturn:!1}}),window["encoding-indexes"]={"windows-1252":r.vM};let l=window.INITIAL_REQUEST_PARAMS||{};(0,n.U)((function(e){e.use.basicConfiguration();let t=new o.Z(e.container.get(s.h),l);e.container.registerInstance(o.Z,t),e.start().then((()=>e.setRoot("app/index",document.body)))}))},1230:(e,t,i)=>{"use strict";i.d(t,{Z:()=>p});var n,s=i("aurelia-framework"),o=i(8546),r=i(7037),a=i(9202);let l=(0,s.noView)(n=class{constructor(){this.debug=!0,this.undo_redo_enabled=!0,this.history=[],this.historyPointer=-1}addHistory(e={scope:null,prop:["null"],old_val:null,new_val:null,type:"object"}){let t=[];a.Z.isArray(e)?t=e:t.push(e),0!==t.length&&(t.map((e=>{if("object"!=typeof e||null===e||!a.Z.isArray(e.prop)||0===e.prop.length)return void(this.debug&&console.debug("History.record requires an action object pointing to a property!"));let t="string"==typeof e.type&&e.type.length>0?e.type:"undefined",i=typeof e.old_val;"undefined"!==t&&i!==t||"undefined"===t&&i===t?this.debug&&console.debug("History.record requires an action object with old_val and new_val "):this.checkProperty(e.prop,e.scope)||this.debug&&console.debug("History.record: given property does not exist!")})),this.history.splice(this.historyPointer+1,this.history.length-this.historyPointer,t),this.historyPointer++)}checkProperty(e=[],t=null,i=null){if(!a.Z.isArray(e)||0===e.length)return!1;let n=t=t||this,s=null;for(let t=0;t<e.length;t++){if("string"!=typeof e[t]||0===e[t].length)return!1;if(t>0&&(n=n[e[t-1]]),void 0===n[e[t]])return!1;s=e[t]}return"function"==typeof i&&i.call(t,n,s),!0}undoHistory(){this.canUndo()&&(this.history[this.historyPointer].map((e=>{this.checkProperty(e.prop,e.scope,((t,i)=>t[i]=e.old_val))||this.debug&&console.debug("Failed to undo history")})),this.historyPointer--)}redoHistory(){this.canRedo()&&(this.history[this.historyPointer+1].map((e=>{this.checkProperty(e.prop,e.scope,((t,i)=>t[i]=e.new_val))||this.debug&&console.debug("Failed to redo history")})),this.historyPointer++)}canRedo(){return this.hasHistory()&&this.undo_redo_enabled&&this.historyPointer<this.history.length-1}canUndo(){return this.hasHistory()&&this.undo_redo_enabled&&this.historyPointer>=0}hasHistory(){return this.history.length>0}resetHistory(){this.history=[],this.historyPointer=-1}})||n;var h,d=i(7674),c=i(7610),g=i(1010);let p=(0,s.noView)(h=class extends l{constructor(e,t,i,n,s){super(),this.context=null,this.id=null,this.revision=0,this.image_info=null,this.regions_info=null,this.sync_group=null,this.sync_locks=null,this.show_controls=!0,this.position=null,this.size={width:"435px",height:"435px"},this.show_histogram=!1,this.context=e,this.id=(new Date).getTime(),this.image_info=new o.Z(this.context,this.id,t,i,n,s),this.regions_info=new r.Z(this.image_info)}bind(){this.image_info.bind()}unbind(){this.regions_info.unbind(),this.image_info.unbind()}changed(){this.revision++}applyRenderingSettings(e,t=!0){if(null===e)return;"boolean"!=typeof t&&(t=!0);let i=this.image_info,n=[],s=t&&"string"==typeof e.m&&e.m.length>0?e.m.toLowerCase():!t&&"string"==typeof e.model&&e.model.length>0?"greyscale"===e.model.toLowerCase()?"greyscale":"color":null;if(s&&("g"===s[0]||"c"===s[0])){let e=i.model;i.model="g"===s[0]?"greyscale":"color",e!==i.model&&n.push({prop:["image_info","model"],old_val:e,new_val:i.model,type:"string"})}let o=t?a.Z.parseChannelParameters(e.c,e.maps):e.c;if(d.lD.MIN_MAX,o)for(let e=0;e<o.length;e++){if("object"!=typeof i.channels[e])continue;let t=i.channels[e],s=o[e];t.active!==s.active&&(n.push({prop:["image_info","channels",""+e,"active"],old_val:t.active,new_val:s.active,type:"boolean"}),t.active=s.active),t.window.start!==s.start&&(n.push({prop:["image_info","channels",""+e,"window","start"],old_val:t.window.start,new_val:s.start,type:"number"}),t.window.start=s.start),t.window.end!==s.end&&(n.push({prop:["image_info","channels",""+e,"window","end"],old_val:t.window.end,new_val:s.end,type:"number"}),t.window.end=s.end);let r="string"==typeof s.lut&&s.lut.length>0?s.lut:s.color;t.color!==r&&(n.push({prop:["image_info","channels",""+e,"color"],old_val:t.color,new_val:r,type:"string"}),t.color=s.color),void 0===s.inverted&&(s.inverted=null),t.inverted!==s.inverted&&(n.push({prop:["image_info","channels",""+e,"inverted"],old_val:t.inverted,new_val:s.inverted,type:"boolean"}),t.inverted=s.inverted),"string"!=typeof s.family||""===s.family||"number"!=typeof s.coefficient||isNaN(s.coefficient)||(n.push({prop:["image_info","channels",""+e,"family"],old_val:t.family,new_val:s.family,type:"string"}),t.family=s.family,n.push({prop:["image_info","channels",""+e,"coefficient"],old_val:t.coefficient,new_val:s.coefficient,type:"string"}),t.coefficient=s.coefficient)}n.length>0&&(n.splice(0,0,{prop:["image_info","initial_values"],old_val:!0,new_val:!0,type:"boolean"}),this.addHistory(n)),this.changed()}toggleSyncGroup(e=null){if(this.sync_group===e)return;let t="string"==typeof this.sync_group?this.context.sync_groups.get(this.sync_group):null;if("object"==typeof t&&null!==t){let e=t.members.indexOf(this.id);-1!==e&&t.members.splice(e,1),this.sync_group=null,this.sync_locks=null}let i="string"==typeof e?this.context.sync_groups.get(e):null;"object"==typeof i&&null!==i&&(i.members.push(this.id),this.sync_group=e,this.sync_locks=i.sync_locks),this.context.publish(c.iw,{config_id:this.id,sync_group:this.sync_group})}saveImageSettings(e,t){if(!this.image_info.ready||!this.image_info.can_annotate||0===this.history.length||this.historyPointer<0||"function"!=typeof e)return;if(a.Z.useJsonp(this.context.server))return void console.error("Saving the rendering settings will not work cross-domain!");let i=this.image_info,n=this.context.server+this.context.getPrefixedURI(d.YH)+"/saveImgRDef/"+i.image_id+"/?m="+i.model[0]+"&p="+i.projection+"&t="+(i.dimensions.t+1)+"&z="+(i.dimensions.z+1)+"&q=0.9&ia=0";n=a.Z.appendChannelsAndMapsToQueryString(i.channels,n),"function"!=typeof t&&(t=e=>console.error(e)),g.ajax({url:n,method:"POST",success:e,error:t})}})||h},8546:(e,t,i)=>{"use strict";i.d(t,{Z:()=>d});var n,s=i("aurelia-framework"),o=i(9202),r=i(5222),a=i(7674),l=i(7610),h=i(1010);let d=(0,s.noView)(n=class{constructor(e,t,i,n,s,o){this.image_id=null,this.parent_id=null,this.parent_type=a.Qo.NONE,this.dataset_name=null,this.ready=!1,this.refresh=!1,this.error=!1,this.tiled=!1,this.author=null,this.image_name=null,this.short_image_name="",this.acquisition_date=null,this.import_date=null,this.image_pixels_type=null,this.image_pixels_size=null,this.image_delta_t=[],this.image_delta_t_unit="s",this.can_annotate=!1,this.imported_settings=null,this.copied_img_rdef=null,this.initial_values=!0,this.families=[],this.dimensions={t:0,max_t:1,z:0,max_z:1},this.channels=null,this.roi_count=0,this.range=null,this.projection=a.PO.NORMAL,this.projection_opts={start:0,end:0},this.model="color",this.web_url=null,this.context=e,this.config_id=t,this.image_id=n==a.Qo.IMAGES?i:void 0,this.initial_roi_id=n==a.Qo.ROIS?i:void 0,this.initial_shape_id=n==a.Qo.SHAPES?i:void 0,"number"==typeof s&&(this.parent_id=s,"number"==typeof o&&o>=a.Qo.NONE&&o<=a.Qo.WELL&&(this.parent_type=o)),this.web_url=this.context.server+this.context.getPrefixedURI(a.cM)+"/?show=image-"+this.image_id}bind(){this.requestData()}unbind(){this.dimensions={t:0,max_t:1,z:0,max_z:1},this.channels=null,this.imported_settings=null}requestData(e){"boolean"!=typeof e&&(e=!1),this.ready=!1;let t=this.context.server+this.context.getPrefixedURI(a.$R);!this.image_id&&this.initial_roi_id?t+="/roi/"+this.initial_roi_id+"/image_data/":!this.image_id&&this.initial_shape_id?t+="/shape/"+this.initial_shape_id+"/image_data/":t+="/image_data/"+this.image_id+"/",h.ajax({url:t,success:t=>{this.image_id||(this.image_id=t.id),this.initializeImageInfo(t,e),this.context.initial_type!==a.Qo.WELL&&"number"!=typeof this.parent_id&&"object"==typeof t.meta&&"number"==typeof t.meta.datasetId&&(this.parent_id=t.meta.datasetId),this.requestImgRDef();let i=this.context.getImageConfig(this.config_id);this.context.isRoisTabActive()&&(this.initial_roi_id?i.regions_info.setPageByRoiAndReload(this.initial_roi_id):this.initial_shape_id?i.regions_info.setPageByRoiAndReload(null,this.initial_shape_id):i.regions_info.requestData())},error:(e,t)=>{this.ready=!1,this.error=!0,"string"==typeof e.responseText&&console.error(e.responseText),"number"==typeof this.config_id&&this.context.removeImageConfig(this.config_id);let i=404===e.status?"Image not found":"Failed to get image data: '".concat(t,"'");r.Z.showModalMessage(i,"OK")}})}initializeImageInfo(e,t=!1){if(this.integrateInitialSettings(e,t),this.range=e.pixel_range,this.image_pixels_size=e.pixel_size,this.can_annotate=e.perms.canAnnotate,"number"==typeof e.meta.wellId&&(this.parent_id=e.meta.wellId,this.parent_type=a.Qo.WELL),"string"==typeof e.meta.imageAuthor&&(this.author=e.meta.imageAuthor),"string"==typeof e.meta.imageName){this.image_name=e.meta.imageName;let t=this.image_name.replace("\\","/").split("/");t.length>0&&(this.short_image_name=t[t.length-1])}"string"==typeof e.meta.pixelsType&&(this.image_pixels_type=e.meta.pixelsType),this.import_date=e.import_date,"string"==typeof e.acquisition_date&&(this.acquisition_date=e.acquisition_date),this.roi_count=e.roi_count,"string"==typeof e.meta.datasetName&&(this.dataset_name=e.meta.datasetName),this.families=e.families,document.title=""!==this.short_image_name?this.short_image_name:a.XI,this.applyCachedSettings(e),this.ready=!0,this.tmp_data=e,t&&this.context.publish(l.FQ,{config_id:this.config_id}),this.requestDeltaT()}applyCachedSettings(e){let t=this.context.getCachedImageSettings(this.image_id),i=this.context.getImageConfig(this.config_id);if(void 0!==t){let n=[];if(void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),t.center&&(e.center=t.center,e.rotation=t.rotation,e.resolution=t.resolution),void 0!==t.z&&(n.push({prop:["image_info","dimensions","z"],old_val:this.dimensions.z,new_val:t.z,type:"number"}),e.rdefs.defaultZ=t.z,this.dimensions.z=t.z),void 0!==t.t&&(n.push({prop:["image_info","dimensions","t"],old_val:this.dimensions.t,new_val:t.t,type:"number"}),e.rdefs.defaultT=t.t,this.dimensions.t=t.t),t.projection&&(this.projection=t.projection,this.projection_opts=t.projection_opts),t.model){let e=this.sanitizeModel(t.model);this.model!=e&&(n.push({prop:["image_info","model"],old_val:this.model,new_val:e,type:"string"}),this.model=e)}if(e.rdefs.model=this.model,i.addHistory(n),t.channels){let e=t.channels.map(((e,t)=>"".concat(e.active?"":"-").concat(t+1,"|").concat(e.window.start,":").concat(e.window.end,"$").concat(e.color))).join(","),n=t.channels.map((e=>({inverted:{enabled:e.inverted},quantization:{coefficient:e.coefficient,family:e.family}})));i.applyRenderingSettings({c:e,maps:n})}}}integrateInitialSettings(e,t=!1){let i=parseInt(this.context.getInitialRequestParam(a.Yj.DATASET_ID));"number"==typeof i&&!isNaN(i)&&i>=0&&(this.parent_id=i,this.parent_type=a.Qo.DATASET),"boolean"==typeof e.tiles&&(this.tiled=e.tiles);let n=this.context.getInitialRequestParam(a.Yj.MODEL);if(this.model=null!==n?n.toLowerCase():e.rdefs.model,t)return void(this.channels=this.initAndMixChannelsWithInitialSettings(e.channels,[]));let s=this.context.getInitialRequestParam(a.Yj.TIME),r=this.context.getInitialRequestParam(a.Yj.PLANE),l=this.context.getInitialRequestParam(a.Yj.PROJECTION),h=this.context.getInitialRequestParam(a.Yj.CHANNELS),d=this.context.getInitialRequestParam(a.Yj.MAPS);h=o.Z.parseChannelParameters(h,d),this.channels=this.initAndMixChannelsWithInitialSettings(e.channels,h),this.dimensions={t:null!==s?parseInt(s)-1:e.rdefs.defaultT,max_t:e.size.t,z:null!==r?parseInt(r)-1:e.rdefs.defaultZ,max_z:e.size.z,max_x:e.size.width,max_y:e.size.height},l=o.Z.parseProjectionParameter(null!==l?l.toLowerCase():e.rdefs.projection),this.projection=l.projection;let c=0,g=0,p=this.dimensions.max_z-1;"number"==typeof l.start&&l.start>=0&&l.start<this.dimensions.max_z?c=l.start:(g=this.dimensions.z-5,g>0&&(c=g)),"number"==typeof l.end&&l.end>=0&&l.end<this.dimensions.max_z?p=l.end:(g=this.dimensions.z+5,g<this.dimensions.max_z-1&&(p=g)),this.projection_opts={start:c,end:p},this.dimensions.max_z>1&&this.projection_opts.start>=this.projection_opts.end&&(this.projection_opts.start=this.projection_opts.end-1),this.sanityCheckInitialValues()}sanityCheckInitialValues(){this.dimensions.t<0&&(this.dimensions.t=0),this.dimensions.t>=this.dimensions.max_t&&(this.dimensions.t=this.dimensions.max_t-1),this.dimensions.z<0&&(this.dimensions.z=0),this.dimensions.z>=this.dimensions.max_z&&(this.dimensions.z=this.dimensions.max_z-1),this.model=this.sanitizeModel(this.model)}sanitizeModel(e){let t;switch(e.toLowerCase()[0]){case"c":default:t="color";break;case"g":t="greyscale"}return t}requestDeltaT(){if(this.dimensions.max_t<=1)return;let e=this.context.server+this.context.getPrefixedURI(a.$R);e+="/image_data/"+this.image_id+"/delta_t/",h.ajax({url:e,success:e=>{console.log("response this.image_id",this.image_id,e.image_id),this.setFormattedDeltaT(e)}})}setFormattedDeltaT(e){this.image_delta_t=e.delta_t,this.image_delta_t_unit=e.delta_t_unit_symbol}formatDeltaT(e,t=!1){const i=1e3;let n="";(e=Math.round(e*i))<0&&(n+="-",e=-e);let s=parseInt(e/864e5);e-=24*s*3600*i;let o=parseInt(e/36e5);e-=3600*o*i;let r=parseInt(e/6e4);e-=6e4*r;let a=parseInt(e/i),l=e-a*i;function h(e,t=2){return("000"+e).slice(-t)}function d(e){return 1==e?"":"s"}return 0!=s&&(n+=t?s+" day".concat(d(s)," "):h(s)+" "),n+=t?"".concat(o," hour").concat(d(o)," ").concat(r," minute").concat(d(r)," ").concat(a,".").concat(h(l,3)," seconds"):"".concat(h(o),":").concat(h(r),":").concat(h(a),".").concat(h(l,3)),n}requestImgRDef(e=null){let t=this.config_id;null===e&&(e=(e,i)=>{if(null===e||"string"!=typeof e.c||i!==t||!this.ready)return;let n=o.Z.parseChannelParameters(e.c,e.maps);o.Z.isArray(n)&&o.Z.isArray(this.channels)&&n.length==this.channels.length&&e.pixel_range==this.range.join(":")||(this.copied_img_rdef=null)}),h.ajax({url:this.context.server+this.context.getPrefixedURI(a.YH)+"/getImgRDef/",success:t=>{"object"!=typeof t||null===t||"object"!=typeof t.rdef||null===t.rdef?this.copied_img_rdef=null:this.copied_img_rdef=t.rdef,"function"==typeof e&&e(this.copied_img_rdef,this.config_id)},error:()=>{this.copied_img_rdef=null,e(this.copied_img_rdef,this.config_id)}})}requestImportedData(e=null){this.imported_settings?"function"==typeof e&&e():h.ajax({url:this.context.server+this.context.getPrefixedURI(a.YH)+"/imgData/"+this.image_id+"/?getDefaults=true",success:t=>{"object"==typeof t&&null!==t&&o.Z.isArray(t.channels)&&"object"==typeof t.rdefs&&null!==t.rdefs&&"string"==typeof t.rdefs.projection&&"string"==typeof t.rdefs.model&&(this.imported_settings={c:t.channels,t:"number"==typeof t.rdefs.defaultT?t.rdefs.defaultT:0,z:"number"==typeof t.rdefs.defaultZ?t.rdefs.defaultZ:0,p:t.rdefs.projection,m:t.rdefs.model},"function"==typeof e&&e())}})}getActiveChannels(){if(null===this.channels)return null;let e=[];for(let t=0;t<this.channels.length;t++)this.channels[t].active&&e.push(t);return e}initAndMixChannelsWithInitialSettings(e,t){return o.Z.isArray(e)?(e.map((e=>{e.show_advanced_settings="string"==typeof e.family&&"linear"!==e.family,"string"==typeof e.lut&&e.lut.length>0&&(e.color=e.lut),"boolean"!=typeof e.inverted&&(e.inverted=null)})),o.Z.isArray(t)?(t.map((t=>{if("object"==typeof e[t.index]){let i=e[t.index];i.active=t.active,i.window.start=t.start,i.window.end=t.end,i.color=t.color,"boolean"==typeof t.inverted&&(i.inverted=t.inverted),"string"==typeof t.family&&(i.family=t.family),"number"!=typeof t.coefficient||isNaN(t.coefficient)||(i.coefficient=t.coefficient)}})),e):e):e}getChannelMinMaxValues(e=0,t=0,i=0){if("number"!=typeof e||e<0||e>2||"number"!=typeof t||t<0||t>=this.channels.length)return null;let n,s,r,l,h,d,c=this.channels[t];switch(e){case a.lD.IMPORTED:case a.lD.MIN_MAX:n=c.window.min,s=c.window.end,r=c.window.start,l=c.window.max,h=this.initial_values?c.window.start:c.window.min,d=this.initial_values?c.window.end:c.window.max;break;case a.lD.FULL_RANGE:n=this.range[0],s=c.window.end,r=c.window.start,l=this.range[1],h=this.range[0],d=this.range[1]}let g=1;return"float"===this.image_pixels_type||"double"===this.image_pixels_type?(g=.001,("number"!=typeof i||i<=0)&&(i=3)):i=0,{start_min:0===i?n:o.Z.roundAtDecimal(n,i),start_max:(0===i?s:o.Z.roundAtDecimal(s,i))-g,end_min:(0===i?r:o.Z.roundAtDecimal(r,i))+g,end_max:0===i?l:o.Z.roundAtDecimal(l,i),start_val:0===i?h:o.Z.roundAtDecimal(h,i),end_val:0===i?d:o.Z.roundAtDecimal(d,i),step_size:g}}})||n},1633:(e,t,i)=>{"use strict";i.d(t,{Z:()=>l});var n,s=i("aurelia-framework"),o=i(9202),r=i(1037),a=i(7610);let l=(0,s.noView)(n=class{constructor(e){this.action={PROPERTIES:0,SHAPES:1,OL_ACTION:2},this.hist_id=0,this.history=[],this.historyPointer=-1,this.hasOnlyNewlyDeleted=!0,this.regions_info=null,this.regions_info=e}getHistoryId(){return this.hist_id++}addHistory(e=-1,t=0,i={shape_id:null,diffs:[],old_vals:[],new_vals:[]},n=null){let s=[];if(o.Z.isArray(i)?s=i:s.push(i),0===s.length)return;if(t!==this.action.PROPERTIES&&t!==this.action.SHAPES&&t!==this.action.OL_ACTION)return;let r=null;"number"!=typeof e||e<0?e=this.getHistoryId():this.history.map((t=>{t.hist_id===e&&(r=t)}));let a=[];for(let e=0;e<s.length;e++){let i=s[e];if(t===this.action.PROPERTIES){if(!o.Z.isArray(i.diffs)||0===i.diffs.length||!o.Z.isArray(i.old_vals)||!o.Z.isArray(i.new_vals)||i.old_vals.length!==i.diffs.length||i.new_vals.length!==i.diffs.length||"string"!=typeof i.shape_id)continue;a.push(i)}else if(t===this.action.SHAPES){if(!o.Z.isArray(i.diffs)||0===i.diffs.length||"boolean"!=typeof i.old_vals||"boolean"!=typeof i.new_vals)continue;a.push(i)}else if(t===this.action.OL_ACTION){if("number"!=typeof i.hist_id)continue;a.push(i)}}if(r)r.records=r.records.concat(a);else{let i={hist_id:e,action:t,records:a};"function"==typeof n&&(i.post_update_handler=n),this.history.splice(this.historyPointer+1,this.history.length-this.historyPointer,i),this.historyPointer++}this.checkIfHistoryHasOnlyNewlyDeleted()}undoHistory(){if(!this.canUndo())return;let e=this.history[this.historyPointer];this.doHistory(e,!0),this.historyPointer--,this.checkIfHistoryHasOnlyNewlyDeleted()}redoHistory(){if(!this.canRedo())return;let e=this.history[this.historyPointer+1];this.doHistory(e,!1),this.historyPointer++,this.checkIfHistoryHasOnlyNewlyDeleted()}doHistory(e,t){let i=this.regions_info.image_info;for(let n=0;n<e.records.length;n++){let s=e.records[n];if(e.action===this.action.PROPERTIES){let i=this.regions_info.getShape(s.shape_id);if(null===i)continue;let n={properties:s.diffs,values:t?s.old_vals:s.new_vals};this.affectHistoryPropertyChange(i,n,e.post_update_handler,s.modifies_attachment)}else if(e.action===this.action.SHAPES)if(t?s.old_vals:s.new_vals)s.diffs.map((e=>{i.context.publish(a.ko,{config_id:i.config_id,property:"state",shapes:[e.shape_id],value:"undo"})}));else{let e=[];s.diffs.map((t=>e.push(t.shape_id))),i.context.publish(a.ko,{config_id:i.config_id,property:"state",shapes:e,value:"delete"})}else e.action===this.action.OL_ACTION&&i.context.publish(a.P4,{config_id:i.config_id,hist_id:s.hist_id,undo:t})}}affectHistoryPropertyChange(e,t,i=null,n=!1){if("object"!=typeof this.regions_info)return;let s={type:e.type};for(let e=0;e<t.properties.length;e++)s[t.properties[e]]=t.values[e];let o=r.c.createUpdateHandler(t,{hist:null,hist_id:-1},i,n),l=this.regions_info.image_info;l.context.publish(a.sU,{config_id:l.config_id,shapes:[e.shape_id],modifies_attachment:n,definition:s,callback:o})}checkIfHistoryHasOnlyNewlyDeleted(){if(this.hasOnlyNewlyDeleted=!0,this.historyPointer<0)return;let e=new Map;for(let t=0;t<=this.historyPointer;t++){let i=this.history[t];if(o.Z.isArray(i.records))for(let t in i.records){let n=i.records[t];switch(i.action){case this.action.OL_ACTION:for(let t in n.shape_ids)if(null!==e.get(n.shape_ids[t]))return void(this.hasOnlyNewlyDeleted=!1);break;case this.action.PROPERTIES:if(null!==e.get(n.shape_id))return void(this.hasOnlyNewlyDeleted=!1);break;default:if(!o.Z.isArray(n.diffs))break;for(let t in n.diffs){let i=n.diffs[t].shape_id,s="boolean"==typeof n.diffs[t].is_new;if(n.new_vals)s&&e.set(i,null);else{if(!s)return void(this.hasOnlyNewlyDeleted=!1);e.delete(i)}}}}}this.hasOnlyNewlyDeleted=0===e.size}canRedo(){return this.hasHistory()&&this.historyPointer<this.history.length-1}canUndo(){return this.hasHistory()&&this.historyPointer>=0}hasHistory(){return this.history.length>0}resetHistory(){this.history=[],this.hasOnlyNewlyDeleted=!0,this.historyPointer=-1}})||n},7037:(e,t,i)=>{"use strict";i.d(t,{Z:()=>c});var n,s=i("aurelia-framework"),o=i(1633),r=i(9202),a=i("utils/converters"),l=i(7610),h=i(7674),d=i(1010);let c=(0,s.noView)(n=class{constructor(e){this.is_pending=!1,this.ready=!1,this.data=new Map,this.plane_shape_counts=null,this.roi_page_size=500,this.roi_page_number=0,this.number_of_shapes=0,this.roi_count_on_current_plane=0,this.history=null,this.selected_shapes=[],this.visibility_toggles=0,this.roi_visibility_toggles={},this.copied_shapes=[],this.copied_image_dims=null,this.regions_modes=[h.uo.SELECT,h.uo.MODIFY,h.uo.TRANSLATE],this.show_comments=!1,this.shape_to_be_drawn=null,this.shape_defaults={},this.drawing_mode=h.pQ.PRESENT_Z_AND_T,this.drawing_dims={t:[],z:[]},this.roi_id=-1,this.image_info=e,this.history=new o.Z(this),this.syncCopiedShapesWithLocalStorage(),this.resetShapeDefaults(),this.roi_page_size=this.image_info.context.roi_page_size}unbind(){this.resetRegionsInfo(),this.history=null}syncCopiedShapesWithLocalStorage(){try{this.copied_shapes=JSON.parse(window.localStorage.getItem(h.$R+".copy_shape_defs")),r.Z.isArray(this.copied_shapes)||(this.copied_shapes=[])}catch(e){this.copied_shapes=[]}try{this.copied_image_dims=JSON.parse(window.localStorage.getItem(h.$R+".copy_image_dims"))}catch(e){this.copied_image_dims=null}}setPropertyForShape(e,t,i){if(null===this.data||"string"!=typeof e||"string"!=typeof t||void 0===i)return;let n=this.getShape(e);if(null===n)return;let s=a.Converters.extractRoiAndShapeId(e),o=this.data.get(s.roi_id);if(void 0!==n[t]&&(n[t]=i),"selected"!==t&&"visible"!==t||!i)if("selected"===t&&!i||"visible"===t&&!i||"deleted"===t&&i){let i=this.selected_shapes.indexOf(e);-1!==i&&this.selected_shapes.splice(i,1),n.selected=!1,"deleted"===t&&"boolean"==typeof n.is_new&&n.is_new?(o.deleted++,this.number_of_shapes--,n.visible||this.updateRoiVisibilityToggles(e,1)):"visible"===t&&this.updateRoiVisibilityToggles(e,-1)}else"deleted"===t&&"boolean"==typeof n.is_new&&n.is_new&&!i&&(o.deleted--,this.number_of_shapes++,n.visible||this.updateRoiVisibilityToggles(e,-1));else"visible"===t?this.updateRoiVisibilityToggles(e,1):(this.data.get(s.roi_id).show=!0,-1===this.selected_shapes.indexOf(e)&&this.selected_shapes.push(e))}updateRoiVisibilityToggles(e,t){this.visibility_toggles+=t;let i=e.split(":")[0];void 0===this.roi_visibility_toggles[i]&&(this.roi_visibility_toggles[i]=0),this.roi_visibility_toggles[i]+=t}setPageAndReload(e){if("number"!=typeof e||e<0||e>=this.getPageCount()||this.is_pending)return!1;this.roi_page_number=e,this.requestData(!0)}setPageByRoiAndReload(e,t){if(this.isRoiLoadingPaginatedByPlane()){let i=this.image_info.context.getPrefixedURI(h.$R);i+=t?"/shape/".concat(t,"/page_data/"):"/roi/".concat(e,"/page_data/"),d.ajax({url:i,success:e=>{const t=parseInt(e.roi_index/this.roi_page_size);this.roi_page_number=t,null!=e.theZ&&(this.image_info.dimensions.z=e.theZ),null!=e.theT&&(this.image_info.dimensions.t=e.theT),this.requestData(!0)},error:e=>{this.is_pending=!1,console.error("Failed to load Rois: "+e)}})}else this.requestData()}getPageCount(){return Math.ceil(this.roi_count_on_current_plane/this.roi_page_size)}isRoiLoadingPaginatedByPlane(){return this.image_info.roi_count>this.roi_page_size}getRegionsUrl(){let e,t=this.image_info.dimensions.z;this.image_info.projection&&"normal"!=this.image_info.projection&&(this.image_info.projection_opts.start&&(t=this.image_info.projection_opts.start),this.image_info.projection_opts.end&&(e=this.image_info.projection_opts.end));let i=this.image_info.context.server;return this.isRoiLoadingPaginatedByPlane()?i+=this.image_info.context.getPrefixedURI(h.$R)+"/rois_by_plane/"+this.image_info.image_id+"/"+t+(e?"-"+e:"")+"/"+this.image_info.dimensions.t+"/?":i+=this.image_info.context.getPrefixedURI(h.oD)+h.VQ+"/?image="+this.image_info.image_id+"&",i+="limit="+this.roi_page_size+"&offset="+this.roi_page_number*this.roi_page_size,i}requestData(e=!1){this.ready&&!e||(this.is_pending?e&&(this.try_request_again=!0):(this.ready=!1,this.resetRegionsInfo(),this.is_pending=!0,d.ajax({url:this.getRegionsUrl(),success:e=>{this.try_request_again?(this.is_pending=!1,this.try_request_again=!1,this.requestData()):this.is_pending&&(this.setData(e.data),this.roi_count_on_current_plane=e.meta.totalCount)},error:e=>{this.is_pending=!1,console.error("Failed to load Rois: "+e)}})))}setData(e=null){if(this.is_pending=!1,r.Z.isArray(e)){this.resetRegionsInfo();try{let t=0;for(let i in e){let n=new Map,s=e[i],o=e[i].Name||"";if(r.Z.isArray(s.shapes)&&s.shapes.length>0){let e=s["@id"];s.shapes.sort((function(e,t){var i=parseInt(e.TheZ),n=parseInt(t.TheZ),s=parseInt(e.TheT),o=parseInt(t.TheT);return i===n?s<o?-1:s>o?1:0:i<n?-1:1}));for(let i in s.shapes){let o=s.shapes[i],r=a.Converters.amendShapeDefinition(Object.assign({},o)),l=r["@id"];r.shape_id=e+":"+l,r.visible=!0,r.selected=!1,r.deleted=!1,r.modified=!1,n.set(l,r),t++}this.data.set(e,{name:o,shapes:n,show:!1,deleted:0})}}this.number_of_shapes=t,this.tmp_data=e}catch(e){console.error("Failed to sync Rois: "+e)}this.ready=!0}}resetRegionsInfo(){this.ready=!1,this.history instanceof o.Z&&this.history.resetHistory(),this.data instanceof Map&&(this.data.forEach(((e,t)=>e.shapes.clear())),this.data.clear()),this.number_of_shapes=0,this.selected_shapes=[]}getNewRegionsId(){return--this.roi_id}getAllShapeIds(e=!0){if(!e)return this.unsophisticatedShapeFilter();let t=[];return this.data.forEach((e=>e.shapes.forEach((e=>{let i="boolean"==typeof e.is_new&&e.is_new;(!i||i&&!e.deleted)&&t.push(e.shape_id)})))),t}unsophisticatedShapeFilter(e=[],t=[],i=[],n=null){let s=[];if(!r.Z.isArray(e)||!r.Z.isArray(t)||!r.Z.isArray(i)||e.length!==t.length||e.length!==i.length)return s;let o=n=>{for(let s=0;s<e.length;s++)if(void 0!==n[e[s]]){if("object"==typeof n.permissions&&null!==n.permissions){let e="string"==typeof i[s]&&i[s].length>0?"can"+i[s][0].toUpperCase()+i[s].substring(1).toLowerCase():null;if(e&&"boolean"==typeof n.permissions[e]&&!n.permissions[e])return!1}if(n[e[s]]!==t[s])return!1}return!0},a=r.Z.isArray(n);return this.data.forEach((e=>e.shapes.forEach((e=>{let t=e.shape_id;(a&&-1!==n.indexOf(t)&&o(e)||!a&&o(e))&&s.push(t)})))),s}getShape(e){if(null===this.data)return null;let t=a.Converters.extractRoiAndShapeId(e),i=this.data.get(t.roi_id);if(void 0===i||!(i.shapes instanceof Map))return null;let n=i.shapes.get(t.shape_id);return void 0!==n?n:null}getRoiFromShapeId(e){if(null===this.data)return null;let t;return this.data.forEach(((i,n)=>{i.shapes.forEach(((i,s)=>{i["@id"]==e&&(t=n)}))})),t}hasBeenModified(){return this.history instanceof o.Z&&this.history.historyPointer>=0&&!this.history.hasOnlyNewlyDeleted}getLastSelectedShape(e="canEdit"){let t=this.selected_shapes.length;if(0===t||"string"!=typeof e)return null;let i=this.getShape(this.selected_shapes[t-1]);if(this.checkShapeForPermission(i,e))return i;for(let i=t-2;i>=0;i--){let t=this.getShape(this.selected_shapes[i]);if(this.checkShapeForPermission(t,e))return t}return i}resetShapeDefaults(){Array.isArray(this.image_info.context.roi_color_palette)?this.shape_defaults.StrokeColor=a.Converters.rgbaToSignedInteger(this.image_info.context.roi_color_palette[0][0]):this.shape_defaults.StrokeColor=-65281,this.shape_defaults.FillColor=-256,this.shape_defaults.StrokeWidth={"@type":"TBD#LengthI",Unit:"PIXEL",Symbol:"pixel",Value:1}}checkShapeForPermission(e,t){return!("object"!=typeof e||null===e||"string"!=typeof t||"canAnnotate"!==t&&"canEdit"!==t&&"canDelete"!==t||"object"==typeof e.permissions&&null!==e.permissions&&"boolean"==typeof e.permissions[t]&&!e.permissions[t])}getNumberOfDeletedShapes(){return this.unsophisticatedShapeFilter(["deleted","is_new"],[!0,"false"],["canDelete","canDelete"]).length}getEmptyRois(){let e={};return this.data.forEach(((t,i)=>{let n=t.shapes.size-t.deleted;if(i>-1&&t.shapes instanceof Map&&n>0){let s=0;t.shapes.forEach((e=>{e.deleted&&s++})),s===n&&(e[i]=null)}})),e}copyShapes(){this.ready&&0!==this.selected_shapes.length&&this.image_info.context.publish(l.n2,{config_id:this.image_info.config_id})}pasteShapes(e=null){if(!this.ready||!this.image_info.can_annotate||0===this.copied_shapes.length)return;this.syncCopiedShapesWithLocalStorage();let t=this.copied_image_dims&&this.copied_image_dims.width<=this.image_info.dimensions.max_x&&this.copied_image_dims.height<=this.image_info.dimensions.max_y,i={config_id:this.image_info.config_id,number:1,paste:!0,shapes:this.copied_shapes,is_compatible:t,hist_id:this.history.getHistoryId(),position:e};this.image_info.context.publish(l.j1,i)}deleteShapes(){if(!this.ready||0===this.selected_shapes.length)return;let e=this.unsophisticatedShapeFilter(["deleted"],[!1],["delete"],this.selected_shapes);if(0===e.length)return;let t={config_id:this.image_info.config_id,property:"state",shapes:e,value:"delete"},i=this.history.getHistoryId();t.callback=e=>{"object"==typeof e&&null!==e&&this.history.addHistory(i,this.history.action.SHAPES,{shape_id:e.shape_id,diffs:[Object.assign({},e)],old_vals:!0,new_vals:!1})},this.image_info.context.publish(l.ko,t)}requestStats(e,t){if("function"!=typeof t&&(t=()=>{}),!this.ready||!r.Z.isArray(e)||0===e.length||0===this.image_info.getActiveChannels().length)return void t();let i=this.image_info.getActiveChannels(),n=[],s=[],o=new Map,a=e=>{let t=e.stats;if("object"!=typeof t||null===t)s.push(e["@id"]),o.set(e["@id"],e),n.length!==i.length&&(n=i.slice());else for(let r in i){let a=i[r];"object"!=typeof t[a]&&(s.push(e["@id"]),o.set(e["@id"],e),n.length!==i.length&&-1===n.indexOf(a)&&n.push(a))}};for(let t in e){if(-1!==e[t].indexOf("-"))continue;let i=this.getShape(e[t]);if(null!==i&&i){if(-1===i.TheT||-1===i.TheZ)continue;a(i)}}0!==s.length?d.ajax({url:this.image_info.context.server+this.image_info.context.getPrefixedURI(h.$R)+"/shape_stats/?ids="+s.join(",")+"&z="+this.image_info.dimensions.z+"&t="+this.image_info.dimensions.t+"&cs="+n.join(","),success:e=>{if("object"==typeof e&&null!==e)for(let t in e){let i=o.get(parseInt(t));if(i){"object"==typeof i.stats&&null!==i.stats||(i.stats={});for(let n in e[t]){let s=e[t][n];i.stats[s.index]=Object.assign({},s)}}}t()},error:e=>{console.error(),t()}}):t()}})||n},"regions/regions-drawing":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n,s,o,r,a=i(4997),l=i("aurelia-framework"),h=i(9202),d=i(5222),c=i(1037),g=i("utils/converters"),p=(i(7674),i(7610));let u=(0,l.customElement)("regions-drawing")(n=(0,l.inject)(a.Z,l.BindingEngine)((r=class extends p.nb{regions_infoChanged(e,t){this.waitForRegionsInfoReady()}constructor(e,t){super(e.eventbus),function(e,t,i,n){i&&Object.defineProperty(e,"regions_info",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.supported_shapes=["rectangle","ellipse","point","arrow","line","polyline","polygon","label"],this.sub_list=[[p.MF,(e={})=>this.onShapeDrawn(e)],[p.vN,(e={})=>this.onModeChange(e)]],this.observers=[],this.regions_ready_observer=null,this.context=e,this.bindingEngine=t}registerObservers(){let e=()=>{let e=this.supported_shapes.indexOf(this.regions_info.shape_to_be_drawn);e<0||this.onDrawShape(e)};this.observers.push(this.bindingEngine.propertyObserver(this.regions_info,"drawing_mode").subscribe(((t,i)=>e()))),this.observers.push(this.bindingEngine.propertyObserver(this.regions_info.image_info,"projection").subscribe(((t,i)=>{null!==this.regions_info.shape_to_be_drawn&&e()})));for(let t in this.regions_info.shape_defaults)this.observers.push(this.bindingEngine.propertyObserver(this.regions_info.shape_defaults,t).subscribe(((t,i)=>e())));this.observers.push(this.bindingEngine.propertyObserver(this.context,"selected_tab").subscribe(((e,t)=>{this.regions_info&&null!==this.regions_info.shape_to_be_drawn&&!this.context.isRoisTabActive()&&this.onModeChange({config_id:this.regions_info.image_info.config_id})})))}unregisterObservers(e=!1){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],e||this.regions_ready_observer&&(this.regions_ready_observer.dispose(),this.regions_ready_observer=null)}onShapeDrawn(e={}){if(e.config_id!==this.regions_info.image_info.config_id)return;"boolean"!=typeof e.drawn&&(e.drawn=!1);let t="boolean"!=typeof e.add||e.add;"boolean"!=typeof e.add_history&&(e.add_history=!0),"number"!=typeof e.hist_id&&(e.hist_id=-1);let i=e.drawn?e.roi_id:null,n=[];if(h.Z.isArray(e.shapes)&&e.shapes.length>0){null===i&&(i=g.Converters.extractRoiAndShapeId(e.shapes[0].oldId).roi_id);let s=this.regions_info.data.get(i);void 0!==s&&s.shapes instanceof Map?s=s.shapes:(s=new Map,this.regions_info.data.set(i,{shapes:s,show:!0,deleted:0})),e.shapes.map((i=>{let o=g.Converters.amendShapeDefinition(i);if(o){o.is_new=!0,o.visible=!0,o.selected=!1,o.deleted=!1,o.modified=!0;let i=Object.assign({},o);t&&(s.set(o["@id"],o),e.add_history&&this.regions_info.history.addHistory(e.hist_id,this.regions_info.history.action.SHAPES,{diffs:[i],shape_id:i.shape_id,old_vals:!1,new_vals:!0})),n.push(i)}}))}let s=n.length;if(this.regions_info.number_of_shapes+=s,e.drawn&&this.onDrawShape(this.supported_shapes.indexOf(this.regions_info.shape_to_be_drawn)),0!==s&&setTimeout(d.Z.scrollContainer.bind(null,"roi-"+n[s-1].shape_id,".regions-table"),50),!e.drawn||0===s)return;let o=Object.assign({},n[s-1]),r=c.c.getDimensionsForPropagation(this.regions_info,o.TheZ,o.TheT);0!==r.length&&(i="number"==typeof e.roi_id&&e.roi_id<0?e.roi_id:this.regions_info.getNewRegionsId(),this.context.publish(p.j1,{config_id:this.regions_info.image_info.config_id,shapes:[o],number:r.length,theDims:r,hist_id:e.hist_id,roi_id:i}))}onDrawShape(e){if(this.regions_info.is_pending)return;let t=!1;e<0||e>=this.supported_shapes.length?(t=!0,this.regions_info.shape_to_be_drawn=null):this.regions_info.shape_to_be_drawn=this.supported_shapes[e];let i={type:this.regions_info.shape_to_be_drawn};for(let e in this.regions_info.shape_defaults)i[e]=this.regions_info.shape_defaults[e];this.context.publish(p.A3,{config_id:this.regions_info.image_info.config_id,shape:i,abort:t,hist_id:this.regions_info.history.getHistoryId(),roi_id:this.regions_info.getNewRegionsId()})}onModeChange(e={}){e.config_id===this.regions_info.image_info.config_id&&this.context.publish(p.A3,{config_id:e.config_id,abort:!0})}bind(){this.waitForRegionsInfoReady()}waitForRegionsInfoReady(){if(null===this.regions_info)return;let e=()=>{null!==this.regions_info&&(this.registerObservers(),this.subscribe())};this.unregisterObservers(),this.unsubscribe(),this.regions_info.ready?e():null===this.regions_ready_observer&&(this.regions_ready_observer=this.bindingEngine.propertyObserver(this.regions_info,"ready").subscribe(((t,i)=>e())))}unbind(){this.unsubscribe(),this.unregisterObservers()}},f=(s=r).prototype,_="regions_info",m=[l.bindable],v={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},y={},Object.keys(v).forEach((function(e){y[e]=v[e]})),y.enumerable=!!y.enumerable,y.configurable=!!y.configurable,("value"in y||y.initializer)&&(y.writable=!0),void 0===(y=m.slice().reverse().reduce((function(e,t){return t(f,_,e)||e}),y)).initializer&&(Object.defineProperty(f,_,y),y=null),o=y,n=s))||n)||n;var f,_,m,v,y},"regions/regions-edit":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var n,s,o,r,a=i(4997),l=(i(9202),i(1037)),h=i(5222),d=i("utils/converters"),c=i(7674),g=i(7610),p=i("aurelia-framework"),u=(i(5686),i(1010));let f=(0,p.customElement)("regions-edit")(n=(0,p.inject)(a.Z,Element,p.BindingEngine)((r=class extends g.nb{regions_infoChanged(e,t){this.waitForRegionsInfoReady()}constructor(e,t,i){super(e.eventbus),function(e,t,i,n){i&&Object.defineProperty(e,"regions_info",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.key_actions=[{key:"A",func:this.selectAllShapes},{key:"C",func:this.copyShapes},{key:"V",func:this.pasteShapes},{key:"Delete",func:this.deleteShapes,ctrl:!1},{key:"Del",func:this.deleteShapes,ctrl:!1},{key:"Backspace",func:this.deleteShapes,ctrl:!1}],this.sub_list=[[g.Fs,()=>this.adjustEditWidgets()],[g.nS,(e={})=>this.handleImageCommentChange(e)]],this.last_selected=null,this.observers=[],this.regions_ready_observer=null,this.context=e,this.element=t,this.bindingEngine=i}bind(){this.waitForRegionsInfoReady()}unbind(){this.unregisterObservers(),this.unsubscribe()}waitForRegionsInfoReady(){if(null===this.regions_info)return;let e=()=>{null!==this.regions_info&&(this.registerObservers(),this.subscribe(),h.Z.registerKeyHandlers(this.context,this.key_actions,c.G7.ROIS,this),this.adjustEditWidgets())};this.unregisterObservers(),this.unsubscribe(),this.regions_info.ready?e():null===this.regions_ready_observer&&(this.regions_ready_observer=this.bindingEngine.propertyObserver(this.regions_info,"ready").subscribe(((t,i)=>e())))}attached(){let e=this.getColorPickerOptions(!1);u(this.element).find(".shape-stroke-color .spectrum-input").spectrum(e);let t=this.getColorPickerOptions(!0);u(this.element).find(".shape-fill-color .spectrum-input").spectrum(t);let i=u(this.element).find(".shape-stroke-width input");i.spinner({min:0,disabled:!1}),i.spinner("value",1),u(this.element).find(".shape-edit-comment input").prop("disabled",!0);let n=u(this.element).find(".shape-font-size input");n.spinner({min:1,disabled:!0}),n.spinner("value",10)}onColorChange(e,t=!0,i=null){if("object"!=typeof i||null===i)return;"boolean"!=typeof t&&(t=!0);let n={type:i.type},s=t?"FillColor":"StrokeColor",o=d.Converters.rgbaToSignedInteger(e);"number"==typeof o&&(n[s]=o,this.modifyShapes(n,this.createUpdateHandler([s],[o])),this.setDrawColors(e,t))}setDrawColors(e,t=!0){"boolean"!=typeof t&&(t=!0);let i=d.Converters.rgbaToSignedInteger(e);"number"==typeof i&&(this.regions_info.shape_defaults[t?"FillColor":"StrokeColor"]=i)}onStrokeWidthChange(e=10,t=null){if("number"!=typeof e||isNaN(e)||e<0)return;let i={"@type":"TBD#LengthI",Unit:"PIXEL",Symbol:"pixel",Value:e};if(this.regions_info.shape_defaults.StrokeWidth=Object.assign({},i),"object"!=typeof t||null===t)return;let n={type:t.type};n.StrokeWidth=i,this.modifyShapes(n,this.createUpdateHandler(["StrokeWidth"],[Object.assign({},n.StrokeWidth)]))}onFontSizeChange(e=10,t=null){if("object"!=typeof t||null===t)return;if("number"!=typeof e||isNaN(e)||e<1)return;let i={type:t.type};i.FontStyle="string"==typeof t.FontStyle?t.FontStyle:"normal",i.FontFamily="string"==typeof t.FontFamily?t.FontFamily:"sans-serif",i.FontSize={"@type":"TBD#LengthI",Unit:"POINT",Symbol:"pt",Value:e},this.modifyShapes(i,this.createUpdateHandler(["FontSize","FontStyle","FontFamily"],[Object.assign({},i.FontSize),i.FontStyle,i.FontFamily]))}handleImageCommentChange(e){if(!e.shapeId)return;let t=this.regions_info.getShape(e.shapeId);t&&this.onCommentChange(e.Text,t)}onCommentChange(e="",t=null){if("object"!=typeof t||null===t||"string"!=typeof e)return;let i={type:t.type};i.Text=e,this.modifyShapes(i,this.createUpdateHandler(["Text"],[e]),!1,t.oldId)}checkAttachmentInput(e,t=!1){let i=e.attr("dim"),n=this.regions_info.image_info.dimensions,s=n[i]+1,o=e.val().replace(/\s/g,"");return""===o?(t&&e.val(s),-1):(o=parseInt(o),isNaN(o)||o<1||o>n["max_"+i]?(t&&e.val(s),-1):o-1)}onAttachmentChange(e,t="t",i=null){if("number"!=typeof e||"string"!=typeof t)return;let n=t.toUpperCase();if("object"!=typeof i||null===i){let i="t"===t?"Z":"T";return void(e<0?this.regions_info.drawing_mode=this.regions_info.drawing_mode===c.pQ["NOT_"+i]?c.pQ.NEITHER_Z_NOR_T:c.pQ["NOT_"+n]:this.regions_info.drawing_mode===c.pQ["NOT_"+i]||this.regions_info.drawing_mode===c.pQ.NEITHER_Z_NOR_T?this.regions_info.drawing_mode=c.pQ["NOT_"+i]:this.regions_info.drawing_mode=c.pQ.PRESENT_Z_AND_T)}let s="The"+n,o={type:i.type};o[s]=e,this.modifyShapes(o,this.createUpdateHandler([s],[e],!0),!0)}modifyShapes(e,t=null,i=!1,n){if("object"!=typeof e||null===e)return;let s=this.regions_info.selected_shapes;n&&(s=[n]),this.context.publish(g.sU,{config_id:this.regions_info.image_info.config_id,shapes:s,modifies_attachment:i,definition:e,callback:t})}registerObservers(){this.observers.push(this.bindingEngine.collectionObserver(this.regions_info.selected_shapes).subscribe(((e,t)=>this.adjustEditWidgets()))),this.observers.push(this.bindingEngine.propertyObserver(this.regions_info,"shape_to_be_drawn").subscribe(((e,t)=>this.adjustEditWidgets()))),this.observers.push(this.bindingEngine.propertyObserver(this.regions_info.image_info,"projection").subscribe(((e,t)=>this.adjustEditWidgets())))}unregisterObservers(e=!1){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],e||this.regions_ready_observer&&(this.regions_ready_observer.dispose(),this.regions_ready_observer=null)}selectAllShapes(){if(!this.regions_info.ready)return;let e=this.regions_info.getAllShapeIds();this.context.publish(g.ko,{config_id:this.regions_info.image_info.config_id,property:"selected",shapes:e,clear:!0,value:!0,center:!1})}detached(){this.key_actions.map((e=>this.context.removeKeyListener(e.key,c.G7.ROIS))),u(this.element).find(".spectrum-input").spectrum("destroy"),u(this.element).find(".shape-stroke-width input").spinner("destroy")}adjustCommentEdit(e=!1,t=!0){let i=u(this.element).find(".shape-edit-comment input");i.off(),i.val("Comment"),i.attr("title",""),this.last_selected?(i.val("string"==typeof this.last_selected.Text?this.last_selected.Text:""),i.on("change keyup",(e=>{"keyup"===e.type&&13!==e.keyCode||this.onCommentChange(e.target.value,this.last_selected)})),i.prop("disabled",t),t&&i.attr("title",c.kN.CANNOT_EDIT)):i.prop("disabled",!0);let n=this.last_selected&&"object"==typeof this.last_selected.FontSize&&null!==this.last_selected.FontSize&&"number"==typeof this.last_selected.FontSize.Value?this.last_selected.FontSize.Value:10,s=u(this.element).find(".shape-font-size input");s.off(),s.spinner("value",n),s.on("change keyup spinstop",((e,t)=>{"keyup"===e.type&&13!==e.keyCode||this.onFontSizeChange(parseInt(e.target.value),this.last_selected)})),s.spinner(e?"enable":"disable"),s.attr("title",t?c.kN.CANNOT_EDIT:"")}adjustAttachmentEdit(e=!1,t=!0){let i=this.regions_info.image_info.dimensions,n=this.regions_info.image_info.projection===c.PO.INTMAX,s=u(this.element).find(".shape-edit-attachments").children(),o=s.filter("input"),r=s.filter("[name='shape-edit-attachments-locks']");r.addClass("disabled-color"),s.attr("title",""),o.prop("disabled",!0);let a=this.regions_info.selected_shapes.length;if((i.max_t>1||i.max_z>1)&&(o.off(),o.val(""),r.removeClass("dim_locked"),r.addClass("dim_unlocked"),r.off(),["t","z"].map((e=>{let s="The"+e.toUpperCase(),l="[dim='"+e+"']",h=i["max_"+e]>1,d=h&&"z"===e&&n,g=r.filter(l),p="z"===e?this.regions_info.drawing_mode===c.pQ.NOT_Z||this.regions_info.drawing_mode===c.pQ.NEITHER_Z_NOR_T:""===g.attr("locked"),u=this.last_selected?-1===this.last_selected[s]:p;g.attr("locked",u||d?"":"locked"),g.removeClass(u?"dim_locked":"dim_unlocked"),g.addClass(u||d?"dim_unlocked":"dim_locked");let f=o.filter(l);if(d?f.val(""):f.val(u?i[e]+1:this.last_selected?this.last_selected[s]+1:i[e]+1),!d&&h&&(!t||this.regions_info.image_info.can_annotate&&null===this.last_selected)){let t="Lock "+(0===a?"new ":"selected ")+(1===a?"shape ":"shapes ")+"to"+(0===a?" current ":" ")+e.toUpperCase()+"-index";g.attr("title",t),g.removeClass("disabled-color"),u||f.prop("disabled",!1)}t&&(f.prop("disabled",!0),f.attr("title",c.kN.CANNOT_EDIT),g.addClass("disabled-color"),g.attr("title",c.kN.CANNOT_EDIT))})),this.regions_info.image_info.can_annotate)){let e=(e,t=!1)=>{if(!this.regions_info.image_info.can_annotate)return;let i=e.target.getAttribute("dim");if(this.regions_info.image_info.dimensions["max_"+i]<=1)return-1;let n=o.filter('[dim="'+i+'"]');return this.checkAttachmentInput(n,t)};o.on("blur",(t=>e(t,!0))),o.on("change keyup",(t=>{if("keyup"===t.type&&13!==t.keyCode)return;let i=t.target.getAttribute("dim"),n=e(t);n>=0&&this.onAttachmentChange(n,i,this.last_selected)})),r.on("click",(i=>{if(t)return;let s=i.target.getAttribute("dim"),r="z"===s&&n;if(this.regions_info.image_info.dimensions["max_"+s]<=1||r)return;let a="locked"===i.target.getAttribute("locked");if(a)this.onAttachmentChange(-1,s,this.last_selected),i.target.className="dim_unlocked";else{let t=e(i,!0);if(t<0)return;this.onAttachmentChange(t,s,this.last_selected),i.target.className="dim_locked"}i.target.setAttribute("locked",a?"":"locked"),o.filter('[dim="'+s+'"]').prop("disabled",a)}))}}adjustStrokeEdit(e=!1,t=!0){let i=this.last_selected?this.last_selected.type.toLowerCase():null,n=this.getColorPickerOptions(!1,this.last_selected),s=u(this.element).find(".shape-stroke-color .spectrum-input");u(".shape-stroke-color").attr("title",""),s.spectrum("enable");let o=this.last_selected?this.last_selected.StrokeColor:this.regions_info.shape_defaults.StrokeColor,r=this.last_selected?"object"==typeof this.last_selected.StrokeWidth&&null!==this.last_selected.StrokeWidth&&"number"==typeof this.last_selected.StrokeWidth.Value?this.last_selected.StrokeWidth.Value:1:this.regions_info.shape_defaults.StrokeWidth.Value;"line"!==i&&"polyline"!==i||0!==r?"label"===i&&(r=0):r=1,n.color=d.Converters.signedIntegerToRgba(o),s.spectrum(n);let a=u(this.element).find(".shape-stroke-width input");a.off(),a.attr("title",""),a.spinner("enable"),"label"===i?(a.spinner("value",0),a.spinner("disable")):(a.spinner("value",r),a.on("change keyup spinstop",((e,t)=>{"keyup"===e.type&&13!==e.keyCode||this.onStrokeWidthChange(parseInt(e.target.value),this.last_selected)}))),this.setDrawColors(n.color,!1),t&&(s.spectrum("disable"),a.spinner("disable"),a.attr("title",c.kN.CANNOT_EDIT),u(".shape-stroke-color").attr("title",c.kN.CANNOT_EDIT))}adjustArrowEdit(e=!1,t=!0){let i=this.last_selected?this.last_selected.type.toLowerCase():null,n=u(this.element).find(".arrow-button button");n.attr("title",t?c.kN.CANNOT_EDIT:""),i&&i.indexOf("line")>=0&&!t?(n.prop("disabled",!1),u(".marker_start").html("string"==typeof this.last_selected.MarkerStart&&"Arrow"===this.last_selected.MarkerStart?"&#10003;":"&nbsp;"),u(".marker_end").html("string"==typeof this.last_selected.MarkerEnd&&"Arrow"===this.last_selected.MarkerEnd?"&#10003;":"&nbsp;")):n.prop("disabled",!0)}adjustFillEdit(e=!1,t=!0){let i=this.last_selected?this.last_selected.type.toLowerCase():null,n=this.getColorPickerOptions(!0,this.last_selected),s=u(this.element).find(".shape-fill-color .spectrum-input"),o=-256,r="line"===i||"polyline"===i||"label"===i;if(r||(o=this.last_selected?this.last_selected.FillColor:this.regions_info.shape_defaults.FillColor),n.color=d.Converters.signedIntegerToRgba(o),s.spectrum(n),u(".shape-fill-color").attr("title",""),r||t)return t&&u(".shape-fill-color").attr("title",c.kN.CANNOT_EDIT),void s.spectrum("disable");this.setDrawColors(n.color,!0),s.spectrum("enable")}adjustDeleteButton(e=!1,t=!0){let i=u(this.element).find(".shape-delete-button");i.prop("disabled",t||0===this.regions_info.selected_shapes.length),i.attr("title",t?c.kN.CANNOT_DELETE:"")}adjustEditWidgets(){this.last_selected=this.regions_info.getLastSelectedShape();let e=this.regions_info.checkShapeForPermission(this.last_selected,"canEdit"),t=this.regions_info.checkShapeForPermission(this.last_selected,"canDelete"),i=this.regions_info.selected_shapes.length>=1&&!e,n=this.regions_info.selected_shapes.length>=1&&!t;this.regions_info.is_pending&&(i=!0,n=!0),this.adjustCommentEdit(e,i),this.adjustAttachmentEdit(e,i),this.adjustStrokeEdit(e,i),this.adjustArrowEdit(e,i),this.adjustFillEdit(e,i),this.adjustDeleteButton(t,n)}getColorPickerOptions(e=!0,t=null){let i={disabled:null===this.regions_info,color:e?"rgba(255, 255, 255, 0.5)":"rgba(0, 153, 255, 0.7)",showInput:!0,showAlpha:!0,showInitial:!0,preferredFormat:"rgb",containerClassName:"color-spectrum-container",replacerClassName:e?"shape-fill-color-replacer":"shape-stroke-color-replacer",appendTo:e?u(this.element).find(".shape-fill-color"):u(this.element).find(".shape-stroke-color")};return Array.isArray(this.context.roi_color_palette)&&(i.palette=this.context.roi_color_palette,i.showPalette=!0,i.showPaletteOnly=this.context.show_palette_only),i.change=t?i=>this.onColorChange(i.toRgbString(),e,t):t=>this.setDrawColors(t.toRgbString(),e),i}toggleArrow(e=!0){if(null===this.last_selected)return;"boolean"!=typeof e&&(e=!0);let t={type:"polyline"},i=e?"MarkerEnd":"MarkerStart",n="string"==typeof this.last_selected[i]&&"Arrow"===this.last_selected[i]?"":"Arrow";t[i]=n,this.modifyShapes(t,this.createUpdateHandler([i],[n]))}createUpdateHandler(e,t,i=!1){let n={properties:e,values:t},s={hist:this.regions_info.history,hist_id:this.regions_info.history.getHistoryId()};return l.c.createUpdateHandler(n,s,this.adjustEditWidgets.bind(this),i)}copyShapes(){this.regions_info.copyShapes()}pasteShapes(){this.regions_info.pasteShapes()}deleteShapes(){this.regions_info.deleteShapes()}},_=(s=r).prototype,m="regions_info",v=[p.bindable],y={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},b={},Object.keys(y).forEach((function(e){b[e]=y[e]})),b.enumerable=!!b.enumerable,b.configurable=!!b.configurable,("value"in b||b.initializer)&&(b.writable=!0),void 0===(b=v.slice().reverse().reduce((function(e,t){return t(_,m,e)||e}),b)).initializer&&(Object.defineProperty(_,m,b),b=null),o=b,n=s))||n)||n;var _,m,v,y,b},"regions/regions-list":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var n,s,o,r,a=i(4997),l=i(9202),h=i(5222),d=i("aurelia-framework"),c=i(7610),g=i(1010);let p=(0,d.customElement)("regions-list")(n=(0,d.inject)(a.Z,d.BindingEngine)((r=class extends c.nb{regions_infoChanged(e,t){this.waitForRegionsInfoReady()}constructor(e,t){super(e.eventbus),function(e,t,i,n){i&&Object.defineProperty(e,"regions_info",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.sortBy="id",this.sortAscending=!0,this.active_column="comments",this.selected_row="",this.observers=[],this.regions_ready_observer=null,this.temp_sliding_page_number=void 0,this.sub_list=[[c.Fs,(e={})=>this.changeDimension(e)],[c.h6,(e={})=>this.changeImageSettings(e)],[c.r7,(e={})=>this.playImageDimension(e)]],this.context=e,this.bindingEngine=t}bind(){this.waitForRegionsInfoReady()}sort(e){this.sortAscending=this.sortBy!==e||!this.sortAscending,this.sortBy=e}sortCss(e,t,i){return i!==e?"sortable":t?"sortable asc":"sortable desc"}get pageCount(){return Math.ceil(this.regions_info.roi_count_on_current_plane/this.regions_info.roi_page_size)}waitForRegionsInfoReady(){if(null===this.regions_info)return;let e=()=>{null!==this.regions_info&&(this.registerObservers(),this.subscribe())};this.unregisterObservers(),this.regions_info.ready?e():null===this.regions_ready_observer&&(this.regions_ready_observer=this.bindingEngine.propertyObserver(this.regions_info,"ready").subscribe(((t,i)=>e())))}registerObservers(){this.observers.push(this.bindingEngine.collectionObserver(this.regions_info.selected_shapes).subscribe(((e,t)=>this.actUponSelectionChange()))),this.observers.push(this.bindingEngine.propertyObserver(this.regions_info,"visibility_toggles").subscribe(((e,t)=>g("#shapes_visibility_toggler").prop("checked",0===e))))}unregisterObservers(e=!1){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],e||this.regions_ready_observer&&(this.regions_ready_observer.dispose(),this.regions_ready_observer=null)}actUponSelectionChange(){if(0===this.regions_info.selected_shapes.length)return;let e=this.regions_info.selected_shapes.length,t=this.regions_info.selected_shapes[e-1],i=this.regions_info.getLastSelectedShape();if(null===i)return;let n=this.regions_info.checkShapeForPermission(i,"canEdit");(t===i.shape_id||n)&&h.Z.scrollContainer("roi-"+i.shape_id,".regions-table")}toggleRegionsTable(){g(".regions-list").is(":visible")?(g(".regions-list").hide(),g(".regions-list-toggler").removeClass("collapse-up"),g(".regions-list-toggler").addClass("expand-down")):(g(".regions-list").show(),g(".regions-list-toggler").removeClass("expand-down"),g(".regions-list-toggler").addClass("collapse-up"))}setPage(e=0){if(this.temp_sliding_page_number=void 0,!this.regions_info.is_pending)return this.regions_info.hasBeenModified()?(h.Z.showModalMessage("You have unsaved ROI changes. Please Save or Undo before going to next page.","OK"),!1):this.regions_info.setPageAndReload(e)}changeDimension(e){if("t"===e.dim||"z"==e.dim){let t=this.regions_info.image_info,i=this.context.getImageConfig(t.config_id),n=t.dimensions["max_"+e.dim]-1,s=t.dimensions[e.dim];if(i.is_movie_playing&&s<n&&this.regions_info.isRoiLoadingPaginatedByPlane())return void this.regions_info.resetRegionsInfo();this.requestRoisForNewPlane()}}changeImageSettings(e){e.projection&&this.requestRoisForNewPlane()}playImageDimension(e){e.stop&&this.requestRoisForNewPlane()}requestRoisForNewPlane(){this.regions_info.isRoiLoadingPaginatedByPlane()&&(this.regions_info.roi_page_number=0,this.regions_info.requestData(!0))}handlePageRange(e){let t=parseInt(e.target.value,10);this.setPage(t)||(e.target.value=this.regions_info.roi_page_number)}handlePageInput(e){let t=parseInt(e.target.value,10);isNaN(t)?e.target.value=this.regions_info.roi_page_number+1:this.setPage(t-1)||(e.target.value=this.regions_info.roi_page_number+1)}handlePageRangeSlide(e){let t=parseInt(e.target.value,10);this.temp_sliding_page_number=t}selectShape(e,t,i,n=!1){if("INPUT"===i.target.tagName.toUpperCase()||n&&(-1!==i.target.className.indexOf("roi_id")||-1!==i.target.parentNode.className.indexOf("roi_id")))return!0;let s=l.Z.isApple()?"metaKey":"ctrlKey",o="boolean"==typeof i[s]&&i[s],r=i.shiftKey,a=[e+=""],h=o,d=h&&t,p=[],u=!1;if(n){let t=this.regions_info.data.get(parseInt(e));if("object"==typeof t&&t.shapes instanceof Map){let e=0,i=0;t.shapes.forEach((t=>{t.is_new&&t.deleted||(e++,t.selected&&i++,p.push(t.shape_id))})),u=i>=e}d=!(!h||!u),a=p}if(n||-1===this.selected_row.indexOf(":")||-1!==this.regions_info.selected_shapes.indexOf(this.selected_row)||(this.selected_row=""),r&&""!==this.selected_row&&this.selected_row!==e){d=!1;let t=!1;a=[];let i=e=>{let t=e.id.substring("roi-".length);if(-1===t.indexOf(":")){let e=this.regions_info.data.get(parseInt(t));"object"==typeof e&&e.shapes instanceof Map&&e.shapes.forEach((e=>{e.is_new&&e.deleted||a.push(e.shape_id)}))}else a.push(t)};g(".regions-table-row").each(((n,s)=>{if(s&&"string"==typeof s.id&&0===s.id.indexOf("roi-"))if(s.id==="roi-"+e||s.id==="roi-"+this.selected_row){if(i(s),t)return!1;t=!0}else t&&i(s)}))}else{let t=this.regions_info.selected_shapes.length;d?d&&this.selected_row===e&&t>0&&(this.selected_row=this.regions_info.selected_shapes[t-1],this.selected_row===e&&t>1&&(this.selected_row=this.regions_info.selected_shapes[t-2])):this.selected_row=e}this.context.publish(c.ko,{config_id:this.regions_info.image_info.config_id,property:"selected",shapes:a,clear:!h,value:!d,center:!h})}selectShapes(e,t){if(t.stopPropagation(),-1!==t.target.className.indexOf("roi_id")||-1!==t.target.parentNode.className.indexOf("roi_id"))return!0;let i=this.regions_info.data.get(e);if(void 0===i)return;let n=[];i.shapes.forEach((e=>n.push(e.shape_id))),this.context.publish(c.ko,{config_id:this.regions_info.image_info.config_id,property:"selected",shapes:n,clear:!0,value:!0,center:!0})}toggleRoiVisibility(e,t){t.stopPropagation(),t.preventDefault();let i=t.target.checked,n=this.regions_info.data.get(e),s=[];if(n.shapes.forEach((e=>{e.visible!==i&&s.push(e.shape_id)})),0!=s.length)return this.context.publish(c.ko,{config_id:this.regions_info.image_info.config_id,property:"visible",shapes:s,value:i}),!1}toggleShapeVisibility(e,t){return t.stopPropagation(),t.preventDefault(),this.context.publish(c.ko,{config_id:this.regions_info.image_info.config_id,property:"visible",shapes:[e],value:t.target.checked}),!1}expandOrCollapseRoi(e,t){t.stopPropagation();let i=this.regions_info.data.get(e);void 0!==i&&(i.show=!i.show)}toggleAllShapesVisibility(e){e.stopPropagation();let t=e.target.checked;if(0===this.regions_info.number_of_shapes)return;let i=[];this.regions_info.data.forEach((e=>e.shapes.forEach((e=>{e.visible===t||e.deleted&&"boolean"==typeof e.is_new&&e.is_new||i.push(e.shape_id)})))),this.context.publish(c.ko,{config_id:this.regions_info.image_info.config_id,property:"visible",shapes:i,value:t})}showColumn(e){"string"==typeof e&&0!==e.length&&e!==this.active_column&&(this.active_column=e)}hasPermissions(e){return!(e&&e.permissions)||e.permissions&&e.permissions.canAnnotate&&e.permissions.canEdit&&e.permissions.canDelete}unbind(){this.unsubscribe(),this.unregisterObservers()}},u=(s=r).prototype,f="regions_info",_=[d.bindable],m={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},v={},Object.keys(m).forEach((function(e){v[e]=m[e]})),v.enumerable=!!v.enumerable,v.configurable=!!v.configurable,("value"in v||v.initializer)&&(v.writable=!0),void 0===(v=_.slice().reverse().reduce((function(e,t){return t(u,f,e)||e}),v)).initializer&&(Object.defineProperty(u,f,v),v=null),o=v,n=s))||n)||n;var u,f,_,m,v},"regions/regions-planes":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var n,s,o,r,a,l,h,d=i("aurelia-framework"),c=i(4997),g=i(5222),p=i(7674),u=i(1010);function f(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function _(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let m=(n=(0,d.customElement)("regions-planes"),s=(0,d.inject)(c.Z,d.BindingEngine),o=(0,d.computedFrom)("regions_info.image_info.dimensions.z","regions_info.image_info.projection","regions_info.image_info.projection_opts.start","regions_info.image_info.projection_opts.end"),n(r=s((l=_((a=class{regions_infoChanged(e,t){this.selected_roi_tab===p.zp.ROI_PLANE_GRID&&this.requestData(!0)}selected_roi_tabChanged(e,t){this.selected_roi_tab===p.zp.ROI_PLANE_GRID&&this.requestData()}constructor(e,t){f(this,"regions_info",l,this),f(this,"selected_roi_tab",h,this),this.observers=[],this.plane_shape_counts=null,this.max_shape_count=0,this.min_shape_count=0,this.is_pending=!1,this.context=e,this.bindingEngine=t}requestData(e=!1){(null==this.plane_shape_counts||e)&&(this.is_pending=!0,u.ajax({url:this.context.server+this.context.getPrefixedURI(p.$R)+"/plane_shape_counts/"+this.regions_info.image_info.image_id+"/",success:e=>{this.is_pending=!1;let t=[],i=1,n=1/0;for(let s=0;s<e.data[0].length;s++){let o=[];for(let t=0;t<e.data.length;t++){let r=e.data[t][s];n=Math.min(n,r),i=Math.max(i,r),o.push(r)}t.push(o)}this.plane_shape_counts=t,this.max_shape_count=i,this.min_shape_count=n},error:(e,t)=>{this.is_pending=!1,"string"==typeof e.responseText&&console.error(e.responseText)}}))}reverse(e){return e?e.slice().reverse():[]}getColor(e){if(0===e)return"#ddd";let t=100*(e-this.min_shape_count)/(this.max_shape_count-this.min_shape_count);return this.min_shape_count===this.max_shape_count&&(t=100),["rgb(212, 222, 223)","rgb(178, 189, 193)","rgb(149, 153, 164)","rgb(90, 89, 109)","rgb(20, 18, 30)"][Math.round(t/25)]}handleGridClick(e,t,i){this.checkForUnsavedRoiLoss()&&(t=parseInt(t),i=parseInt(i),this.regions_info.image_info.dimensions.t=i,e.shiftKey?this.regions_info.image_info.projection===p.PO.INTMAX?t<(this.regions_info.image_info.projection_opts.start+this.regions_info.image_info.projection_opts.end)/2?this.regions_info.image_info.projection_opts.start=t:this.regions_info.image_info.projection_opts.end=t:(this.regions_info.image_info.projection=p.PO.INTMAX,this.regions_info.image_info.projection_opts.start=Math.min(t,this.regions_info.image_info.dimensions.z),this.regions_info.image_info.projection_opts.end=Math.max(t,this.regions_info.image_info.dimensions.z)):(this.regions_info.image_info.projection=p.PO.NORMAL,this.regions_info.image_info.dimensions.z=t))}checkForUnsavedRoiLoss(){return!this.regions_info.isRoiLoadingPaginatedByPlane()||!this.regions_info.hasBeenModified()||(g.Z.showModalMessage("You have unsaved ROI changes. Please Save or Undo before moving to a new plane.","OK"),!1)}get selectedZ(){let e=this.regions_info.image_info,t=[];if(e.projection===p.PO.INTMAX){let i=e.projection_opts;for(let e=i.start;e<=i.end;e++)t.push(e)}else t.push(e.dimensions.z);return t}toInt(e){return parseInt(e)}slice(e,t,i){return e.slice(t,i)}ceil(e){return Math.ceil(e)}}).prototype,"regions_info",[d.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h=_(a.prototype,"selected_roi_tab",[d.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_(a.prototype,"selectedZ",[o],Object.getOwnPropertyDescriptor(a.prototype,"selectedZ"),a.prototype),r=a))||r)||r)},"regions/regions":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n,s,o,r,a=i(4997),l=i(9202),h=i(5222),d=i(7674),c=i(7610),g=i("aurelia-framework"),p=i(1010);let u=(0,g.customElement)("regions")(n=(0,g.inject)(a.Z)((r=class{constructor(e){!function(e,t,i,n){i&&Object.defineProperty(e,"regions_info",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.key_actions=[{key:"S",func:this.saveShapes},{key:"Y",func:this.redoHistory},{key:"Z",func:this.undoHistory}],this.ROI_TABS=d.zp,this.selected_roi_tab=d.zp.ROI_TABLE,this.show_roi_link=!1,this.context=e}attached(){h.Z.registerKeyHandlers(this.context,this.key_actions,d.G7.ROIS,this),p("#regions-tabs").find("a").click((e=>{e.preventDefault(),this.selected_roi_tab=e.currentTarget.hash.substring(1)}))}detached(){this.key_actions.map((e=>this.context.removeKeyListener(e.key,d.G7.ROIS)))}saveShapes(){l.Z.useJsonp(this.context.server)?alert("Saving the regions will not work cross-domain!"):this.regions_info.ready&&this.context.publish(c.q0,{config_id:this.regions_info.image_info.config_id})}showComments(e){return e.stopPropagation(),e.preventDefault(),!!this.regions_info.ready&&(this.regions_info.show_comments=e.target.checked,this.context.publish(c.bX,{config_id:this.regions_info.image_info.config_id,value:this.regions_info.show_comments}),!1)}undoHistory(){this.regions_info.ready&&this.regions_info.history.undoHistory()}redoHistory(){this.regions_info.ready&&this.regions_info.history.redoHistory()}toggleShowRoiLink(){this.show_roi_link=!this.show_roi_link,this.show_roi_link&&setTimeout((()=>{document.getElementById("roi_link_input").select()}),0)}getRoisLink(e){if(!e||0===e.length)return"No shapes selected";let t=e[0].split(":")[1];return t<0?"Can't link to unsaved ROIs":window.location.origin+this.context.getPrefixedURI(d.$R)+"?shape="+t}},f=(s=r).prototype,_="regions_info",m=[g.bindable],v={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},y={},Object.keys(v).forEach((function(e){y[e]=v[e]})),y.enumerable=!!y.enumerable,y.configurable=!!y.configurable,("value"in y||y.initializer)&&(y.writable=!0),void 0===(y=m.slice().reverse().reduce((function(e,t){return t(f,_,e)||e}),y)).initializer&&(Object.defineProperty(f,_,y),y=null),o=y,n=s))||n)||n;var f,_,m,v,y},"regions/sort":(e,t,i)=>{"use strict";i.r(t),i.d(t,{SortValueConverter:()=>n});class n{toView(e,t,i){if(!e)return new Map;let n=Array.from(e.keys()).map((t=>Object.assign(e.get(t),{id:t}))),s=e=>e.id,o=e=>t=>{if(!t.shapes)return-1;let i;for(let n of t.shapes.values()){i=n[e];break}return-1!==i?i:void 0};"shapeText"===t?s=e=>{if(!e.shapes)return"";let t="";for(let i of e.shapes.values())if(i.Text&&i.Text.length>0){t=i.Text;break}return t.toLowerCase()}:"theZ"===t?s=o("TheZ"):"theT"===t?s=o("TheT"):"area"===t?s=o("Area"):"length"===t&&(s=o("Length"));let r=n.sort(((e,t)=>{let n=s(e),o=s(t);return n||0===n?o||0===o?n>o?i?1:-1:n<o?i?-1:1:0:i?-1:1:i?1:-1}));return new Map(r.map((e=>[e.id,e])))}}},"settings/channel-range-advanced":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var n,s,o,r,a,l,h,d=i(4997),c=(i(9202),i("utils/converters"),i("aurelia-framework")),g=(i(6566),i(432),i(1010));function p(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function u(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let f=(0,c.customElement)("channel-range-advanced")(n=(0,c.inject)(d.Z,Element,c.BindingEngine)((o=u((s=class{revisionChanged(e,t){this.context.getSelectedImageConfig().image_info.initial_values=!0,this.updateUI()}constructor(e,t,i,n){p(this,"channel",o,this),p(this,"index",r,this),p(this,"mode",a,this),p(this,"families",l,this),p(this,"revision",h,this),this.GAMMA_MIN_MAX=[0,4],this.context=e,this.element=t,this.bindingEngine=i}bind(){this.updateUI()}detached(){try{g(this.element).find(".gamma-input").off(),g(this.element).find(".gamma-input").spinner("destroy"),g(this.element).find(".gamma-slider").slider("destroy")}catch(e){}}updateUI(){this.detached(),this.context.getSelectedImageConfig().image_info;let e=g(this.element).find(".gamma-input");e.spinner({min:this.GAMMA_MIN_MAX[0],max:this.GAMMA_MIN_MAX[1],step:.1});let t=g(e).parent().find("a.ui-spinner-button");t.css("display","none"),e.on("focus",(e=>t.css("display","block"))),e.on("blur",(e=>{t.css("display","none"),this.onGammaChange(e.target.value)})),e.on("spinstop",(e=>{"number"==typeof e.keyCode&&13!==e.keyCode||this.onGammaChange(e.target.value)})),e.spinner("value",this.channel.coefficient),g(this.element).find(".gamma-slider").slider({min:this.GAMMA_MIN_MAX[0],max:this.GAMMA_MIN_MAX[1],step:.1,value:this.channel.coefficient,change:(e,t)=>{e.originalEvent&&this.onGammaChange(t.value)},slide:(t,i)=>{e.spinner("value",i.value)}})}onGammaChange(e){let t=g(this.element).find(".gamma-input");if("number"!=typeof e&&"string"!=typeof e)return void t.parent().css("border-color","rgb(255,0,0)");t.parent().css("border-color","rgb(170,170,170)");let i=this.channel.coefficient;if("string"==typeof e){if(0===(e=e.replace(/\s/g,"")).length&&replace_empty_value)return void t.spinner("value",i);if(e=parseFloat(e),isNaN(e))return void t.parent().css("border-color","rgb(255,0,0)")}let n=this.GAMMA_MIN_MAX[0],s=this.GAMMA_MIN_MAX[1],o=!1;if(e<n&&(e=n,o=!0),e>s&&(e=s,o=!0),o)t.parent().css("border-color","rgb(255,0,0)");else{if(i===e)return;this.channel.coefficient=e;try{t.spinner("value",e),g(this.element).find(".gamma-slider").slider("option","value",e),this.context.getSelectedImageConfig().addHistory({prop:["image_info","channels",""+this.index,"coefficient"],old_val:i,new_val:e,type:"number"})}catch(e){}}}onFamilyChange(e){let t=this.channel.family;e!==t&&(this.channel.family=e,this.context.getSelectedImageConfig().addHistory({prop:["image_info","channels",""+this.index,"family"],old_val:t,new_val:e,type:"string"}))}hideAdvancedSettings(){this.channel.show_advanced_settings=!1}}).prototype,"channel",[c.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r=u(s.prototype,"index",[c.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a=u(s.prototype,"mode",[c.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l=u(s.prototype,"families",[c.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h=u(s.prototype,"revision",[c.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n=s))||n)||n},"settings/channel-range":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var n,s,o,r,a,l,h=i(4997),d=i(9202),c=i(7674),g=i(7610),p=i("aurelia-framework"),u=(i(6566),i(432),i(5686),i(1010));function f(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function _(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let m=(0,p.customElement)("channel-range")(n=(0,p.inject)(h.Z,Element,p.BindingEngine)((o=_((s=class{revisionChanged(e,t){this.context.getSelectedImageConfig().image_info.initial_values=!0,this.updateUI()}constructor(e,t,i,n){f(this,"channel",o,this),f(this,"index",r,this),f(this,"mode",a,this),this.full_range_min_max=null,this.min_max_range=null,f(this,"revision",l,this),this.context=e,this.element=t,this.bindingEngine=i}bind(){this.updateUI()}detached(){try{u(this.element).find(".channel-start").off(),u(this.element).find(".channel-start").spinner("destroy"),u(this.element).find(".channel-end").off(),u(this.element).find(".channel-end").spinner("destroy"),u(this.element).find(".channel-slider").slider("destroy"),u(this.element).find(".spectrum-input").spectrum("destroy")}catch(e){}}updateRanges(e){this.full_range_min_max=e.getChannelMinMaxValues(c.lD.FULL_RANGE,this.index,c.Fe),this.min_max_range=e.getChannelMinMaxValues(this.mode,this.index,c.Fe),1!==this.min_max_range.step_size&&(this.channel.window.start=d.Z.roundAtDecimal(this.channel.window.start,c.Fe),this.channel.window.end=d.Z.roundAtDecimal(this.channel.window.end,c.Fe))}updateUI(){this.detached();let e=this.context.getSelectedImageConfig().image_info;this.updateRanges(e);let t=u(this.element).find(".channel-start");t.spinner({min:this.full_range_min_max.start_min,max:this.full_range_min_max.start_max,step:this.min_max_range.step_size});let i=u(t).parent().find("a.ui-spinner-button");i.css("display","none"),t.on("focus",(e=>i.css("display","block"))),t.on("blur",(e=>{i.css("display","none"),this.onRangeChange(e.target.value,!0,!0)})),t.on("spinstop",(e=>{"number"==typeof e.keyCode&&13!==e.keyCode||this.onRangeChange(e.target.value,!0)})),t.spinner("value",this.min_max_range.start_val);let n=u(this.element).find(".channel-slider"),s=this.mode===c.lD.FULL_RANGE?this.full_range_min_max.start_min:this.min_max_range.start_val>this.min_max_range.start_min?this.min_max_range.start_min:this.min_max_range.start_val,o=this.mode===c.lD.FULL_RANGE?this.full_range_min_max.end_max:this.min_max_range.end_val<this.min_max_range.end_max?this.min_max_range.end_max:this.min_max_range.end_val;1!==this.min_max_range.step_size&&(o=this.adjustCalculatedMax(s,o)),n.slider({min:s,max:o,step:this.min_max_range.step_size,range:!0,values:[this.min_max_range.start_val,this.min_max_range.end_val],change:(e,t)=>{this.lastUpdate&&(clearTimeout(this.lastUpdate),this.lastUpdate=null),this.onRangeChangeBoth(t,!!e.originalEvent)},slide:(e,t)=>{if(t.values[0]>=t.values[1])return!1;t.value===t.values[0]&&u(this.element).find(".channel-start").spinner("value",t.values[0]),t.value===t.values[1]&&u(this.element).find(".channel-end").spinner("value",t.values[1]);let i=this.context.getSelectedImageConfig();if(i.image_info.tiled)return!0;this.lastDelayedTimeout=(new Date).getTime();let n=(()=>{(new Date).getTime()<this.lastDelayedTimeout||this.context.publish(g.gO,{config_id:i.id,prop:"start",channel:this.index,start:t.values[0],end:t.values[1]})}).bind(this);this.lastUpdate=setTimeout(n,100)}}),n.css("background","white");let r=this.context.hasLookupTableEntry(this.channel.color);this.setBackgroundAfterColorChange(r);let a=u(this.element).find(".channel-end");a.spinner({min:this.full_range_min_max.end_min,max:this.full_range_min_max.end_max,step:this.min_max_range.step_size});let l=u(a).parent().find("a.ui-spinner-button");l.css("display","none"),a.on("focus",(e=>l.css("display","block"))),a.on("blur",(e=>{l.css("display","none"),this.onRangeChange(e.target.value,!1,!0)})),a.on("spinstop",(e=>{"number"==typeof e.keyCode&&13!==e.keyCode||this.onRangeChange(e.target.value)})),a.spinner("value",this.min_max_range.end_val),u(this.element).find(".spectrum-input").spectrum({color:r?"#fff":"#"+this.channel.color,showInput:!0,containerClassName:"color-range-spectrum-container",replacerClassName:"color-range-replacer",showInitial:!0,preferredFormat:"hex",appendTo:u(this.element).find(".channel-color"),change:e=>this.onColorChange(e.toHexString())})}adjustCalculatedMax(e,t){return e+Math.round((t-e)/this.min_max_range.step_size)*this.min_max_range.step_size>t?t+this.min_max_range.step_size:t}onColorChange(e){let t=this.context.getSelectedImageConfig(),i=this.context.hasLookupTableEntry(e),n=this.channel.color;this.channel.color=i?e:e.substring(1),this.setBackgroundAfterColorChange(i),u(this.element).find(".spectrum-input").spectrum("set",i?"#fff":e),t.addHistory({prop:["image_info","channels",""+this.index,"color"],old_val:n,new_val:this.channel.color,type:"string"})}onInvertedToggle(){let e=this.channel.inverted;this.context.getSelectedImageConfig().addHistory({prop:["image_info","channels",""+this.index,"inverted"],old_val:!e,new_val:e,type:"boolean"}),this.updateUI()}setBackgroundAfterColorChange(e){let t=e=>{let t=e.prop("style");t&&(t.removeProperty("background-color"),t.removeProperty("background-image"),t.removeProperty("background-size"),t.removeProperty("background-position"),t.removeProperty("background-repeat"),t.removeProperty("transform"))},i={};this.channel.inverted&&(i.transform="scaleX(-1)");let n=u(this.element).find(".channel-slider").find(".ui-slider-range");if(e){let e=this.context.luts.get(this.channel.color).index;-1===e?(t(n),n.addClass("gradient-png")):(n.removeClass("gradient-png"),i["background-image"]="url('"+this.context.luts_png.url+"')",i["background-size"]="100% "+3*this.context.luts_png.height+"px",i["background-position"]="0px -"+(30*e+1)+"px",i["background-repeat"]="no-repeat")}else t(n),n.addClass("gradient-png"),i["background-color"]="#"+this.channel.color;n.css(i);let s=u(this.element).find(".channel");t(s),delete i.transform,s.css(i)}onRangeChangeBoth(e,t=!1){let i=e.values;t&&d.Z.isArray(i)&&(1!==this.min_max_range.step_size&&(i[0]=d.Z.roundAtDecimal(i[0],c.Fe),i[1]=d.Z.roundAtDecimal(i[1],c.Fe)),e.value===e.values[0]?(i[0]>=i[1]&&(i[0]=i[1]-this.min_max_range.step_size),this.onRangeChange(i[0],!0)):(i[1]<=i[0]&&(i[1]=i[0]+this.min_max_range.step_size),this.onRangeChange(i[1],!1)))}onRangeChange(e,t=!1,i=!1){let n=t?".channel-start":".channel-end",s=t?this.channel.window.start:this.channel.window.end;if("number"!=typeof e&&"string"!=typeof e)return;if("string"==typeof e){if(u(this.element).children("span").css("border-color","rgb(170,170,170)"),0===(e=e.replace(/\s/g,"")).length&&i)return void u(this.element).find(n).spinner("value",s);if(e=parseFloat(e),isNaN(e))return void u(this.element).find(n).parent().css("border-color","rgb(255,0,0)");1!==this.min_max_range.step_size&&(e=d.Z.roundAtDecimal(e,c.Fe))}let o=t?this.full_range_min_max.start_min:this.full_range_min_max.end_min,r=t?this.full_range_min_max.start_max:this.full_range_min_max.end_max,a=t?this.min_max_range.start_min:this.min_max_range.end_min,l=t?this.min_max_range.start_max:this.min_max_range.end_max;t||1===this.min_max_range.step_size||(l=this.adjustCalculatedMax(a,l));let h=!1;if(e<o&&(e=o,h=!0),e>r&&(e=r,h=!0),h)u(this.element).find(n).parent().css("border-color","rgb(255,0,0)");else{let i=t?".channel-end":".channel-start";if(u(this.element).children("span").css("border-color","rgb(170,170,170)"),s===e)return;t?this.channel.window.start=e:this.channel.window.end=e;try{u(this.element).find(n).spinner("value",e),u(this.element).find(".channel-slider").slider("option","values",[this.channel.window.start,this.channel.window.end]),t?(u(this.element).find(i).spinner("option","min",e+this.min_max_range.step_size),u(this.element).find(".channel-slider").slider("option","min",e<a?e:a)):(u(this.element).find(i).spinner("option","max",e-this.min_max_range.step_size),u(this.element).find(".channel-slider").slider("option","max",e>l?e:l));let o=this.context.getSelectedImageConfig();o.addHistory({prop:["image_info","channels",""+this.index,"window",t?"start":"end"],old_val:s,new_val:e,type:"number"}),this.updateRanges(o.image_info)}catch(e){}}}hideColorPicker(){u(this.element).find(".spectrum-input").spectrum("hide")}toggleChannel(){let e=this.context.getSelectedImageConfig();if("greyscale"===e.image_info.model&&this.channel.active)return;let t=[];if(this.channel.active=!this.channel.active,t.push({prop:["image_info","channels",""+this.index,"active"],old_val:!this.channel.active,new_val:this.channel.active,type:"boolean"}),"greyscale"===e.image_info.model){let i=e.image_info.channels;for(let e=0;e<i.length;e++){let n=i[e];e!==this.index&&n.active&&(n.active=!1,t.push({prop:["image_info","channels",""+e,"active"],old_val:!0,new_val:!1,type:"boolean"}))}}e.addHistory(t)}showAdvancedSettings(){this.channel.show_advanced_settings=!0}}).prototype,"channel",[p.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r=_(s.prototype,"index",[p.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a=_(s.prototype,"mode",[p.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l=_(s.prototype,"revision",[p.bindable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n=s))||n)||n},"settings/channel-settings":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var n,s,o,r,a=i(4997),l=(i(9202),i("aurelia-framework")),h=i(7674),d=i(7610);let c=(0,l.customElement)("channel-settings")(n=(0,l.inject)(a.Z,l.BindingEngine)((r=class extends d.nb{image_configChanged(e,t){this.waitForImageInfoReady()}constructor(e,t){super(e.eventbus),function(e,t,i,n){i&&Object.defineProperty(e,"image_config",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.sub_list=[[d.FQ,(e={})=>{"number"==typeof e.config_id&&e.config_id===this.image_config.id&&this.waitForImageInfoReady()}]],this.mode=h.lD.MIN_MAX,this.old_mode=null,this.enable_mode_history=!0,this.observers=[],this.image_info_ready_observer=null,this.observedProperties=[{obj:null,prop:"active"},{obj:null,prop:"color"},{obj:null,prop:"inverted"},{obj:null,prop:"family"},{obj:null,prop:"coefficient"},{obj:"window",prop:"start"},{obj:"window",prop:"end"}],this.context=e,this.bindingEngine=t}bind(){this.subscribe(),this.waitForImageInfoReady()}waitForImageInfoReady(){if(null===this.image_config||null===this.image_config.image_info)return;let e=()=>{this.mode!==h.lD.MIN_MAX&&(this.enable_mode_history=!1,this.mode=h.lD.MIN_MAX),this.registerObservers()};this.unregisterObservers(),this.image_config.image_info.ready?e():null===this.image_info_ready_observer&&(this.image_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((t,i)=>e())))}unregisterObservers(e=!1){this.observers.map((e=>{e&&e.dispose()})),this.observers=[],e||this.image_info_ready_observer&&(this.image_info_ready_observer.dispose(),this.image_info_ready_observer=null)}registerObservers(){let e=this.image_config.image_info;for(let t=0;t<e.channels.length;t++)for(let i=0;i<this.observedProperties.length;i++){let n=this.observedProperties[i];((t,i,n)=>{this.observers.push(this.bindingEngine.propertyObserver(i?e.channels[t][i]:e.channels[t],n).subscribe(((e,i)=>this.propagateChannelChanges(t,n))))})(t,n.obj,n.prop)}this.observers.push(this.bindingEngine.propertyObserver(this,"mode").subscribe(((e,t)=>this.takeHistorySnapshot(e,t))))}takeHistorySnapshot(e,t){if(null===e)return;if(null===t&&(t=e),!this.enable_mode_history)return void(this.enable_mode_history=!0);let i=this.image_config,n=i.image_info,s=()=>{let s=[];for(let t=0;t<n.channels.length;t++)this.takeChannelSnapshot(e,t,s);if(this.enable_mode_history&&e!==t){let i=[];i.push({prop:["image_info","initial_values"],old_val:!0,new_val:!0,type:"boolean"}),i.push({scope:this,prop:["enable_mode_history"],old_val:!1,new_val:!1,type:"boolean"}),i.push({scope:this,prop:["mode"],old_val:t,new_val:e,type:"number"}),s=i.concat(s)}i.addHistory(s),i.changed()};e===h.lD.IMPORTED?n.requestImportedData(s):s()}takeChannelSnapshot(e,t,i){let n=this.image_config.image_info,s=n.getChannelMinMaxValues(e,t),o=n.channels[t];if(o.window.start!==s.start_val&&(i.push({prop:["image_info","channels",""+t,"window","start"],old_val:o.window.start,new_val:s.start_val,type:"number"}),o.window.start=s.start_val),o.window.end!==s.end_val&&(i.push({prop:["image_info","channels",""+t,"window","end"],old_val:o.window.end,new_val:s.end_val,type:"number"}),o.window.end=s.end_val),e===h.lD.IMPORTED){let e=n.imported_settings;o.color!==e.c[t].color&&(i.push({prop:["image_info","channels",""+t,"color"],old_val:o.color,new_val:e.c[t].color,type:"string"}),o.color=e.c[t].color),void 0===e.c[t].inverted&&(e.c[t].inverted=null),o.inverted!==e.c[t].inverted&&(i.push({prop:["image_info","channels",""+t,"inverted"],old_val:o.inverted,new_val:e.c[t].inverted,type:"boolean"}),o.inverted=e.c[t].inverted),"string"!=typeof e.c[t].family||""===e.c[t].family||"number"!=typeof e.c[t].coefficient||isNaN(e.c[t].coefficient)||(o.family!==e.c[t].family&&(i.push({prop:["image_info","channels",""+t,"family"],old_val:o.family,new_val:e.c[t].family,type:"string"}),o.family=e.c[t].family),o.coefficient!==e.c[t].coefficient&&(i.push({prop:["image_info","channels",""+t,"coefficient"],old_val:o.coefficient,new_val:e.c[t].coefficient,type:"number"}),o.coefficient=e.c[t].coefficient)),o.active!==e.c[t].active&&(i.push({prop:["image_info","channels",""+t,"active"],old_val:o.active,new_val:e.c[t].active,type:"boolean"}),o.active=e.c[t].active),n.dimensions.t!==e.t&&(i.push({prop:["image_info","dimensions","t"],old_val:n.dimensions.t,new_val:e.t,type:"number"}),n.dimensions.t=e.t),n.dimensions.z!==e.z&&(i.push({prop:["image_info","dimensions","z"],old_val:n.dimensions.z,new_val:e.z,type:"number"}),n.dimensions.z=e.z),n.model!==e.m&&(i.push({prop:["image_info","model"],old_val:n.model,new_val:e.m,type:"string"}),n.model=e.m),n.projection!==e.p&&(i.push({prop:["image_info","projection"],old_val:n.projection,new_val:e.p,type:"string"}),n.projection=e.p)}}onModeChange(e){let t=!1;"object"==typeof e&&null!==e&&"number"==typeof e.mode&&(e.fullrange,1)?(e=parseInt(e.mode),t=!0):e=parseInt(e),"number"!=typeof e||e<0||e>2||(this.old_mode=this.mode,this.mode=e,t||(this.image_config.image_info.initial_values=!1),this.old_mode===this.mode&&(this.mode=null,setTimeout((()=>this.mode=e),0)))}propagateChannelChanges(e,t){let i=this.image_config.image_info.channels[e],n={config_id:this.image_config.id,sync_group:this.image_config.sync_group,prop:t,ranges:[{index:e,start:i.window.start,end:i.window.end,color:i.color,active:i.active,inverted:i.inverted}]};"string"!=typeof i.family||""===i.family||"number"!=typeof i.coefficient||isNaN(i.coefficient)||(n.ranges[0].family=i.family,n.ranges[0].coefficient=i.coefficient),this.context.publish(d.h6,n)}unbind(){this.unsubscribe(),this.unregisterObservers()}},g=(s=r).prototype,p="image_config",u=[l.bindable],f={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},_={},Object.keys(f).forEach((function(e){_[e]=f[e]})),_.enumerable=!!_.enumerable,_.configurable=!!_.configurable,("value"in _||_.initializer)&&(_.writable=!0),void 0===(_=u.slice().reverse().reduce((function(e,t){return t(g,p,e)||e}),_)).initializer&&(Object.defineProperty(g,p,_),_=null),o=_,n=s))||n)||n;var g,p,u,f,_},"settings/settings":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n,s=i(4997),o=i(9202),r=i("aurelia-framework"),a=i(7674),l=i(8546),h=i(7610),d=i(5857),c=i(1010);let g=(0,r.noView)(n=class extends h.nb{constructor(e=null,t=".histogram"){if(super(e?e.context.eventbus:null),this.image_info=null,this.visible=!1,this.data_cache=new Map,this.sub_list=[[h.h6,(e={})=>this.handleSettingsChanges(e)],[h.Fs,(e={})=>this.handleSettingsChanges(e)],[h.gO,(e={})=>this.handleSettingsChanges(e)]],this.graph_dims=[300,125],this.graph_cols=256,this.graph_svg=null,this.last_active_channel=-1,!(e instanceof l.Z)||0===c(t).length)return;this.image_info=e,this.selector=t;let i=c(this.selector);this.graph_dims[0]=i.width(),this.graph_dims[1]=i.height(),this.image_info.tiled||(this.subscribe(),this.createHistogramSVG())}createHistogramSVG(){d.Ys(c(this.selector+" svg").get(0)).remove(),this.graph_svg=d.Ys(c(this.selector).get(0)).append("svg").attr("width",this.graph_dims[0]+1).attr("height",this.graph_dims[1]).append("g"),this.graph_svg.append("g").append("path").attr("class","histogram-line"),this.graph_svg.append("path").attr("class","histogram-area").attr("opacity",.5),this.graph_svg.selectAll("rect").data([0,0]).enter().append("rect").attr("y",0).attr("height",300).attr("width",1).attr("x",((e,t)=>e*(this.graph_dims[1]/2)))}handleSettingsChanges(e={}){if(null===this.image_info||"number"==typeof e.config_id&&e.config_id!==this.image_info.config_id)return;let t="string"==typeof e.prop?e.prop:null,i="number"==typeof e.channel?e.channel:o.Z.isArray(e.ranges)?e.ranges[0].index:this.last_active_channel;if(-1===i||t&&"active"===t&&!e.ranges[0].active)for(let e in this.image_info.channels)if(this.image_info.channels[e].active){i=parseInt(e);break}null===t||"active"===t||"color"===t||i!==this.last_active_channel?this.plotHistogram(i):"number"==typeof e.channel&&"number"==typeof e.start&&"number"==typeof e.end&&e.channel===this.last_active_channel?this.plotHistogramLines(e.channel,e.start,e.end):this.plotHistogramLines(i),this.last_active_channel=i}plotHistogram(e){if(!this.visible||"number"!=typeof e||"object"!=typeof this.image_info.channels[e])return;let t="#"+this.image_info.channels[e].color;"#FFFFFF"===t&&(t="#000000");let i=i=>{this.graph_cols=i.length;let n=d.BYU().domain([0,i.length-1]).range([0,this.graph_dims[0]]),s=d.BYU().domain([d.VV$(i),d.Fp7(i)]).range([this.graph_dims[1],0]),o=d.jvg().x(((e,t)=>n(t))).y(((e,t)=>s(e)));this.graph_svg.selectAll(".histogram-line").datum(i).attr("d",o).attr("stroke",t);let r=d.SOn().x(((e,t)=>n(t))).y0(this.graph_dims[1]).y1((e=>s(e)));this.graph_svg.selectAll(".histogram-area").datum(i).attr("class","histogram-area").attr("d",r).attr("fill",t),this.plotHistogramLines(e)},n=this.image_info.dimensions.t,s=this.image_info.dimensions.z,o=e+"/"+s+"/"+n,r=this.data_cache.get(o);r?i(r):this.requestHistogramJson(e,i)}plotHistogramLines(e,t,i){if(!this.visible||"object"!=typeof this.image_info.channels[e])return;let n=this.image_info.channels[e],s="#"+n.color;"#FFFFFF"===s&&(s="#000000"),"number"!=typeof t&&(t=n.window.start),"number"!=typeof i&&(i=n.window.end);let o=n.window.max-n.window.min,r=(t-n.window.min)/o*this.graph_cols,a=(i-n.window.min)/o*this.graph_cols;this.graph_svg.selectAll("rect").data([r,a]).attr("x",((e,t)=>e*(this.graph_dims[0]/this.graph_cols))).attr("fill",s)}toggleHistogramVisibilty(e=!1){if(!this.image_info.tiled&&"boolean"==typeof e)return e?(this.visible||(this.visible=!0,this.handleSettingsChanges()),c(this.selector).show()):(c(this.selector).hide(),this.visible=!1),this.visible}requestHistogramJson(e=0,t=null){if(o.Z.isArray(this.image_info.channels)&&("number"!=typeof e||e<0||e>this.image_info.channels.length||"function"!=typeof t))return;let i=this.image_info.context.server,n=this.image_info.context.getPrefixedURI(a.YH),s=this.image_info.dimensions.t,r=this.image_info.dimensions.z,l=i+n+"/histogram_json/"+this.image_info.image_id+"/channel/"+e+"/?theT="+s+"&theZ="+r;c.ajax({url:l,success:i=>{let n="object"==typeof i&&o.Z.isArray(i.data)?i.data:null;n&&this.data_cache.set(e+"/"+r+"/"+s,n),t(n)},error:()=>t(null)})}destroyHistogram(){d.Ys(c(this.selector+" svg").get(0)).remove(),this.unsubscribe(),this.image_info=null}})||n;var p,u,f,_,m=i(5222),v=i(1010);let y=(0,r.customElement)("settings")(p=(0,r.inject)(s.Z,r.BindingEngine)((_=class extends h.nb{image_configChanged(e,t){this.waitForImageInfoReady()}constructor(e,t){super(e.eventbus),function(e,t,i,n){i&&Object.defineProperty(e,"image_config",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,f,this),this.key_actions=[{key:"S",func:this.saveImageSettings},{key:"Y",func:this.redo},{key:"Z",func:this.undo},{key:"C",func:this.copy},{key:"V",func:this.paste}],this.revision=null,this.rdefs=null,this.histogram=null,this.observer=null,this.image_info_ready_observer=null,this.sub_list=[[h.gw,(e={})=>this.revision++],[h.w3,(e={})=>this.saveImageSettings()]],this.context=e,this.bindingEngine=t}bind(){this.waitForImageInfoReady()}waitForImageInfoReady(){if(null===this.image_config||null===this.image_config.image_info)return;let e=()=>{this.registerObserver(),this.subscribe(),this.requestAllRenderingDefs(),this.histogram&&this.histogram.destroyHistogram(),this.histogram=new g(this.image_config.image_info),this.image_config.show_histogram&&this.histogram.toggleHistogramVisibilty(!0)};this.unregisterObservers(),this.unsubscribe(),this.image_config.image_info.ready?e():null===this.image_info_ready_observer&&(this.image_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((t,i)=>e())))}attached(){m.Z.registerKeyHandlers(this.context,this.key_actions,a.G7.SETTINGS,this)}requestAllRenderingDefs(e){if(!this.image_config.image_info.ready)return;let t=this.image_config.image_info.image_id;v.ajax({url:this.context.server+this.context.getPrefixedURI(a.YH)+"/get_image_rdefs_json/"+t+"/",success:i=>{if(!o.Z.isArray(i.rdefs)||t!==this.image_config.image_info.image_id)return;let n=new Map;for(let e in i.rdefs){let t=i.rdefs[e],s=n.get(t.owner.id);if(s){if(!(s.id<t.id))continue;n.set(t.owner.id,t)}else n.set(t.owner.id,t)}this.rdefs=[];for(let[e,t]of n)t.c.map((e=>{"string"==typeof e.lut&&e.lut.length>0&&(e.color=e.lut)})),this.rdefs.push(t);"function"==typeof e&&e()},error:()=>{"function"==typeof e&&e()}})}getRdefThumbUrl(){if(null===this.image_config||null===this.image_config.image_info)return;let e=this.image_config.image_info.image_id;return this.context.server+this.context.getPrefixedURI(a.YH)+"/render_thumbnail/"+e}toggleHistogram(e){return e.stopPropagation(),e.preventDefault(),this.histogram&&(this.image_config.show_histogram=this.histogram.toggleHistogramVisibilty(e.target.checked)),!1}onModelChange(e){let t=[];if(e){let e=this.image_config.image_info.channels,i=-1,n=(e,i,n)=>{e.active=n,t.push({prop:["image_info","channels",""+i,"active"],old_val:!n,new_val:n,type:"boolean"})};for(let t=0;t<e.length;t++){let s=e[t];i<0&&s.active&&(i=t),t>i&&s.active&&n(s,t,!1)}i<0&&n(e[0],0,!0)}t.push({prop:["image_info","model"],old_val:e?"color":"greyscale",new_val:e?"greyscale":"color",type:"string"}),this.image_config.addHistory(t)}saveImageSettings(){v(".save-settings").children("button").blur(),this.image_config.saveImageSettings((e=>{this.image_config.resetHistory(),this.requestAllRenderingDefs((()=>{let e=this.image_config.image_info.image_id;this.triggerUpdates([e]),this.context.useMDI&&this.context.reloadImageConfigForGivenImage(e,a.Iz.IMAGE,this.image_config.id)}))}))}saveImageSettingsToAll(){if(!this.image_config.image_info.ready)return;let e="Do you want to apply the settings to all Images ";"number"==typeof this.image_config.image_info.dataset_id?e+="in Dataset "+this.image_config.image_info.dataset_id+"?":e+="in the Dataset?",m.Z.showConfirmationDialog("Save Image Settings",e,(()=>this.copy(!0)))}undo(){this.image_config.image_info.ready&&(this.image_config.undoHistory(),this.image_config.changed())}redo(){this.image_config.image_info.ready&&(this.image_config.redoHistory(),this.image_config.changed())}copy(e=!1){if(!this.image_config.image_info.ready)return;if(e&&o.Z.useJsonp(this.context.server))return void m.Z.showModalMessage("Saving to All will not work cross-domain!","OK");let t=this.image_config.image_info,i=this.context.server+this.context.getPrefixedURI(a.YH)+"/copyImgRDef/?";e||(i+="imageId="+t.image_id+"&q=0.9&pixel_range="+t.range[0]+":"+t.range[1]+"&"),i+="m="+t.model[0]+"&p="+t.projection+"&ia=0",i=o.Z.appendChannelsAndMapsToQueryString(t.channels,i);let n={url:i,method:e?"POST":"GET",error:e=>{}};e?(n.data={dataType:"json",toids:t.parent_id,to_type:"dataset",imageId:t.image_id},n.success=e=>{let i=[t.image_id];"object"==typeof e&&null!==e&&o.Z.isArray(e.True)?(i=i.concat(e.True),this.context.clearCachedImageSettings(e.True)):this.context.clearCachedImageSettings(),this.requestAllRenderingDefs((()=>{this.triggerUpdates(i),this.context.useMDI&&this.context.reloadImageConfigsGivenParent(t.parent_id,t.parent_type,t.config_id)}))}):n.success=e=>t.requestImgRDef(),v.ajax(n)}triggerUpdates(e){this.context.publish(h.gw,{config_id:this.image_config.id,ids:e}),this.context.publish(h.FQ,{config_id:this.image_config.id})}applyRenderingSettings(e,t=!0){this.image_config.applyRenderingSettings(e,t)}paste(){this.image_config.image_info.ready&&null!==this.image_config.image_info.copied_img_rdef&&this.image_config.image_info.requestImgRDef(this.applyRenderingSettings.bind(this))}applyUserSetting(e){this.applyRenderingSettings(this.rdefs[e],!1)}registerObserver(){this.observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"model").subscribe(((e,t)=>this.context.publish(h.h6,{config_id:this.image_config.id,sync_group:this.image_config.sync_group,model:e})))}toggleInterpolation(e){return e.preventDefault(),e.stopPropagation(),this.context.interpolate=e.target.checked,this.context.publish(h.h6,{interpolate:this.context.interpolate}),!1}togglePixelIntensity(e){if(null!==this.image_config)return e.preventDefault(),e.stopPropagation(),this.context.publish(h.Md,{config_id:this.image_config.id,flag:e.target.checked}),!1}unregisterObservers(e=!1){this.observer&&(this.observer.dispose(),this.observer=null),e||this.image_info_ready_observer&&(this.image_info_ready_observer.dispose(),this.image_info_ready_observer=null)}detached(){this.key_actions.map((e=>this.context.removeKeyListener(e.key,a.G7.SETTINGS)))}unbind(){this.histogram&&this.histogram.destroyHistogram(),this.unregisterObservers(),this.unsubscribe()}},b=(u=_).prototype,w="image_config",x=[r.bindable],I={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},S={},Object.keys(I).forEach((function(e){S[e]=I[e]})),S.enumerable=!!S.enumerable,S.configurable=!!S.configurable,("value"in S||S.initializer)&&(S.writable=!0),void 0===(S=x.slice().reverse().reduce((function(e,t){return t(b,w,e)||e}),S)).initializer&&(Object.defineProperty(b,w,S),S=null),f=S,p=u))||p)||p;var b,w,x,I,S},7674:(e,t,i)=>{"use strict";i.d(t,{$R:()=>d,DT:()=>a,EW:()=>o,Fe:()=>f,Fp:()=>R,G7:()=>C,HX:()=>u,Iz:()=>O,PO:()=>A,PP:()=>w,Qo:()=>E,TQ:()=>p,VQ:()=>l,XI:()=>s,YH:()=>c,Yj:()=>m,cM:()=>g,fg:()=>h,h6:()=>I,iC:()=>n,kN:()=>x,lD:()=>v,oD:()=>r,pQ:()=>b,pf:()=>S,uo:()=>y,vM:()=>_,x2:()=>P,zp:()=>T}),i("aurelia-framework");const n="iviewer",s="OMERO."+n,o="omero_iviewer",r="WEB_API_BASE",a="/m/datasets",l="/m/rois",h="URI_PREFIX",d="IVIEWER",c="WEBGATEWAY",g="WEBCLIENT",p="PLUGIN_PREFIX",u="ol3_viewer_",f=3,_=[8364,129,8218,402,8222,8230,8224,8225,710,8240,352,8249,338,141,381,143,144,8216,8217,8220,8221,8226,8211,8212,732,8482,353,8250,339,157,382,376,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],m={CHANNELS:"C",CENTER_X:"X",CENTER_Y:"Y",DATASET_ID:"DATASET",INTERPOLATE:"INTERPOLATE",IMAGES:"IMAGES",ROI:"ROI",SHAPE:"SHAPE",MAPS:"MAPS",MODEL:"M",OMERO_VERSION:"OMERO_VERSION",PLANE:"Z",PROJECTION:"P",SERVER:"SERVER",TIME:"T",VERSION:"VERSION",WELL_ID:"WELL",ZOOM:"ZM",ROI_PAGE_SIZE:"ROI_PAGE_SIZE",MAX_PROJECTION_BYTES:"MAX_PROJECTION_BYTES",ROI_COLOR_PALETTE:"ROI_COLOR_PALETTE",SHOW_PALETTE_ONLY:"SHOW_PALETTE_ONLY",ENABLE_MIRROR:"ENABLE_MIRROR",FLIP_X:"FX",FLIP_Y:"FY"},v={MIN_MAX:0,FULL_RANGE:1,IMPORTED:2},y={DEFAULT:0,SELECT:1,TRANSLATE:2,MODIFY:3,DRAW:4},b={PRESENT_Z_AND_T:1,ALL_Z_AND_T:2,ALL_Z:3,ALL_T:4,NEITHER_Z_NOR_T:5,NOT_Z:6,NOT_T:7,CUSTOM_Z_AND_T:8},w={NOT_WATCHED:0,IN_PROGRESS:1,RENDERED:2,ERROR:3},x={CANNOT_EDIT:"No permission to edit",CANNOT_DELETE:"No permission to delete"},I="/img/luts_10.png",S=["16_colors.lut","3-3-2_rgb.lut","5_ramps.lut","6_shades.lut","blue_orange_icb.lut","brgbcmyw.lut","cool.lut","cyan_hot.lut","edges.lut","fire.lut","gem.lut","glasbey.lut","glasbey_inverted.lut","glow.lut","grays.lut","green_fire_blue.lut","hilo.lut","ica.lut","ica2.lut","ica3.lut","ice.lut","magenta_hot.lut","orange_hot.lut","phase.lut","physics.lut","pup_br.lut","pup_nr.lut","rainbow_rgb.lut","red-green.lut","red_hot.lut","royal.lut","sepia.lut","smart.lut","spectrum.lut","thal.lut","thallium.lut","thermal.lut","unionjack.lut","yellow_hot.lut"],C={INFO:"info",SETTINGS:"settings",ROIS:"rois"},T={ROI_PLANE_GRID:"ROI_PLANE_GRID",ROI_TABLE:"ROI_TABLE"},E={NONE:0,IMAGES:1,DATASET:2,WELL:3,ROIS:4,SHAPES:5},A={NORMAL:"normal",INTMAX:"intmax"},R="\r\n",P={ZT:{CHAR:"zt",LABEL:"Z/T"},Z:{CHAR:"z",LABEL:"Z"},T:{CHAR:"t",LABEL:"T"},VIEW:{CHAR:"v",LABEL:"View"},CHANNELS:{CHAR:"c",LABEL:"Channels"}},O={IMAGE:0,REGIONS:1}},"utils/converters":(e,t,i)=>{"use strict";i.r(t),i.d(t,{Converters:()=>h,ImageModelValueConverter:()=>a,SyncGroupValueConverter:()=>l});var n,s,o,r=i("aurelia-framework");i(9202);let a=(0,r.noView)(n=class{toView(e){let t=!0;return"string"==typeof e&&e.length>0&&("color"===e.toLowerCase()||"c"===e[0].toLowerCase())&&(t=!1),t}fromView(e){let t="greyscale";return"boolean"!=typeof e||e||(t="color"),t}})||n,l=(0,r.noView)(s=class{toView(e){let t="group".length;return"string"!=typeof e||e.length<t?"":e.substring(t)}})||s,h=(0,r.noView)(o=class e{static rgbaToSignedInteger(e){if("string"!=typeof e||0===e.length)return null;let t=e.replace(/\(rgba|\(|rgba|rgb|\)/g,"").split(",");if(t.length<3)return null;let i={red:parseInt(t[0]),green:parseInt(t[1]),blue:parseInt(t[2]),alpha:t.length>3?parseFloat(t[3]):1};var n=255*i.alpha,s=n-parseInt(n);return i.alpha=s<=.5?Math.floor(n):Math.ceil(n),i.red<<24|i.green<<16|i.blue<<8|i.alpha}static signedIntegerToRgba(e){if("number"!=typeof e)return null;e<0&&(e>>>=0);let t=e.toString(16);t=("00000000"+t).slice(-8);let i="rgba(";for(let e=0;e<t.length-2;e+=2)i+=parseInt(t.substr(e,2),16)+",";return i+=parseInt(t.substring(6,8),16)/255,i+")"}static extractRoiAndShapeId(e){let t={roi_id:null,shape_id:null};if("string"!=typeof e||e.length<3)return t;let i=e.indexOf(":");if(i<1)return t;let n=parseInt(e.substring(0,i));isNaN(n)||(t.roi_id=n);let s=parseInt(e.substring(i+1));return isNaN(s)||(t.shape_id=s),t}static amendShapeDefinition(t){if("object"!=typeof t||null===t||"string"!=typeof t["@type"])return null;let i=t["@type"].lastIndexOf("#");if(-1===i)return;let n=t["@type"].substring(i+1).toLowerCase();if(t.type=n,"object"==typeof t["omero:details"]&&null!==t["omero:details"]){if("object"==typeof t["omero:details"].permissions&&null!==t["omero:details"].permissions&&(t.permissions=Object.assign({},t["omero:details"].permissions)),"object"==typeof t["omero:details"].owner&&null!==t["omero:details"].owner){let e="string"==typeof t["omero:details"].owner.FirstName?t["omero:details"].owner.FirstName:"",i="string"==typeof t["omero:details"].owner.LastName?t["omero:details"].owner.LastName:"",n="string"==typeof t["omero:details"].owner.UserName?t["omero:details"].owner.UserName:"";t.owner=""===e&&""===i?n:e+" "+i}delete t["omero:details"]}let s=e.extractRoiAndShapeId(t.oldId);return null!==s.shape_id&&(t.shape_id=t.oldId,t["@id"]=s.shape_id),["TheZ","TheT","TheC"].map((e=>{"number"!=typeof t[e]&&(t[e]=-1)})),"number"!=typeof t.Length&&(t.Length=-1),"number"!=typeof t.Area&&(t.Area=-1),t}static convertHexColorToRGB(e){if("string"!=typeof e)return null;let t=e.length;if(4!==t&&7!==t||(e=e.substring(1),t--),3!==t&&6!==t)return null;let i=t/3,n=[];for(let s=0;s<t;s+=i){let t=parseInt(e.substring(s,s+i),16);if(isNaN(t))return null;n.push(t)}return n}})||o},9202:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var n,s=i("aurelia-framework"),o=i(7674),r=i(1010);let a=(0,s.noView)(n=class e{static isArray(e){return"object"==typeof e&&null!==e&&(e instanceof Array||"[object Array]"===Object.prototype.toString.call(null,e))}static useJsonp(e=""){return!1}static pruneUrlToLastDash(e){if("string"!=typeof e||e.length<1)return"";let t=e.lastIndexOf("/");return t<0?e:e.substring(0,t)}static getCookie(e=""){let t=null;if(document.cookie&&""!=document.cookie){let i=document.cookie.split(";");for(let n=0;n<i.length;n++){let s=r.trim(i[n]);if(s.substring(0,e.length+1)==e+"="){t=decodeURIComponent(s.substring(e.length+1));break}}}return t}static prepareURI(e){if("string"==typeof e&&e.length>1){let t=e.length-1;for(;t>0&&"/"===e[t];)e=e.substring(0,t),t--;"/"!==e[0]&&(e="/"+e)}return e}static parseChannelParameters(t="",i=""){if("string"!=typeof t||0===t.length)return null;let n=[],s=(t=t.replace(/\s/g,"")).split(",");if(0===s.length)return null;for(let e in s){let t=s[e],i=t.indexOf("|");if(-1===i)continue;let o=parseInt(t.substring(0,i));if(isNaN(o))continue;let r={index:o<0?-o-1:o-1,active:!(o<0)};if(t=t.substring(i+1),i=t.indexOf("$"),-1===i)continue;let a=t.substring(0,i).split(":");if(2!==a.length)continue;let l=parseFloat(a[0]),h=parseFloat(a[1]);isNaN(l)||isNaN(h)||(r.start=l,r.end=h,t=t.substring(i+1),r.color=t,n.push(r))}if(e.isArray(i))return e.integrateMapsInfoIntoChannels(n,i);if("string"!=typeof i||0===i.length)return n;try{return i=i.replace(/&quot;/g,'"'),e.integrateMapsInfoIntoChannels(n,JSON.parse(i))}catch(e){console.error("Error parsing maps json")}return n}static parseProjectionParameter(e){let t={projection:o.PO.NORMAL};if("string"!=typeof e||0===e.length)return t;let i=e.indexOf("|");if(-1!==i){t.projection=e.substring(0,i);let n=e.substring(i+1).split(":");2===n.length&&(t.start=parseInt(n[0]),t.end=parseInt(n[1]))}else t.projection=e;return t.projection!==o.PO.NORMAL&&t.projection!==o.PO.INTMAX&&(t.projection=o.PO.NORMAL),t}static integrateMapsInfoIntoChannels(t,i){if(!e.isArray(t)||!e.isArray(i)||0===t.length||0===i.length)return t;let n=t.length;for(let e=0;e<n&&e<i.length;e++){let n=i[e];"object"==typeof n&&null!==n&&(t[e].inverted="object"==typeof n.inverted&&n.inverted&&"boolean"==typeof n.inverted.enabled&&n.inverted.enabled,"object"!=typeof n.quantization||null===n.quantization||"string"!=typeof n.quantization.family||""===n.quantization.family||"number"!=typeof n.quantization.coefficient||isNaN(n.quantization.coefficient)||(t[e].family=n.quantization.family,t[e].coefficient=n.quantization.coefficient))}return t}static appendChannelsAndMapsToQueryString(t,i){if("string"!=typeof i)return i;if(!e.isArray(t)||0===t.length)return i;let n=i[i.length-1];i+=("?"!==n&&"&"!==n?"&":"")+"c=";let s=0,o=[];return t.map((e=>{i+=(0!==s?",":"")+(e.active?"":"-")+ ++s+"|"+e.window.start+":"+e.window.end+"$"+e.color;let t={inverted:{enabled:"boolean"==typeof e.inverted&&e.inverted}};"string"!=typeof e.family||""===e.family||"number"!=typeof e.coefficient||isNaN(e.coefficient)||(t.quantization={family:e.family,coefficient:e.coefficient}),o.push(t)})),i+"&maps="+JSON.stringify(o)}static assembleImageLink(t="",i,n,s={}){if("string"!=typeof t||0===t.length){let e=null;if(window&&window.location&&window.location.protocol&&(e=window.location.protocol+"//"),t="",window&&window.location&&window.location.hostname){let i=window.location.hostname;t="localhost"!==i&&"127.0.0.1"!==i?e+i:i}}let o=t+i+"/img_detail/"+n+"/?";return o=e.appendChannelsAndMapsToQueryString(s.channels,o),"number"==typeof s.plane&&(o+="&z="+(s.plane+1)),"number"==typeof s.time&&(o+="&t="+(s.time+1)),"string"==typeof s.projection&&(o+="&p="+s.projection),"string"==typeof s.model&&(o+="&m="+s.model),"number"==typeof s.resolution&&(o+="&zm="+parseInt(1/s.resolution*100)),e.isArray(s.center)&&(o+="&x="+s.center[0]+"&y="+s.center[1]),o}static isIE(){return new RegExp("MSIE|Trident|Edge").test(navigator.userAgent)}static isApple(){return new RegExp("Mac|iPod|iPhone|iPad").test(navigator.platform)}static getRandomInteger(e=0,t=100){return Math.floor(Math.random()*(t-e+1))+e}static roundAtDecimal(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}static quoteCsvCellValue(e){return"number"==typeof e&&(e=""+e),"string"!=typeof e?e:'"'+e.replace(/"/g,'""')+'"'}})||n},3603:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var n,s=i("aurelia-framework"),o=i(9202),r=i(1010);let a=(0,s.noView)(n=class e{static initOpenWith(){window.OME=window.OME||{},window.OME.setOpenWithEnabledHandler=function(t,i){e.OPEN_WITH.forEach((function(e){e.label===t&&(e.isEnabled=function(){var e=Array.from(arguments),n=!1;try{n=i.apply(this,e)}catch(e){console.log("Open with "+t+": "+e)}return n})}))},window.OME.setOpenWithUrlProvider=function(t,i){e.OPEN_WITH.forEach((function(e){e.id===t&&(e.getUrl=i)}))}}static fetchOpenWithScripts(t){e.OPEN_WITH=[],r.ajax({url:t+"/open_with/",success:t=>{"object"==typeof t&&null!==t&&o.Z.isArray(t.open_with_options)&&(e.OPEN_WITH=t.open_with_options,e.OPEN_WITH.forEach((e=>{e.script_url&&r.getScript(e.script_url)})))}})}static getOpenWithLinkParams(t,i,n,s){return e.OPEN_WITH.map((e=>{var o=[{id:t,type:"image",name:i}],r=!1;if("function"==typeof e.isEnabled?r=e.isEnabled(o):"object"==typeof e.supported_objects&&e.supported_objects.length>0&&(r=e.supported_objects.reduce((function(e,t){return e||"images"===t||"image"===t}),!1)),r&&0!==e.url.indexOf(n)&&0!=e.url.indexOf(s)){var a,l=e.label||e.id;try{a=e.getUrl(o,e.url)}catch(e){}return{text:l,url:a||e.url+"?image="+t}}})).filter((e=>e))}})||n},1037:(e,t,i)=>{"use strict";i.d(t,{c:()=>l});var n,s=i("aurelia-framework"),o=i(7674),r=i(9202),a=i(1633);let l=(0,s.noView)(n=class{static getDimensionsForPropagation(e,t=1,i=-1){if(e.drawing_mode===o.pQ.PRESENT_Z_AND_T||e.drawing_mode>o.pQ.ALL_T&&e.drawing_mode<o.pQ.CUSTOM_Z_AND_T)return[];let n=[],s=e.drawing_mode,r=s===o.pQ.CUSTOM_Z_AND_T?e.drawing_dims.z:[],a=s===o.pQ.CUSTOM_Z_AND_T?e.drawing_dims.t:[],l=e.image_info.dimensions.max_z,h=e.image_info.dimensions.max_t;if(s!==o.pQ.CUSTOM_Z_AND_T){let e=Array.from(Array(l).keys()),t=Array.from(Array(h).keys());["z","t"].map((i=>{"z"!==i||s!==o.pQ.ALL_Z&&s!==o.pQ.ALL_Z_AND_T||(r=e),"t"!==i||s!==o.pQ.ALL_T&&s!==o.pQ.ALL_Z_AND_T||(a=t)}))}(0===r.length||t<0||t>=l)&&r.push(t),(0===a.length||i<0||i>=h)&&a.push(i);for(let e=0;e<r.length;e++){let t=r[e];for(let e=0;e<a.length;e++){let i=a[e];n.push({z:t,t:i})}}return n}static parseDimensionInput(e,t){if("string"!=typeof e||"number"!=typeof t||t<=0)return[];if(0===(e=e.replace(/\s/g,"")).length)return[];let i=e.split(","),n=[];i.map((e=>{let i=e.indexOf("-");if(-1===i){let i=parseInt(e);"number"==typeof i&&!isNaN(i)&&i>0&&i<=t&&n.push(i)}else{let s=parseInt(e.substring(0,i)),o=parseInt(e.substring(i+1));if("number"==typeof s&&"number"==typeof o&&!isNaN(s)&&!isNaN(o)&&s<=o)for(let e=s;e<=o;e++)e>0&&e<=t&&n.push(e)}})),n.sort();let s=-1,o=[];for(let e=0;e<n.length;e++){let t=n[e];t!==s&&(s=t,o.push(t-1))}return o}static createUpdateHandler(e={properties:[],values:[]},t={hist:null,hist_id:-1},i=null,n=!1){return r.Z.isArray(e.properties)&&0!==e.properties.length&&r.Z.isArray(e.values)&&e.values.length===e.properties.length?(s,o)=>{if("object"!=typeof s||null===s)return;let r=[],l=!0;for(let t=0;t<e.properties.length;t++){let i=e.properties[t],n=void 0!==s[i]?s[i]:null;if("object"==typeof n&&"object"==typeof e.values[t]&&null!==n&&null!==e.values[t])for(let i in n)void 0!==typeof e.values[t][i]&&n[i]===e.values[t][i]||(l=!1);else n!==e.values[t]&&(l=!1);r.push(n),s[i]=e.values[t]}t.hist instanceof a.Z&&!l&&("boolean"==typeof o&&(e.properties.push("modified"),r.push(o),e.values.push(s.modified)),"number"!=typeof t.hist_id&&(t.hist_id=-1),t.hist.addHistory(t.hist_id,t.hist.action.PROPERTIES,{shape_id:s.shape_id,diffs:e.properties,modifies_attachment:n,old_vals:r,new_vals:e.values},"function"==typeof i?i:null)),"function"==typeof i&&i()}:null}})||n},5222:(e,t,i)=>{"use strict";i.d(t,{Z:()=>l});var n,s=i("aurelia-framework"),o=i(9202),r=i(7610),a=i(1010);let l=(0,s.noView)(n=class{static bindResizeHandlers(e){"object"==typeof e&&"function"==typeof e.publish&&a(".col-splitter").mousedown((t=>{t.preventDefault();let i=a(t.currentTarget).hasClass("left-split");a(document).mousemove((t=>{t.preventDefault();let n=a(i?".thumbnail-panel":".right-hand-panel");if(0===n.width())return!1;let s=i?t.pageX-n.offset().left:a(window).width()-t.pageX,o=a(".frame").width(),l=i?25:50,h=parseInt(n.css("max-width")),d=a(window).width()-(i?a(".right-hand-panel").width():a(".thumbnail-panel").width())-200;h>d&&(h=d);let c=i?a(window).width()-o:a(window).width();s>l&&s<h&&t.pageX<c&&(n.width(s),i?a(".frame").css({"margin-left":-s-5+"px","padding-left":s+5+"px"}):a(".frame").css({"margin-right":-s-5+"px","padding-right":s+5+"px"})),e.publish(r.D3,{config_id:-1,is_dragging:!0})})),a(document).mouseup((t=>{a(document).unbind("mousemove"),a(document).unbind("mouseup"),e.publish(r.D3,{config_id:-1,is_dragging:!1})}))}))}static unbindResizeHandlers(){a(".col-splitter").unbind("mousedown mouseup")}static unbindCollapseHandlers(){a(".collapse-left").unbind("mousedown click"),a(".collapse-right").unbind("mousedown click")}static bindCollapseHandlers(e,t){"string"!=typeof t&&(t=""),a(".collapse-left, .collapse-right").mousedown((e=>{e.preventDefault(),e.stopPropagation()})),a(".collapse-left, .collapse-right").click((i=>{let n=a(i.currentTarget).hasClass("collapse-left"),s=a(n?".thumbnail-panel":".right-hand-panel"),l=n?20:50,h=parseInt(s.attr("old-width")),d=s.width(),c=a(window).width()-(n?a(".right-hand-panel").width():a(".thumbnail-panel").width())-200,g=0===d?isNaN(h)||h<=0?l:h:0;if(0!==g&&g>c){if(l>c)return;g=c}s.attr("old-width",d);let p=""===t?o.Z.pruneUrlToLastDash(a(i.currentTarget).attr("src")):t+"/css/images";a(i.currentTarget).attr("src",p+"/collapse-"+(n&&0===g||!n&&0!==g?"right":"left")+".png"),s.width(g),s.css("flex","0 0 "+g+"px"),0===g?a(i.currentTarget).parent().css("cursor","default"):a(i.currentTarget).parent().css("cursor","ew-resize"),n?a(".frame").css({"margin-left":-g-5+"px","padding-left":g+5+"px"}):a(".frame").css({"margin-right":-g-5+"px","padding-right":g+5+"px"}),e.publish(r.D3,{config_id:-1})}))}static registerSidePanelHandlers(e,t){this.unbindResizeHandlers(),this.unbindCollapseHandlers(),this.bindResizeHandlers(e),this.bindCollapseHandlers(e,t)}static adjustSideBarsOnWindowResize(){let e=a(".thumbnail-panel"),t=a(".right-hand-panel"),i=e.width(),n=0,s=null;i>0&&(n=a(window).width()-t.width()-200,s=a(".collapse-left"),i>n&&s.trigger("click",{currentTarget:s})),e=a(".right-hand-panel"),i=e.width(),n=a(window).width()-200,s=a(".collapse-right"),i>n&&(n<50?s.trigger("click",{currentTarget:s}):(a(".right-hand-panel").width(n),a(".frame").css({"margin-right":-n-5+"px","padding-right":n+15+"px"})))}static showModalMessage(e,t){"string"!=typeof e&&(e=""),t="string"==typeof t?t.replace(/\s/g,""):"";let i=a(".modal-message");if(0===i.length)return;let n=i.find(".modal-footer");t?(n.find("button").html(t),n.show()):n.hide(),i.find(".modal-body").html(e),i.modal()}static hideModalMessage(){let e=a(".modal-message");0!==e.length&&(e.find(".modal-body").html(""),e.modal("hide"))}static showConfirmationDialog(e="",t="",i=null,n=null,s=!0){"string"!=typeof e&&(e="Confirmation"),"string"!=typeof t&&(t=""),"function"!=typeof i&&(i=null),"function"!=typeof n&&(n=null),"boolean"!=typeof s&&(s=!0);let o=a(".confirmation-dialog");0!==o.length&&(s?o.find(".modal-header .close").show():o.find(".modal-header .close").hide(),o.find(".modal-title").html(e),o.find(".modal-body").html(t),[".yes",".no"].map((e=>{o.find(e).off(),o.find(e).on("click",(()=>{o.modal("hide"),".yes"===e&&i&&i(),".no"===e&&n&&n()}))})),o.modal())}static scrollContainer(e,t,i){if("string"!=typeof e||"string"!=typeof t)return;let n=document.getElementById(e);if(null===n)return;("number"!=typeof i||i<0)&&(i=0);let s=a(t),o=s.scrollTop(),r=o+s.outerHeight(),l=n.offsetTop-i,h=l+n.offsetHeight;if(l>o&&h<r)return;let d=l-parseInt((s.outerHeight()-n.offsetHeight)/2);s.scrollTop(d<0?l:d)}static measureScrollbarWidth(){let e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",document.body.appendChild(e);let t=e.offsetWidth;e.style.overflow="scroll";let i=document.createElement("div");i.style.width="100%",e.appendChild(i);let n=i.offsetWidth;return e.parentNode.removeChild(e),t-n}static registerKeyHandlers(e,t,i="global",n=null){t.map((t=>e.addKeyListener(t.key,(s=>{let r=o.Z.isApple()?"metaKey":"ctrlKey";if(null===e.selected_config||"global"!==i&&e.selected_tab!==i||("boolean"!=typeof t.ctrl||t.ctrl)&&!s[r])return!0;try{t.func.apply(n,t.args)}catch(e){console.error("Key Handler failed: "+e)}return!1}),i,t.ctrl)))}static getFullScreenApiPrefix(){try{let e=null;if(document.body.webkitRequestFullscreen?e="webkit":document.body.mozRequestFullScreen?e="moz":document.body.msRequestFullscreen?e="ms":document.body.requestFullscreen&&(e=""),null===e)return null;if(document[e+"FullScreenEnabled"]||document[e+"FullscreenEnabled"])return e}catch(e){}return null}})||n},"viewers/ol3-viewer":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n,s=i(4997),o=i(9202),r=i("utils/converters"),a=i(5222),l=i("aurelia-framework"),h=i(426),d=(i(1230),i(7674));let c=(0,l.noView)(n=class{constructor(e){this.ol3_viewer=null,this.ol3_viewer=e}hasViewerInstance(){return null!==this.ol3_viewer&&null!==this.ol3_viewer.viewer}getViewer(){return this.hasViewerInstance()?this.ol3_viewer.viewer:null}getImageConfig(){return this.hasViewerInstance()?this.ol3_viewer.image_config:null}isMemberOfSyncGroup(e=null){let t=this.getImageConfig();return null!==t&&"string"==typeof e&&0!==e.length&&t.sync_group===e}preventEventPublish(e=!1){this.hasViewerInstance()&&(this.ol3_viewer.context.prevent_event_notification=e)}syncAction(e={},t=""){if(!this.isMemberOfSyncGroup(e.sync_group)||"string"!=typeof t||""===t.length||"function"!=typeof this[t])return;let i=this[t],n=this.getImageConfig(),s=this.ol3_viewer.context.sync_groups.get(n.sync_group);-1!==s.members.indexOf(n.id)&&i.call(this,e,s.sync_locks)}isLocked(e="",t={}){return"object"==typeof t&&null!==t&&"string"==typeof e&&t[e]}changeImageSettings(e={},t={}){if(!this.isLocked(d.x2.CHANNELS.CHAR,t))return;let i=this.getImageConfig();if("string"==typeof e.model){let t=i.image_info.model,n=e.model;t!==n&&(i.image_info.model=n,i.addHistory({prop:["image_info","model"],old_val:t,new_val:n,type:"string"}),this.getViewer().changeImageModel(e.model))}else if(o.Z.isArray(e.ranges)&&e.ranges.length>0){let t=e.ranges.map((e=>Object.assign({},e))),n=i.image_info.channels,s=i.image_info.getChannelMinMaxValues(d.lD.FULL_RANGE,0,d.Fe),o=[];for(let i=0;i<e.ranges.length;i++){let r=e.ranges[i];if(r.index<n.length){let e=s.start_min,a=s.end_max,l=s.step_size;for(let s in r){if("index"===s)continue;let h=null,d=r[s];if("start"===s||"end"===s){if(h=n[r.index].window[s],"start"===s&&d>=a||"end"===s&&d<=e)d=h;else{"start"===s&&d<e&&(d=e),"end"===s&&d>a&&(d=a);let t="start"===s?"end":"start",i=n[r.index].window[t];Math.abs(i-d)<l&&(d=h)}n[r.index].window[s]=d}else h=n[r.index][s],n[r.index][s]=d;if(t[i][s]=d,d!==h){let e=["image_info","channels",""+r.index];"start"!==s&&"end"!==s||e.push("window"),e.push(s),o.push({prop:e,old_val:h,new_val:d,type:typeof r[s]})}}}}o.length>0&&(i.addHistory(o),this.getViewer().changeChannelRange(t))}}setProjection(e={},t={}){if(!this.isLocked(d.x2.ZT.CHAR,t))return;let i=[],n=this.getImageConfig(),s=n.image_info.projection,o=e.projection;s!==o&&(n.image_info.projection=o,i.push({prop:["image_info","projection"],old_val:s,new_val:o,type:"string"}));let r=n.image_info.projection_opts,a=Object.assign({},e.projection_opts),l=n.image_info.dimensions.max_z-1;a.start>l&&(a.start=l),a.end>l&&(a.end=l),r.start===a.start&&r.end===a.end||(n.image_info.projection_opts=a,i.push({prop:["image_info","projection_opts"],old_val:Object.assign({},r),new_val:Object.assign({},a),type:"object"})),i.length>0&&(i.splice(0,0,{prop:["image_info","projection_opts","synced"],old_val:!1,new_val:!1,type:"boolean"}),n.addHistory(i),this.getViewer().changeImageProjection(e.projection,a),n.image_info.projection_opts.synced=!0)}setDimensionIndex(e={},t={}){if(!this.isLocked(d.x2.ZT.CHAR,t))return;let i=this.getImageConfig(),n=[],s=i.image_info.projection,o=e.projection;s!==o&&(i.image_info.projection=o,i.image_info.projection_opts.synced=!1,n.push({prop:["image_info","projection_opts","synced"],old_val:!1,new_val:!1,type:"boolean"}),n.push({prop:["image_info","projection"],old_val:s,new_val:o,type:"string"}));let r=i.image_info.dimensions,a=r[e.dim],l=r["max_"+e.dim]-1,h=e.value[0];h>l&&(h=l),this.preventEventPublish(!0);try{a!==h&&(r[e.dim]=h,n.push({prop:["image_info","dimensions",e.dim],old_val:a,new_val:h,type:"number"}),this.getViewer().setDimensionIndex(e.dim,[h])),n.length>0&&i.addHistory(n)}catch(e){console.error(e)}this.preventEventPublish(!1)}syncView(e={},t={}){if(!this.isLocked(d.x2.VIEW.CHAR,t))return;let i=e.w,n=e.h;if("number"==typeof i&&"number"==typeof n&&!isNaN(i)&&!isNaN(n)&&i>0&&n>0){let t=this.getImageConfig(),s=t.image_info.dimensions.max_x,o=t.image_info.dimensions.max_y;e.center=[e.center[0]*(s/i),e.center[1]*(o/n)]}else e.center=e.center.slice();this.getViewer().setViewParameters(e.center,e.resolution,e.rotation)}})||n;var g,p,u,f,_=i(6997),m=(i(6297),i(2214),i(7610)),v=i(1010);let y=(0,l.customElement)("ol3-viewer")(g=(0,l.inject)(s.Z,Element,l.BindingEngine)((f=class extends m.nb{constructor(e,t,i){super(e.eventbus),this.linked_events=new c(this),function(e,t,i,n){i&&Object.defineProperty(e,"image_config",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,u,this),this.image_info_ready_observer=null,this.image_config_selection_observer=null,this.viewer=null,this.player_info={dim:null,forwards:null,handle:null},this.sub_list=[[m.Wp,(e={})=>this.enableShapePopup(e)],[m.I4,(e={})=>this.handleViewerInteraction(e)],[m.Dk,(e={})=>this.toggleControlsVisibility(e)],[m.D3,(e={})=>this.resizeViewer(e)],[m.Fs,(e={})=>this.changeDimension(e)],[m.r7,(e={})=>this.playDimension(e)],[m.h6,(e={})=>this.changeImageSettings(e)],[m.IJ,(e={})=>this.getRegionsPropertyChange(e)],[m.ko,(e={})=>this.setRegionsProperty(e)],[m.Ot,(e={})=>this.getImageSettings(e)],[m.fo,(e={})=>this.syncImageSettingsProjections(e)],[m.vN,(e={})=>this.changeRegionsModes(e)],[m.A3,(e={})=>this.drawShape(e)],[m.j1,(e={})=>this.generateShapes(e)],[m.q0,(e={})=>this.storeShapes(e)],[m.XN,(e={})=>this.afterShapeStorage(e)],[m.sU,(e={})=>this.modifyShapes(e)],[m.F7,(e={})=>this.addHistoryEntry(e)],[m.P4,(e={})=>this.affectHistoryAction(e)],[m.n2,(e={})=>this.copyShapeDefinitions(e)],[m.bX,(e={})=>this.showComments(e)],[m.xf,(e={})=>this.captureViewport(e)],[m.w5,(e={})=>this.linkViewport(e)],[m.Du,(e={})=>this.saveCanvasData(e)],[m.iw,(e={})=>this.setSyncGroup(e)],[m.FQ,(e={})=>this.refreshImageSettings(e)]],this.context=e,this.element=t,this.bindingEngine=i}getContainer(){return v(this.element).parent()}getInitialViewerPositions(e,t){let i=e.position().left,n=e.position().top,s=e.width(),o=e.height(),r=parseInt(t.width),a=parseInt(t.height);return[{top:Math.max(0,n+o/2-a),left:i+s/2-r},{top:Math.max(0,n+o/2-a),left:i+s/2},{top:n+o/2,left:i+s/2-r},{top:n+o/2,left:i+s/2}]}getNewViewerPosition(e,t){let i,n=this.getInitialViewerPositions(e,t),s=this.image_config.context,o=parseInt(t.width),r=parseInt(t.height);for(let e=0;e<n.length;e++){let t=n[e];if(0===s.getImageConfigsAtPosition(t.left+o/2,t.top+r/2).length){i={left:t.left+"px",top:t.top+"px"};break}}return i}attached(){let e=v(".frame"),t=0,i=0,n=0,s=0,r=this.getContainer();if(Array.from(this.image_config.context.image_configs.keys()).indexOf(this.image_config.id),null===this.image_config.position){let r=parseInt(this.image_config.size.width),a=parseInt(this.image_config.size.height);t=e.position().left+10,i=e.position().left+e.width()-r,n=e.position().top+10,s=e.position().top+e.height()-a;let l=this.getNewViewerPosition(e,this.image_config.size);l||(l={top:o.Z.getRandomInteger(n,s)+"px",left:o.Z.getRandomInteger(t,i)+"px"}),this.image_config.position=l}r.draggable({handle:".viewer-handle",start:()=>{t=e.position().left+100-parseInt(this.image_config.size.width,10),n=0,i=e.width()+e.position().left-100,s=e.height()-100},drag:(e,o)=>{o.position.top=Math.max(n,o.position.top),o.position.top=Math.min(s,o.position.top),o.position.left=Math.max(t,o.position.left),o.position.left=Math.min(i,o.position.left)},stop:(e,t)=>{this.image_config.position.top=t.position.top+"px",this.image_config.position.left=t.position.left+"px"}}),r.resizable({containment:"parent",handles:"se",stop:(e,t)=>{this.image_config.size.width=t.size.width+"px",this.image_config.size.height=t.size.height+"px",this.resizeViewer()}}),this.createObservers()}createObservers(){let e=()=>{if(this.image_config.image_info.refresh){this.viewer.changeImageModel(this.image_config.image_info.model);let e=this.image_config.image_info.channels,t=[];for(let i=0;i<e.length;i++){let n=e[i],s={index:i,active:n.active,start:n.window.start,end:n.window.end,color:n.color,inverted:n.inverted};"string"!=typeof n.family||""===n.family||"number"!=typeof n.coefficient||isNaN(n.coefficient)||(s.family=n.family,s.coefficient=n.coefficient),t.push(s)}return this.viewer.changeChannelRange(t),this.saveImageSettings(),void(this.image_config.image_info.refresh=!1)}this.initViewer(),this.subscribe(),this.regions_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.regions_info,"ready").subscribe(((e,t)=>{null!==this.viewer&&(this.viewer.removeRegions(),e&&(this.initRegions(),delete this.image_config.regions_info.tmp_data))})),this.getContainer().find(".ol-control").on("mousedown",(()=>this.context.selectConfig(this.image_config.id)))};this.image_info_ready_observer=this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((t,i)=>{!i&&t&&e()})),this.image_config_selection_observer=this.bindingEngine.propertyObserver(this.context,"selected_config").subscribe(((e,t)=>{this.resizeViewer({config_id:e,delay:200}),this.context.useMDI&&t===this.image_config.id&&null!==e&&this.image_config.regions_info.hasBeenModified()&&0!==this.context.getImageConfigsForGivenImage(this.image_config.image_info.image_id,this.image_config.id).length&&a.Z.showConfirmationDialog("Save ROIs?","You have changed ROI(s) on an image that's been opened multiple times.<br>Do you want to save now to avoid inconsistence (and a potential loss of some of your changes)?",(()=>this.storeShapes({config_id:this.image_config.id})))}))}bind(){this.element.parentNode.id=this.image_config.id,this.container=d.HX+this.image_config.id}detached(){if(this.context.useMDI){let e=this.getContainer();e.find(".ol-control").off("mousedown");try{e.draggable("destroy")}catch(e){}try{e.resizable("destroy")}catch(e){}}this.viewer&&(this.viewer.destroyViewer(),this.viewer=null)}unbind(){this.image_config_selection_observer&&(this.image_config_selection_observer.dispose(),this.image_config_selection_observer=null),this.image_info_ready_observer&&(this.image_info_ready_observer.dispose(),this.image_info_ready_observer=null),this.regions_info_ready_observer&&(this.regions_info_ready_observer.dispose(),this.regions_info_ready_observer=null),this.unsubscribe(),this.viewer=null,this.image_config=null}initViewer(){let e=Object.assign({},this.context.initParams);e[d.TQ]=this.context.getPrefixedURI(d.$R),this.viewer=new h.Z(this.image_config.image_info.image_id,{eventbus:this.context.eventbus,server:this.context.server,data:this.image_config.image_info.tmp_data,initParams:e,container:this.container}),delete this.image_config.image_info.tmp_data,this.context.useMDI&&this.context.image_configs.size>1&&this.toggleControlsVisibility({config_id:this.image_config.id,flag:!1});let t=this.context.getInitialRequestParam(d.Yj.ENABLE_MIRROR);this.context.resetInitParams(),this.context.initParams[d.Yj.ENABLE_MIRROR]=t,this.viewer.enableSmoothing(this.context.interpolate),this.viewer.zoomToFit(),this.context.isRoisTabActive()&&this.initRegions(),this.resizeViewer({window_resize:!0,delay:100})}changeDimension(e={}){if(null!==this.viewer&&"string"==typeof e.dim&&o.Z.isArray(e.value)&&0!==e.value.length)if(e.config_id===this.image_config.id){this.viewer.setDimensionIndex(e.dim,e.value);let t={};t[e.dim]=e.value[0];let i=this.viewer.getId();this.context.setCachedImageSettings(i,t)}else this.linked_events.syncAction(e,"setDimensionIndex")}changeImageSettings(e={}){if(null===this.viewer)return;let t=e.config_id===this.image_config.id;"string"==typeof e.model?t?this.viewer.changeImageModel(e.model):this.linked_events.syncAction(e,"changeImageSettings"):t&&"string"==typeof e.projection?(this.viewer.changeImageProjection(e.projection,Object.assign({},e.projection_opts)),this.context.publish(m.fo,e)):o.Z.isArray(e.ranges)&&e.ranges.length>0?t?this.viewer.changeChannelRange(e.ranges):this.linked_events.syncAction(e,"changeImageSettings"):"boolean"==typeof e.interpolate&&this.viewer.enableSmoothing(e.interpolate),t&&this.cacheImageSettings(e)}cacheImageSettings(e={}){if(null===this.viewer)return;let t=this.viewer.captureViewParameters(),i={channels:t.channels,model:t.model};e.projection&&(i.projection=e.projection,i.projection_opts=e.projection_opts);let n=this.viewer.getId();this.context.setCachedImageSettings(n,i)}refreshImageSettings(e={}){null!==this.viewer&&null!==this.image_config&&this.image_config.id===e.config_id&&(this.viewer.refreshBirdsEye(500),this.saveImageSettings(e))}saveImageSettings(e={}){null!==this.viewer&&this.viewer.updateSavedSettings()}syncImageSettingsProjections(e={}){"number"==typeof e.config_id&&e.config_id!==this.image_config.id&&this.linked_events.syncAction(e,"setProjection")}resizeViewer(e={}){null===this.viewer||"number"==typeof e.config&&!isNaN(e.config_id)&&-1!==e.config&&e.config_id!==this.image_config.id||("boolean"!=typeof e.is_dragging&&(e.is_dragging=!1),e.is_dragging||("boolean"==typeof e.window_resize&&e.window_resize&&a.Z.adjustSideBarsOnWindowResize(),this.viewer.redraw(e.delay)))}getRegionsPropertyChange(e={}){if(!("object"!=typeof e||e.config_id!==this.image_config.id||!o.Z.isArray(e.shapes)||0===e.shapes.length||!o.Z.isArray(e.properties)&&"string"!=typeof e.properties||o.Z.isArray(e.properties)&&e.properties.length!==e.shapes.length||!o.Z.isArray(e.values)&&void 0===e.values||o.Z.isArray(e.values)&&e.values.length!==e.shapes.length))for(let t in e.shapes){let i=e.shapes[t],n=this.image_config.regions_info.data?this.image_config.regions_info.getShape(i):null,s=n?n.modified:null,r=o.Z.isArray(e.properties)?e.properties[t]:e.properties,a=o.Z.isArray(e.values)?e.values[t]:e.values;if("selected"!==r&&"modified"!==r&&"deleted"!==r&&"visible"!==r||this.image_config.regions_info.setPropertyForShape(i,r,a),n&&"deleted"===r&&(n=Object.assign({},n)),"function"==typeof e.callback&&e.callback(n,s),"modified"===r){let e=this.viewer.getLengthAndAreaForShapes([i],!0);o.Z.isArray(e)&&e.length>0&&e[0].id===i&&(n.Area=e[0].Area,n.Length=e[0].Length)}}}setRegionsProperty(e={}){if(null===this.viewer||"object"!=typeof e||"string"!=typeof e.property||e.config_id!==this.image_config.id)return;let t=e.property.toLowerCase();"visible"===t?this.viewer.setRegionsVisibility(e.value,e.shapes):"selected"===t?this.changeShapeSelection(e):"state"===t&&this.deleteShapes(e)}generateShapes(e={}){if(e.config_id!==this.image_config.id||null===this.viewer||!o.Z.isArray(e.shapes)||0===e.shapes.length)return;"number"!=typeof e.number&&(e.number=1),"number"!=typeof e.roi_id&&(e.roi_id=this.image_config.regions_info.getNewRegionsId());let t=o.Z.isArray(e.theDims)&&0!==e.theDims.length?e.theDims:null;e.shapes.map((i=>{try{if(!i.deleted){let n=Object.assign({},i);if(n.modified){let e=this.viewer.getShapeDefinition(n.shape_id);e&&(n=r.Converters.amendShapeDefinition(e))}delete n.shape_id,"boolean"==typeof e.paste&&e.paste?n.roi_id=this.image_config.regions_info.getNewRegionsId():n.roi_id=e.roi_id;let s={number:e.number,position:e.position,is_compatible:e.is_compatible,extent:this.viewer.getSmallestViewExtent(),theDims:t};"boolean"==typeof e.add_history&&(s.add_history=e.add_history),"number"==typeof e.hist_id&&(s.hist_id=e.hist_id),this.viewer.generateShapes(n,s)}}catch(e){}}))}deleteShapes(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&"string"==typeof e.value&&o.Z.isArray(e.shapes)&&0!==e.shapes.length&&("delete"===e.value?this.viewer.deleteShapes(e.shapes,!1,e.callback):"undo"===e.value&&this.viewer.deleteShapes(e.shapes,!0))}changeShapeSelection(e={}){if(e.config_id!==this.image_config.id||null===this.viewer||!o.Z.isArray(e.shapes)||0===e.shapes.length)return;let t=e.shapes[e.shapes.length-1];if(!e.value){let e=this.image_config.regions_info.selected_shapes.length;if(e>0){let i=this.image_config.regions_info.selected_shapes[e-1];t=i!==t?i:e>1?this.image_config.regions_info.selected_shapes[e-2]:null}else t=null}let i=0;if(t){let e=this.viewer.getDimensionIndex("t"),n=this.viewer.getDimensionIndex("z"),s=this.viewer.getDimensionIndex("c"),o=this.image_config.regions_info.getShape(t),r=!0,a="number"==typeof o.TheT?o.TheT:-1;-1!==a&&a!==e&&(this.image_config.image_info.dimensions.t=a,r=!1,i+=25);let l="number"==typeof o.TheZ?o.TheZ:-1;-1!==l&&l!==n&&(this.image_config.image_info.dimensions.z=l,r=!1,i+=25),this.image_config.image_info.initial_shape_id=r?void 0:o["@id"];let h="number"==typeof o.TheC?o.TheC:-1;-1!==h&&-1===s.indexOf(h)&&(this.image_config.image_info.channels[h].active=!0,i+=25)}setTimeout((()=>{this.abortDrawing(),this.viewer.selectShapes(e.shapes,e.value,e.clear,e.center?t:null,e.zoomToShape),e.shapes.length>1&&this.viewer.viewer_.getOverlays().forEach((e=>{e.hideShapeEditPopup&&e.hideShapeEditPopup()}))}),i)}getImageSettings(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&"function"==typeof e.callback&&(e.callback(this.viewer.captureViewParameters()),this.viewer.redraw())}changeRegionsModes(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&"object"==typeof e&&o.Z.isArray(e.modes)&&(this.image_config.regions_info.regions_modes=this.viewer.setRegionsModes(e.modes))}initRegions(){if(null===this.viewer||null===this.image_config||null===this.image_config.regions_info||!this.image_config.regions_info.ready||!o.Z.isArray(this.image_config.regions_info.tmp_data))return;let e,t;if(this.viewer.addRegions(this.image_config.regions_info.tmp_data),this.changeRegionsModes({modes:this.image_config.regions_info.regions_modes}),this.viewer.showShapeComments(this.image_config.regions_info.show_comments),this.image_config.image_info.initial_shape_id?(t=this.image_config.image_info.initial_shape_id,e=this.image_config.regions_info.getRoiFromShapeId(t)):this.image_config.image_info.initial_roi_id&&(e=this.image_config.image_info.initial_roi_id),e){let i,n=this.image_config.regions_info.data.get(e);i=t?["".concat(e,":").concat(t)]:["".concat(n.id,":").concat(n.shapes.keys().next().value)],this.changeShapeSelection({config_id:this.image_config.id,property:"selected",shapes:i,clear:!0,value:!0,center:!0,zoomToShape:!0})}setTimeout((()=>{if(null===this.viewer)return;let e=this.image_config.regions_info.unsophisticatedShapeFilter(),t=this.viewer.getLengthAndAreaForShapes(e);for(let e=0;e<t.length;e++){let i=t[e];if("object"!=typeof i||null===i||"string"!=typeof i.id)continue;let n=this.image_config.regions_info.getShape(i.id);null!==n&&(n.Area=i.Area,n.Length=i.Length)}}),50)}drawShape(e={}){if(e.config_id!==this.image_config.id||null===this.viewer)return;if("boolean"==typeof e.abort&&e.abort)return void this.abortDrawing();let t=!0,i=[];switch(this.image_config.regions_info.drawing_mode){case d.pQ.NEITHER_Z_NOR_T:i=["z","t"];break;case d.pQ.NOT_Z:i.push("z");break;case d.pQ.NOT_T:i.push("t");break;case d.pQ.ALL_Z_AND_T:case d.pQ.ALL_Z:case d.pQ.ALL_T:case d.pQ.CUSTOM_Z_AND_T:t=!1}-1===i.indexOf("z")&&this.image_config.image_info.projection===d.PO.INTMAX&&i.push("z"),this.viewer.drawShape(e.shape,e.roi_id,{hist_id:e.hist_id,unattached:i,add:t})}abortDrawing(){this.viewer.abortDrawing(),this.image_config.regions_info.shape_to_be_drawn=null}storeShapes(e={}){if(null===this.viewer||e.config_id!==this.image_config.id)return;let t=this.image_config.regions_info.getNumberOfDeletedShapes(),i=t>0?this.image_config.regions_info.getEmptyRois():{},n=()=>{this.viewer.storeRegions(i,!1,e.omit_client_update)?a.Z.showModalMessage("Saving Regions. Please wait..."):e.omit_client_update&&this.context.publish(m.XN,{omit_client_update:!0})};t>0?a.Z.showConfirmationDialog("Save ROIS?","Saving your changes includes the deletion of "+t+" ROIs. Do you want to continue?",n,(()=>{e.omit_client_update&&this.context.publish(m.XN,{omit_client_update:!1})})):n()}modifyShapes(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&o.Z.isArray(e.shapes)&&0!==e.shapes.length&&"object"==typeof e.definition&&null!==e.definition&&("boolean"==typeof e.modifies_attachment&&e.modifies_attachment?this.viewer.modifyShapesAttachment:this.viewer.modifyRegionsStyle).call(this.viewer,e.definition,e.shapes.slice(),"function"==typeof e.callback?e.callback:null)}afterShapeStorage(e={}){if(a.Z.hideModalMessage(),e.config_id!==this.image_config.id)return;if(this.context.useMDI&&this.context.reloadImageConfigForGivenImage(this.image_config.image_info.image_id,d.Iz.REGIONS,this.image_config.id,this.viewer.getRois()),"object"!=typeof e.shapes||null===e.shapes||e.omit_client_update)return;let t=[],i=0;for(let n in e.shapes){let s=this.image_config.regions_info.getShape(n);if(s){let o=e.shapes[n];t.push(n);let a=r.Converters.extractRoiAndShapeId(n),l=r.Converters.extractRoiAndShapeId(o);s.modified=!1,s.stats=null;let h="boolean"==typeof s.is_new&&s.is_new;if(h){i++;let e=this.image_config.regions_info.data.get(l.roi_id);void 0===e&&(e={shapes:new Map,show:!1,deleted:0},this.image_config.regions_info.data.set(l.roi_id,e)),delete s.is_new;let t=Object.assign({},s);t.shape_id=o,t["@id"]=l.shape_id,e.shapes.set(l.shape_id,t),s.deleted=!0;let n=this.image_config.regions_info.selected_shapes,r=n.indexOf(s.shape_id);-1!==r&&(n[r]=t.shape_id)}if(s.deleted){let e=this.image_config.regions_info.data.get(a.roi_id);void 0!==e&&e.shapes instanceof Map&&e.shapes.delete(a.shape_id),0===e.shapes.size&&this.image_config.regions_info.data.delete(a.roi_id),h||(i--,s.visible||this.image_config.regions_info.visibility_toggles++,this.image_config.regions_info.number_of_shapes--)}}}if(this.image_config.regions_info.roi_count=this.image_config.regions_info.roi_count+i,this.image_config.regions_info.roi_count_on_current_plane=this.image_config.regions_info.roi_count_on_current_plane+i,this.image_config.regions_info.history.resetHistory(),o.Z.isArray(e.errors)){let t="Saving of Rois/Shapes failed.";for(let t in e.errors)console.error(e.errors[t]);a.Z.showModalMessage(t,"OK")}}showComments(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&this.viewer.showShapeComments(e.value)}enableShapePopup(e={}){e.config_id===this.image_config.id&&null!==this.viewer&&this.viewer.enableShapePopup(e.enable)}addHistoryEntry(e){if(e.config_id!==this.image_config.id||"number"!=typeof e.hist_id)return;let t=this.image_config.regions_info.history;t.addHistory(t.getHistoryId(),t.action.OL_ACTION,{hist_id:e.hist_id,shape_ids:e.shape_ids})}affectHistoryAction(e){e.config_id===this.image_config.id&&null!==this.viewer&&"number"==typeof e.hist_id&&("boolean"!=typeof e.undo&&(e.undo=!0),this.viewer.doHistory(e.hist_id,e.undo))}copyShapeDefinitions(e){if(e.config_id===this.image_config.id&&null!==this.viewer&&0!==this.image_config.regions_info.selected_shapes.length){this.image_config.regions_info.copied_shapes=[],this.image_config.regions_info.selected_shapes.map((e=>{let t=Object.assign({},this.image_config.regions_info.getShape(e));if("mask"!==t.type){if(t.modified){let e=this.viewer.getShapeDefinition(t.shape_id);e&&(t=r.Converters.amendShapeDefinition(e))}this.image_config.regions_info.copied_shapes.push(t)}}));try{window.localStorage.setItem(d.$R+".copy_image_dims",JSON.stringify({width:this.image_config.image_info.dimensions.max_x,height:this.image_config.image_info.dimensions.max_y})),window.localStorage.setItem(d.$R+".copy_shape_defs",JSON.stringify(this.image_config.regions_info.copied_shapes))}catch(e){}}}playDimension(e={}){if(e.config_id!==this.image_config.id||null===this.viewer||"boolean"!=typeof e.forwards||"string"!=typeof e.dim||"z"!==e.dim&&"t"!==e.dim)return;let t=(()=>{null!==this.player_info.handle&&clearInterval(this.player_info.handle),this.player_info.dim=null,this.player_info.forwards=null,this.player_info.handle=null,this.image_config.is_movie_playing=!1,this.viewer.getRenderStatus(!0)}).bind(this);"boolean"!=typeof e.stop&&(e.stop=!0);let i=e.forwards;if((e.stop&&null!==this.player_info.handle||!e.stop&&null!==this.player_info.handle&&(e.dim!==this.player_info.dim||i!==this.player_info.forwards))&&t(),e.stop)return;let n="number"==typeof e.delay&&e.delay>=100?e.delay:250,s=this.image_config.image_info.dimensions,o=e.dim;var r=s["max_"+o]-1,a=s[o];0!==r&&(i&&a>=r&&(s[o]=0),!i&&a<=0&&(s[o]=r),this.player_info.dim=o,this.player_info.forwards=i,this.image_config.is_movie_playing=!0,this.player_info.handle=setInterval((()=>{try{window.interval_handle=this.player_info.handle;let e=this.viewer.getRenderStatus();if(e===d.PP.IN_PROGRESS)return;if(a=s[o],e===d.PP.ERROR||i&&a>=r||!i&&a<=0)return void t();this.viewer.watchRenderStatus(!0)||this.viewer.getRenderStatus(!0),s[o]=a+(i?1:-1)}catch(e){clearInterval(window.interval_handle)}}),n))}captureViewport(e={}){let t="boolean"==typeof e.all_configs&&e.all_configs;if(null===this.viewer)return void(t&&e.count--);if(!t&&e.config_id!==this.image_config.id)return;t&&(e.zip_entry=this.image_config.image_info.image_name);let i=this.viewer.viewer_.getView();e.flipX=i.values_.flipX,e.flipY=i.values_.flipY,this.viewer.sendCanvasContent(e)}linkViewport(e={}){if(e.config_id!==this.image_config.id||null===this.viewer)return;let t=new Map;if(window.location.search.length>0){let e=window.location.search.substr(1).split("&").map((e=>e.split("="))).map((e=>[e[0].toLowerCase(),e[1]]));t=new Map(e)}let i=this.viewer.viewer_.getView(),n=i.getProperties(),s=this.image_config.image_info,o=[],r=i.getCenter();o.push([d.Yj.CENTER_X,parseInt(r[0])]),o.push([d.Yj.CENTER_Y,-parseInt(r[1])]),o.push([d.Yj.ZOOM,parseInt(100/i.getResolution())]);let l=s.channels,h=l.map(((e,t)=>{let i=e.window;return"".concat(e.active?"":"-").concat(t+1,"|").concat(i.start,":").concat(i.end,"$").concat(e.color)}));o.push([d.Yj.CHANNELS,h.join(",")]),o.push([d.Yj.MODEL,s.model.toLowerCase()[0]]);let c=l.map((e=>({inverted:{enabled:e.inverted},quantization:{family:e.family,coefficient:e.coefficient}})));o.push([d.Yj.MAPS,JSON.stringify(c)]),o.push([d.Yj.FLIP_X,n.flipX]),o.push([d.Yj.FLIP_Y,n.flipY]);let g=window.location.origin+window.location.pathname;o.forEach((e=>{t.set(e[0].toLowerCase(),e[1])}));let p=[];for(var[u,f]of t)p.push("".concat(u,"=").concat(f));g+="?"+p.join("&");let _="<p>Copy Viewport URL</p>\n            <input id='viewport_url' style='font-size: 12px; width: 100%;' value='".concat(g,"' />");a.Z.showModalMessage(_,"Close");let m=document.getElementById("viewport_url");m.focus(),m.select()}saveCanvasData(e={}){if(e.config_id!==this.image_config.id)return;if(!e.supported)return void console.error("Capturing Viewport as Blob not supported");let t="boolean"==typeof e.all_configs&&e.all_configs;(t||this.image_config.id===e.config_id)&&(()=>{if(t)e.zip?0===e.count&&e.zip.generateAsync({type:"blob"}).then((e=>_.saveAs(e,"images.zip"))):console.error("no jszip instance!");else{if(null===this.image_config)return;_.saveAs(e.data,this.image_config.image_info.image_name+".png")}})()}handleViewerInteraction(e={}){if(null!==this.viewer)if(e.config_id===this.image_config.id){let t=this.viewer.getId();const i={center:[...e.center],resolution:e.resolution,rotation:e.rotation,flipX:e.flipX,flipY:e.flipY};this.context.setCachedImageSettings(t,i)}else this.linked_events.syncAction(e,"syncView")}setSyncGroup(e={}){null!==this.viewer&&e.config_id===this.image_config.id&&this.viewer.setSyncGroup(e.sync_group)}toggleIntensityQuerying(e={}){null!==this.viewer&&null!==this.image_config&&this.image_config.id===e.config_id&&(this.image_config.image_info.query_intensity=this.viewer.toggleIntensityQuerying(e.flag))}toggleControlsVisibility(e={}){null!==this.viewer&&null!==this.image_config&&this.image_config.id===e.config_id&&"boolean"==typeof e.flag&&(e.flag?(v("#"+this.image_config.id+" .ol-control").show(),this.image_config.show_controls=!0):(v("#"+this.image_config.id+" .ol-control").hide(),this.image_config.show_controls=!1))}handleDrop(e){document.getElementById(this.image_config.id).classList.remove("drag_enter"),e.stopPropagation();var t=parseInt(e.dataTransfer.getData("id"),10);this.context.useMDI?this.context.onClicks(t,!1,this.image_config):(this.context.useMDI=!0,this.context.onClicks(t,!0))}handleDragover(e){e.preventDefault(),v(".viewer-mdi").removeClass("drag_enter"),document.getElementById(this.image_config.id).classList.add("drag_enter")}handleDragleave(e){v(".viewer-mdi").removeClass("drag_enter")}},b=(p=f).prototype,w="image_config",x=[l.bindable],I={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},S={},Object.keys(I).forEach((function(e){S[e]=I[e]})),S.enumerable=!!S.enumerable,S.configurable=!!S.configurable,("value"in S||S.initializer)&&(S.writable=!0),void 0===(S=x.slice().reverse().reduce((function(e,t){return t(b,w,e)||e}),S)).initializer&&(Object.defineProperty(b,w,S),S=null),u=S,g=p))||g)||g;var b,w,x,I,S},"viewers/viewer-context-menu":(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n,s,o,r,a=i(4997),l=i("aurelia-framework"),h=i(7610),d=i(7674),c=i(1010);let g=(0,l.customElement)("viewer-context-menu")(n=(0,l.inject)(a.Z,Element,l.BindingEngine)((r=class{constructor(e,t,i){!function(e,t,i,n){i&&Object.defineProperty(e,"image_config",{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}(this,0,o,this),this.SELECTOR=".viewer-context-menu",this.viewport_location=null,this.observers=[],this.image_config=null,this.shape_popup_enabled=!0,this.context=e,this.element=t,this.bindingEngine=i}attached(){this.observers.push(this.bindingEngine.propertyObserver(this.image_config.image_info,"ready").subscribe(((e,t)=>this.enableContextMenu()))),this.observers.push(this.bindingEngine.propertyObserver(this.context,"selected_config").subscribe(((e,t)=>{e!==this.image_config&&this.hideContextMenu()})))}detached(){this.observers.map((e=>{e&&e.dispose()})),this.observers=[]}getElement(){return c(this.element).find(this.SELECTOR)}hideContextMenu(){this.getElement().offset({top:0,left:0}),this.getElement().hide()}enableContextMenu(){let e=c("#"+d.HX+this.image_config.id);0!==e.length&&(e.click((e=>this.hideContextMenu())),e.contextmenu((e=>(e.stopPropagation(),e.preventDefault(),!!c(e.target).parent().hasClass("ol-viewport")&&(this.viewport_location=[e.offsetX,e.offsetY],this.getElement().show(),this.getElement().offset({left:e.clientX,top:e.clientY}),!1)))),this.getElement().off(),this.getElement().contextmenu((e=>(e.stopPropagation(),e.preventDefault(),!1))))}enableShapePopup(){return this.hideContextMenu(),!!this.image_config.regions_info.ready&&(this.shape_popup_enabled=!this.shape_popup_enabled,this.context.eventbus.publish("ENABLE_SHAPE_POPUP",{config_id:this.image_config.id,enable:!0}),!1)}pasteShapes(){return this.image_config.regions_info.pasteShapes(this.viewport_location),this.hideContextMenu(),!1}captureViewport(){this.context.eventbus.publish(h.xf,{config_id:this.image_config.id})}linkToViewport(){this.hideContextMenu(),this.context.eventbus.publish(h.w5,{config_id:this.image_config.id})}},p=(s=r).prototype,u="image_config",f=[l.bindable],_={configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}},m={},Object.keys(_).forEach((function(e){m[e]=_[e]})),m.enumerable=!!m.enumerable,m.configurable=!!m.configurable,("value"in m||m.initializer)&&(m.writable=!0),void 0===(m=f.slice().reverse().reduce((function(e,t){return t(p,u,e)||e}),m)).initializer&&(Object.defineProperty(p,u,m),m=null),o=m,n=s))||n)||n;var p,u,f,_,m},426:(e,t,i)=>{"use strict";i.d(t,{Z:()=>W});var n=i(9978),s=i(1749),o=i(8816),r=i(3376),a=i(4922),l=i(7552),h=i(4889),d=i(2790),c=i(2372),g=i(7094),p=i(6850),u=i(5408),f=i(5745),_=i(2929),m=i(8228),v=i(2293),y=i(5882),b=i(3529),w=i(3721),x=i(1201),I=i(366),S=i(5222);class C extends y.Z{constructor(e){document.querySelectorAll(".shape-edit-popup");let t=document.createElement("div");t.className="shape-edit-popup",t.innerHTML="\n        <div>\n            <input class='shape-popup-edit-text'\n                placeholder='Edit shape comment'\n                value=''/>\n            <div><input readonly class='shape-popup-coords'/></div>\n            <div><input readonly class='shape-popup-area'/></div>\n            <a href=\"#\" class=\"shape-edit-popup-closer\" class=\"shape-edit-popup-closer\">&times;</a>\n        </div>",t.onpointermove=function(e){e.isOverShapeEditPopup=!0},super({element:t,insertFirst:!1,autoPan:!1}),this.popup=t,this.regions=e,this.viewer_=e.viewer_,this.map=e.viewer_.viewer_,this.map.addOverlay(this),this.textInput=this.popup.querySelectorAll(".shape-popup-edit-text")[0],this.coordsInput=this.popup.querySelectorAll(".shape-popup-coords")[0],this.areaInput=this.popup.querySelectorAll(".shape-popup-area")[0],this.popupCloser=this.popup.querySelectorAll(".shape-edit-popup-closer")[0],this.bindListeners()}showPopupForShape(e){this.map.getOverlays().forEach((e=>e.setPosition(void 0)));let t="",i=e.getStyle();"function"==typeof i&&(i=i(1)),(0,I.kJ)(i)&&(i=i[0]);let n=i instanceof w.ZP?i.getText():null;null===n&&e.oldText instanceof b.Z&&(n=e.oldText),n&&n.getText()&&n.getText().length>0&&(t=n.getText()),this.shapeId=e.getId(),this.textInput.value=t,this.regions.renderFeature(e)&&this.updatePopupCoordinates(e.getGeometry())}updatePopupText(e,t){this.shapeId&&e.indexOf(this.shapeId)>-1&&(this.textInput.value=t)}updatePopupVisibility(){if(this.shapeId){let e=this.regions.getFeatureById(this.shapeId);e&&this.regions.renderFeature(e)?this.updatePopupCoordinates(e.getGeometry()):this.setPosition(void 0)}}hideShapeEditPopup(e){e!==this.shapeId&&void 0!==e||(this.shapeId=void 0,this.setPosition(void 0))}updatePopupCoordinates(e){let t=e.getExtent(),i=this.map.getView(),n=i.values_.flipX?((0,_.hC)(t)[0]+(0,_.w$)(t)[0])/2:((0,_.rL)(t)[0]+(0,_.Xv)(t)[0])/2,s=i.values_.flipY?(0,_.hC)(t)[1]:(0,_.rL)(t)[1];if(e instanceof x.Z){let t=e.getLineCoordinates();t[1]<t[3]?n=t[2]:t[1]>t[3]&&(n=t[0])}let o="";e.getDisplayCoords&&(o=e.getDisplayCoords().map((e=>"".concat(e[0],": ").concat(e[1]))).join(", "));let r="",a=this.regions.getLengthAndAreaForShape(e);if(this.regions.viewer_&&a){let e=this.regions.viewer_.image_info_.pixel_size.symbol_x||"px";["Area","Length"].forEach((t=>{a.hasOwnProperty(t)&&(r+="".concat(t,": ").concat(a[t]," ").concat(e).concat("Area"==t?"²":""))}))}if(this.coordsInput.value=o,this.areaInput.value=r,this.regions.viewer_.enable_shape_popup){let e=this.map.getViewport().getBoundingClientRect(),t=this.map.getPixelFromCoordinate([n,s]);i.values_.flipX&&(t[0]=e.width-t[0]),i.values_.flipY&&(t[1]=e.height-t[1]);let o=this.map.getCoordinateFromPixel(t);this.setPosition(o)}}bindListeners(){let e;this.textInput.onkeyup=t=>{e&&(clearTimeout(e),e=void 0),e=setTimeout((()=>{let e=t.target.value;(0,I.qD)(this.viewer_,"IMAGE_COMMENT_CHANGE",{shapeId:this.shapeId,Text:e})}),500)},this.popupCloser.onclick=e=>(this.setPosition(void 0),e.target.blur(),S.Z.showModalMessage("<p>ROI popups disabled.</p>\n            <p>To re-enable popups, right-click on the image and use the context menu.</p>","OK"),(0,I.qD)(this.viewer_,"ENABLE_SHAPE_POPUP",{enable:!1}),!1)}unbindListeners(){this.textInput.onkeyup=null,this.popupCloser.onclick=null}disposeInternal(){this.unbindListeners(),this.setPosition(void 0),this.map.removeOverlay(this),this.map=null}}const T=C;var E=i(6721),A=i(29),R=i(9672),P=i(1221),O=i(4783),k=i(8500),N=i(7297),L=i(6905),M=i(2101),j=i(4848),F=i(9128),D=i(8185),z=i(550),Z=i(5385);class H extends Z.Z{constructor(e,t,i,n,s,o){super(e,t,i,n,s,o),this.imageByContext_={}}getRenderedTileAsContext(e,t,i,n){if("object"!=typeof e||"number"!=typeof e.width||"number"!=typeof e.height)return e;"boolean"!=typeof i&&(i=!1);var s=e.width,o=e.height;if((0,I.kJ)(t)&&t.length>1&&(s=t[0],o=t[1]),i&&s===e.width&&o===e.height)return e;var r=(0,z.E4)(s,o);return r.drawImage(e,0,0),i&&n&&(this.imageByContext_[n]=r.canvas),r.canvas}getImage(e){var t=super.getImage();if(this.state!==F.Z.LOADED)return t;var i=(0,D.sq)(t);if(i in this.imageByContext_)return this.imageByContext_[i];var n=this.source.getPostTileLoadFunction(),s=this.source.tileGrid.tileSize_;if("function"!=typeof n)return this.getRenderedTileAsContext(t,s,!0,i);t=this.getRenderedTileAsContext(t);try{var o=n.call(this,t);return null===o&&(o=t),this.imageByContext_[i]=o,o}catch(e){return t}}}const G=H,U=function(e){var t=e||{};this.id_=t.image||-1,("number"!=typeof this.id_||this.id_<=0)&&console.error("Image id must be a strictly positive integer"),this.cache_version_=0,this.width_=t.width||-1,("number"!=typeof this.width_||this.width_<=0)&&console.error("Image width must be a strictly positive integer"),this.height_=t.height||-1,("number"!=typeof this.height_||this.height_<=0)&&console.error("Image height must be a strictly positive integer"),this.plane_=t.plane||0,("number"!=typeof this.plane_||this.plane_<0)&&console.error("Image plane must be a non negative integer"),this.time_=t.time||0,("number"!=typeof this.time_||this.time_<0)&&console.error("Image time must be a non negative integer"),this.channels_info_=(0,I.kJ)(t.channels)?[].concat(t.channels):[],this.updateSavedSettings(),this.projection_opts_={start:t.img_proj.start,end:t.img_proj.end},this.image_projection_=t.img_proj.projection,this.setImageProjection(this.image_projection_,this.projection_opts_),this.image_model_="g",this.setImageModel(t.img_model),this.resolutions_=(0,I.kJ)(t.resolutions)?t.resolutions:[1],this.tiled_=t.tiled,this.use_tiled_retrieval_=this.tiled_||this.width_*this.height_>O.y9,this.tile_size_=this.use_tiled_retrieval_?t.tile_size:{width:this.width_,height:this.height_},this.server_=t.server,null===this.server_&&console.error("The given server information is invalid!"),this.uri_=(0,E.$2)(t.uri+"/"+(this.use_tiled_retrieval_?"render_image_region":"render_image")),this.postTileLoadFunction_=null,this.render_status_=O.PP.NOT_WATCHED,this.render_watch_=null,this.tileUrlFunction_=function(e,t,i){if(e){var n=this.server_.full+"/"+this.uri_.full+"/"+this.id_+"/"+this.plane_+"/"+this.time_+"/?";if(this.tiled_||this.use_tiled_retrieval_){var s=this.tiled_?this.tileGrid.resolutions_.length-e[0]-1:0;this.tiled_?n+="tile="+s+","+e[1]+","+(-e[2]-1):n+="region="+e[1]*this.tileGrid.tileSize_[0]+","+(-e[2]-1)*this.tileGrid.tileSize_[1],n+=","+this.tileGrid.tileSize_[0]+","+this.tileGrid.tileSize_[1]+"&"}var o=[];n+="c=";for(var r=this.channels_info_.length,a=0;a<r;a++){var l=this.channels_info_[a];0!=a&&(n+=","),n+=(l.active?"":"-")+(a+1),n+="|"+l.start+":"+l.end,n+="$"+l.color;var h={};if(l.active){h.inverted={enabled:"boolean"==typeof l.inverted&&l.inverted};var d=l.family,c="linear"!==d||"linear"===d&&"linear"!==this.saved_channels_info_[a].family;"string"==typeof d&&""!==d&&c&&"number"==typeof l.coefficient&&!isNaN(l.coefficient)&&(h.quantization={family:d},"linear"!==d&&"logarithmic"!==d&&(h.quantization.coefficient=l.coefficient))}o.push(h)}return n+="&maps="+JSON.stringify(o),n+="&m="+this.image_model_,n+="&p="+this.image_projection_,this.image_projection_===O.PO.INTMAX&&"object"==typeof this.projection_opts_&&null!==this.projection_opts_&&(n+="|"+this.projection_opts_.start+":"+this.projection_opts_.end),n+"&q=0.9"}};var i=[0,-this.height_,this.width_,0],n=new M.Z({tileSize:this.tile_size_?[this.tile_size_.width,this.tile_size_.height]:[O.AQ.width,O.AQ.height],extent:i,origin:(0,_.rL)(i),resolutions:this.resolutions_});N.Z.call(this,{transition:0,crossOrigin:t.crossOrigin,tileClass:G,tileGrid:n,tileUrlFunction:this.tileUrlFunction_})};(0,D.XW)(U,N.Z),U.prototype.createTile_=function(e,t,i,n,s,o){var r=[e,t,i],a=this.getTileCoordForTileUrlFunction(r,s),h=a?this.tileUrlFunction(a,n,s):void 0,d=new this.tileClass(r,void 0!==h?F.Z.IDLE:F.Z.EMPTY,void 0!==h?h:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return d.key=o,d.source=this,(0,l.oL)(d,j.Z.CHANGE,this.handleTileChange,this),d},U.prototype.getKey=function(){return this.cache_version_},U.prototype.getWidth=function(){return this.width_},U.prototype.getHeight=function(){return this.height_},U.prototype.getPlane=function(){return this.plane_},U.prototype.setPlane=function(e){("number"!=typeof e||e<0)&&console.error("Image plane must be a non negative integer"),this.plane_=e},U.prototype.getTime=function(){return this.time_},U.prototype.setTime=function(e){("number"!=typeof e||e<0)&&console.error("Image time must be a non negative integer"),this.time_=e},U.prototype.getChannels=function(){for(var e=[],t=0;t<this.channels_info_.length;t++)this.channels_info_[t].active&&e.push(t);return e},U.prototype.setChannels=function(e){if((0,I.kJ)(e)){var t=this.channels_info_.length;for(var i in e)"number"!=typeof e[i]||e[i]<0||e[i]>=t||(this.channels_info_[i].active=!0)}},U.prototype.updateSavedSettings=function(){this.saved_channels_info_=this.channels_info_.map((e=>Object.assign({},e)))},U.prototype.setImageProjection=function(e,t){if("string"==typeof e&&0!==e.length)try{this.image_projection_=O.PO[e.toUpperCase()],"object"==typeof t&&"number"==typeof t.start&&t.start>=0&&"number"==typeof t.end&&t.end>=0&&t.end>=t.start?this.projection_opts_={start:t.start,end:t.end}:this.projection_opts_=null}catch(e){}},U.prototype.setImageModel=function(e){"string"!=typeof e||0===e.length||"greyscale"!==e.toLowerCase()&&"color"!==e.toLowerCase()&&"g"!==e.toLowerCase()&&"c"!==e.toLowerCase()||(this.image_model_=e[0])},U.prototype.changeChannelRange=function(e){if(!(0,I.kJ)(e))return!1;var t=!1,i="g"===this.image_model_.toLowerCase();for(var n in e){var s=e[n];if(!("object"!=typeof s||"number"!=typeof s.index||s.index<0||s.index>=this.channels_info_.length||"number"!=typeof s.start||"number"!=typeof s.end)){var o=s.index;"boolean"==typeof s.active&&this.channels_info_[o].active!==s.active&&(this.channels_info_[o].active=s.active,t=!0);var r=this.channels_info_[o].active;this.channels_info_[o].start===s.start&&this.channels_info_[o].end===s.end||(this.channels_info_[o].start=s.start,this.channels_info_[o].end=s.end,r&&(t=!0)),"string"==typeof s.color&&0!==s.color.length&&this.channels_info_[o].color!==s.color&&(this.channels_info_[o].color=s.color,r&&!i&&(t=!0)),"boolean"==typeof s.inverted&&this.channels_info_[o].inverted!==s.inverted&&(this.channels_info_[o].inverted=s.inverted,r&&(t=!0)),"string"==typeof s.family&&""!==s.family&&this.channels_info_[o].family!==s.family&&(this.channels_info_[o].family=s.family,r&&(t=!0)),"number"!=typeof s.coefficient||isNaN(s.coefficient)||this.channels_info_[o].coefficient===s.coefficient||(this.channels_info_[o].coefficient=s.coefficient,r&&(t=!0))}}return t},U.prototype.captureImageSettings=function(){var e={projection:this.image_projection_===O.PO.INTMAX?this.image_projection_+"|"+this.projection_opts_.start+":"+this.projection_opts_.end:this.image_projection_,model:this.image_model_,channels:[],time:this.time_,plane:this.plane_};for(var t in this.channels_info_){var i=this.channels_info_[t],n={active:i.active,color:i.color,window:{min:i.min,max:i.max,start:i.start,end:i.end}};"boolean"==typeof i.inverted&&(n.inverted=i.inverted),"string"!=typeof i.family||""===i.family||"number"!=typeof i.coefficient||isNaN(i.coefficient)||(n.family=i.family,n.coefficient=i.coefficient),e.channels.push(n)}return e},U.prototype.getPostTileLoadFunction=function(){return this.postTileLoadFunction_},U.prototype.setPostTileLoadFunction=function(e){"function"==typeof e&&(this.postTileLoadFunction_=e)},U.prototype.clearPostTileLoadFunction=function(){this.postTileLoadFunction_=null},U.prototype.watchRenderStatus=function(e,t){if(null!==this.render_watch_)return!1;"boolean"!=typeof t&&(t=!1);var i=0,n=0;return this.render_watch_=e.once("postrender",(function(e){var s=function(e){++i},o=function e(t){++n>=i&&(this.un("tileloadstart",s),this.un("tileloadend",e,this),this.un("tileloaderror",e,this),this.render_status_=O.PP.RENDERED,this.render_watch_=null)},r=t?function(e){++n,this.un("tileloadstart",s),this.un("tileloadend",o,this),this.un("tileloaderror",r,this),this.render_status_=O.PP.ERROR,this.render_watch_=null}:o;this.on("tileloadstart",s),this.on("tileloadend",o,this),this.on("tileloaderror",r,this),this.render_status_=O.PP.IN_PROGRESS,setTimeout(function(){0===i&&(this.un("tileloadstart",s),this.un("tileloadend",o,this),this.un("tileloaderror",r,this),this.render_status_=O.PP.NOT_WATCHED,this.render_watch_=null)}.bind(this),50)}),this),!0},U.prototype.getRenderStatus=function(e){"boolean"!=typeof e&&(e=!1);var t=this.render_status_;return e&&(this.render_status_=O.PP.NOT_WATCHED),t},U.prototype.disposeInternal=function(){this.tileCache instanceof L.Z&&this.tileCache.clear(),this.channels_info_=[]};const V=U;var Y=i(7630),q=i(6866),$=i(7674);class B extends n.ZP{constructor(e,t){super();var i=t||{};this.id_=e||-1;try{this.id_=parseInt(this.id_)}catch(t){e=-1}this.server_=(0,E.at)(i.server||""),this.initParams_=i.initParams||{},this.prefixed_uris_={},this.readPrefixedUris(this.initParams_),this.tried_regions_=!1,this.tried_regions_data_=!1,this.sync_group_=null,this.container_="ome-viewer","string"==typeof i.container&&(this.container_=i.container),this.image_info_="object"==typeof i.data?i.data:null,this.regions_=null,this.enable_shape_popup=!0,this.viewerState_={},this.viewer_=null,this.eventbus_="object"==typeof i.eventbus&&"function"==typeof i.eventbus.publish?i.eventbus:null,this.prevent_event_notification_=!1,this.supportsOmeroServerVersion=function(e){if("number"==typeof e)e=""+e;else if("string"!=typeof e)return!1;if(e=parseInt(e.replace(/[.]/g,"")),isNaN(e)||3!==(""+e).length)return!1;let t=this.getInitialRequestParam($.Yj.OMERO_VERSION);return"string"==typeof t&&(t=parseInt(t.replace(/[.]/g,"")),!isNaN(t)&&t>=e)},this.initialize_=function(e,t){if(!(this.id_<0))if(null===this.image_info_){var i=function(i){if("string"==typeof i)try{i=JSON.parse(i)}catch(e){console.error("Failed to parse json response!")}"object"==typeof i?(this.image_info_=i,this.bootstrapOpenLayers(e,t)):console.error("Image Request did not receive proper response!")}.bind(this),n={server:this.getServer(),uri:this.getPrefixedURI(O.YH)+"/imgData/"+this.id_,jsonp:!0,success:i,error:function(e){console.error("Error retrieving image info for id: "+this.id_+(e&&e.length>0?" => "+e:""))}.bind(this)};(0,E.wG)(n)}else this.bootstrapOpenLayers(e,t)},this.initialize_()}bootstrapOpenLayers(e,t){if(void 0===this.image_info_.size)return void console.error("Image Info does not contain size info!");"function"==typeof t&&t.call(this);var i=null,n=this.image_info_.size;if(this.image_info_.zoomLevelScaling){var o=[];for(var r in this.image_info_.zoomLevelScaling){var a=1/this.image_info_.zoomLevelScaling[r];if(a<=o[o.length-1])break;o.push(a)}i=o.reverse()}var d=i?i.length:-1,p=this.getInitialRequestParam($.Yj.PROJECTION),_=(0,I.ef)(null!==p?p.toLowerCase():this.image_info_.rdefs.projection);p=_.projection;var v=this.getInitialRequestParam($.Yj.MODEL);switch((v=null!==v?v:this.image_info_.rdefs.model).toLowerCase()[0]){case"c":default:v="color";break;case"g":v="greyscale"}var y=[n.width/2,-n.height/2],b="object"==typeof this.image_info_.pixel_size&&"number"==typeof this.image_info_.pixel_size.x?this.image_info_.pixel_size.x:null,w=new c.Z({code:"OMERO",units:"pixels",extent:[0,0,n.width,n.height],metersPerUnit:b}),x=this.getInitialRequestParam($.Yj.TIME);(x=null!==x?parseInt(x)-1:this.image_info_.rdefs.defaultT)<0&&(x=0),x>=n.t&&(x=n.t-1);var S=this.getInitialRequestParam($.Yj.PLANE);(S=null!==S?parseInt(S)-1:this.image_info_.rdefs.defaultZ)<0&&(S=0),S>=n.z&&(S=n.z-1);var C=this.getInitialRequestParam($.Yj.CENTER_X),T=this.getInitialRequestParam($.Yj.CENTER_Y);let E;C&&!isNaN(parseFloat(C))&&T&&!isNaN(parseFloat(T))&&(C=parseFloat(C),T=parseFloat(T),E=[C=Math.min(Math.max(0,C),n.width),-(T=Math.min(Math.max(0,T),n.height))]);var A=this.getInitialRequestParam($.Yj.CHANNELS),R=this.getInitialRequestParam($.Yj.MAPS);A=(0,I.Hm)(A,R);var P="True"===this.getInitialRequestParam($.Yj.ENABLE_MIRROR),k=[];this.image_info_.channels.forEach((function(e,t){var i={active:e.active,label:"string"==typeof e.label?e.label:t,color:"string"==typeof e.lut&&e.lut.length>0?e.lut:e.color,min:e.window.min,max:e.window.max,start:e.window.start,end:e.window.end};"boolean"==typeof e.inverted&&(i.inverted=e.inverted),"string"!=typeof e.family||""===e.family||"number"!=typeof e.coefficient||isNaN(e.coefficient)||(i.family=e.family,i.coefficient=e.coefficient),k.push(i)}));var N="boolean"==typeof this.image_info_.tiles&&this.image_info_.tiles,L=new V({server:this.getServer(),uri:this.getPrefixedURI(O.YH),image:this.id_,width:n.width,height:n.height,plane:S,time:x,channels:k,resolutions:d>1?i:[1],img_proj:_,img_model:v,tiled:N,tile_size:N&&this.supportsOmeroServerVersion("5.4.4")?O.AQ:this.image_info_.tile_size?this.image_info_.tile_size:null});L.changeChannelRange(A,!1);var M,j=d>1?i[0]:1,F=this.getInitialRequestParam($.Yj.ZOOM),D=(0,I.Lc)(i);if(F&&!isNaN(parseFloat(F))){F=1/(parseFloat(F)/100);var z=D.length;if(z>1){if(F>=D[0])M=D[0];else if(F<=D[z-1])M=D[z-1];else for(r=0;r<z-1;r++)if(!(F<D[r+1])){M=Math.abs(D[r]-F)<Math.abs(D[r+1]-F)?D[r]:D[r+1];break}}else M=1}let Z=D[D.length-1];Z>.5&&(D.push(Z/2),D.push(Z/4));var H=new u.ZP({projection:w,center:y,extent:[0,-n.height,n.width,0],resolutions:D,resolution:j,maxZoom:D.length-1}),G=(0,O.Nj)(),U=new h.Z;for(var Y in G)U.push(G[Y].ref),this.viewerState_[Y]=G[Y];var q=(0,O.yJ)(),B=new h.Z;for(var W in q)B.push(q[W].ref),this.viewerState_[W]=q[W];this.viewer_=new f.Z({logo:!1,controls:B,interactions:U,layers:[new g.Z({source:L})],target:this.container_,view:H});var X={url:this.getPrefixedURI(O.YH)+"/render_thumbnail/"+this.id_,size:[n.width,n.height],collapsed:!L.use_tiled_retrieval_};if(this.addControl("birdseye",X),P){var Q="true"===this.getInitialRequestParam($.Yj.FLIP_X),J="true"===this.getInitialRequestParam($.Yj.FLIP_Y);H.setProperties({flipX:!1,flipY:!1}),this.image_info_.flipX&&(Q=this.image_info_.flipX),this.image_info_.flipY&&(J=this.image_info_.flipY),this.addControl("mirror",{flipX:Q,flipY:J})}var K=this.getTargetId(),ee=K?document.getElementById(K):null;K&&ee&&(this.viewerState_.fullscreen.ref.source_=ee,this.viewerState_.dragPan.ref.condition_=function(e){return(0,m.rM)(e)&&(0,m.Xp)(e)}),this.toggleScaleBar(!0),this.toggleIntensityControl(!0);var te=function(e){(0,I.qD)(e,"IMAGE_VIEWER_INTERACTION",e.getViewParameters())};if(this.image_info_.center||E||this.image_info_.resolution||this.image_info_.rotation||M){let e=this.image_info_.center||E,t=this.image_info_.resolution||M,i=this.image_info_.rotation;setTimeout(function(){this.setViewParameters(e,t,i)}.bind(this),100)}this.onViewResolutionListener=(0,l.oL)(this.viewer_.getView(),"change:resolution",(function(e){this.displayResolutionInPercent(),this.eventbus_&&te(this)}),this),this.displayResolutionInPercent(),this.onViewRotationListener=(0,l.oL)(this.viewer_.getView(),"change:rotation",(function(e){var t=this.getRegions();t&&t.changed(),this.eventbus_&&te(this)}),this),this.onViewFlipXListener=(0,l.oL)(this.viewer_.getView(),"change:flipX",(function(e){this.eventbus_&&te(this)}),this),this.onViewFlipYListener=(0,l.oL)(this.viewer_.getView(),"change:flipY",(function(e){this.eventbus_&&te(this)}),this),"function"==typeof e&&e.call(this),this.tried_regions&&this.addRegions(),this.eventbus_&&(this.onEndMoveListener=(0,l.oL)(this.viewer_,s.Z.MOVEEND,(function(e){te(this)}),this))}show(){var e=document.getElementById(this.container_);e&&(e.style.visibility="visible")}hide(){var e=document.getElementById(this.container_);e&&(e.style.visibility="hidden")}addRegions(e){if(!(this.viewer_ instanceof f.Z))return this.tried_regions_=!0,void((0,I.kJ)(e)&&(this.tried_regions_data_=e));if(this.tried_regions_=!1,this.tried_regions_data_=null,!(this.regions_ instanceof Y.Z)){var t={};e&&(t.data=e),this.regions_=new Y.Z(this,t),this.regions_&&(this.viewer_.addLayer(new p.Z({source:this.regions_})),this.regions_.setModes([O.uo.SELECT,O.uo.MODIFY,O.uo.TRANSLATE])),new T(this.regions_)}}setRegionsVisibility(e,t){var i=this.getRegionsLayer();if(i){var n=e||!1;(0,I.kJ)(t)&&0!==t.length?this.getRegions().setProperty(t,"visible",n):i.setVisible(n)}}showShapeComments(e){var t=this.getRegions();t&&"boolean"==typeof e&&(t.show_comments_=e,t.changed())}enableShapePopup(e){this.enable_shape_popup=e,e&&this.viewer_.getOverlays().forEach((e=>{e.updatePopupVisibility&&e.updatePopupVisibility()}))}selectShapes(e,t,i,n,s){var o=this.getRegions();if(null!==o&&null!==o.select_&&("boolean"==typeof i&&i&&o.select_.clearSelection(),o.setProperty(e,"selected",t),"object"==typeof o.idIndex_[n])){let e,t=o.idIndex_[n].getGeometry(),i=!1;if(s){let n=t.getExtent(),s=n[2]-n[0],o=n[3]-n[1],a=Math.max(s,o);e=Math.max(a/300,1);var r=this.viewer_.getView().getResolution();e<r&&(i=!0),e=Math.min(e,r)}this.centerOnGeometry(t,e,i)}}deleteShapes(e,t,i){var n=this.getRegions();null!==n&&n.setProperty(e,"state","boolean"==typeof t&&t?O.HI.ROLLBACK:O.HI.REMOVED,"function"==typeof i?i:null)}centerOnGeometry(e,t,i){if(e instanceof o.Z){if("number"==typeof t&&!isNaN(t)){var n=this.viewer_.getView().constrainResolution(t);"number"==typeof n&&this.viewer_.getView().setResolution(n)}if(!(0,_.kK)(e.getExtent(),this.viewer_.getView().calculateExtent())||i){var s=this.viewer_.getView().getRotation();if(e.getType()===r.Z.CIRCLE){var l=e.getExtent();(e=(0,a.oJ)(l)).rotate(s,(0,_.qg)(l))}for(var h=e.getFlatCoordinates(),d=Math.cos(-s),c=Math.sin(-s),g=1/0,p=1/0,u=-1/0,f=-1/0,m=e.getStride(),v=0,y=h.length;v<y;v+=m){var b=h[v]*d-h[v+1]*c,w=h[v]*c+h[v+1]*d;g=Math.min(g,b),p=Math.min(p,w),u=Math.max(u,b),f=Math.max(f,w)}var x=(g+u)/2,I=(p+f)/2,S=x*d-I*(c=-c),C=I*d+x*c;this.viewer_.getView().setCenter([S,C])}}}removeRegions(){if(this.regions_ instanceof Y.Z&&(this.regions_.setModes([O.uo.DEFAULT]),this.regions_.dispose(),this.regions_=null),this.getRegionsLayer())for(var e=this.viewer_.getLayers().getLength()-1;e>0;e--){var t=this.viewer_.getLayers().item(e);t.setSource(null),t.sourceChangeKey_=null,this.viewer_.getLayers().removeAt(e)}}setTextBehaviorForRegions(e,t){this.getRegionsLayer()&&(this.getRegions().setScaleText(e),this.getRegions().setRotateText(t))}addInteraction(e,t){if("object"==typeof t&&null!==t){var i="object"==typeof O.hL[e]?O.hL[e]:null;null!=i&&t instanceof i.clazz&&this.viewer_ instanceof f.Z&&"string"==typeof e&&"object"!=typeof this.viewerState_[e]&&(this.viewer_.addInteraction(t),this.viewerState_[e]={type:"interaction",ref:t,defaults:!1,links:[]})}else this.addInteractionOrControl(e,"interaction",!0)}addControl(e,t){this.addInteractionOrControl(e,"control",!0,t)}addInteractionOrControl(e,t,i,n){if(this.viewer_ instanceof f.Z&&"string"==typeof e&&"string"==typeof t&&"object"!=typeof this.viewerState_[e]){var s=!0;"boolean"==typeof i&&(s=i);var o="control"===t?"object"==typeof O.HP[e]?O.HP[e]:null:"object"==typeof O.hL[e]?O.hL[e]:null;if(null!=o){var r=o.clazz;if("object"==typeof n&&!(0,I.kJ)(n))for(var a in n)o.options[a]=n[a];var l=new r(o.options);if("control"===t?this.viewer_.addControl(l):this.viewer_.addInteraction(l),this.viewerState_[e]={type:t,ref:l,defaults:o.defaults,links:o.links},s)for(var h in o.links)this.addInteractionOrControl(o.links[h],"control"===t?"interaction":"control",!1)}}}removeInteractionOrControl(e,t){if(this.viewer_ instanceof f.Z&&"string"==typeof e&&"object"==typeof this.viewerState_[e]){var i=this.viewerState_[e],n=!0;if("boolean"==typeof t&&(n=t),"control"===i.type?this.viewer_.getControls().remove(i.ref):this.viewer_.getInteractions().remove(i.ref),"function"==typeof i.ref.disposeInternal&&"function"==typeof i.ref.dispose&&i.ref.dispose(),delete this.viewerState_[e],n)for(var s in i.links)this.removeInteractionOrControl(i.links[s],!1)}}setDimensionIndex(e,t){if("string"==typeof e&&0!==e.length&&(0,I.kJ)(t)){var i=e.substr(0,1).toLowerCase(),n=this.getImage(),s="object"==typeof O.Az[i]?O.Az[i]:null;if(null!==n&&null!=s&&s.settable){var o;for(var r in"x"===e&&(e="width"),"y"===e&&(e="height"),o=this.image_info_.size[e],t){if("string"==typeof t[r]&&(t[r]=parseInt(t[r])),"number"!=typeof t[r]||t[r]<0)return;if(t[r]=parseInt(t[r]),t[r]>o)return}var a="set"+s.method;try{n[a]("c"!==e?t[0]:t)}catch(e){return}this.affectImageRender(n.use_tiled_retrieval_&&"c"===e),this.getRegionsLayer()&&this.getRegions().changed(),this.viewer_.getOverlays().forEach((e=>{e.updatePopupVisibility&&e.updatePopupVisibility()}))}}}getDimensionIndex(e){if("string"==typeof e&&0!==e.length){var t=e.substr(0,1).toLowerCase(),i=this.getImage();if(null!=i){var n="object"==typeof O.Az[t]?O.Az[t]:null;if(null!=n){var s="get"+n.method;try{return i[s]()}catch(e){return null}}}}}addPostTileLoadHook(e){var t=this.getImage();t&&(t.setPostTileLoadFunction(e),this.affectImageRender())}removePostTileLoadHook(){var e=this.getImage();e&&(e.clearPostTileLoadFunction(),this.affectImageRender())}getImageLayer(){return this.viewer_ instanceof f.Z&&0!=this.viewer_.getLayers().getLength()?this.viewer_.getLayers().item(0):null}getRegionsLayer(){return!(this.viewer_ instanceof f.Z)||this.viewer_.getLayers().getLength()<2?null:this.viewer_.getLayers().item(this.viewer_.getLayers().getLength()-1)}getImage(){var e=this.getImageLayer();return e?e.getSource():null}getRegions(){var e=this.getRegionsLayer();return e?e.getSource():null}getId(){return this.id_}getPrefixedURI(e){if("string"!=typeof this.prefixed_uris_[e])return null;var t=this.prefixed_uris_[e];if("string"==typeof t&&t.length>1){for(var i=t.length-1;i>0&&"/"===t[i];)t=t.substring(0,i),i--;"/"!==t[0]&&(t="/"+t)}return t}readPrefixedUris(e){if("object"==typeof e&&null!==e)for(var t in O.kY){var i=O.kY[t];"string"==typeof e[i]?this.prefixed_uris_[i]=e[i]:this.prefixed_uris_[i]="/"+i.toLowerCase()}}getServer(){return this.server_}setRegionsModes(e){return this.getRegionsLayer()?(this.getRegions().setModes(e),this.getRegions().present_modes_):[]}generateShapes(e,t){if(this.image_info_.perms.canAnnotate&&null!==this.getRegionsLayer()&&"object"==typeof e){"object"==typeof t&&null!==t||(t={});var i="number"==typeof t.number&&t.number>0?t.number:1,n=(0,I.kJ)(t.position)&&2===t.position.length?this.viewer_.getCoordinateFromPixel(t.position):null,s=(0,I.kJ)(t.extent)&&4===t.extent.length?t.extent:this.getViewExtent(),o=(0,I.kJ)(t.theDims)&&t.theDims.length>0?t.theDims:[{z:this.getDimensionIndex("z"),t:this.getDimensionIndex("t"),c:-1}],r=o.length;if(!(r!==i&&r>1)){var a=1===r&&i>1,l=(0,A.mE)(e,i,s,n,"boolean"==typeof t.is_compatible&&t.is_compatible);if(null!==l&&(a||l.length===o.length)){for(var d=0;d<l.length;d++){var c=l[d];c.TheZ=a?o[0].z:o[d].z,c.TheT=a?o[0].t:o[d].t;var g=a?o[0].c:"number"==typeof o[d].c?o[d].c:-1;c.TheC=g,this.viewer_.getView().getResolution();var p=this.viewer_.getView().getRotation();c.getGeometry()instanceof P.Z&&0!==p&&!this.getRegions().rotate_text_&&c.getGeometry().rotate(-p),(0,R.Ru)(c,this.regions_,!0),this.getRegions().getLengthAndAreaForShape(c,!0)}if(this.getRegions().addFeatures(l),this.eventbus_){var u=(0,k.ZQ)(new h.Z(l),!0);if("object"!=typeof u||!(0,I.kJ)(u.new)||0===u.new.length)return;var f={shapes:u.new};"number"==typeof t.hist_id&&(f.hist_id=t.hist_id),"boolean"==typeof t.add_history&&(f.add_history=t.add_history),(0,I.qD)(this,"REGIONS_SHAPE_GENERATED",f,25)}}}}}getViewExtent(){return this.viewer_ instanceof f.Z||null===this.viewer_.getView()?this.viewer_.getView().calculateExtent(this.viewer_.getSize()):null}getSmallestViewExtent(){var e=this.getViewExtent();if(null!==e){var t=this.viewer_.getView().getProjection().getExtent(),i=t.slice();return i[1]=-i[3],i[3]=0,e[0]>t[0]&&(i[0]=e[0]),e[1]>-t[3]&&(i[1]=e[1]),e[2]<t[2]&&(i[2]=e[2]),e[3]<t[1]&&(i[3]=e[3]),i}}getFeatureCollection(e){if(!(0,I.kJ)(e)||0===e.length||null===this.regions_.idIndex_)return null;var t=new h.Z;for(var i in e)try{var n=this.regions_.idIndex_[e[i]];if(n.state===O.HI.REMOVED||n.getGeometry()instanceof q.Z||"object"==typeof n.permissions&&null!==n.permissions&&"boolean"==typeof n.permissions.canEdit&&!n.permissions.canEdit)continue;t.push(n)}catch(e){}return t}modifyRegionsStyle(e,t,i){this.regions_ instanceof Y.Z&&"object"==typeof e&&null!==e&&((0,R.$T)(e,this.regions_,this.getFeatureCollection(t),i),e.hasOwnProperty("Text")&&this.viewer_.getOverlays().forEach((i=>{i.updatePopupText&&i.updatePopupText(t,e.Text)})))}modifyShapesAttachment(e,t,i){if(this.regions_ instanceof Y.Z&&"object"==typeof e&&null!==e){var n=[],s=this.getFeatureCollection(t);if(null!==s){var o=["TheT","TheZ","TheC"];s.forEach((function(t){for(var i in e)-1!==o.indexOf(i)&&"number"==typeof e[i]&&e[i]>=-1&&t[i]!==e[i]&&(t[i]=e[i],n.push(t.getId()))})),n.length>0&&this.regions_.setProperty(n,"state",O.HI.MODIFIED,i)}}}storeRegions(e,t,i){if(!(this.regions_ instanceof Y.Z))return!1;i="boolean"==typeof i&&i,t="boolean"!=typeof t||t;var n=new h.Z(this.regions_.getFeatures()),s=(0,k.ZQ)(n,t,e);if(0===s.count){if(!i&&s.new_and_deleted.length>0){var o={};for(var r in s.new_and_deleted){var a=s.new_and_deleted[r];"object"==typeof this.regions_.idIndex_[a]&&(this.regions_.removeFeature(this.regions_.idIndex_[a]),o[a]=a)}this.eventbus_&&(0,I.qD)(this,"REGIONS_STORED_SHAPES",{shapes:o})}return!1}return this.regions_.storeRegions(s,i)}drawShape(e,t,i){if(this.image_info_.perms.canAnnotate&&this.regions_ instanceof Y.Z&&"object"==typeof e&&null!==typeof e&&"string"==typeof e.type&&0!==e.type.length){var n=this.regions_.present_modes_.slice();this.setRegionsModes([O.uo.DRAW]),this.regions_.draw_ instanceof v.Z?this.regions_.draw_.drawShape(e,t,i):this.setRegionsModes(n)}}abortDrawing(){this.regions_ instanceof Y.Z&&this.regions_.draw_ instanceof v.Z&&this.regions_.draw_.endDrawingInteraction()}dispose(e){this.removeRegions(),"boolean"!=typeof e&&(e=!1);var t=e?[]:null;if(this.viewer_ instanceof f.Z){if(e&&this.viewerState_){for(var i in this.viewerState_){var n=this.viewerState_[i];this.removeInteractionOrControl(i),"object"==typeof n&&n.defaults&&t.push({key:i,type:n.type})}this.viewerState_={}}else this.viewerState_={},this.viewer_.getControls().clear(),this.viewer_.getInteractions().clear();var s=this.getImage();s&&s.dispose(),this.viewer_.getLayers().clear(),this.viewer_.getOverlays().clear(),void 0!==this.onEndMoveListener&&this.onEndMoveListener&&(0,l.bN)(this.onEndMoveListener),void 0!==this.onViewResolutionListener&&this.onViewResolutionListener&&(0,l.bN)(this.onViewResolutionListener),void 0!==this.onViewRotationListener&&this.onViewRotationListener&&(0,l.bN)(this.onViewRotationListener),this.viewer_.dispose()}return this.initParams_={},this.image_info_=null,this.viewer_=null,t}destroyViewer(){this.dispose(),this.eventbus_&&(this.eventbus_=null)}changeChannelRange(e){var t=this.getImage();null!==t&&(t.changeChannelRange(e)&&this.affectImageRender(),this.getRegionsLayer()&&this.getRegions().changed())}changeImageProjection(e,t){null!==this.getImage()&&(this.getImage().setImageProjection(e,t),this.affectImageRender(),this.getRegionsLayer()&&this.getRegions().changed())}changeImageModel(e){null!==this.getImage()&&(this.getImage().setImageModel(e),this.affectImageRender())}updateSavedSettings(){null!==this.getImage()&&this.getImage().updateSavedSettings()}toggleScaleBar(e){if(null===this.getImage()||"object"!=typeof this.image_info_.pixel_size||"number"!=typeof this.image_info_.pixel_size.x)return!1;if("boolean"!=typeof e&&(e=!1),"object"!=typeof this.viewerState_.scalebar)return e&&this.addControl("scalebar"),!0;try{this.viewerState_.scalebar.ref.element_.style.display=e?"":"none"}catch(e){return!1}return!0}toggleIntensityControl(e){var t="object"==typeof this.viewerState_.intensity;(t||e)&&(!t||e?(t||this.addControl("intensity"),this.viewerState_.intensity.ref.enable(this.getPrefixedURI(O.TQ))):this.removeInteractionOrControl("intensity"))}redraw(e){if(this.viewer_){var t=function(){this.viewer_&&this.viewer_.updateSize()}.bind(this);if("number"!=typeof e||e<=0)return void t();setTimeout(t,e)}}getTargetId(){return(0,I.sn)(this.viewer_.getTargetElement())}getInitialRequestParam(e){return"string"!=typeof e||"object"!=typeof this.initParams_?null:(e=e.toUpperCase(),void 0===this.initParams_[e]||null===typeof this.initParams_[e]?null:this.initParams_[e])}captureViewParameters(){if(null===this.getImage())return null;var e=this.viewer_.getView().getCenter(),t=this.getImage().captureImageSettings();return t.resolution=this.viewer_.getView().getResolution(),t.center=[e[0],-e[1]],t}doHistory(e,t){"number"==typeof e&&null!==this.getRegions()&&this.getRegions().doHistory(e,t)}getShapeDefinition(e){return null===this.getRegions()||"string"!=typeof e||"object"!=typeof this.getRegions().idIndex_[e]?null:(0,k.y_)(this.getRegions().idIndex_[e])}displayResolutionInPercent(){var e=this.getTargetId(),t=document.getElementById(""+e).querySelectorAll(".ol-zoom-display");"object"==typeof t&&"number"==typeof t.length&&0!==t.length&&(t[0].value=Math.round(1/this.viewer_.getView().getResolution()*100))}watchRenderStatus(e){return this.getImage().watchRenderStatus(this.viewer_,e)}getRenderStatus(e){return this.getImage().getRenderStatus(e)}enableSmoothing(e){this.viewer_.once("precompose",(function(t){t.context.imageSmoothingEnabled=e,t.context.webkitImageSmoothingEnabled=e,t.context.mozImageSmoothingEnabled=e,t.context.msImageSmoothingEnabled=e})),this.viewer_.updateSize()}sendCanvasContent(e){var t="boolean"==typeof(e=e||{}).all_configs&&e.all_configs;if(null!==this.viewer_&&null!==this.eventbus_){var i=e.zip_entry,n=!1;try{new Blob(["test text"],{type:"text/plain"})instanceof Blob&&(n=!0)}catch(e){}var s=this,o=function(o){if(t&&e.count--,null!==s.eventbus_){if(e.supported=n,n&&t){var r=i+".png";if("object"==typeof e.zip.files[r]){var a=1;for(r=i+"-"+a+".png";"object"==typeof e.zip.files[r];)++a,r=i+"-"+a+".png"}e.zip.file(r,o)}else e.data=o;(0,I.qD)(s,"IMAGE_CANVAS_DATA",e)}},r=this.getImage();if(null!==r&&n){var a=0,l=0,h=function(){++a},d=function(e){navigator.msSaveBlob?o(e.msToBlob()):e.toBlob((function(e){o(e)}))},c=function e(){++l;var t=this;a===l&&(r.un("tileloadstart",h),r.un("tileloadend",e,t.canvas),r.un("tileloaderror",e,t.canvas),d(t.canvas))};this.viewer_.once("postcompose",(function(t){r.on("tileloadstart",h),r.on("tileloadend",c,t.context),r.on("tileloaderror",c,t.context),setTimeout((function(){if(0===a){r.un("tileloadstart",h),r.un("tileloadend",c,t.context),r.un("tileloaderror",c,t.context);let i=document.createElement("canvas"),n=i.getContext("2d");i.width=t.context.canvas.width,i.height=t.context.canvas.height,e.flipX&&(n.translate(i.width,0),n.scale(-1,1)),e.flipY&&(n.translate(0,i.height),n.scale(1,-1)),n.drawImage(t.context.canvas,0,0),d(i)}}),50)})),"boolean"==typeof e.full_extent&&e.full_extent&&this.zoomToFit(),this.viewer_.renderSync()}else o()}else t&&e.count--}getLengthAndAreaForShapes(e,t){var i=this.getRegions();if(null===i||!(0,I.kJ)(e)||0===e.length)return[];for(var n=[],s=0;s<e.length;s++)if("string"==typeof e[s]&&"object"==typeof i.idIndex_&&i.idIndex_[e[s]]instanceof d.Z){var o=i.getLengthAndAreaForShape(i.idIndex_[e[s]],t);null!==o&&n.push(o)}return n}setViewParameters(e,t,i){this.prevent_event_notification_=!0;try{if("number"==typeof t&&!isNaN(t)){var n=this.viewer_.getView().constrainResolution(t);"number"==typeof n&&n!==this.viewer_.getView().getResolution()&&this.viewer_.getView().setResolution(n)}var s=this.viewer_.getView().getCenter();(0,I.kJ)(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&s[0]!==e[0]&&s[1]!==e[1]&&this.viewer_.getView().setCenter(e),"number"!=typeof i||isNaN(i)||i===this.viewer_.getView().getRotation()||this.viewer_.getView().setRotation(i),"boolean"==typeof flipX&&(this.viewer_.getView().flipX=flipX),"boolean"==typeof flipY&&(this.viewer_.getView().flipY=flipY),this.viewer_.renderSync()}catch(e){}this.prevent_event_notification_=!1}toggleIntensityQuerying(e){try{return this.viewerState_.intensity.ref.toggleIntensityQuerying(e)}catch(e){return!1}}affectImageRender(e){var t=this.getImageLayer();if(null!==t){var i=t.getSource();try{if("boolean"!=typeof e&&(e=i.use_tiled_retrieval_),e){var n=this.viewer_.getRenderer(t).getLayerRenderer(t).getImage();n.getContext("2d").clearRect(0,0,n.width,n.height),i.tileCache.clear()}else i.cache_version_++;i.changed()}catch(e){}}}setSyncGroup(e){(null===e||"string"==typeof e&&0!==e.length)&&(this.sync_group_=e)}getViewParameters(){if(null===this.viewer_||null===this.getImage())return null;var e=this.viewer_.getView().getProperties();return console.log(e),{z:this.getDimensionIndex("z"),t:this.getDimensionIndex("t"),c:this.getDimensionIndex("c"),w:this.getImage().getWidth(),h:this.getImage().getHeight(),center:e.center.slice(),resolution:e.resolution,rotation:e.rotation,flipX:e.flipX,flipY:e.flipY}}getRois(){if(!(this.regions_ instanceof Y.Z))return[];for(var e={},t=this.regions_.getFeatures(),i=0;i<t.length;i++){var n=t[i];if(n instanceof d.Z&&null!==n.getGeometry()&&("number"!=typeof n.state||n.state===O.HI.DEFAULT)){var s=-1,o=-1;try{var r=n.getId(),a=r.indexOf(":");if(s=parseInt(r.substring(0,a)),o=parseInt(r.substring(a+1)),isNaN(s)||isNaN(o))continue}catch(e){continue}var l=null;"object"==typeof e[s]||(e[s]={"@id":s,"@type":"http://www.openmicroscopy.org/Schemas/OME/2016-06#ROI",shapes:[]}),l=e[s];var h=n.type;try{var c=k.Uw[h].call(null,n.getGeometry(),o);(0,k.uX)(n,c),(0,k.I5)(n,c),c["omero:details"]={permissions:n.permissions},l.shapes.push(c)}catch(e){console.error("Failed to turn feature "+h+"("+n.getId()+") into json => "+e)}}}var g=[];for(var p in e)e[p].shapes.length>0&&g.push(e[p]);return g}refreshBirdsEye(e){if(this.viewer_ instanceof f.Z&&"object"==typeof this.viewerState_.birdseye){("number"!=typeof e||isNaN(e)||e<0)&&(e=0);var t=function(){this.viewerState_.birdseye.ref.initOrUpdate()}.bind(this);0===e?t():setTimeout(t,e)}}zoomToFit(){if(this.viewer_ instanceof f.Z){var e=this.viewer_.getView();if(e){var t=e.getProjection().getExtent();e.fit([t[0],-t[3],t[2],t[1]])}}}}const W=B},4780:(e,t,i)=>{"use strict";i.d(t,{Z:()=>d});var n=i(4922),s=i(5202),o=i(9236),r=i(366),a=i(29);class l extends n.ZP{constructor(e,t,i,n,s){"number"==typeof e&&"number"==typeof t&&"number"==typeof i&&"number"==typeof n||console.error("at least one ellipse param is not numeric!"),super([h(e,t,i,n,s,.1)]),this.cx_=e,this.cy_=t,this.rx_=i,this.ry_=n,this.transform_=(0,o.L9)(s),this.step_=.1}getPolygonCoords(){return h(this.cx_,this.cy_,this.rx_,this.ry_,this.transform_,this.step_)}getTransform(){return(0,o.gQ)(this.transform_)}getCenter(){return[this.cx_,this.cy_]}setCenter(e){(0,r.kJ)(e)&&"number"==typeof e[0]&&"number"==typeof e[1]||console.error("the center needs to be given as a numeric array [cx,cy]"),this.cx_=e[0],this.cy_=e[1]}getRadius(){return[this.rx_,this.ry_]}setRadius(e){(0,r.kJ)(e)&&"number"==typeof e[0]&&"number"==typeof e[1]||console.error("the radius needs to be given as a numeric array [rx,ry]"),this.rx_=e[0],this.ry_=e[1]}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.setCoordinates([this.getPolygonCoords()])):(s.ZP.prototype.translate.call(this,e,t),this.setCenter([this.cx_+e,this.cy_+t]))}scale(e){if(this.transform_)this.transform_[0]*=e,this.transform_[1]*=e,this.transform_[2]*=e,this.transform_[3]*=e,this.setCoordinates([this.getPolygonCoords()]);else{s.ZP.prototype.scale.call(this,e);var t=this.getRadius();this.setRadius([t[0]*e,t[1]*e])}}getLength(){return(0,a.xA)(this)}getArea(){return Math.PI*this.rx_*this.ry_}clone(){return new l(this.cx_,this.cy_,this.rx_,this.ry_,this.getTransform())}getDisplayCoords(){return[["X",this.cx_.toFixed(1)],["Y",-this.cy_.toFixed(1)],["RadiusX",this.rx_.toFixed(1)],["RadiusY",this.ry_.toFixed(1)]]}}function h(e,t,i,n,s,r){for(var a=[],l=0*Math.PI,h=2*Math.PI;l<h;l+=r){var d=e+i*Math.cos(l),c=t+n*Math.sin(l);a.push((0,o.Ne)(s,[d,c]))}return a.length>0&&a.push(a[0]),a}const d=l},1221:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});var n=i(5202),s=i(9256);class o extends s.Z{constructor(e,t,i){var n=i||null;null!=n&&"number"==typeof n.width&&"number"==typeof n.height||(n={width:10,height:10}),super(e,t,n.width,n.height),this.original_coordinates,this.setOriginalCoordinates=function(){this.original_coordinates=[];var e=this.getFlatCoordinates();for(var t in e)this.original_coordinates.push(e[t])},this.setOriginalCoordinates()}changeRectangle(e,t,i,n){super.changeRectangle(e,t,i,n),this.setOriginalCoordinates()}modifyOriginalCoordinates(e,t){if("number"!=typeof e&&(e=0),"number"!=typeof t&&(t=1),0!=e){var i=[],n=this.getFlatCoordinates();for(var s in n)i.push(n[s]);var o=this.getWidth(),r=this.getHeight();this.applyTransform((function(e,t,i){return t[0]=e[0],t[1]=e[1],t[2]=e[0]+o,t[3]=e[1],t[4]=e[0]+o,t[5]=e[1]-r,t[6]=e[0],t[7]=e[1]-r,t[8]=e[0],t[9]=e[1],t}))}this.setOriginalCoordinates(),0!=e&&this.applyTransform((function(e,t,n){for(var s in i)t[s]=i[s];return t}))}adjustCoordinates(e,t){if("number"==typeof e){var i=this.original_coordinates;this.applyTransform((function(e,t,n){for(var s in i)t[s]=i[s];return t}));var n=this.original_coordinates[2]-this.original_coordinates[0],s=Math.abs(this.original_coordinates[5]-this.original_coordinates[3]);"object"==typeof t&&null!==t&&"number"==typeof t.width&&"number"==typeof t.height&&(n=t.width>0?t.width:1,s=t.height>0?t.height:1),this.resize({width:n,height:s}),0!==e&&this.rotate(e)}}rotate(e){this.applyTransform((function(t,i,n){for(var s=Math.cos(e),o=Math.sin(e),r=[t[0],t[1]],a=2,l=t.length;a<l;a+=2){var h=t[a],d=t[a+1];i[a]=s*(h-r[0])+o*(d-r[1])+r[0],i[a+1]=s*(d-r[1])-o*(h-r[0])+r[1]}return i}))}resize(e){"object"==typeof e&&null!==e&&"number"==typeof e.width&&"number"==typeof e.height&&(e.width<0&&(e.width=1),e.height<0&&(e.height=1),this.applyTransform((function(t,i,n){return i[2]=i[0]+e.width,i[4]=i[0]+e.width,i[5]=i[1]-e.height,i[7]=i[1]-e.height,i})))}translate(e,t){n.ZP.prototype.translate.call(this,e,t),this.setOriginalCoordinates()}clone(){var e=this.getUpperLeftCorner();return new o(e[0],e[1],{width:this.getWidth(),height:this.getHeight()})}}const r=o},1201:(e,t,i)=>{"use strict";i.d(t,{Z:()=>d});var n=i(4078),s=i(5202),o=i(4922),r=i(366),a=i(29),l=i(9236);class h extends n.Z{constructor(e,t,i,n){(!(0,r.kJ)(e)||e.length<2)&&console.error("Line needs a minimum of 2 points!"),super(e),this.initial_coords_=null,this.transform_=(0,l.L9)(n),this.has_start_arrow_="boolean"==typeof t&&t,this.has_end_arrow_="boolean"==typeof i&&i,this.initial_coords_=this.getFlatCoordinates(),this.flatCoordinates=(0,l.Ne)(this.transform_,this.initial_coords_)}isPolyline(){return this.getCoordinates().length>2}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.flatCoordinates=(0,l.Ne)(this.transform_,this.initial_coords_),this.changed()):s.ZP.prototype.translate.call(this,e,t)}getArrowGeometry(e,t,i){"boolean"!=typeof e&&(e=!0),("number"!=typeof t||t<=0)&&(t=10),("number"!=typeof i||i<=0)&&(i=2*t),t/=2;var n=this.getCoordinates(),s=n.length,r=e?s-1:1,a=[n[r][0]-n[r-1][0],n[r][1]-n[r-1][1]];e||(r=0);var l=[n[r][0],n[r][1]],h=Math.sqrt(a[0]*a[0]+a[1]*a[1]),d=[a[0]/h,a[1]/h],c=[-d[1],d[0]],g=e?1:-1,p=[l[0]-g*i*d[0]-t*c[0],l[1]-g*i*d[1]-t*c[1]],u=[l[0]-g*i*d[0]+t*c[0],l[1]-g*i*d[1]+t*c[1]];return new o.ZP([[l,p,u]])}getLineCoordinates(){return this.transform_?this.initial_coords_:this.getFlatCoordinates()}getTransform(){return(0,l.gQ)(this.transform_)}getInvertedCoordinates(){if(null===this.transform_)return this.getCoordinates();for(var e=this.getCoordinates(),t=new Array(e.length),i=0;i<e.length;i++)t[i]=(0,l.HC)(this.transform_,e[i]);return t}clone(){return new h(this.getInvertedCoordinates().slice(),this.has_start_arrow_,this.has_end_arrow_,this.getTransform())}getLength(){return(0,a.xA)(this)}getDisplayCoords(){let e=this.getLineCoordinates();return e=e.map((e=>e.toFixed(1))),4==e.length?[["X1",e[0]],["Y1",-e[1]],["X2",e[2]],["Y2",-e[3]]]:[["points",e.map(((e,t,i)=>t%2==0?"".concat(e,",").concat(-i[t+1]):null)).filter((e=>e)).join(" ")]]}}const d=h},6866:(e,t,i)=>{"use strict";i.d(t,{Z:()=>h});var n=i(2685),s=i(5202),o=i(6993),r=i(9256),a=i(9236);class l extends n.Z{constructor(e,t,i,n,s){("number"!=typeof e||"number"!=typeof t||"number"!=typeof i||"number"!=typeof n||isNaN(e)||isNaN(t)||isNaN(i)||isNaN(n))&&console.error("Mask needs x,y, width and height!"),super([e,t]),this.size_=[i,n],this.initial_coords_=null,this.transform_=(0,a.L9)(s),this.initial_coords_=this.getFlatCoordinates(),this.flatCoordinates=(0,a.Ne)(this.transform_,this.initial_coords_)}getPointCoordinates(){return(this.transform_?this.initial_coords_:this.getFlatCoordinates()).slice(0,2)}getTransform(){return(0,a.gQ)(this.transform_)}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.flatCoordinates=(0,a.Ne)(this.transform_,this.initial_coords_),this.changed()):s.ZP.prototype.translate.call(this,e,t)}clone(){var e=this.getPointCoordinates();return new l(e[0],e[1],this.size_[0],this.size_[1],this.getTransform())}getArea(){return this.size_[0]*this.size_[1]}getLength(){return 2*(this.size_[0]+this.size_[1])}getExtent(){var e=this.getPointCoordinates();return[e[0],e[1]-this.size_[1],e[0]+this.size_[0],e[1]]}intersectsExtent(e){var t=this.getOutline().getRectangleCoordinates();return(0,o.mV)(t,0,[t.length],2,e)}getOutline(){var e=this.getPointCoordinates();return new r.Z(e[0],e[1],this.size_[0],this.size_[1])}getDisplayCoords(){var e=this.getPointCoordinates();return[["X",e[0].toFixed(1)],["Y",e[1].toFixed(1)],["Width",this.size_[0].toFixed(1)],["Height",this.size_[1].toFixed(1)]]}}const h=l},3e3:(e,t,i)=>{"use strict";i.d(t,{Z:()=>l});var n=i(5202),s=i(4070),o=i(9236),r=i(366);class a extends s.Z{constructor(e,t){(0,r.kJ)(e)&&2===e.length||console.error("Point needs an array of coordinates (length: 2)!"),super(e,5),this.radius_=5,this.initial_coords_=null,this.transform_=(0,o.L9)(t),this.initial_coords_=this.getFlatCoordinates(),this.flatCoordinates=(0,o.Ne)(this.transform_,this.initial_coords_)}getPointCoordinates(){return(this.transform_?this.initial_coords_:this.getFlatCoordinates()).slice(0,2)}getTransform(){return(0,o.gQ)(this.transform_)}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.flatCoordinates=(0,o.Ne)(this.transform_,this.initial_coords_),this.changed()):n.ZP.prototype.translate.call(this,e,t)}clone(){return new a(this.getPointCoordinates(),this.getTransform())}getDisplayCoords(){var e=this.getPointCoordinates();return[["X",e[0].toFixed(1)],["Y",-e[1].toFixed(1)]]}}const l=a},2933:(e,t,i)=>{"use strict";i.d(t,{Z:()=>h});var n=i(4922),s=i(5202),o=i(366),r=i(29),a=i(9236);class l extends n.ZP{constructor(e,t){(0,o.kJ)(e)&&0!==e.length||console.error("Polygon needs a non-empty array of coordinates!"),super(e),this.initial_coords_=null,this.transform_=(0,a.L9)(t),this.initial_coords_=this.getFlatCoordinates(),this.flatCoordinates=(0,a.Ne)(this.transform_,this.initial_coords_)}getPolygonCoordinates(){return this.transform_?this.initial_coords_:this.getFlatCoordinates()}getTransform(){return(0,a.gQ)(this.transform_)}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.flatCoordinates=(0,a.Ne)(this.transform_,this.initial_coords_),this.changed()):s.ZP.prototype.translate.call(this,e,t)}getInvertedCoordinates(){if(null===this.transform_)return this.getCoordinates();for(var e=this.getCoordinates(),t=new Array(e[0].length),i=0;i<e[0].length;i++)t[i]=(0,a.HC)(this.transform_,e[0][i]);return[t]}clone(){return new l(this.getInvertedCoordinates(),this.getTransform())}getLength(){return(0,r.xA)(this)}getDisplayCoords(){let e=this.getInvertedCoordinates();return 1!==e.length?[]:(e=e[0],[["Points",e.map((e=>"".concat(e[0].toFixed(1),",").concat(-e[1].toFixed(1)))).join(" ")]])}}const h=l},9256:(e,t,i)=>{"use strict";i.d(t,{Z:()=>d});var n=i(4922),s=i(5202),o=i(3609),r=i(366),a=i(29),l=i(9236);class h extends n.ZP{constructor(e,t,i,n,s){"number"!=typeof e&&(e=0),"number"!=typeof t&&(t=0),("number"!=typeof i||i<=0)&&(i=1),("number"!=typeof n||n<=0)&&(n=1),super([[[e,t],[e+i,t],[e+i,t-n],[e,t-n],[e,t]]],o.Z.XY),this.initial_coords_=null,this.transform_=(0,l.L9)(s),this.initial_coords_=this.getFlatCoordinates(),this.flatCoordinates=(0,l.Ne)(this.transform_,this.initial_coords_)}getUpperLeftCorner(){var e=this.getRectangleCoordinates();return(0,r.kJ)(e)&&10==e.length?[e[0],e[1]]:null}setUpperLeftCorner(e){(0,r.kJ)(e)&&this.changeRectangle(e[0],e[1])}getWidth(){var e=this.getRectangleCoordinates();return(0,r.kJ)(e)&&10==e.length?e[2]-e[0]:0}setWidth(e){this.changeRectangle(null,null,e,null)}getHeight(){var e=this.getRectangleCoordinates();return(0,r.kJ)(e)&&10==e.length?Math.abs(e[5]-e[3]):0}setHeight(e){this.changeRectangle(null,null,null,e)}changeRectangle(e,t,i,n){var s=this.getRectangleCoordinates();if((0,r.kJ)(s)&&10==s.length){"number"!=typeof e&&(e=s[0]),"number"!=typeof t&&(t=s[1]),"number"!=typeof i&&(i=this.getWidth()),"number"!=typeof n&&(n=this.getHeight());var o=[[[e,t],[e+i,t],[e+i,t-n],[e,t-n],[e,t]]];this.setCoordinates(o)}}translate(e,t){this.transform_?(this.transform_[4]+=e,this.transform_[5]-=t,this.flatCoordinates=(0,l.Ne)(this.transform_,this.initial_coords_),this.changed()):s.ZP.prototype.translate.call(this,e,t)}getTransform(){return(0,r.kJ)(this.transform_)?{"@type":"http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",A00:this.transform_[0],A10:this.transform_[1],A01:this.transform_[2],A11:this.transform_[3],A02:this.transform_[4],A12:this.transform_[5]}:null}getRectangleCoordinates(){return this.transform_?this.initial_coords_:this.getFlatCoordinates()}clone(){var e=this.getUpperLeftCorner();return new h(e[0],e[1],this.getWidth(),this.getHeight(),this.getTransform())}getLength(){return(0,a.xA)(this)}getDisplayCoords(){var e=this.getUpperLeftCorner();return[["X",e[0].toFixed(1)],["Y",(-e[1]).toFixed(1)],["Width",this.getWidth().toFixed(1)],["Height",this.getHeight().toFixed(1)]]}}const d=h},4783:(e,t,i)=>{"use strict";i.d(t,{HP:()=>_e,hL:()=>me,oL:()=>ee,Rz:()=>te,PK:()=>ie,AQ:()=>he,Az:()=>fe,TQ:()=>re,kY:()=>ae,PO:()=>pe,uo:()=>ce,VQ:()=>se,HI:()=>de,PP:()=>ge,g9:()=>ue,y9:()=>le,YH:()=>oe,oD:()=>ne,yJ:()=>ve,Nj:()=>ye});var n=i(7124),s=i(7738),o=i(5706),r=i(1496),a=i(4511),l=i(856),h=i(4632),d=i(2617),c=i(9032),g=i(1262),p=i(9231),u=i(3778),f=i(7552),_=i(4848),m=i(8291),v=i(6074),y=i(7421),b=i(366);class w extends m.Z{constructor(e){var t=e||{},i=document.createElement("div");super({element:i,target:t.target}),this.duration_=void 0!==t.duration?t.duration:0,this.delta_="number"===t.delta?t.delta:1,this.class_name_="string"===t.className?t.className:"ol-zoom";var n=this.class_name_+" "+v.XV+" "+v.hg;i.className=n;var s=document.createElement("div");s.className="btn-group btn-group-sm ol-zoom-buttons",s.appendChild(this.addZoomButton_(!1)),s.appendChild(this.addZoomButton_(!0)),s.appendChild(this.addFitToExtentButton_()),s.appendChild(this.addOneToOneButton_()),i.appendChild(s),i.appendChild(this.addZoomPercentage_())}addZoomButton_(e){"boolean"!=typeof e&&(e=!1);var t="Zoom "+(e?"in":"out"),i=document.createElement("button");return i.className=this.class_name_+(e?"-in":"-out")+" btn btn-default glyphicon "+(e?"glyphicon-plus":"glyphicon-minus"),i.setAttribute("type","button"),i.title=t,(0,f.oL)(i,_.Z.CLICK,this.handleClick_,this),i}addZoomPercentage_(){var e=document.createElement("input");e.className=this.class_name_+"-display",e.setAttribute("type","input"),e.className="form-control ol-zoom-display",(0,f.oL)(e,"keyup",(function(t){13===t.keyCode&&this.changeResolution_(parseInt(e.value))}),this);var t=document.createElement("button");t.className="btn btn-default ol-zoom-percent",t.title="Click to apply Zoom Value",t.appendChild(document.createTextNode("%")),(0,f.oL)(t,"click",(function(){this.changeResolution_(parseInt(e.value))}),this);var i=document.createElement("span");i.className="input-group-btn input-group-sm",i.appendChild(t);var n=document.createElement("div");return n.className="input-group ol-zoom-percentage",n.appendChild(e),n.appendChild(i),n}changeResolution_(e){var t=this.getMap(),i=t?t.getView():null;if(null!==i){if(!isNaN(e)){e<0&&(e=0);var n=i.constrainResolution(1/(e/100),0,0);i.setResolution(n)}var s=(0,b.sn)(t.getTargetElement()),o=document.getElementById(""+s).querySelectorAll(".ol-zoom-display");0!==o.length&&(o[0].value=Math.round(1/i.getResolution()*100))}}addOneToOneButton_(){var e=document.createElement("button");return e.className=this.class_name_+"-1-1 btn btn-default",e.setAttribute("type","button"),e.title="Actual Size",e.appendChild(document.createTextNode("1:1")),(0,f.oL)(e,_.Z.CLICK,(function(){var e=this.getMap(),t=e?e.getView():null;null!==t&&t.setResolution(1)}),this),e}addFitToExtentButton_(){var e=document.createElement("button");return e.className=this.class_name_+"-fit btn btn-default glyphicon glyphicon-fullscreen",e.setAttribute("type","button"),e.title="Zoom Image to Fit",(0,f.oL)(e,_.Z.CLICK,(function(){var e=this.getMap(),t=e?e.getView():null;if(null!==t){var i=t.getProjection().getExtent();t.fit([i[0],-i[3],i[2],i[1]])}}),this),e}handleClick_(e){e.preventDefault();var t=this.getMap().getView();if(t){var i=-1!==e.target.className.indexOf("ol-zoom-out")?-1:1,n=t.getResolution();if(n){var s=t.constrainResolution(n,i);this.duration_>0?(t.getAnimating()&&t.cancelAnimations(),t.animate({resolution:s,duration:this.duration_,easing:y.Vv})):t.setResolution(s)}}}}const x=w;var I=i(8182),S=i(6386),C=i(4889),T=i(2372),E=i(2929),A=i(1749),R=i(5408),P=i(5882),O=i(1304),k=i(7981),N=i(1531),L=i(5745),M=i(6346),j=i(550);class F extends m.Z{constructor(e){e=e||{};var t=document.createElement("div");super({element:t,render:F.render,target:e.target}),this.collapsed_=void 0===e.collapsed||e.collapsed,this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent="«",this.label_=document.createElement("span"),this.label_.textContent="»";var i=this.collapsed_?this.label_:this.collapseLabel_,n=document.createElement("button");n.setAttribute("type","button"),n.appendChild(i),(0,f.oL)(n,_.Z.CLICK,this.handleClick_,this),this.controlDiv_=document.createElement("DIV"),this.controlDiv_.className="ol-overviewmap-map",this.thumbnail_url_=e.url,this.full_image_size_=e.size,this.thumbnail_size_=[150,100];var s=this.full_image_size_[0]/this.full_image_size_[1],o=[this.thumbnail_size_[0],parseInt(this.thumbnail_size_[0]/s)];if(o[1]>this.thumbnail_size_[1]){var r=this.thumbnail_size_[1]/o[1];this.thumbnail_size_=[parseInt(this.thumbnail_size_[0]*r),this.thumbnail_size_[1]]}else this.thumbnail_size_=o.slice();this.ratio_=[this.thumbnail_size_[0]/this.full_image_size_[0],this.thumbnail_size_[1]/this.full_image_size_[1]],this.birds_eye_=this.initOrUpdate();var a=document.createElement("DIV");a.className="ol-overviewmap-box",a.style.boxSizing="border-box",this.boxOverlay_=new P.Z({position:[0,0],positioning:O.Z.BOTTOM_LEFT,element:a}),this.birds_eye_.addOverlay(this.boxOverlay_),t.className="ol-overviewmap  "+v.XV+" "+v.hg+(this.collapsed_?" ol-collapsed":""),t.appendChild(this.controlDiv_),t.appendChild(n),this.singleBoxClick=null,this.lastBoxCoordinate_=null,this.birds_eye_.addInteraction(new k.Z({handleDownEvent:function(e){if(!(e instanceof N.Z)||this.clickedIntoBox(e.pixel))return!1;var t=this.getBoxDims(),i=[e.pixel[0]-t[0]/2,e.pixel[1]+t[1]/2];return this.boxOverlay_.setPosition(this.birds_eye_.getCoordinateFromPixel(i)),this.getMap().getView().setCenter(this.convertBirdsEyeCoords(this.birds_eye_.getCoordinateFromPixel(e.pixel))),!1}.bind(this),handleMoveEvent:function(e){if(e instanceof N.Z&&e.originalEvent instanceof MouseEvent&&0!==e.originalEvent.buttons&&this.clickedIntoBox(e.pixel)){if(null===this.lastBoxCoordinate_){var t=this.birds_eye_.getPixelFromCoordinate(this.boxOverlay_.getPosition());this.clickDistance_=[e.pixel[0]-t[0],e.pixel[1]-t[1]]}this.singleBoxClick=!0,this.lastBoxCoordinate_=[e.pixel[0]-this.clickDistance_[0],e.pixel[1]-this.clickDistance_[1]],this.boxOverlay_.setPosition(this.birds_eye_.getCoordinateFromPixel(this.lastBoxCoordinate_))}}.bind(this)})),this.onUpEvent=(0,f.oL)(this.birds_eye_.getTarget(),_.Z.MOUSEUP,(function(e){if(null!==this.lastBoxCoordinate_){var t=this.getBoxDims(),i=[this.lastBoxCoordinate_[0]+t[0]/2,this.lastBoxCoordinate_[1]-t[1]/2];this.getMap().getView().setCenter(this.convertBirdsEyeCoords(this.birds_eye_.getCoordinateFromPixel(i))),this.lastBoxCoordinate_=null,this.clickDistance_=null}}),this)}convertBirdsEyeCoords(e){return[e[0]/this.ratio_[0],e[1]/this.ratio_[1]]}setMap(e){e&&(m.Z.prototype.setMap.call(this,e),this.birds_eye_.updateSize(),this.render())}initOrUpdate(){var e=[0,-this.thumbnail_size_[1],this.thumbnail_size_[0],0],t=new T.Z({code:"BIRDSEYE",units:"pixels",extent:e.slice()});if(this.birds_eye_ instanceof L.Z&&this.birds_eye_.getLayers().getLength()>0)return this.birds_eye_.getLayers().item(0).setSource(new M.Z({url:this.getThumbnailUrlWithVersion(),projection:t,imageExtent:e})),this.birds_eye_;var i=new R.ZP({projection:t,center:(0,E.qg)(e),resolutions:[1],resolution:1}),n=new I.Z({source:new M.Z({url:this.getThumbnailUrlWithVersion(),projection:t,imageExtent:e})});return new L.Z({controls:new C.Z,interactions:new C.Z,layers:[n],view:i,target:this.controlDiv_})}getThumbnailUrlWithVersion(){var e=this.getMap(),t=(new Date).getTime();return e&&(t+="-"+(0,b.sn)(e.getTargetElement())),this.thumbnail_url_+"/?rev="+t}updateBox_(){var e=this.getMap();if(this.birds_eye_.isRendered()){var t=e.getView(),i=t.getRotation();this.birds_eye_.getView().setRotation(i);var n=(0,E.p8)(t.getCenter(),t.getResolution(),0,e.getSize()),s=(0,E.hC)(n),o=(0,E.Xv)(n),r=this.calculateCoordinateRotate_(i,s);this.boxOverlay_.setPosition([r[0]*this.ratio_[0],r[1]*this.ratio_[1]]);var a=this.boxOverlay_.getElement();a&&(a.style.width=Math.abs((s[0]-o[0])*this.ratio_[0])+"px",a.style.height=Math.abs((o[1]-s[1])*this.ratio_[1])+"px")}}calculateCoordinateRotate_(e,t){var i,n=this.getMap().getView().getCenter();return n&&(i=[t[0]-n[0],t[1]-n[1]],(0,S.U1)(i,e),(0,S.IH)(i,n)),i}handleClick_(e){e.preventDefault(),this.handleToggle_()}handleToggle_(){this.element.classList.toggle("ol-collapsed"),this.collapsed_?(0,j.$H)(this.collapseLabel_,this.label_):(0,j.$H)(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.collapsed_||(this.birds_eye_.isRendered()||this.birds_eye_.updateSize(),(0,f.Vx)(this.birds_eye_,A.Z.POSTRENDER,(function(){try{this.updateBox_()}catch(e){}}),this))}setCollapsed(e){this.collapsed_!==e&&this.handleToggle_()}getCollapsed(){return this.collapsed_}getBoxDims(){var e=this.boxOverlay_.getElement(),t=[(0,j.iO)(e),(0,j.Pb)(e)];return(isNaN(t[0])||isNaN(t[1]))&&(t=[e.offsetWidth,e.offsetHeight]),t}clickedIntoBox(e){var t=this.birds_eye_.getPixelFromCoordinate(this.boxOverlay_.getPosition()),i=this.getBoxDims(),n=[t[0]-5,t[1]-i[1]-5,t[0]+i[0]+5,t[1]+5];return(0,E.b8)(n,e)}disposeInternal(){void 0!==this.onUpEvent&&this.onUpEvent&&(0,f.bN)(this.onUpEvent),F.superClass_.disposeInternal.call(this),this.birds_eye_&&this.birds_eye_.dispose()}}F.render=function(e){null!==this.lastBoxCoordinate_||this.singleBoxClick?this.singleBoxClick=!1:this.updateBox_()};const D=F;var z=i(513);const Z=[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4];class H extends z.ZP{constructor(e){"object"!=typeof e&&(e={}),super(e),this.bar_min_width_=100,this.drag_listener_=null,this.element.title="Click and drag to move scalebar",this.element.className+=" ol-control",(0,f.oL)(this.element,"mousedown",(function(e){if(this.map_ instanceof L.Z){null!==this.drag_listener_&&((0,f.bN)(this.drag_listener_),this.drag_listener_=null);var t=-e.offsetX,i=-e.offsetY;this.drag_listener_=(0,f.oL)(this.map_,"pointermove",(function(e){var n=e.originalEvent;if((void 0!==n.buttons||1!==n.which)&&1!==n.buttons)return(0,f.bN)(this.drag_listener_),void(this.drag_listener_=null);this.element.style.bottom="auto",this.element.style.left=e.pixel[0]+t+"px",this.element.style.top=e.pixel[1]+i+"px"}),this)}}),this)}updateElement_(){var e=this.viewState_;if(!e)return void(this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1));for(var t=e.projection.getMetersPerUnit(),i=e.resolution,n=t*this.bar_min_width_*i,s="µm",o=0;o<ue.length;o++){var r=ue[o];if(n<r.threshold){n*=r.multiplier,s=r.symbol;break}}var a=0;let l=0;for(let e=0;e<Z.length;e++)if((a=Z[e])>=n){l=this.bar_min_width_*a/n;break}var h=a+" "+s;this.innerElement_.innerHTML=h,this.innerElement_.style.width=l+"px",this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}}const G=H;var U=i(332),V=i(6721);class Y extends m.Z{constructor(){var e=document.createElement("div");super({element:e}),this.CACHE_LIMIT=1e6,this.intensities_cache_={count:0,intensities:{}},this.movement_handle_=null,this.last_cursor_=[0,0],this.prefix_="",this.query_intensity_=!1,this.image_=null,this.pointer_move_listener_=null;var t="ol-intensity "+v.XV+" "+v.hg;e.className=t;var i=document.createElement("div");i.className="intensity-display",i.appendChild(document.createTextNode(""));var n=document.createElement("span");n.className="intensity-toggler",n.title="Turn on intensity querying",(0,f.oL)(n,_.Z.CLICK,(function(){this.toggleIntensityQuerying(!this.query_intensity_),this.query_intensity_?(n.title="Turn off intensity querying",n.className="intensity-toggler intensity-on"):(n.title="Turn on intensity querying",n.className="intensity-toggler")}),this),e.appendChild(i),e.appendChild(n)}setMap(e){this.map_&&(0,j.ZF)(this.element);for(var t=0,i=this.listenerKeys.length;t<i;++t)(0,f.bN)(this.listenerKeys[t]);this.listenerKeys=[],this.map_=e,this.map_&&((this.target_?this.target_:e.getOverlayContainerStopEvent()).appendChild(this.element),null!==this.render&&this.listenerKeys.push((0,f.oL)(e,A.Z.POSTRENDER,this.render,this)),e.render())}enable(e){null!==this.getMap()&&(this.query_intensity_=!1,this.prefix_=e||"",this.image_=this.getMap().getLayers().item(0).getSource(),this.pointer_move_listener_=(0,f.oL)(this.getMap(),U.Z.POINTERMOVE,this.handlePointerMove_.bind(this)),this.getMap().getTargetElement().onmouseleave=()=>{this.resetMoveTracking_()})}disable(){this.query_intensity_=!1,this.pointer_move_listener_&&((0,f.bN)(this.pointer_move_listener_),this.pointer_move_listener_=null),this.getMap()&&this.getMap().getTargetElement()&&(this.getMap().getTargetElement().onmouseleave=null),this.resetMoveTracking_();var e=this.getIntensityDisplayElement();e&&(e.innerHTML=""),this.image_=null}updateTooltip(e,t,i){if(null!==this.getMap()&&null!==this.getMap().getTargetElement()){"boolean"!=typeof i&&(i=!1);var n=(0,b.sn)(this.getMap().getTargetElement());if(null!==n){var s=document.getElementById(""+n).querySelectorAll(".ol-intensity-popup"),o=s&&s.length>0?s[0]:null,r="object"==typeof t&&null!==t;if("object"!=typeof e||null===e||!i&&!r)o&&(o.style.display="none");else{var a=null==o;if(a&&((o=document.createElement("div")).className="ol-intensity-popup"),o.style.position="absolute",o.style.display="",o.style.visibility="hidden",o.innerHTML="",r){var l='<div style="display:table-row"><div class="intensity-header">Channel</div><div class="intensity-header">Intensity</div></div>';for(var h in t)if(this.image_.channels_info_[h].active){var d=t[h];l+='<div style="display:table-row"><div class="intensity-label">'+this.image_.channels_info_[h].label+'</div><div class="intensity-value">'+(d%1==0?d:d.toFixed(3))+"</div></div>"}o.innerHTML=l}else i&&(o.innerHTML="Querying Intensity...");var c=e.pixel.slice(),g=[15,15];try{var p=e.originalEvent.target.parentNode,u=o.offsetWidth,f=o.offsetHeight;if(c[0]+u>p.offsetWidth&&(h=c[0]-u,c[0]=h>=0?h:0,g[0]=-g[0]),c[1]+f>p.offsetHeight){var _=c[1]-f;c[1]=_>=0?_:0,g[1]=-g[1]}}catch(e){}if(o.style.left=c[0]+g[0]+"px",o.style.top=c[1]+g[1]+"px",this.last_cursor_[0]===e.pixel[0]&&this.last_cursor_[1]===e.pixel[1]&&(o.style.visibility="visible",a)){var m=this.getMap().getTargetElement();m&&m.childNodes[0].appendChild(o)}}}}}resetMoveTracking_(e){this.last_cursor_=(0,b.kJ)(e)&&2===e.length?e:[0,0],this.updateTooltip(),"number"==typeof this.movement_handle_&&(clearTimeout(this.movement_handle_),this.movement_handle_=null)}getIntensityDisplayElement(){if(null!==this.element){var e=this.element.querySelectorAll(".intensity-display");return e&&e.length>0?e[0]:null}}handlePointerMove_(e){var t=!1;try{this.resetMoveTracking_(e.pixel);var i=e.originalEvent.target;"CANVAS"===i.nodeName.toUpperCase()&&(t=i.parentNode.parentNode.className.indexOf("ol-overviewmap")<0)}catch(e){}if(this.getMap().getTargetElement().style.cursor=this.query_intensity_&&t?"crosshair":"auto",t&&!e.dragging){var n=this.getIntensityDisplayElement(),s=e.coordinate[0],o=-e.coordinate[1];if(s<0||s>=this.image_.getWidth()||o<0||o>=this.image_.getHeight())return n.style.display="none",void(n.innerHTML="");if(n.style.display="block",n.innerHTML="X: "+s.toFixed(0)+" Y: "+o.toFixed(0),this.query_intensity_){var r=this.image_.getChannels();if(0===r.length)return;s=parseInt(s),o=parseInt(o);var a=this.image_.getPlane(),l=this.image_.getTime(),h=function(t){n.innerHTML="X: "+s.toFixed(0)+" Y: "+o.toFixed(0),this.updateTooltip(e,t)}.bind(this),d=this.getCachedIntensities(a,l,s,o),c=[];if(null!==d)for(var g in r)"number"!=typeof d[r[g]]&&c.push(r[g]);else c=r;var p=null,u=250;c.length>0?(u=500,p=function(){var t={server:this.image_.server_,uri:this.prefix_+"/get_intensity/?image="+this.image_.id_+"&z="+a+"&t="+l+"&x="+s+"&y="+o+"&c="+c.join(","),success:function(e){try{var t=JSON.parse(e);this.cacheIntensities(t),h(this.getCachedIntensities(a,l,s,o))}catch(e){console.error(e)}}.bind(this),error:function(e){this.updateTooltip(),console.error(e)}.bind(this)};this.updateTooltip(e,null,!0),(0,V.wG)(t)}):p=function(){h(d)},this.movement_handle_=setTimeout(function(){this.last_cursor_[0]===e.pixel[0]&&this.last_cursor_[1]===e.pixel[1]&&p.call(this)}.bind(this),u)}}}getCachedIntensities(e,t,i,n){if(0===this.intensities_cache_.count)return null;try{var s=this.intensities_cache_.intensities[e+"-"+t];return"object"!=typeof s.pixels[i+"-"+n]?null:s.pixels[i+"-"+n]}catch(e){return null}}cacheIntensities(e){try{var t=this.image_.getPlane()+"-"+this.image_.getTime();if(this.intensities_cache_.count+e.count>this.CACHE_LIMIT){for(var i in this.intensities_cache_.intensities)if(i!==t&&(this.intensities_cache_.count-=this.intensities_cache_.intensities[i].count,delete this.intensities_cache_.intensities[i]),this.intensities_cache_.count+e.count<this.CACHE_LIMIT)break;this.intensities_cache_.count+e.count>this.CACHE_LIMIT&&(delete this.intensities_cache_.intensities[t],this.intensities_cache_.count=0)}if("object"!=typeof this.intensities_cache_.intensities[t])this.intensities_cache_.intensities[t]=e,this.intensities_cache_.count+=e.count;else{var n=this.intensities_cache_.intensities[t];for(var s in e.pixels){"object"!=typeof n.pixels[s]&&(n.pixels[s]={});var o=e.pixels[s];for(var r in o)"number"!=typeof n.pixels[s][r]&&(n.pixels[s][r]=o[r],n.count++,this.intensities_cache_.count++)}}}catch(e){console.error("Failed to cache intensities: "+e)}}toggleIntensityQuerying(e){return null!==this.pointer_move_listener_&&null!==this.image_||(this.disable(),this.enable(this.prefix_)),"boolean"!=typeof e&&(e=!1),e&&this.query_intensity_||!e&&!this.query_intensity_?this.query_intensity_:this.query_intensity_=e}disposeInternal(){this.disable()}}const q=Y;var $=i(8228),B=i(246);class W extends B.Z{constructor(){super(),this.condition_=$.vY}}const X=W;var Q=i(5303);class J extends m.Z{constructor(e){var t=e||{},i=document.createElement("div");super({element:i,target:t.target}),this.class_name_="string"===t.className?t.className:"ol-flip",this.ref_=null,this.view=null,this.flipX="boolean"==typeof t.flipX&&t.flipX,this.flipY="boolean"==typeof t.flipY&&t.flipY;var n=this.class_name_+" "+v.XV+" "+v.hg;i.className=n;var s=document.createElement("div");s.className="btn-group btn-group-sm ol-flip-buttons",s.appendChild(this.addFlipButton(!1)),s.appendChild(this.addFlipButton(!0)),i.appendChild(s),this.setMap_=this.setMap,this.setMap=e=>{this.setMap_(e),null!=e&&this.init()}}addFlipButton(e){"boolean"!=typeof e&&(e=!1);var t="Flip "+(e?"vertical":"horizontal"),i=document.createElement("button");return i.className=this.class_name_+(e?"-vertical glyphicon-resize-vertical":"-horizontal glyphicon-resize-horizontal")+" btn btn-default glyphicon ol-flip-button",i.setAttribute("type","button"),i.title=t,(0,f.oL)(i,_.Z.CLICK,this.handleClick_,this),i}init(){this.view=this.getMap().getView(),this.getMap().getControls().getArray().forEach((e=>{"birds_eye_"in e&&(this.birdseye=e)})),this.view.constrainCenter_=this.view.constrainCenter,this.view.constrainCenter=e=>{let t=this.view.getCenter(),i=this.view.getRotation();return 0!=i&&((0,S.U1)(e,2*Math.PI-i),(0,S.U1)(t,2*Math.PI-i)),this.view.values_.flipX&&(e[0]=t[0]-(e[0]-t[0])),this.view.values_.flipY&&(e[1]=t[1]-(e[1]-t[1])),0!=i&&(0,S.U1)(e,i),this.view.constrainCenter_(e)},this.map_.getEventPixel=function(e){const t=this.viewport_.getBoundingClientRect(),i="changedTouches"in e?e.changedTouches[0]:e;let n=i.clientX-t.left,s=i.clientY-t.top;return this.getView().flipX&&(n=t.width-n),this.getView().flipY&&(s=t.height-s),[n,s]},this.flipX&&this.flip(1),this.flipY&&this.flip(0)}flip(e){var t=this.getMap().getViewport().children[0];let i;0==e?(i="scaleY(-1)",this.view.setProperties({flipY:!this.view.values_.flipY})):(i="scaleX(-1)",this.view.setProperties({flipX:!this.view.values_.flipX})),t.style.transform=t.style.transform.includes(i)?t.style.transform.replace(i,""):t.style.transform+i,this.birdseye.controlDiv_.style.transform=this.birdseye.controlDiv_.style.transform.includes(i)?this.birdseye.controlDiv_.style.transform.replace(i,""):this.birdseye.controlDiv_.style.transform+i}handleClick_(e){e.preventDefault();var t=-1!==e.target.className.indexOf("ol-flip-vertical")?0:1;return this.flip(t),!0}}const K=J,ee="butt",te="miter",ie=20,ne="WEB_API_BASE",se="/m/rois",oe="WEBGATEWAY",re="PLUGIN_PREFIX",ae=[re,ne,"WEBCLIENT",oe],le=4194304,he={width:512,height:512},de={DEFAULT:0,MODIFIED:1,ADDED:2,REMOVED:3,ROLLBACK:4},ce={DEFAULT:0,SELECT:1,TRANSLATE:2,MODIFY:3,DRAW:4},ge={NOT_WATCHED:0,IN_PROGRESS:1,RENDERED:2,ERROR:3},pe={NORMAL:"normal",INTMAX:"intmax"},ue=[{unit:"angstrom",threshold:.01,multiplier:1e4,symbol:"Å"},{unit:"nanometer",threshold:1,multiplier:1e3,symbol:"nm"},{unit:"micron",threshold:1e3,multiplier:1,symbol:"µm"},{unit:"millimeter",threshold:1e5,multiplier:.001,symbol:"mm"},{unit:"centimeter",threshold:1e6,multiplier:1e-4,symbol:"cm"},{unit:"meter",threshold:1e9,multiplier:1e-6,symbol:"m"},{unit:"kilometer",threshold:1/0,multiplier:1e-9,symbol:"km"}],fe={x:{method:"Width",settable:!1},width:{method:"Width",settable:!1},y:{method:"Height",settable:!1},height:{method:"Width",settable:!1},z:{method:"Plane",settable:!0},t:{method:"Time",settable:!0},c:{method:"Channels",settable:!0}},_e={attribution:{clazz:s.Z,options:{},defaults:!0,enabled:!1,links:[]},zoom:{clazz:x,options:{},defaults:!0,enabled:!0,links:[]},rotate:{clazz:o.Z,options:{autoHide:!1},defaults:!0,enabled:!0,links:["shiftRotate"]},fullscreen:{clazz:r.Z,options:{},defaults:!0,enabled:!0,links:[]},birdseye:{clazz:D,options:{collapsed:!0},defaults:!0,enabled:!1,links:[]},scalebar:{clazz:G,options:{},defaults:!0,enabled:!1,links:[]},intensity:{clazz:q,options:{},defaults:!0,enabled:!1,links:[]},mirror:{clazz:K,options:{},defaults:!0,enabled:!1,links:[]}},me={dragPan:{clazz:a.Z,options:{kinetic:new n.Z(-.005,.05,100)},defaults:!0,enabled:!0,links:[]},pinchZoom:{clazz:l.Z,options:{zoomDuration:null},defaults:!0,enabled:!0,links:[]},mouseWheelZoom:{clazz:h.Z,options:{duration:0,timeout:0},defaults:!0,enabled:!0,links:[]},keyboardPan:{clazz:d.Z,options:{},defaults:!0,enabled:!1,links:[]},keyboardZoom:{clazz:c.Z,options:{zoomDuration:null,zoomDelta:null},defaults:!0,enabled:!1,links:[]},shiftDragZoom:{clazz:g.Z,options:{zoomDuration:null},defaults:!0,enabled:!1,links:[]},doubleClickZoom:{clazz:p.Z,options:{duration:250,delta:10},defaults:!0,enabled:!0,links:[]},pinchRotate:{clazz:u.Z,options:{},defaults:!0,enabled:!1,links:["rotate"]},shiftRotate:{clazz:X,options:{},defaults:!0,enabled:!0,links:["rotate"]},boxSelect:{clazz:Q.Z,options:{},defaults:!1,enabled:!1,links:[]}},ve=function(){var e={};for(var t in _e){var i=_e[t];if(i.defaults&&i.enabled)try{var n=i.clazz;e[t]={type:"control",ref:new n(i.options),defaults:i.defaults}}catch(e){console.error("Failed to construct control: "+e)}}return e},ye=function(){var e={};for(var t in me){var i=me[t];if(i.defaults&&i.enabled)try{var n=i.clazz;e[t]={type:"interaction",ref:new n(i.options),defaults:i.defaults}}catch(e){console.error("Failed to construct interaction: "+e)}}return e}},5303:(e,t,i)=>{"use strict";i.d(t,{Z:()=>l});var n=i(5584),s=i(7552),o=i(8228),r=i(7630);class a extends n.Z{constructor(e){e instanceof r.Z||console.error("Select needs Regions instance!"),super(),this.condition_=o.QC,e instanceof r.Z&&(this.regions_=e,this.boxStartFunction_=function(){this.regions_.select_&&this.regions_.select_.clearSelection()},this.boxStartListener_=null,this.boxEndFunction_=function(){if(null!==this.regions_.select_){var e=[],t=this.getGeometry().getExtent();this.regions_.forEachFeatureInExtent(t,(function(i){i.getGeometry().intersectsExtent(t)&&e.push(i.getId())})),e.length>0&&this.regions_.setProperty(e,"selected",!0)}},this.boxEndListener_=null,this.registerListeners=function(){this.boxStartListener_=(0,s.oL)(this,"boxstart",this.boxStartFunction_,this),this.boxEndListener_=(0,s.oL)(this,"boxend",this.boxEndFunction_,this)},this.registerListeners())}resetListeners(){this.unregisterListeners(),this.registerListeners()}unregisterListeners(){this.boxStartListener_&&(0,s.bN)(this.boxStartListener_),this.boxEndListener_&&(0,s.bN)(this.boxEndListener_)}disposeInternal(){this.unregisterListeners(),this.regions_=null}}const l=a},2293:(e,t,i)=>{"use strict";i.d(t,{Z:()=>A});var n=i(759),s=i(2790),o=i(3529),r=i(8405),a=i(9107),l=i(3721),h=i(8389),d=i(4889),c=i(8743),g=i(8228),p=i(4780),u=i(1221),f=i(1201),_=i(3e3),m=i(2933),v=i(9256),y=i(7630),b=i(8185),w=i(366),x=i(4783),I=i(9672),S=i(8500);const C="drawend";class T extends c.ZP{startDrawing_(e){this.map=e.map;let t=super.startDrawing_(e);return this.sketchFeature_&&e.map.getOverlays().forEach((e=>{e.showPopupForShape&&e.showPopupForShape(this.sketchFeature_)})),t}handlePointerMove_(e){return this.sketchFeature_&&e.map.getOverlays().forEach((e=>{e.updatePopupCoordinates&&e.updatePopupCoordinates(this.sketchFeature_.getGeometry())})),super.handlePointerMove_(e)}finishDrawing(){let e=this.sketchFeature_,t=super.finishDrawing();return this.map instanceof n.Z&&e&&this.map.getOverlays().forEach((t=>{t.showPopupForShape&&t.showPopupForShape(e)})),t}}class E{constructor(e,t){(0,w.kJ)(e)||console.error("Draw needs the prevously set modes as an array"),t instanceof y.Z||console.error("Draw needs Regions instance!"),this.opts_={},this.regions_=t,this.previous_modes_=e,this.ol_draw_=null,this.history_id_=null,this.roi_id_=0,this.abort_polyline_=!1,this.default_style_=null}drawShapeCommonCode_(e,t,i){if("string"!=typeof e||"string"!=typeof t||0===e.length||0===t.length)return;let n=this;this.ol_draw_&&this.regions_.viewer_.viewer_.removeInteraction(this.ol_draw_),this.ol_draw_=new T({style:this.default_style_function_,type:e,condition:function(e){return(0,g.rM)(e)&&(0,g.Xp)(e)},geometryFunction:"function"==typeof i?i:null}),this.regions_.viewer_.viewer_.addInteraction(this.ol_draw_),this.abort_polyline_&&this.ol_draw_.once("drawstart",(function(e){var t=e.feature.getGeometry().on("change",(function(e){e.target.getCoordinates().length>=3&&((0,h.B)(t),n.ol_draw_.finishDrawing())}),this)}),this),this.ol_draw_.on(C,(function(e){if(e.feature instanceof s.Z){e.feature.setId(("number"==typeof n.roi_id_&&n.roi_id_<0?n.roi_id_+":":"-1:")+-(0,b.sq)(e.feature)),e.feature.state=x.HI.ADDED,e.feature.type=t;var i=(0,w.kJ)(n.opts_.unattached)&&n.opts_.unattached.length>0;e.feature.TheT=i&&-1!==n.opts_.unattached.indexOf("t")?-1:n.regions_.viewer_.getDimensionIndex("t"),e.feature.TheZ=i&&-1!==n.opts_.unattached.indexOf("z")?-1:n.regions_.viewer_.getDimensionIndex("z"),e.feature.TheC=-1,e.feature.setStyle(n.default_style_),(0,I.Ru)(e.feature,n.regions_,!0),n.regions_.getLengthAndAreaForShape(e.feature,!0);var o="boolean"!=typeof n.opts_.add||n.opts_.add;if(o&&n.regions_.addFeature(e.feature),n.regions_.viewer_.eventbus_){var r=n.history_id_;n.roi_id_<0&&(e.feature.roi_id=n.roi_id_);var a=(0,S.ZQ)(new d.Z([e.feature]),!1);if("object"!=typeof a||!(0,w.kJ)(a.new)||0===a.new.length)return;var l={shapes:a.new,drawn:!0,add:o};"number"==typeof r&&(l.hist_id=r),"number"==typeof e.feature.roi_id&&(l.roi_id=e.feature.roi_id),(0,w.qD)(n.regions_.viewer_,"REGIONS_SHAPE_GENERATED",l,25)}n.history_id_=null,n.rois_id_=0}n.endDrawingInteraction(!1)}),this)}drawShape(e,t,i){if(this.opts_=i||{},this.abort_polyline_=!1,"string"!=typeof e.type||0===e.type.length)return this.history_id_=null,this.roi_id_=0,void this.dispatchEvent(new c.ZP.Event(C,null));this.roi_id_="number"==typeof t&&t<0?t:-1,"number"==typeof this.opts_.hist_id&&(this.history_id_=this.opts_.hist_id);var n=null;switch(e.type.toLowerCase()){case"point":n=E.prototype.drawPoint_;break;case"polygon":n=E.prototype.drawPolygon_;break;case"ellipse":n=E.prototype.drawEllipse_;break;case"polyline":n=E.prototype.drawPolyLine_;break;case"line":n=E.prototype.drawLine_;break;case"arrow":n=E.prototype.drawArrow_;break;case"rectangle":n=E.prototype.drawRectangle_;break;case"label":n=E.prototype.drawLabel_;break;default:return void this.regions_.setModes(this.previous_modes_)}this.setDefaultDrawingStyle(e),n.call(this)}setDefaultDrawingStyle(e){this.default_style_function_=null,this.default_style_=null;var t="label"===e.type,i="line"===e.type||"arrow"===e.type||"point"===e.type,n="number"==typeof e.FillColor?(0,S.Fj)(e.FillColor):null;n=null===n?"rgba(255,255,255,0.5)":(0,S.hg)(n);var s={color:"number"==typeof e.StrokeColor?(0,S.Fj)(e.StrokeColor):null,width:"object"==typeof e.StrokeWidth&&null!==e.StrokeWidth&&"number"==typeof e.StrokeWidth.Value?e.StrokeWidth.Value:1,lineCap:x.oL,lineJoin:x.Rz,miterLimit:x.PK};null===s.color?s.color="rgba(0, 153, 255, 0.9)":s.color=(0,S.hg)(s.color),i&&0===s.width?s.width=1:t&&(s.width=0);var h={stroke:new r.Z(s)};t||(h.fill=new a.Z({color:n})),this.default_style_=new l.ZP(h),this.default_style_function_=function(e,t){var i=this.ol_draw_.sketchFeature_,n=i?i.getGeometry():e.getGeometry();if(null===i)return null;if(n instanceof u.Z){var s=new o.Z({overflow:!0,text:"TEXT",font:"normal "+n.getHeight()+"px sans-serif",fill:new a.Z({color:this.default_style_.getStroke().getColor()})}),r=this.regions_.viewer_.viewer_.getView().getRotation();0===r||this.regions_.rotate_text_||s.setRotation(r),s.setScale(1/t),this.default_style_.text_=s}var h=[this.default_style_];if(n instanceof f.Z&&n.has_end_arrow_){var d=this.default_style_.getStroke(),c=(d.getWidth(),15*t),g=new l.ZP({geometry:n.getArrowGeometry(!0,c,c),fill:new a.Z({color:d.getColor()}),stroke:d});h.push(g)}return i.setStyle(h),null}.bind(this)}endDrawingInteraction(e){this.ol_draw_&&(this.regions_.viewer_.viewer_.removeInteraction(this.ol_draw_),this.ol_draw_=null,("boolean"!=typeof e||e)&&this.regions_.setModes(this.previous_modes_))}drawPolygon_(e){this.drawShapeCommonCode_("Polygon","polygon",(function(e,t){var i=new m.Z(e);return t&&t.setCoordinates(i.getCoordinates()),i}))}drawPolyLine_(e){this.drawShapeCommonCode_("LineString","polyline",(function(e,t){var i=new f.Z(e);return t&&t.setCoordinates(i.getCoordinates()),i}))}drawLine_(e){this.abort_polyline_=!0,this.drawPolyLine_()}drawArrow_(e){this.abort_polyline_=!0,this.drawShapeCommonCode_("LineString","polyline",(function(e,t){var i=new f.Z(e,!1,!0);return t&&t.setCoordinates(i.getCoordinates()),i}))}drawPoint_(e){this.drawShapeCommonCode_("Point","point",(function(e,t){return new _.Z(e)}))}drawRectangle_(e){this.drawShapeCommonCode_("Circle","rectangle",(function(e,t){var i=e[0],n=e[1],s=Math.abs(n[0]-i[0]),o=Math.abs(i[1]-n[1]);0===s&&(s=1),0===o&&(o=1);var r=n[0]<i[0]?n[0]:i[0],a=n[1]>i[1]?n[1]:i[1],l=new v.Z(r,a,s,o);return t&&(t.setUpperLeftCorner(l.getUpperLeftCorner()),t.setWidth(l.getWidth()),t.setHeight(l.getHeight())),l}))}drawLabel_(e){this.regions_.viewer_.getDimensionIndex("y"),this.drawShapeCommonCode_("Circle","label",(function(e,t){var i=e[0],n=e[1],s=Math.abs(i[1]-n[1]);0===s&&(s=1);var o=n[0]<i[0]?n[0]:i[0],r=n[1]>i[1]?n[1]:i[1],a=(0,I.E0)("TEXT","normal "+parseInt(s)+"px sans-serif"),l=new u.Z(o,r,a);return t&&(t.setUpperLeftCorner(l.getUpperLeftCorner()),t.setWidth(l.getWidth()),t.setHeight(l.getHeight())),l}))}drawEllipse_(e){this.drawShapeCommonCode_("Circle","ellipse",(function(e,t){var i=e[0],n=e[1],s=Math.abs(i[0]-n[0]),o=Math.abs(i[1]-n[1]),r=new p.Z(i[0],i[1],s,o);return t&&(t.setCoordinates(r.getCoordinates()),t.setRadius(r.getRadius())),r}))}dispose(){this.ol_draw_&&(this.regions_.viewer_.viewer_.removeInteraction(this.ol_draw_),this.ol_draw_=null,this.previous_modes_=null),this.regions_=null}}const A=E},7630:(e,t,i)=>{"use strict";i.d(t,{Z:()=>te});var n=i(291),s=i(2790),o=i(8816),r=i(426),a=i(2293),l=i(212),h=i(4889),d=i(892),c=i(6278),g=i(8228),p=i(366);class u extends l.ZP{constructor(e){e instanceof te||console.error("Select needs Regions instance!"),super({}),this.regions_=e,this.condition_=function(t){return g.V4.call(e.select_,t)},this.features_=new h.Z;var t=this.regions_.viewer_.getRegionsLayer();this.layerFilter_=function(e){return(0,d.q9)([t],e)},this.filter_=c.uX}clearSelection(){var e=[];this.getFeatures().forEach((function(t){e.push(t.getId())}),this),e.length>0&&this.regions_.setProperty(e,"selected",!1),this.regions_.viewer_.viewer_.getOverlays().forEach((e=>{e.hideShapeEditPopup&&e.hideShapeEditPopup()}))}handleEvent(e){if(!this.condition_(e)||e.dragging)return!0;var t=this.featuresAtCoords_(e.pixel),i=!(!t||"boolean"!=typeof t.selected)&&t.selected;return null!==t&&(0,g.vY)(e)||(this.clearSelection(),null!==t)?(this.regions_.setProperty([t.getId()],"selected",!i),(0,g.MJ)(e)):void 0}featuresAtCoords_(e,t,i){if((0,p.kJ)(e)&&2===e.length){"number"!=typeof t&&(t=5),"boolean"!=typeof i&&(i=!1);var n=this.regions_.viewer_.viewer_,s=n.getCoordinateFromPixel([e[0]-t,e[1]+t]),o=n.getCoordinateFromPixel([e[0]+t,e[1]-t]),r=[s[0],s[1],o[0],o[1]],a=[],l=this.features_.getArray();return this.regions_.forEachFeatureInExtent(r,(function(e){e.getGeometry().intersectsExtent(r)&&(!i||i&&(0,d.q9)(l,e))&&a.push(e)})),(0,p.Ox)(a)}}getFeatures(){return this.features_}toggleFeatureSelection(e,t,i){e instanceof s.Z&&("boolean"!=typeof t||t?("boolean"==typeof i&&i&&this.getFeatures().remove(e),e.selected=!0,this.getFeatures().push(e)):(e.selected=!1,this.getFeatures().remove(e)),this.regions_.viewer_.viewer_.getOverlays().forEach((t=>{t.hideShapeEditPopup?e.selected||t.hideShapeEditPopup(e.getId()):t.setPosition(void 0)})),e.selected&&this.regions_.viewer_.viewer_.getOverlays().forEach((t=>{t.showPopupForShape&&t.showPopupForShape(e)})))}disposeInternal(){this.regions_=null}}const f=u;var _=i(7981),m=i(5882);class v extends _.Z{constructor(e){super({}),document.querySelectorAll(".hover-popup"),this.tooltip=document.createElement("div"),this.tooltip.className="hover-popup",this.regions_=e,this.map=e.viewer_.viewer_,this.overlay=new m.Z({element:this.tooltip,insertFirst:!1,autoPan:!1}),this.map.addOverlay(this.overlay)}handleMoveEvent(e){const t=e.map;let i=[];t.forEachFeatureAtPixel(e.pixel,(e=>i.push(e)),{hitTolerance:0}),0==i.length&&t.forEachFeatureAtPixel(e.pixel,(e=>i.push(e)),{hitTolerance:5});let n=(0,p.Ox)(i);this.overlay.setPosition(void 0);let s=e.originalEvent.isOverShapeEditPopup;if(!n||n.selected||s)this.regions_.getHoverId()&&this.regions_.setHoverId(null);else{let t=e.coordinate,i=n.oldText;if(i&&i.getText()&&i.getText().length>0){let e=i.getText(),n=Math.min(Math.max(100,8*e.length),250);this.tooltip.innerHTML="<div style='width: ".concat(n,"px'>\n                                            ").concat(i.getText(),"\n                                        </div>"),this.overlay.setPosition([t[0],t[1]+20])}let s=n.getId();this.regions_.getHoverId()!=s&&this.regions_.setHoverId(s)}}disposeInternal(){this.overlay.setPosition(void 0),this.map.removeOverlay(this.overlay),this.map=null}}const y=v;var b=i(5303),w=i(8725),x=i(8623),I=i(4070),S=i(2685),C=i(5270),T=i(849),E=i(4078),A=i(6580),R=i(3376),P=i(332),O=i(7552),k=i(8185),N=i(2929),L=i(6386),M=i(1221),j=i(9256),F=i(4780),D=i(1201),z=i(2933),Z=i(6866),H=i(9236),G=i(4783);const U="modifyend";class V extends w.Z{constructor(e){e instanceof te||console.error("Modify needs a Regions instance!"),e.select_ instanceof f||console.error("Select needs a Select instance!"),super({pixelTolerance:5,features:e.select_.getFeatures(),handleDragEvent:Y,handleUpEvent:q}),this.regions_=e,this.hist_id_=-1,this.handleEvent=$,this.deleteCondition_=function(e){return(0,g.rM)(e)&&(0,g.V4)(e)},(0,O.oL)(this,"modifystart",(function(e){this.hist_id_=this.regions_.addHistory(e.features.array_,!0)}),this),(0,O.oL)(this,U,(function(e){if(this.hist_id_>=0){var t=e.features.array_[0].getId();this.regions_.addHistory(e.features.array_,!1,this.hist_id_),(0,p.qD)(this.regions_.viewer_,"REGIONS_HISTORY_ENTRY",{hist_id:this.hist_id_,shape_ids:[t]}),this.regions_.setProperty([t],"state",G.HI.MODIFIED)}}),this)}handleFeatureAdd_(e){var t=e.element;!this.regions_.renderFeature(t)||t.getGeometry()instanceof Z.Z||"object"==typeof t.permissions&&null!==t.permissions&&"boolean"==typeof t.permissions.canEdit&&!t.permissions.canEdit||this.addFeature_(t)}handlePointerAtPixel_(e,t){if(this.features_ instanceof h.Z&&0!==this.features_.getLength()){var i=t.getCoordinateFromPixel(e),n=t.getCoordinateFromPixel([e[0]-this.pixelTolerance_,e[1]+this.pixelTolerance_]),s=t.getCoordinateFromPixel([e[0]+this.pixelTolerance_,e[1]-this.pixelTolerance_]),o=(0,N.hI)([n,s]),r=this.rBush_.getInExtent(o);if(r.length>0){r.sort((function(e,t){return(0,L.Bs)(i,e.segment)-(0,L.Bs)(i,t.segment)}));var a=r[0];if(!(a.geometry instanceof M.Z||a.geometry instanceof Z.Z||a.geometry instanceof I.Z)&&this.regions_.renderFeature(a.feature)){var l=a.segment,d=(0,L.oL)(i,l),c=t.getPixelFromCoordinate(d);if(Math.sqrt((0,L.bI)(e,c))<=this.pixelTolerance_){var g=t.getPixelFromCoordinate(l[0]),p=t.getPixelFromCoordinate(l[1]),u=(0,L.bI)(c,g),f=(0,L.bI)(c,p),_=Math.sqrt(Math.min(u,f));if(this.snappedToVertex_=_<=this.pixelTolerance_,(a.geometry instanceof j.Z||a.geometry instanceof F.Z||a.geometry instanceof D.Z)&&!this.snappedToVertex_)return;this.snappedToVertex_&&(d=u>f?l[1]:l[0]),this.createOrUpdateVertexFeature_(d);var m,v={};v[(0,k.sq)(l)]=!0;for(var y=1,b=r.length;y<b&&(m=r[y].segment,(0,L.fS)(l[0],m[0])&&(0,L.fS)(l[1],m[1])||(0,L.fS)(l[0],m[1])&&(0,L.fS)(l[1],m[0]));++y)v[(0,k.sq)(m)]=!0;return this.vertexSegments_=v,void(this.regions_.is_modified=!0)}}}this.vertexFeature_&&(this.regions_.is_modified=!1,this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}}handlePointerEvent(e){if(!e.pointerEvent)return!0;var t=!1;if(this.updateTrackedPointers_(e),this.handlingDownUpSequence){if(e.type==P.Z.POINTERDRAG)this.handleDragEvent(e);else if(e.type==P.Z.POINTERUP){var i=this.handleUpEvent(e);this.handlingDownUpSequence=i&&this.targetPointers.length>0}}else if(e.type==P.Z.POINTERDOWN){var n=this.handleDownEvent(e);n&&e.preventDefault(),this.handlingDownUpSequence=n,t=this.stopDown(n)}else e.type==P.Z.POINTERMOVE&&this.handleMoveEvent(e);return!t}removeVertex_(){var e,t,i,n,s,o,r,a,l,h,d,c=this.dragSegments_,g={},p=!1;for(s=c.length-1;s>=0;--s)h=(i=c[s])[0],d=(0,k.sq)(h.feature),h.depth&&(d+="-"+h.depth.join("-")),d in g||(g[d]={}),0===i[1]?(g[d].right=h,g[d].index=h.index):1==i[1]&&(g[d].left=h,g[d].index=h.index+1);for(d in g){l=g[d].right,r=g[d].left,(a=(o=g[d].index)-1)<0&&(a=0),e=t=(n=(h=void 0!==r?r:l).geometry).getCoordinates(),p=!1;var u=n.getTransform();switch(n.getType()){case R.Z.MULTI_LINE_STRING:t[h.depth[0]].length>2&&(t[h.depth[0]].splice(o,1),p=!0);break;case R.Z.LINE_STRING:if(t.length>2&&(t.splice(o,1),p=!0,u)){this.setGeometryCoordinates_(n,t);var f=new D.Z(n.getInvertedCoordinates(),n.has_start_arrow_,n.has_end_arrow_,u);n.initial_coords_=f.getLineCoordinates()}break;case R.Z.MULTI_POLYGON:e=e[h.depth[1]];case R.Z.POLYGON:(e=e[h.depth[0]]).length>4&&(o==e.length-1&&(o=0),e.splice(o,1),p=!0,0===o&&(e.pop(),e.push(e[0]),a=e.length-1),u)&&(this.setGeometryCoordinates_(n,t),f=new z.Z(n.getInvertedCoordinates(),u),n.initial_coords_=f.getPolygonCoordinates())}if(p){this.setGeometryCoordinates_(n,t);var _=[];if(void 0!==r&&(this.rBush_.remove(r),_.push(r.segment[0])),void 0!==l&&(this.rBush_.remove(l),_.push(l.segment[1])),void 0!==r&&void 0!==l){var m={depth:h.depth,feature:h.feature,geometry:h.geometry,index:a,segment:_};this.rBush_.insert((0,N.hI)(m.segment),m)}this.updateSegmentIndices_(n,o,h.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),c.length=0}}return p}}const Y=function(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e);for(var t=e.coordinate,i=0,n=this.dragSegments_.length;i<n;++i){for(var s=this.dragSegments_[i],o=s[0],r=o.depth,a=o.geometry,l=a.getCoordinates(),h=o.segment,d=s[1],c=a.getTransform();t.length<a.getStride();)t.push(0);if(a instanceof S.Z)l=t,h[0]=h[1]=t;else if(a instanceof C.Z)l[o.index]=t,h[0]=h[1]=t;else if(a instanceof E.Z){if(l[o.index+d]=t,c){var g=new D.Z(a.getInvertedCoordinates(),a.has_start_arrow_,a.has_end_arrow_,c);a.initial_coords_=g.getLineCoordinates()}h[d]=t}else if(a instanceof A.Z)l[r[0]][o.index+d]=t,h[d]=t;else if(a instanceof F.Z){var p=t.slice();c&&(p=(0,H.HC)(a.transform_,p)),a.rx_=Math.abs(a.cx_-p[0]),a.ry_=Math.abs(a.cy_-p[1]),l=(g=new F.Z(a.cx_,a.cy_,a.rx_,a.ry_,c)).getCoordinates()}else if(a instanceof j.Z){if(null==this.oppVertBeingDragged){for(var u=this.vertexFeature_.getGeometry().getCoordinates(),f=0,_=0;_<l[r[0]].length;_++)if(l[r[0]][_][0]===u[0]&&l[r[0]][_][1]===u[1]){f=_;break}f>2&&f++;var m=(f+2)%5;this.oppVertBeingDragged=[l[0][m][0],l[0][m][1]]}var v=(p=(0,H.HC)(a.transform_,t.slice()))[0]<this.oppVertBeingDragged[0]?p[0]:this.oppVertBeingDragged[0],y=p[0]>this.oppVertBeingDragged[0]?p[0]:this.oppVertBeingDragged[0],b=-p[1]<-this.oppVertBeingDragged[1]?p[1]:this.oppVertBeingDragged[1],w=-p[1]>-this.oppVertBeingDragged[1]?p[1]:this.oppVertBeingDragged[1];l=(g=new j.Z(v,b,Math.abs(y-v),Math.abs(w-b),c)).getCoordinates(),a.initial_coords_=g.initial_coords_}else a instanceof z.Z?(l[r[0]][o.index+d]=t,c&&(g=new z.Z(a.getInvertedCoordinates(),c),a.initial_coords_=g.getPolygonCoordinates()),h[d]=t):a instanceof T.Z&&(l[r[1]][r[0]][o.index+d]=t,h[d]=t);this.setGeometryCoordinates_(a,l),this.regions_.viewer_.viewer_.getOverlays().forEach((e=>{e.updatePopupCoordinates&&e.updatePopupCoordinates(a)}))}this.createOrUpdateVertexFeature_(t)},q=function(e){var t;this.oppVertBeingDragged=null;for(var i=this.dragSegments_.length-1;i>=0;--i)(t=this.dragSegments_[i][0]).geometry instanceof j.Z||t.geometry instanceof F.Z?(this.removeFeatureSegmentData_(t.feature),this.writePolygonGeometry_(t.feature,t.geometry)):(this.rBush_.update((0,N.hI)(t.segment),t),this.vertexFeature_&&this.features_.remove(this.vertexFeature_)),t.feature.getId();return this.modified_&&(this.dispatchEvent(new w.m(U,this.features_,e)),this.modified_=!1),!1},$=function(e){var t;return e.map.getView().getHints()[x.Z.INTERACTING]||e.type!=P.Z.POINTERMOVE||this.handlingDownUpSequence||this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(e.type==P.Z.SINGLECLICK&&this.ignoreNextSingleClick_||this.features_ instanceof h.Z&&this.features_.getLength()>0&&(this.features_.item(0).getGeometry()instanceof j.Z||this.features_.item(0).getGeometry()instanceof F.Z)?t=!0:(this.vertexFeature_.getGeometry()instanceof S.Z||console.error("geometry should be an Point!"),this.willModifyFeatures_(e),t=this.removeVertex_(),this.dispatchEvent(new w.m(U,this.features_,e)),this.modified_=!1)),e.type==P.Z.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),_.Z.prototype.handleEvent.call(this,e)&&!t},B=V;var W=i(6627);class X extends W.Z{constructor(e){e instanceof te||console.error("Translate needs Regions instance!"),super({}),this.regions_=e,this.translatedFeatures_=[],this.hist_id_=-1,this.features_=this.regions_.select_.getFeatures(),(0,O.oL)(this,"translatestart",(function(e){this.translatedFeatures_=[];for(var t=e.features.array_,i=0;i<t.length;i++){var n=t[i];if(!(n.getGeometry()instanceof Z.Z||"object"==typeof n.permissions&&null!==n.permissions&&"boolean"==typeof n.permissions.canEdit&&!n.permissions.canEdit)){var s=n.clone();s.setId(n.getId()),this.translatedFeatures_.push(s)}}}),this),(0,O.oL)(this,"translating",(function(e){if(1==e.features.getArray().length){let t=e.features.getArray()[0].getGeometry();this.regions_.viewer_.viewer_.getOverlays().forEach((e=>{e.updatePopupCoordinates&&e.updatePopupCoordinates(t)}))}this.hist_id_>=0||0===this.translatedFeatures_.length||(this.hist_id_=this.regions_.addHistory(this.translatedFeatures_,!0))}),this),(0,O.oL)(this,"translateend",X.prototype.handleTranslateEnd,this)}handleTranslateEnd(e){this.translatedFeatures_=[];for(var t=e.features.array_,i=[],n=[],s=0;s<t.length;s++){var o=t[s];o.getGeometry()instanceof Z.Z||"object"==typeof o.permissions&&null!==o.permissions&&"boolean"==typeof o.permissions.canEdit&&!o.permissions.canEdit||(o.getGeometry()instanceof M.Z&&o.getGeometry().modifyOriginalCoordinates(e.target.getMap().getView().getRotation(),e.target.getMap().getView().getResolution()),i.push(o),n.push(o.getId()))}this.hist_id_<0||(this.regions_.addHistory(i,!1,this.hist_id_),(0,p.qD)(this.regions_.viewer_,"REGIONS_HISTORY_ENTRY",{hist_id:this.hist_id_,shape_ids:n}),this.hist_id_=-1,n.length>0&&this.regions_.setProperty(n,"state",G.HI.MODIFIED))}handleDownEvent_(e){return this.lastFeature_=this.featuresAtCoords_(e.pixel),!(this.lastCoordinate_||!this.lastFeature_||(this.lastCoordinate_=e.coordinate,X.handleMoveEvent_.call(this,e),this.dispatchEvent(new W.m("translatestart",this.features_,e.coordinate)),0))}handleMoveEvent_(e){}handleUpEvent_(e){return!!this.lastCoordinate_&&(this.lastCoordinate_=null,X.handleMoveEvent_.call(this,e),this.dispatchEvent(new W.m("translateend",this.features_,e.coordinate)),!0)}featuresAtCoords_(e){var t=this.regions_.select_.featuresAtCoords_(e,5,!0);return null===t||!(this.features_ instanceof h.Z)||t.getGeometry()instanceof Z.Z||"object"==typeof t.permissions&&null!==t.permissions&&"boolean"==typeof t.permissions.canEdit&&!t.permissions.canEdit||"boolean"==typeof this.regions_.is_modified&&this.regions_.is_modified?null:t}disposeInternal(){this.features_=null,this.regions_=null}}const Q=X;var J=i(29),K=i(6721);class ee extends n.Z{constructor(e,t){e instanceof r.Z||console.error("Regions needs an Viewer instance!");var i=t||{};i.useSpatialIndex=!0,super(i),this.scale_text_=!0,"boolean"==typeof i.scaleText&&(this.scale_text_=i.scaleText),this.rotate_text_=!1,"boolean"==typeof i.rotateText&&(this.rotate_text_=i.rotateText),this.show_comments_=!1,this.regions_info_=null,this.new_unsaved_shapes_={},this.viewer_=e,this.select_=null,this.translate_=null,this.modify_=null,this.draw_=null,this.present_modes_=[],this.history_={},this.history_id_=0,this.hoverId=null,this.initialize_=function(e,t){var i=function(t){e.regions_info_=t,e.new_unsaved_shapes_={};var i=(0,J.EI)(e);(0,p.kJ)(i)&&i.length>0&&e.addFeatures(i)};if((0,p.kJ)(t))i(t);else{var n={server:e.viewer_.getServer(),uri:e.viewer_.getPrefixedURI(G.oD)+G.VQ+"/?image="+e.viewer_.getId(),success:function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){console.error("Failed to parse json response!")}"object"==typeof e&&null!==e?i(e.data):console.error("Regions Request did not receive proper response!")},error:function(t){console.error("Error retrieving regions info for id: "+e.viewer_.getId()+(t&&t.length>0?"\\n"+t:""))}};(0,K.wG)(n)}},this.initialize_(this,i.data)}setModes(e){if((0,p.kJ)(e)){var t=!1,i=!1,n=!1,s=!1,o=!1,r=this.present_modes_.slice();for(var l in this.present_modes_=[],e)if(!("number"!=typeof e[l]||e[l]<0||e[l]>4)){if(e[l]===G.uo.DEFAULT){t=!0,i=n=s=o=!1;break}e[l]!==G.uo.SELECT?e[l]!==G.uo.TRANSLATE?e[l]!==G.uo.MODIFY?e[l]!==G.uo.DRAW||(i=!1,n=!1,s=!1,o=!0):(i=!0,s=!0,o=!1):(i=!0,n=!0,o=!1):(i=!0,o=!1)}var h=function(e){"boolean"!=typeof e&&(e=!1),this.modify_&&(this.viewer_.viewer_.getInteractions().remove(this.modify_),this.modify_.dispose(),this.modify_=null),this.translate_&&(this.viewer_.viewer_.getInteractions().remove(this.translate_),this.translate_.dispose(),this.viewer_.viewer_.getTargetElement()&&(this.viewer_.viewer_.getTargetElement().style.cursor=""),this.translate_=null),e||(this.viewer_.removeInteractionOrControl("boxSelect"),this.viewer_.removeInteractionOrControl("doubleClickZoom"),this.select_&&(this.select_.clearSelection(),this.viewer_.viewer_.getInteractions().remove(this.select_),this.select_.dispose(),this.select_=null),this.hover_&&(this.viewer_.viewer_.getInteractions().remove(this.hover_),this.hover_.dispose(),this.hover_=null),this.changed())},d=function(){this.draw_&&(this.draw_.dispose(),this.draw_=null)},c=function(){null===this.select_&&(this.select_=new f(this),this.viewer_.viewer_.addInteraction(this.select_),this.hover_=new y(this),this.viewer_.viewer_.addInteraction(this.hover_),this.viewer_.addInteraction("boxSelect",new b.Z(this)))};if(t)return d.call(this),h.call(this),void this.present_modes_.push(G.uo.DEFAULT);if(o)return h.call(this),null===this.draw_&&(this.draw_=new a.Z(r,this)),void this.present_modes_.push(G.uo.DRAW);h.call(this,!0),n&&(d.call(this),c.call(this),null===this.translate_&&(this.translate_=new Q(this),this.viewer_.viewer_.addInteraction(this.translate_)),this.present_modes_.push(G.uo.TRANSLATE)),s&&(d.call(this),c.call(this),null===this.modify_&&(this.modify_=new B(this),this.viewer_.viewer_.addInteraction(this.modify_)),this.present_modes_.push(G.uo.MODIFY)),i&&(d.call(this),c.call(this),function(){this.viewer_.addInteraction("doubleClickZoom","interaction")}.call(this),this.present_modes_.push(G.uo.SELECT))}}updateRegions(e){var t=!1;"boolean"==typeof e&&(t=e),this.select_&&this.select_.clearSelection(),this.viewer_.removeRegions();var i=this.featuresRtree_.getAll();for(var n in i){var s=i[n];s.state===G.HI.ADDED&&"object"!=typeof this.new_unsaved_shapes_[s.getId()]&&(this.new_unsaved_shapes_[s.getId()]=s)}if(this.clear(),t)this.initialize_(this);else{var o=(0,J.EI)(this,!0);(0,p.kJ)(o)||(o=[]),o.length>0&&this.addFeatures(o)}}setScaleText(e){"boolean"==typeof e&&(this.scale_text_=e,this.changed())}setRotateText(e){"boolean"==typeof e&&(this.rotate_text_=e,this.changed())}forEachFeatureInExtent(e,t,i){return this.featuresRtree_.forEachInExtent(e,(function(e){this.renderFeature(e)&&t.call(this,e)}),this)}renderFeature(e){if(!this.viewer_)return!1;var t=this.viewer_.getImage().image_projection_,i="boolean"!=typeof e.visible||e.visible,n="number"==typeof e.state&&e.state===G.HI.REMOVED,s="number"==typeof e.TheT?e.TheT:-1,o="number"==typeof e.TheZ?e.TheZ:-1,r="number"==typeof e.TheC?e.TheC:-1,a=this.viewer_.getDimensionIndex("t"),l=this.viewer_.getDimensionIndex("z"),h=this.viewer_.getDimensionIndex("c"),d=!0,c=function(){if(t===G.PO.INTMAX){var e=this.viewer_.getImage().projection_opts_,i=e?e.start:l,n=e?e.end:l;return-1!==o&&(o<i||o>n)}return-1!==o&&o!==l}.bind(this);return(-1!==r&&-1===h.indexOf(r)||-1!==s&&s!==a||c())&&(d=!1),i&&!n&&d}storeRegions(e,t){"boolean"!=typeof t&&(t=!1);try{var i={imageId:this.viewer_.id_,rois:e},n={server:this.viewer_.getServer(),uri:this.viewer_.getPrefixedURI(G.TQ)+"/persist_rois",method:"POST",content:JSON.stringify(i),headers:{"X-CSRFToken":(0,p.ej)("csrftoken")},jsonp:!1},s=this;n.success=function(i){var n={shapes:{},omit_client_update:t},o=[];try{(i=JSON.parse(i))&&"object"==typeof i.ids&&(n.shapes=i.ids),i&&(0,p.kJ)(i.errors)&&(o=i.errors)}catch(e){o.push("Failed to parse JSON response")}try{for(var r in n.shapes){var a=s.idIndex_[r];a.state===G.HI.REMOVED?s.removeFeature(a):(a.state=G.HI.DEFAULT,a.setId(n.shapes[r]),"object"!=typeof a.permissions&&(a.permissions={canAnnotate:!0,canEdit:!0,canDelete:!0}))}for(var l in e.new_and_deleted)r=e.new_and_deleted[l],"object"==typeof s.idIndex_[r]&&(s.removeFeature(s.idIndex_[r]),n.shapes[r]=r)}catch(e){o.push("Failed to sync rois"+e)}o.length>0&&(n.errors=o),(0,p.qD)(s.viewer_,"REGIONS_STORED_SHAPES",n)},n.error=function(e){var t={shapes:[],errors:[e]};(0,p.qD)(s.viewer_,"REGIONS_STORED_SHAPES",t)},(0,K.wG)(n,this)}catch(e){return console.error(e),!1}return!0}setHoverId(e){this.hoverId=e,this.changed()}getHoverId(){return this.hoverId}setProperty(e,t,i,n){if((0,p.kJ)(e)&&0!==e.length&&"string"==typeof t&&void 0!==i&&"object"==typeof this.idIndex_){var o=[],r=[],a=[],l=null;for(var h in e){var d=e[h],c=this.idIndex_[d];if(c instanceof s.Z){var g=null,u=this.select_ instanceof f;if("selected"===t||"visible"===t)l=t,!u||"visible"===t&&i||this.select_.toggleFeatureSelection(c,i);else if("state"===t){if(g=c[t],i===G.HI.REMOVED){if("object"==typeof c.permissions&&null!==c.permissions&&"boolean"==typeof c.permissions.canDelete&&!c.permissions.canDelete)continue;u&&this.select_.toggleFeatureSelection(c,!1),g===G.HI.REMOVED||"number"==typeof c.old_state&&c.old_state===G.HI.ADDED||(c.old_state=g),l="deleted"}else if(i===G.HI.MODIFIED){if("object"==typeof c.permissions&&null!==c.permissions&&"boolean"==typeof c.permissions.canEdit&&!c.permissions.canEdit)continue;if(g===G.HI.REMOVED){c.old_state=i;continue}g===G.HI.ADDED&&(c.old_state=g),l="modified"}else if(i===G.HI.ROLLBACK){if("object"==typeof c.permissions&&null!==c.permissions&&"boolean"==typeof c.permissions.canDelete&&!c.permissions.canDelete)continue;l="rollback"}}else l=t;c[t]="state"===t&&i===G.HI.ROLLBACK?"number"==typeof c.old_state?c.old_state:G.HI.DEFAULT:i,o.push(d);var _=!0;"rollback"===l?(l="deleted",_=!1):_="deleted"===l||"state"===t&&"modified"===l||i,r.push(l),a.push(_)}}this.changed(),(0,p.qD)(this.viewer_,"REGIONS_PROPERTY_CHANGED",{properties:r,shapes:o,values:a,callback:n},25)}}addHistory(e,t,i){if((0,p.kJ)(e)&&0!==e.length){var n={};if("number"!=typeof i?(i=++this.history_id_,this.history_[i]=n):n=this.history_[i],"object"==typeof n){for(var s=0;s<e.length;s++){var o=e[s],r={old_state:o.state,new_state:G.HI.MODIFIED,old_value:null,new_value:null};"object"==typeof n[o.getId()]?r=n[o.getId()]:n[o.getId()]=r;var a=o.getGeometry().clone();t?r.old_value=a:r.new_value=a}return i}}}doHistory(e,t){if("object"==typeof this.history_[e]){"boolean"!=typeof t&&(t=!0);var i=this.history_[e];for(var n in i){var o=i[n];if(this.idIndex_[n]instanceof s.Z){this.idIndex_[n].setGeometry(t?o.old_value:o.new_value);var r=t?o.old_state:o.new_state;r!==this.idIndex_[n].state&&(this.idIndex_[n].state=r,this.setProperty([this.idIndex_[n].getId()],"modified",r!==G.HI.DEFAULT))}}}}getLengthAndAreaForShape(e,t){return(e instanceof s.Z||e instanceof o.Z)&&this.viewer_?("boolean"!=typeof t&&(t=!1),(0,J.J1)(e,t,this.viewer_.viewer_.getView().getProjection().getMetersPerUnit(),this.viewer_.image_info_.pixel_size.symbol_x||"px")):null}disposeInternal(){this.clear(),this.featuresRtree_=null,this.loadedExtentsRtree_=null,this.nullGeometryFeatures_=null,this.history_={},this.regions_info_=null,this.viewer_=null}}const te=ee},8500:(e,t,i)=>{"use strict";i.d(t,{Fj:()=>y,I5:()=>C,Uw:()=>I,ZQ:()=>T,hg:()=>m,iQ:()=>A,uX:()=>S,wT:()=>_,y_:()=>E});var n=i(4889),s=i(2790),o=i(3721),r=i(3529),a=i(4780),l=i(1221),h=i(1201),d=i(3e3),c=i(2933),g=i(9256),p=i(6866),u=i(4783),f=i(366);const _="rgba(1,1,1,0)",m=function(e){var t=v(e);if(null==t)return null;var i="rgba(";return i+=t.red.toString(10)+",",i+=t.green.toString(10)+",",i+=t.blue.toString(10)+",",(i+=t.alpha.toString(10))+")"},v=function(e){if("object"!=typeof e)return null;var t=["red","green","blue"];for(var i in t){if(void 0===e[t[i]])return null;var n=e[t[i]];if(n<0||n>255)return null}return void 0===e.alpha&&(e.alpha=1),e},y=function(e){if("number"!=typeof e)return null;e<0&&(e>>>=0);var t=e.toString(16);return t=("00000000"+t).slice(-8),{red:parseInt(t.substring(0,2),16),green:parseInt(t.substring(2,4),16),blue:parseInt(t.substring(4,6),16),alpha:parseInt(t.substring(6,8),16)/255}},b=function(e,t){if("number"!=typeof t&&(t=parseInt(t),isNaN(t)&&(t=1)),"string"==typeof e?e=-1!=e.indexOf("rgba")?function(e,t){if("string"!=typeof e||0===e.length)return null;"number"!=typeof t&&(t=1);try{var i=e.replace(/\(rgba|\(|rgba|rgb|\)/g,"").split(",");if(i.length<3)return null;var n={red:255,green:255,blue:255,alpha:t};n.red=parseInt(i[0],10),n.green=parseInt(i[1],10),n.blue=parseInt(i[2],10),i.length>3&&(n.alpha=parseFloat(i[3],10))}catch(e){return null}return(n.red<0||n.red>255||n.green<0||n.green>255||n.blue<0||n.blue>255)&&console.error("RGB values need to range in between 0 and 255!"),(n.alpha<0||n.alpha>1)&&console.error("Alpha values need to range in between 0 and 1!"),n}(e,t):function(e,t){if("string"!=typeof e||0===e.length)return null;"number"!=typeof t&&(t=1);try{var i=e.replace(/#|\s/g,"");if(3===i.length&&(i=""+i[0]+i[0]+i[1]+i[1]+i[2]+i[2]),6!=i.length)return null;var n={red:255,green:255,blue:255,alpha:t};return n.red=parseInt(i.substring(0,2),16),n.green=parseInt(i.substring(2,4),16),n.blue=parseInt(i.substring(4,6),16),n}catch(e){return null}}(e,t):(0,f.kJ)(e)&&(e=function(e,t){return!(0,f.kJ)(e)||e.length<3?null:(t=3===e.length&&"number"!=typeof t?1:e[3],{red:e[0],green:e[1],blue:e[2],alpha:t})}(e,t)),"object"==typeof e&&null!==e&&"number"!=typeof e.alpha&&(e.alpha=t),"object"!=typeof e||"object"!=typeof(e=v(e)))return null;var i=255*e.alpha;return t=i-parseInt(i)<=.5?Math.floor(i):Math.ceil(i),e.red<<24|e.green<<16|e.blue<<8|t},w=function(e,t){if(!(e instanceof h.Z))throw"type line must be an instance of Line!";var i={};"number"==typeof t&&(i["@id"]=t);var n=e.getLineCoordinates();if(e.isPolyline())return x.call(null,e,t);i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Line",i.X1=n[0],i.X2=n[2],i.Y1=-n[1],i.Y2=-n[3],e.has_start_arrow_&&(i.MarkerStart="Arrow"),e.has_end_arrow_&&(i.MarkerEnd="Arrow");var s=e.getTransform();return"object"==typeof s&&null!==s&&(s["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=s),i},x=function(e,t){if(!(e instanceof h.Z))throw"type polyline must be an instance of Line!";var i={};"number"==typeof t&&(i["@id"]=t);var n=e.getLineCoordinates();if(!e.isPolyline())return w.call(null,e,t);i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Polyline",i.Points="";for(var s=0;s<n.length;s+=2)0!==s&&s%2==0&&(i.Points+=" "),i.Points+=n[s]+","+-n[s+1];e.has_start_arrow_&&(i.MarkerStart="Arrow"),e.has_end_arrow_&&(i.MarkerEnd="Arrow");var o=e.getTransform();return"object"==typeof o&&null!==o&&(o["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=o),i},I={point:function(e,t){if(!(e instanceof d.Z))throw"type point must be an instance of geom.Point!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Point";var n=e.getPointCoordinates();i.X=n[0],i.Y=-n[1];var s=e.getTransform();return"object"==typeof s&&null!==s&&(s["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=s),i},ellipse:function(e,t){if(!(e instanceof a.Z))throw"type ellipse must be an instance of Ellipse!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Ellipse";var n=e.getCenter();i.X=n[0],i.Y=-n[1];var s=e.getRadius();i.RadiusX=s[0],i.RadiusY=s[1];var o=e.getTransform();return"object"==typeof o&&null!==o&&(o["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=o),i},rectangle:function(e,t){if(!(e instanceof g.Z))throw"type rectangle must be an instance of Rectangle!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Rectangle";var n=e.getUpperLeftCorner();i.X=n[0],i.Y=-n[1],i.Width=e.getWidth(),i.Height=e.getHeight();var s=e.getTransform();return"object"==typeof s&&null!==s&&(s["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=s),i},line:w,polyline:x,label:function(e,t){if(!(e instanceof l.Z))throw"type label must be an instance of Label!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Label";var n=e.getUpperLeftCorner();return i.X=n[0],i.Y=-n[1],i},polygon:function(e,t){if(!(e instanceof c.Z))throw"type polygon must be an instance of Polygon!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Polygon";var n=e.getPolygonCoordinates();i.Points="";for(var s=0;s<n.length;s+=2)0!==s&&s%2==0&&(i.Points+=" "),i.Points+=n[s]+","+-n[s+1];var o=e.getTransform();return"object"==typeof o&&null!==o&&(o["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=o),i},mask:function(e,t){if(!(e instanceof p.Z))throw"type mask must be an instance of Mask!";var i={};"number"==typeof t&&(i["@id"]=t),i["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#Mask";var n=e.getPointCoordinates();i.X=n[0],i.Y=-n[1],i.Width=e.size_[0],i.Height=e.size_[1];var s=e.getTransform();return"object"==typeof s&&null!==s&&(s["@type"]="http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",i.Transform=s),i}},S=function(e,t){if("object"==typeof t&&"string"==typeof t["@type"]&&e instanceof s.Z&&(e.getStyle()instanceof o.ZP||"function"==typeof e.getStyle())){var i=e.getStyle();if("function"==typeof i&&(i=i(1)),(0,f.kJ)(i)&&(i=i[0]),i instanceof o.ZP){var n="http://www.openmicroscopy.org/Schemas/OME/2016-06#Label"===t["@type"],a=n&&i.getText()&&i.getText().getFill()?i.getText().getFill().getColor():i.getFill()?i.getFill().getColor():null;a&&a!==_&&(t.FillColor=b(a));var l=n&&i.getText()&&i.getText().getFill()?i.getText().getFill().getColor():"object"==typeof e.oldStrokeStyle&&null!==e.oldStrokeStyle&&void 0!==e.oldStrokeStyle.color?e.oldStrokeStyle.color:null;l&&(t.StrokeColor=b(l));var h="object"==typeof e.oldStrokeStyle&&null!==e.oldStrokeStyle&&"number"==typeof e.oldStrokeStyle.width?e.oldStrokeStyle.width:1;t.StrokeWidth={"@type":"TBD#LengthI",Unit:"PIXEL",Symbol:"px",Value:n&&i.getText()&&i.getText().getStroke()?i.getText().getStroke().getWidth():h};var d=i.getText();if(null===d&&e.oldText instanceof r.Z&&(d=e.oldText),d instanceof r.Z&&(d.getText()&&(t.Text=d.getText()),d.getFont())){var c=d.getFont().split(" ");if(3==c.length)try{t.FontStyle=c[0],t.FontSize={"@type":"TBD#LengthI",Unit:"POINT",Symbol:"pt",Value:parseInt(c[1])},t.FontFamily=c[2]}catch(e){}}}}},C=function(e,t){"object"==typeof t&&e instanceof s.Z&&(["TheZ","TheT","TheC"].map((i=>{"number"==typeof e[i]&&e[i]>=0&&(t[i]=e[i])})),"number"==typeof e.Area&&(t.Area=e.Area),"number"==typeof e.Length&&(t.Length=e.Length))},T=function(e,t,i){if(!(e instanceof n.Z)||0===e.getLength())return null;var o="boolean"==typeof t&&t;i=i||{};for(var r=-1,a={count:0,empty_rois:{},new_and_deleted:[],deleted:{},new:[],modified:[]},l={},h=e.getArray(),d=0;d<h.length;d++){var c=h[d];if(c instanceof s.Z&&null!==c.getGeometry()&&"number"==typeof c.state&&c.state!==u.HI.DEFAULT){var g=-1,p=-1;if(!("string"!=typeof c.getId()||c.getId().length<3)){var _=c.getId().indexOf(":");if(!(_<1)){try{if(g=parseInt(c.getId().substring(0,_)),p=parseInt(c.getId().substring(_+1)),isNaN(g)||isNaN(p))continue}catch(e){continue}var m=g;if(c.state!==u.HI.REMOVED){if(c.state===u.HI.MODIFIED){if("object"==typeof c.permissions&&null!==c.permissions&&"boolean"==typeof c.permissions.canEdit&&!c.permissions.canEdit)continue;if((g<0||p<0)&&o)m=r--;else if(g>0&&p>0){var v=E(c,p,m);v.oldId=c.getId(),a.modified.push(v),a.count++;continue}}else c.state===u.HI.ADDED&&o&&(m=r--);var y=null;"object"==typeof l[m]||(l[m]={"@type":"http://www.openmicroscopy.org/Schemas/OME/2016-06#ROI",shapes:[]}),y=l[m];var b=E(c,p,m);null!==b&&(b.oldId=c.getId(),y.shapes.push(b),a.count++)}else{if(g<0||p<0||"object"==typeof c.permissions&&null!==c.permissions&&"boolean"==typeof c.permissions.canDelete&&!c.permissions.canDelete){a.new_and_deleted.push(c.getId());continue}void 0===i[g]?((0,f.kJ)(a.deleted[g])||(a.deleted[g]=[]),a.deleted[g].push(c.getId())):((0,f.kJ)(a.empty_rois[g])||(a.empty_rois[g]=[]),a.empty_rois[g].push(c.getId())),a.count++}}}}}var w=[];for(var x in l)if((0,f.kJ)(l[x].shapes)){var I=l[x].shapes;for(var S in I)w.push(I[S])}return a.new=w,a},E=function(e,t,i){var n=e.type;try{if("number"!=typeof t)try{var s=e.getId().indexOf(":");s>0&&(t=parseInt(e.getId().substring(s+1)))}catch(t){return console.error("Failed to turn feature "+n+"("+e.getId()+") into json => "+t),null}var o=I[n].call(null,e.getGeometry(),"number"!=typeof i||i>-1?t:null);return S(e,o),C(e,o),o}catch(t){return console.error("Failed to turn feature "+n+"("+e.getId()+") into json => "+t),null}},A=function(e){if("string"!=typeof e)return null;var t=e.split(" ");if(0===t.length)return null;var i=[];for(var n in t){var s=t[n].trim();if(""!==s){var o=s.split(",");if(o.length<2)return null;var r=parseFloat(o[0]),a=parseFloat(o[1]);if(isNaN(r)||isNaN(a))return null;i.push([r,-a])}}return i}},366:(e,t,i)=>{"use strict";i.d(t,{Hm:()=>c,Lc:()=>a,Ox:()=>l,ef:()=>g,ej:()=>d,kJ:()=>h,qD:()=>p,sn:()=>u});var n=i(5745),s=i(2929),o=i(426);const r="normal",a=function(e){if(!h(e)||0===e.length||1===e.length&&1===e[0])return function(e,t){("number"!=typeof e||e<.01||e>=1)&&(e=.2),("number"!=typeof t||t<.1||t>=5)&&(t=1);for(var i=[],n=[],s=1+t;s<5;s+=t)n.push(s);(i=i.concat(n.reverse())).push(1);var o=[];for(s=1-e;s>.01;s-=e)o.push(s);return i.concat(o)}(.025,.1);var t=[1],i=e.indexOf(1);-1===i&&e.push(1),e.sort(((e,t)=>t-e));for(var n=(i=e.indexOf(1))>0?i:e.length-1;n>0;n--)for(var s=e[n],o=e[n-1],r=.125*Math.abs(o-s),a=1;a<=8;a++)t.push(s+a*r);if(i<e.length-1)for(var l=i+1;l<e.length;l++)t.push(e[l]);t.sort(((e,t)=>t-e));var d=(1===t.length?20:t.length+10)-t.length,c=!0;for(t.length-i<i&&(c=!1);d>0;){if(c)c=!1,t.splice(0,0,1.2*t[0]);else{c=!0;var g=t[t.length-1]/1.1;t.push(g)}d--}return t},l=function(e){if(!h(e)||0===e.length)return null;var t=[];for(var i in e)if(t.length>0){var n=t[0].getGeometry();(0,s.r4)(n.getExtent(),e[i].getGeometry().getExtent())&&(t[0]=e[i])}else t.push(e[i]);return t.length>0?t[0]:null},h=function(e){return"object"==typeof e&&null!==e&&(e instanceof Array||"[object Array]"===Object.prototype.toString.call(null,e))},d=function(e){if("string"!=typeof e)return"";for(var t=document.cookie.split(";"),i=0,n=t.length;i<n;i++){for(var s=t[i];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(e+"="))return s.substring(e.length+1,s.length)}return""},c=function(e,t){if("string"!=typeof e||0===e.length)return null;var i=[],n=(e=e.replace(/\s/g,"")).split(",");if(0===n.length)return null;for(var s in n){var o=n[s],r=o.indexOf("|");if(-1!==r){var a=parseInt(o.substring(0,r));if(!isNaN(a)){var l={index:a<0?-a-1:a-1,active:!(a<0)};if(-1!==(r=(o=o.substring(r+1)).indexOf("$"))){var d=o.substring(0,r).split(":");if(2===d.length){var c=parseInt(d[0]),g=parseInt(d[1]);isNaN(c)||isNaN(g)||(l.start=c,l.end=g,o=o.substring(r+1),l.color=o,i.push(l))}}}}}if("string"!=typeof t||0===t.length)return i;try{t=t.replace(/&quot;/g,'"');var p=JSON.parse(t);if(!h(p))return i;for(var u=i.length,f=0;f<u&&f<p.length;f++){var _=p[f];"object"==typeof _&&null!==_&&(i[f].inverted="object"==typeof _.inverted&&_.inverted&&"boolean"==typeof _.inverted.enabled&&_.inverted.enabled,"string"!=typeof _.family||""===_.family||"number"!=typeof _.coefficient||isNaN(_.coefficient)||(i[f].family=_.family,i[f].coefficient=_.coefficient))}}catch(e){}return i},g=function(e){var t={projection:r};if("string"!=typeof e||0===e.length)return t;var i=e.indexOf("|");if(-1!==i){t.projection=e.substring(0,i);var n=e.substring(i+1).split(":");2===n.length&&(t.start=parseInt(n[0]),t.end=parseInt(n[1]))}else t.projection=e;return t.projection!==r&&"intmax"!==t.projection&&(t.projection=r),t},p=function(e,t,i,s){if(e instanceof o.Z&&e.viewer_ instanceof n.Z&&!e.prevent_event_notification_&&"string"==typeof t&&0!==t.length){var r=u(e.viewer_.getTargetElement()),a=e.eventbus_;if(r&&a){"object"==typeof i&&null!==i||(i={}),i.config_id=r,i.sync_group=e.sync_group_;var l=function(){a.publish(t,i)};"number"==typeof s&&s>0?setTimeout(l,s):l()}}},u=function(e){try{var t="string"==typeof e?e:"object"==typeof e&&null!==e&&"string"==typeof e.id?e.id:null;if(null===t)return null;var i=t.lastIndexOf("_");if(-1===i)return t;var n=parseInt(t.substring(i+1));return isNaN(n)?null:n}catch(e){return null}}},6721:(e,t,i)=>{"use strict";i.d(t,{$2:()=>n,at:()=>s,wG:()=>o});const n=function(e){if("string"!=typeof e)return null;try{var t={path:"/",query:"",full:"/",relative:!0};if(0===(e=e.replace(/\s/g,"")).length)return t;for(var i=e.length,n=0;n<i&&"/"===e.charAt(n);n++)t.relative=!1,e=e.substring(n+1),n--;var s=e.indexOf("?");if(-1!==s&&(t.query=e.substring(s+1),e=e.substring(0,s)),(i=e.length)>0)for(n=i-1;n>=0&&"/"===e.charAt(n);n--)e=e.substring(0,n);return t.path=e,t.full=t.path,t.query.length>0&&(t.full+="/?"+t.query),t}catch(e){return null}},s=function(e){if("string"!=typeof e)return null;try{var t={protocol:"",server:"",full:""};if(0===(e=e.replace(/\s/g,"")).length)return t;var i=e.indexOf("://");if(-1===i)t.protocol="http";else{var n=e.substring(0,i).toLowerCase();if("http"!==n&&"https"!==n&&"file"!==n)return null;t.protocol=n,e=e.substring(i+"://".length)}var s=e.length;if(s>0)for(var o=s-1;o>0&&"/"===e.charAt(o);o--)e=e.substring(0,o);return t.server=e,t.full=t.protocol+"://"+t.server,t}catch(e){return null}},o=function(e,t){var i=e||{};"object"==typeof i&&null!==i||console.error("sendRequest did not receive a params object");var o=i.server||"";"string"==typeof o&&(o=s(o)),"object"==typeof o&&null!==o||console.error("sendRequest server info is invalid");var r=i.uri||"";"string"!=typeof r&&console.error("sendRequest uri parameter has to be a string"),"object"==typeof(r=n(r))&&null!==r||console.error("sendRequest uri parameter is invalid");var h="string"==typeof i.method?i.method.toUpperCase():"GET",d=("boolean"==typeof i.jsonp&&i.jsonp,"object"==typeof i.headers?i.headers:{}),c="string"==typeof i.content?i.content:null,g="number"==typeof i.timeout?i.timeout:6e4,p="function"==typeof i.success?i.success:function(e){},u="function"==typeof i.error?i.error:function(e){console.error(e)};!function(e){return"object"==typeof e&&"string"==typeof e.protocol&&"string"==typeof e.server&&"string"==typeof e.full&&(""===e.full||("file:"===window.location.protocol?window.location.href:window.location.protocol+"//"+window.location.host).toLowerCase()===e.full.toLowerCase())}(o)?l(o,r,p,u,t):a(o,r,p,u,h,d,g,c,t)},r=function(e,t,i,n,s,o,r,a,l){"boolean"!=typeof e&&console.error("this method needs the is_jsonp_request flag as first argument!"),"object"==typeof t&&null!==t||console.error("sendRequest server parameter has to be an object"),"string"!=typeof t.full&&console.error("sendRequest server parameter has to have the fully qualified server name"),"object"==typeof i&&null!==i||console.error("sendRequest uri parameter has to be an object"),"string"==typeof i.query&&"string"==typeof i.full||console.error("sendRequest uri parameter has to have the fully qualified uri"),"function"==typeof n&&"function"==typeof s||console.error("sendRequest success/error handlers have to be functions"),e||("string"!=typeof o&&console.error("sendRequest method has to be a string"),"object"==typeof r&&null!==r||console.error("sendRequest header parameter has to be an object"),"number"!=typeof a&&console.error("sendRequest timeout has to be a number"),null!=l&&"string"!=typeof l&&console.error("sendRequest post content has to be a string"))},a=function(e,t,i,n,s,o,a,l,h){r(!1,e,t,i,n,s,o,a,l);var d=void 0!==window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=""===e.full&&t.relative?t.full:e.full+"/"+t.full,g="_="+(new Date).getTime();for(var p in""===t.query?c+="/?"+g:c+="&"+g,d.open(s,c,!0),o)d.setRequestHeader(p,o[p]);d.timeout=a,d.ontimeout=function(){console.error("xhr request timed out!")},d.onerror=function(e){var t=void 0!==e.target?e.target.responseText:null,i=null===t?"xhr: an error occured":"xhr error: "+t;console.error(i)},d.onreadystatechange=function(e){if(4==d.readyState&&d.status>=200&&d.status<300){var t=d.responseText;if(void 0===t&&(t=null),null!==t){var s="webclient/login/?url=",o="string"==typeof d.responseURL,r=o?d.responseURL.lastIndexOf(s):d.responseText.lastIndexOf(s);if(-1!==r){var a=s,l=window.location.href;return o&&(a=d.responseURL.substring(0,r+s.length)),window.location.href=a+l,!0}h?i.call(h,t):i(t)}else h?n.call(h,d.statusText):n(d.statusText);return!0}return 4==d.readyState&&(h?n.call(h,d.statusText):n(d.statusText),!0)},d.send("POST"===s?l:null)},l=function(e,t,i,n,s){r(!0,e,t,i,n);var o=document.head,a=document.createElement("script"),l="jsonpCallback_"+(new Date).getTime(),h=function(){delete window[l],a&&o.removeChild(a),a=null},d=setTimeout((function(){var e="jsonp request ran into timeout";s?n.call(s,e):n(e),h(),console.error(e)}),9e4);window[l]=function(e){try{clearTimeout(d),s?i.call(s,e):i(e)}catch(e){s?n.call(s,e):n(e)}finally{h()}},a.onerror=function(e){clearTimeout(d),h(),console.error("JSONP request failed!"),s?n.call(s,n):n(e)};try{var c=e.full+"/"+t.full;""==t.query?c+="/?":c+="&",a.src=c+"callback="+l,o.appendChild(a)}catch(e){clearTimeout(d),h(),console.error("jsonp failed => "+e)}}},29:(e,t,i)=>{"use strict";i.d(t,{EI:()=>T,J1:()=>E,mE:()=>S,xA:()=>A});var n=i(2790),s=i(4070),o=i(8816),r=i(8765),a=i(8185),l=i(4780),h=i(3e3),d=i(1201),c=i(1221),g=i(2933),p=i(9256),u=i(7630),f=i(6866),_=i(4783),m=i(9672),v=i(366),y=i(8500),b=i(2929);const w={point:function(e){var t=new n.Z({geometry:new h.Z([e.X,-e.Y],"object"==typeof e.Transform?e.Transform:null)});return t.type="point",t.setStyle((0,m.WR)(e)),t},ellipse:function(e){var t=new n.Z({geometry:new l.Z(e.X,-e.Y,e.RadiusX,e.RadiusY,"object"==typeof e.Transform?e.Transform:null)});return t.type="ellipse",t.setStyle((0,m.WR)(e)),t},rectangle:function(e){var t=new n.Z({geometry:new p.Z(e.X,-e.Y,e.Width,e.Height,"object"==typeof e.Transform?e.Transform:null)});return t.type="rectangle",t.setStyle((0,m.WR)(e)),t},line:function(e){var t="string"==typeof e.MarkerStart&&"Arrow"===e.MarkerStart,i="string"==typeof e.MarkerEnd&&"Arrow"===e.MarkerEnd,s=new n.Z({geometry:new d.Z([[e.X1,-e.Y1],[e.X2,-e.Y2]],t,i,"object"==typeof e.Transform?e.Transform:null)});return s.type="line",s.setStyle((0,m.WR)(e)),s},polyline:function(e){if("string"!=typeof e.Points)return null;var t=(0,y.iQ)(e.Points);if(null===t)return null;var i="string"==typeof e.MarkerStart&&"Arrow"===e.MarkerStart,s="string"==typeof e.MarkerEnd&&"Arrow"===e.MarkerEnd,o=new n.Z({geometry:new d.Z(t,i,s,"object"==typeof e.Transform?e.Transform:null)});return o.type="polyline",o.setStyle((0,m.WR)(e)),o},label:function(e){"string"!=typeof e.Text&&(e.Text=""),"object"==typeof e.FontSize&&null!==e.FontSize&&"number"==typeof e.FontSize.Value||(e.FontSize={Value:10,Unit:"PIXEL"}),"string"!=typeof e.FontFamily&&(e.FontFamily="sans-serif"),"string"!=typeof e.FontStyle&&(e.FontStyle="normal");var t=e.FontStyle+" "+e.FontSize.Value+"px "+e.FontFamily,i=(0,m.E0)(e.Text,t),s=new n.Z({geometry:new c.Z(e.X,-e.Y,i)});return s.type="label",s.setStyle((0,m.WR)(e,!0)),s},polygon:function(e){if("string"!=typeof e.Points)return null;var t=(0,y.iQ)(e.Points);if(null===t)return null;var i=new n.Z({geometry:new g.Z([t],"object"==typeof e.Transform?e.Transform:null)});return i.type="polygon",i.setStyle((0,m.WR)(e)),i},mask:function(e){var t=new n.Z({geometry:new f.Z(e.X,-e.Y,e.Width,e.Height,"object"==typeof e.Transform?e.Transform:null)});return t.type="mask",t.setStyle((0,m.WR)(e,!0)),t}},x=function(e){return"string"!=typeof e||0===e.length?null:(e=e.toLowerCase(),void 0===w[e]?null:w[e])},I=function(e){var t=x(e.type);if("function"!=typeof t)return console.error("Failed to find factory method for shape: "+e),null;(0,m.$g)(e);var i=t(e);return i instanceof n.Z?i:null},S=function(e,t,i,s,o){if((0,v.kJ)(i)&&4==i.length&&"number"==typeof t&&!(t<=0)){if(null==x(e.type))return null;"boolean"!=typeof o&&(o=!1),(0,m.$g)(e),(0,m.xq)(e);var r=I(e);if(null==r)return null;r.state=_.HI.ADDED;var l=(0,v.kJ)(s)&&2===s.length?s.slice():null;if(null!==l||null===l&&!o){var h=r.getGeometry().getExtent(),d=(0,b.dz)(h),c=(0,b.Cr)(h);0===c&&(c=1),0===d&&(d=1);var g=(0,b.dz)(i),p=(0,b.Cr)(i),u=(0,b.rL)(h);r.getGeometry().translate(-u[0],-u[1]),(0,b.rL)(i),i=[0,0,g-d,p-c]}for(var f=[],y=0;y<t;y++){var w=new n.Z({geometry:r.getGeometry().clone()});if(w.type=r.type,w.setStyle((0,m.fN)(r.getStyle())),"string"!=typeof e.shape_id||0===e.shape_id.length||-1===e.shape_id.indexOf(":")?w.setId(("number"==typeof e.roi_id?e.roi_id+":":"-1:")+-(0,a.sq)(w)):w.setId(e.shape_id),w.state=_.HI.ADDED,null!==l||o)null!==l&&w.getGeometry().translate(l[0],l[1]);else{var S=C(i);w.getGeometry().translate(S[0],S[1])}f.push(w)}return f}},C=function(e){if(!(0,v.kJ)(e)||4!=e.length)return null;var t=e[2],i=Math.floor(Math.random()*(t-0+1))+0;return t=e[3],[i,-(Math.floor(Math.random()*(t-0+1))+0)]},T=function(e,t){if(!(e instanceof u.Z&&(0,v.kJ)(e.regions_info_)))return null;var i=[];for(var s in e.regions_info_)if("number"==typeof e.regions_info_[s]["@id"]&&(0,v.kJ)(e.regions_info_[s].shapes)){var o=e.regions_info_[s]["@id"];for(var r in e.regions_info_[s].state=_.HI.DEFAULT,e.regions_info_[s].shapes){var a=e.regions_info_[s].shapes[r];if("number"==typeof a["@id"]){var l=a["@id"],h=a["@type"],d=h.lastIndexOf("#");a.type=-1!==d?h.substring(d+1).toLowerCase():null,l=o+":"+a["@id"];var g="number"==typeof a.TheT?a.TheT:-1,p="number"==typeof a.TheZ?a.TheZ:-1,f="number"==typeof a.TheC?a.TheC:-1;a.state=_.HI.DEFAULT;try{var y=I(a);if(!(y instanceof n.Z)){console.error("Failed to create "+h+"("+l+") from json!");continue}y.setId(l);var b=e.viewer_.viewer_.getView().getRotation();if(y.getGeometry()instanceof c.Z&&0!==b&&!e.rotate_text_&&y.getGeometry().rotate(-b),(0,m.Ru)(y,e,!0),y.TheT=g,y.TheZ=p,y.TheC=f,y.state=_.HI.DEFAULT,"object"!=typeof a["omero:details"]||null===a["omero:details"]||"object"!=typeof a["omero:details"].permissions||null===a["omero:details"].permissions){console.error("Missing persmissons for shape "+y.getId());continue}y.permissions=a["omero:details"].permissions,e.getLengthAndAreaForShape(y,!0),i.push(y)}catch(e){console.error("Failed to create ol3 feature for: "+l),console.error(e);continue}}}}if("boolean"==typeof t&&t&&"object"==typeof e.new_unsaved_shapes_)for(var w in e.new_unsaved_shapes_){var x=e.new_unsaved_shapes_[w],S="number"==typeof x.TheT?x.TheT:-1,C="number"==typeof x.TheZ?x.TheZ:-1;(-1===S||-1===C||e.viewer_.getDimensionIndex("t")===S&&e.viewer_.getDimensionIndex("z")===C)&&i.push(x)}return i},E=function(e,t,i,o){"number"!=typeof i&&(i=1);var r=e.getGeometry?e.getGeometry():e,a=!(r instanceof s.Z||r instanceof d.Z||r instanceof c.Z),l=r instanceof d.Z;if("string"!=typeof o||0!==o.localeCompare("µm"))for(var h=0;h<_.g9.length;h++){var g=_.g9[h];if(0===g.symbol.localeCompare(o)){i*=g.multiplier;break}}var p=function(e){return e<0?e:Number(Math.round(e+"e3")+"e-3")};if(e instanceof n.Z)return("number"!=typeof e.Area||t)&&(e.Area=a?p(r.getArea()*(i*i)):-1),("number"!=typeof e.Length||t)&&(e.Length=l?p(r.getLength()*i):-1),{id:e.getId(),Area:e.Area,Length:e.Length};{let e={};return l&&(e.Length=p(r.getLength()*i)),a&&(e.Area=p(r.getArea()*(i*i))),e}},A=function(e){return e instanceof o.Z?(0,r.W)(e.flatCoordinates,0,e.flatCoordinates.length,e.stride):0}},9672:(e,t,i)=>{"use strict";i.d(t,{$T:()=>x,$g:()=>S,E0:()=>y,Ru:()=>v,WR:()=>m,fN:()=>b,xq:()=>I});var n=i(2790),s=i(4889),o=i(3721),r=i(1256),a=i(9107),l=i(8405),h=i(3529),d=i(4783),c=i(8500),g=i(7630),p=i(1221),u=i(1201),f=i(6866),_=i(366);const m=function(e,t,i){if("object"!=typeof e)return null;var n="boolean"==typeof t&&t;"boolean"!=typeof i&&(i=!0);var s={count:0},r={count:0},g=null;"number"==typeof e.FillColor&&(g=(0,c.Fj)(e.FillColor),r.color=(0,c.hg)(g),null!=r.color&&r.count++),"number"==typeof e.StrokeColor&&(g=(0,c.Fj)(e.StrokeColor),s.color=(0,c.hg)(g),null!=s.color&&s.count++),"object"==typeof e.StrokeWidth&&null!==e.StrokeWidth&&"number"==typeof e.StrokeWidth.Value?(s.width=e.StrokeWidth.Value,s.count++):i&&(s.width=1),s.count>0&&(s.lineCap=d.oL,s.lineJoin=d.Rz,s.miterLimit=d.PK);var p=s.count>0?new l.Z(s):null,u=r.count>0?new a.Z(r):null,f={},_={count:0};"string"==typeof e.Text?(_.text=e.Text,_.count++):"object"==typeof e.Text&&null===e.Text&&(_.text="",_.count++);var m="";return"string"==typeof e.FontStyle?m+=e.FontStyle+" ":i&&(m+="normal "),"object"==typeof e.FontSize&&null!==e.FontSize?m+=e.FontSize.Value+"px ":i&&(m+="10px "),"string"==typeof e.FontFamily?m+=e.FontFamily:i&&(m+="sans-serif"),m.length>0&&(_.font=m,_.count++),p?(s.lineCap="round",s.lineJoin="round",_.fill=new a.Z(s),_.count++):!n||_.fill instanceof a.Z||!u||(_.fill=new a.Z(r),_.count++),_.count>0&&(_.overflow=!0,f.text=new h.Z(_),!i&&(!n&&"number"!=typeof e.StrokeColor||n&&"number"!=typeof e.FillColor&&"number"!=typeof e.StrokeColor)&&(f.text.fill_=null)),p&&(f.stroke=p),u&&(f.fill=u),n&&(f.stroke=new l.Z({color:"rgba(255,255,255,0)",width:1,lineCap:d.oL,lineJoin:d.Rz,miterLimit:d.PK}),f.fill=new a.Z({color:"rgba(255,255,255,0)"})),new o.ZP(f)},v=function(e,t,i){e instanceof n.Z||console.error("A style function requires an instance of a feature!"),t instanceof g.Z||console.error("A style function requires an instance of Regions!");var s=e.getStyle();if(null!=s){var m=t.viewer_.viewer_.getView();"function"==typeof s&&(s=s.call(e,m.getResolution())),(0,_.kJ)(s)&&(s=s[0]),e.regions=t;var v=s.getStroke();if("object"!=typeof e.oldStrokeStyle&&(e.oldStrokeStyle=v?{color:v.getColor(),width:v.getWidth()}:null),e.getGeometry()instanceof p.Z&&(void 0===e.oldRotation&&(e.oldRotation=m.getRotation()),void 0===e.oldScale&&(e.oldScale=m.getResolution()),void 0===e.oldRotationFlag&&(e.oldRotationFlag=t.rotate_text_),void 0===e.oldScaleFlag&&(e.oldScaleFlag=t.scale_text_)),e.getGeometry()instanceof f.Z){var b=e.getId(),w=t.viewer_.getServer().full+t.viewer_.getPrefixedURI(d.YH)+"/render_shape_mask/"+b.substring(b.indexOf(":")+1)+"/";s.setImage(new r.Z({anchorOrigin:"top-left",anchor:[0,0],rotateWithView:!0,src:w}))}e.setStyle((function(t,n){if(!(e.regions instanceof g.Z))return s;null==s.getFill()&&s.setFill(new a.Z({color:c.wT}));var r=e.regions,_=e.getGeometry(),b=r.scale_text_,w=r.rotate_text_,x=m.getRotation(),I=s.getText(),S=_ instanceof p.Z;if(!S&&!r.show_comments_&&I instanceof h.Z?(e.oldText=I.clone(),I=null,s.text_=I):!S&&r.show_comments_&&!(I instanceof h.Z)&&e.oldText instanceof h.Z&&(I=e.oldText.clone(),s.text_=I),I instanceof h.Z){if(I.setOverflow(!0),b){var C=1/n;I.setScale(C)}else I.setScale(1);if(w?I.setRotation(x):I.setRotation(0),i=i||!1,S&&(i||e.oldRotation!==x||e.oldScale!==n||e.oldRotationFlag!==w||e.oldScaleFlag!==b)){e.oldRotation!==x&&(e.oldRotation=x),e.oldScale!==n&&(e.oldScale=n),e.oldRotationFlag!==w&&(e.oldRotationFlag=w),e.oldScaleFlag!==b&&(e.oldScaleFlag=b),i&&(i=!1);var T=y(I.getText(),I.getFont(),b?null:n),E=w?0:0-x;_.adjustCoordinates(E,T)}}var A=(e.selected,e.selected),R=new l.Z;if(R.setColor("rgba(0,153,255,1)"),R.setWidth(3),A)s.stroke_=R;else if(r.getHoverId()==e.getId())s.stroke_=new l.Z({color:v.getColor(),width:v.getWidth()+2});else if(e.oldStrokeStyle){var P=e.oldStrokeStyle.width;0===P&&(P=1),s.stroke_=new l.Z({color:e.oldStrokeStyle.color,width:P})}else s.stroke_=null;var O=[s],k=A?2:1;if(_ instanceof u.Z&&(_.has_start_arrow_||_.has_end_arrow_)){var N=s.getStroke(),L=15*n,M=[];for(var j in _.has_end_arrow_&&M.push(!0),_.has_start_arrow_&&M.push(!1),N.setLineCap(d.oL),N.setLineJoin(d.Rz),N.setMiterLimit(d.PK),M){var F=M[j],D=_.getArrowGeometry(F,L,L),z=new o.ZP({geometry:D,fill:new a.Z({color:N.getColor()}),stroke:N,zIndex:k});O.push(z)}}return _ instanceof f.Z&&(s.getImage().setScale(1/n),A?O.push(new o.ZP({geometry:_.getOutline(),stroke:R,zIndex:k+1})):k--),s.setZIndex(k),O}))}},y=function(e,t,i){if("string"!=typeof e||"string"!=typeof t)return null;var n=10;i="number"==typeof i&&i>0?i:1;var s=t.split(" ");if(3!=s.length)return null;try{n=parseInt(s[1]),n*=i,n=Math.ceil(n),t=s[0]+" "+n+"px "+s[2]}catch(e){}var o=document.createElement("canvas").getContext("2d");o.font=t;var r=o.measureText(e);return{width:r.width>0?r.width:5,height:n}},b=function(e){if(!(e instanceof o.ZP))return null;var t=null,i=null;e.getFill()&&(i=new a.Z({color:e.getFill().getColor()}));var n=w(e.getStroke()),s=null;if(e.getText()){var r=e.getText().getFont()?e.getText().getFont():null,l="string"==typeof e.getText().getText()?e.getText().getText():"",d=w(e.getText().getStroke()),c=e.getText().getFill()?new a.Z({color:e.getText().getFill().getColor()}):null;s=new h.Z({overflow:!0,font:r,text:l,stroke:d,fill:c})}return null===i&&null===n&&null===s||(t=new o.ZP({fill:i,stroke:n,text:s})),t},w=function(e){if(!(e instanceof l.Z))return null;var t=e.getColor()?e.getColor():null,i=null!==e.getWidth()?e.getWidth():1,n=e.getLineCap()?e.getLineCap():"butt",s=e.getLineDash()?e.getLineDash():null,o=e.getLineJoin()?e.getLineJoin():"miter",r=e.getMiterLimit()?e.getMiterLimit():20;return new l.Z({color:t,lineCap:n,lineDash:s,lineJoin:o,miterLimit:r,width:i})},x=function(e,t,i,r){if(t instanceof g.Z&&"object"==typeof e){if(!(i instanceof s.Z)){if(null===t.select_)return;i=t.select_.getFeatures()}for(var c=[],p=i.getArray(),u=0;u<p.length;u++){var f=p[u];if(f instanceof n.Z){var y=f.type.toLowerCase();e.type=y,"line"!==y&&"polyline"!==y||("object"==typeof e.StrokeWidth&&null!==e.StrokeWidth&&"number"==typeof e.StrokeWidth.Value&&0===e.StrokeWidth.Value&&(e.StrokeWidth.Value=1),"string"==typeof e.MarkerStart?f.getGeometry().has_start_arrow_="Arrow"===e.MarkerStart:"object"==typeof e.MarkerStart&&null===e.MarkerStart&&(f.getGeometry().has_start_arrow_=!1),"string"==typeof e.MarkerEnd?f.getGeometry().has_end_arrow_="Arrow"===e.MarkerEnd:"object"==typeof e.MarkerEnd&&null===e.MarkerEnd&&(f.getGeometry().has_end_arrow_=!1));var b=m(e,"label"===y,!1);if(null===b)continue;var w=f.getStyle();"function"==typeof w&&(w=w(t.viewer_.viewer_.getView().getResolution())),(0,_.kJ)(w)&&(w=w[0]);var x=b.getFill()?b.getFill():w.getFill(),I=null;"object"==typeof f.oldStrokeStyle&&null!==f.oldStrokeStyle&&((I=new l.Z).setColor(f.oldStrokeStyle.color),I.setWidth(f.oldStrokeStyle.width),I.setLineDash(f.oldStrokeStyle.lineDash),I.setLineCap(f.oldStrokeStyle.lineCap),I.setLineJoin(f.oldStrokeStyle.lineJoin),I.setMiterLimit(f.oldStrokeStyle.miterLimit)),b.getStroke()&&(null===I&&(I=new l.Z),b.getStroke().getColor()&&I.setColor(b.getStroke().getColor()),b.getStroke().getLineCap()&&I.setLineCap(b.getStroke().getLineCap()),b.getStroke().getLineDash()&&I.setLineDash(b.getStroke().getLineDash()),b.getStroke().getLineJoin()&&I.setLineJoin(b.getStroke().getLineJoin()),b.getStroke().getMiterLimit()&&I.setMiterLimit(b.getStroke().getMiterLimit()),"number"==typeof b.getStroke().getWidth()&&I.setWidth(b.getStroke().getWidth()));var S=w.getText();if(null===S&&f.oldText instanceof h.Z){var C=b.getText();C instanceof h.Z&&("string"==typeof C.getText()&&(f.oldText.text_=C.getText()),"string"==typeof C.getFont()&&(f.oldText.font_=C.getFont()),I&&(f.oldText.fill_=I))}else null===S?S=b.getText():b.getText()&&(b.getText().getFont()&&S.setFont(b.getText().getFont()),b.getText().getOffsetX()&&S.setOffsetX(b.getText().getOffsetX()),b.getText().getOffsetY()&&S.setOffsetY(b.getText().getOffsetY()),b.getText().getFill()&&S.setFill(b.getText().getFill()),b.getText().getRotation()&&S.setRotation(b.getText().getRotation()),b.getText().getScale()&&S.setScale(b.getText().getScale()),b.getText().getStroke()&&S.setStroke(b.getText().getStroke()),"string"==typeof b.getText().getText()&&S.setText(b.getText().getText()),b.getText().getTextAlign()&&S.setTextAlign(b.getText().getTextAlign()),b.getText().getTextBaseline()&&S.setTextBaseline(b.getText().getTextBaseline()));S instanceof h.Z&&(S.setOverflow(!0),"string"!=typeof S.text_&&(S.text_=""),null===S.fill_&&(S.fill_=new a.Z({color:I.getColor()})));var T=new o.ZP({fill:x,stroke:I,text:S});delete f.oldStrokeStyle,f.setStyle(T),v(f,t,!0),c.push(f.getId())}}c.length>0&&t.setProperty(c,"state",d.HI.MODIFIED,r)}},I=function(e){if("object"==typeof e&&"string"==typeof e.type&&0!==e.type.length){var t=e.type.toLowerCase();"point"===t?("number"!=typeof e.X&&(e.X=6),"number"!=typeof e.Y&&(e.Y=6)):"line"===t?("number"!=typeof e.X1&&(e.X1=2),"number"!=typeof e.X2&&(e.X2=17),"number"!=typeof e.Y1&&(e.Y1=2),"number"!=typeof e.Y2&&(e.Y2=2)):"polyline"===t?"string"!=typeof e.Points&&(e.Points="2,2 7,7 12,2 17,7"):"polygon"===t?"string"!=typeof e.Points&&(e.Points="2,2 7,7 12,2 17,7 2,2"):"rectangle"===t?("number"!=typeof e.X&&(e.X=2),"number"!=typeof e.Y&&(e.Y=2),"number"!=typeof e.Width&&(e.Width=15),"number"!=typeof e.Height&&(e.Height=15)):"ellipse"===t?("number"!=typeof e.X&&(e.X=20),"number"!=typeof e.Y&&(e.Y=15),"number"!=typeof e.RadiusX&&(e.RadiusX=8),"number"!=typeof e.RadiusY&&(e.RadiusY=5)):"label"===t&&("string"!=typeof e.FontFamily&&(e.FontFamily="sans-serif"),"object"==typeof e.FontSize&&null!==e.FontSize&&"number"==typeof e.FontSize.Value||(e.FontSize={},e.FontSize.Value=15),"string"!=typeof e.FontStyle&&(e.FontStyle="normal"),"string"!=typeof e.Text&&(e.Text="generated"),"number"!=typeof e.X&&(e.X=10),"number"!=typeof e.Y&&(e.Y=10))}},S=function(e){if("object"==typeof e){var t="string"==typeof e.type&&-1!==e.type.indexOf("line"),i="number"==typeof e.StrokeColor&&!isNaN(e.StrokeColor);(("number"!=typeof e.FillColor||isNaN(e.FillColor))&&!i||t&&!i)&&(e.StrokeColor=-1,"object"==typeof e.StrokeWidth&&null!==e.StrokeWidth&&"number"==typeof e.StrokeWidth.Value||(e.StrokeWidth={},e.StrokeWidth.Value=1))}}},9236:(e,t,i)=>{"use strict";i.d(t,{HC:()=>a,L9:()=>s,Ne:()=>r,gQ:()=>o});var n=i(366);const s=function(e){if("object"!=typeof e||null===e||"string"!=typeof e["@type"]||-1===e["@type"].indexOf("#AffineTransform"))return null;try{return[e.A00,e.A10,e.A01,e.A11,e.A02,e.A12]}catch(e){console.error("failed to convert tranform into matrix")}return null},o=function(e){return(0,n.kJ)(e)&&6===e.length?{"@type":"http://www.openmicroscopy.org/Schemas/OME/2016-06#AffineTransform",A00:e[0],A10:e[1],A01:e[2],A11:e[3],A02:e[4],A12:e[5]}:null},r=function(e,t){if(!(0,n.kJ)(e)||6!==e.length||!(0,n.kJ)(t)||0===t.length||t.length%2!=0)return t;for(var i=t.length,s=new Array(i),o=0;o<i;o+=2)s[o]=e[0]*t[o]+e[2]*-t[o+1]+e[4],s[o+1]=-(e[1]*t[o]+e[3]*-t[o+1]+e[5]);return s},a=function(e,t){if(!(0,n.kJ)(e)||6!==e.length||!(0,n.kJ)(t)||0===t.length||t.length%2!=0)return t;var i=e[0]*e[3]-e[1]*e[2];if(0===i)return t;var s=new Array(e.length),o=e[0],r=e[1],a=e[2],l=e[3],h=e[4],d=e[5];s[0]=l/i,s[1]=-r/i,s[2]=-a/i,s[3]=o/i,s[4]=(a*d-l*h)/i,s[5]=-(o*d-r*h)/i;for(var c=t.length,g=new Array(c),p=0;p<c;p+=2)g[p]=s[0]*t[p]+s[2]*-t[p+1]+s[4],g[p+1]=-(s[1]*t[p]+s[3]*-t[p+1]+s[5]);return g}},1709:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>n});const n=i.p+"css/app.css"},1354:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>n});const n=i.p+"css/ol3-viewer.css"},"app/header.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <nav class="navbar navbar-default navbar-fixed-top fixed-header">\n        <div class="fixed-header-text">\n            \x3c!-- OMERO --\x3e\n            <div class="fixed-header-webclient"\n                 show.bind="webclient_link !== null"\n                 title="Back to OMERO.webclient">\n                <a href="${webclient_link}">OMERO</a>\n            </div>\n\n            \x3c!-- FILE --\x3e\n            <div class="dropdown">\n                <button type="button"\n                        class="btn btn-default btn-sm dropdown-toggle"\n                        data-toggle="dropdown">File\n                        <span class="caret"></span>\n                </button>\n                <ul class="dropdown-menu quantization-dropdown">\n                    <li show.bind="context.image_configs.size > 1"\n                        class="${ hasModifiedImageSettings ?\n                                 \'\' : \'disabled-color\'}">\n                        <a click.delegate="saveAllImageSettings()"\n                           href="#">Save All Image Settings\n                        </a>\n                    </li>\n                    <li class="${image_config.image_info.ready ?\n                                 \'\' : \'disabled-color\'}">\n                        <a click.delegate="captureViewport()"\n                           href="#">Save ${context.image_configs.size > 1 ?\n                                            \'All Viewports as PNGs (zipped)\' :\n                                            \'Viewport as PNG\'}\n                        </a>\n                    </li>\n                    <li class="${image_config.image_info.ready  &&\n                                 image_config.image_info.projection !== PROJECTION.NORMAL?\n                                 \'\' : \'disabled-color\'}">\n                        <a click.delegate="saveProjectedImage()"\n                           href="#">Save Projection as new Image</a>\n                    </li>\n                </ul>\n            </div>\n\n            \x3c!-- ROIS --\x3e\n            <div class="dropdown">\n                <button type="button"\n                        class="btn btn-default btn-sm dropdown-toggle"\n                        data-toggle="dropdown">ROIs\n                        <span class="caret"></span>\n                </button>\n                <ul class="dropdown-menu">\n                    <li class="${image_config.regions_info.ready &&\n                                 image_config.regions_info.selected_shapes.length > 0 ?\n                                 \'\' : \'disabled-color\'}">\n                        <a click.delegate="copyShapes()"\n                           href="#">Copy<span>${getKeyboardShortCutPrefix()}C</span>\n                        </a>\n                    </li>\n                    <li class="${image_config.regions_info.ready &&\n                               image_config.image_info.can_annotate &&\n                               image_config.regions_info.copied_shapes.length > 0 ?\n                                 \'\' : \'disabled-color\'}">\n                        <a click.delegate="pasteShapes()"\n                           href="#">Paste<span>${getKeyboardShortCutPrefix()}V</span>\n                        </a>\n                    </li>\n                    <li class="${image_config.regions_info.ready &&\n                                 image_config.image_info.can_annotate &&\n                                 image_config.regions_info.selected_shapes.length > 0 &&\n                                    selected_can_delete ? \'\' : \'disabled-color\'}">\n                        <a click.delegate="deleteShapes()"\n                           href="#">Delete</a>\n                    </li>\n                    <li class="${image_config.regions_info.ready &&\n                                 image_config.regions_info.selected_shapes.length > 0 ?\n                                    \'\' : \'disabled-color\'}"\n                        title="Export selected ROIs to a spreadsheet (CSV file), suitable for opening in Excel">\n                        <a click.delegate="saveRoiMeasurements(true)"\n                           href="#">Export as Table (CSV)</a>\n                    </li>\n                </ul>\n            </div>\n\n            \x3c!-- HELP --\x3e\n            <div class="dropdown">\n                <button type="button"\n                        class="btn btn-default btn-sm dropdown-toggle"\n                        data-toggle="dropdown">Help\n                        <span class="caret"></span>\n                </button>\n                <ul class="dropdown-menu">\n                    <li>\n                        <a target="_blank"\n                            href="https://omero-guides.readthedocs.io/en/latest/iviewer/docs/">\n                            How to use OMERO.iviewer\n                        </a>\n                    </li>\n                    <li click.delegate="showAbout()">\n                        <a href="#">About OMERO.iviewer</a>\n                    </li>\n                    <li>\n                        <a  target="_blank"\n                            href="https://github.com/ome/omero-iviewer">\n                            OMERO.iviewer on GitHub\n                        </a>\n                    </li>\n                </ul>\n            </div>\n        </div>\n        <div class="fixed-header-text">\n           <span>${image_config.image_info.ready &&\n                   !image_config.image_info.error ?\n                        image_config.image_info.short_image_name : \'\'}\n           </span>\n       </div>\n    </nav>\n    <div class="modal-about modal" role="dialog"\n        data-backdrop="true" data-keyboard="true">\n        <div class="modal-dialog modal-sm" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <button type="button" class="close"\n                            data-dismiss="modal"\n                            aria-hidden="true">×\n                    </button>\n                    <h4 class="modal-title">About OMERO.iviewer</h4>\n                </div>\n                <div class="modal-body">\n                    <p>\n                        <span style="font-weight: bold;">Version<span>:\n                            ${context.version}\n                    </p>\n                    <p>\n                        For more information, visit the\n                        <a target="new" href="https://www.openmicroscopy.org/omero/iviewer/">\n                            OMERO.iviewer page</a>.\n                    </p>\n                    <p>\n                        &copy; 2017-2022 University of Dundee &amp; Open Microscopy Environment<br>\n                        OMERO is distributed under the terms of the GNU GPL and<br>\n                        OMERO.iviewer under AGPL.<br>\n                        See: <a target="new" href="https://www.openmicroscopy.org">openmicroscopy.org</a>\n                    </p>\n                </div>\n                <div class="modal-footer">\n                <button type="button"\n                        class="ok center-block btn btn-default"\n                        data-dismiss="modal">Close\n                </button>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n'},"app/index.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <require from="../utils/converters"></require>\n    <require from="../viewers/ol3-viewer"></require>\n    <require from="./header"></require>\n    <require from="./thumbnail-slider"></require>\n    <require from="./right-hand-panel"></require>\n\n    <header></header>\n\n    <div class="modal-message modal" role="dialog"\n        data-backdrop="static" data-keyboard="false">\n        <div class="modal-dialog modal-sm" role="document">\n            <div class="modal-content">\n                <h4 class="modal-body"></h4>\n                <div class="modal-footer">\n                    <button type="button"\n                            class="ok center-block btn btn-primary btn-sm"\n                            data-dismiss="modal">Ok</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    <div class="confirmation-dialog modal" tabindex="-1" role="dialog"\n         data-backdrop="static" data-keyboard="false">\n        <div class="modal-dialog modal-sm" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <button type="button" class="close" data-dismiss="modal">\n                        <span>&times;</span>\n                    </button>\n                    <h4 class="modal-title">Confirmation</h4>\n                </div>\n                <div class="modal-body"></div>\n                <div class="modal-footer">\n                    <button type="button" class="yes btn btn-primary btn-sm">Yes</button>\n                    <button type="button" class="no btn btn-default btn-sm">No</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class="row center">\n        <thumbnail-slider\n            class="thumbnail-panel sidebar">\n        </thumbnail-slider>\n\n        <div class="col-splitter left-split">\n            <div class="collapse-left"></div>\n        </div>\n\n        <div class="frame col-xs-12"\n            drop.delegate="handleDrop($event)"\n            dragover.delegate="handleDragover($event)">\n            <div class="${context.useMDI && context.image_configs.size > 1 ?\n                            \'viewer-mdi\' : \'viewer\'}\n                        ${context.useMDI && context.selected_config === id &&\n                            context.image_configs.size > 1 ? \'mdi-selected\' : \'\'}"\n                 repeat.for="[id, conf] of context.image_configs"\n                 css="${context.useMDI && context.image_configs.size > 1 ?\n                        \';position: absolute;top:\' + conf.position.top +\n                        \';left:\' + conf.position.left +\n                        \';width:\' + conf.size.width +\n                        \';height:\' + conf.size.height : \'\'}"\n                 click.delegate="context.selectConfig(id)">\n                 <div class="config-linking"\n                      show.bind="context.useMDI && context.image_configs.size > 1">\n                     <div class="dropdown dropdown-image-config"\n                          title="Link Image Settings">\n                         <button type="button"\n                             class="${conf.sync_group === null ?\n                                 \'dim_unlocked\' : \'dim_locked\'}\n                                 btn btn-default btn-sm dropdown-toggle"\n                             data-toggle="dropdown">\n                                <sup style="margin-left: 10px;">\n                                    ${conf.sync_group | syncGroup}\n                                </sup>\n                         </button>\n                         <ul class="dropdown-menu">\n                             <li click.delegate="toggleSyncGroup(id, null)"\n                                 show.bind="conf.sync_group !== null">\n                                 <a class="dim_unlocked" href="#">&nbsp;</a>\n                             </li>\n                             <li repeat.for="[name, group] of context.sync_groups"\n                                 click.delegate="toggleSyncGroup(id, name)"\n                                 show.bind="conf.sync_group !== name"\n                                 mouseover.delegate="highlightSyncGroup(group.members, true)"\n                                 mouseout.delegate="highlightSyncGroup(group.members)"\n                                 title="Group ${name | syncGroup}">\n                                 <a class="dim_locked" href="#">\n                                     <sup>${name | syncGroup}</sup>\n                                 </a>\n                             </li>\n                         </ul>\n                     </div>\n                     <div class="sync-locks"\n                          show.bind="context.useMDI && context.image_configs.size > 1 &&\n                                        conf.sync_group !== null">\n                         <label repeat.for="lock of sync_locks"\n                                show.bind="conf.image_info.ready &&\n                                           (lock.CHAR === \'c\' || lock.CHAR === \'v\' ||\n                                            (lock.CHAR === \'z\' &&\n                                             conf.image_info.dimensions.max_z > 1) ||\n                                            (lock.CHAR === \'t\' &&\n                                             conf.image_info.dimensions.max_t > 1) ||\n                                             (lock.CHAR === \'zt\' &&\n                                              conf.image_info.dimensions.max_z > 1 ||\n                                              conf.image_info.dimensions.max_t > 1))"\n                                title="Lock ${lock.LABEL}">\n                             <input type="checkbox"\n                                 checked.bind="conf.sync_locks[lock.CHAR]"\n                                 change.delegate="\n                                     toggleSyncLock(id, lock.CHAR, $event.target.checked)"/>\n                             &nbsp;${lock.LABEL}\n                         </label>\n                    </div>\n                </div>\n                <div show.bind="context.useMDI && context.image_configs.size > 1"\n                     class="viewer-handle\n                            ${context.useMDI && context.image_configs.size > 1 &&\n                                 context.selected_config === id ?\n                                    \'viewer-handle-selected\' : \'\'}">\n                    <span click.delegate="closeViewerInMDI(id)"\n                          class="close">&times;</span>\n                    <span click.delegate="toggleViewerControlsInMDI(id)"\n                          title="${conf.show_controls ?\n                                    \'Hide Viewer Controls\' :\n                                    \'Show Viewer Controls\'}"\n                          css="${conf.show_controls ? \'\' : \'opacity: 0.6\'}"\n                          class="glyphicon glyphicon-cog cog"></span>\n                </div>\n                <ol3-viewer image_config.bind="conf">\n                </ol3-viewer>\n            </div>\n        </div>\n\n        <div class="col-splitter">\n            <div class="collapse-right"></div>\n        </div>\n\n        <right-hand-panel class="right-hand-panel sidebar"></right-hand-panel>\n    </div>\n\n</template>\n'},"app/right-hand-panel.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <require from="../settings/settings"></require>\n    <require from="../regions/regions"></require>\n    <require from="../info/info"></require>\n\n    <ul id="panel-tabs" class="nav nav-tabs" role="tablist">\n        <li class="${context.selected_tab === TABS.INFO ? \'active\' : \'\'}">\n            <a href="${\'#\' + TABS.INFO}" role="tab">Info</a>\n        </li>\n        <li class="${context.selected_tab === TABS.SETTINGS ? \'active\' : \'\'}">\n            <a href="${\'#\' + TABS.SETTINGS}" role="tab">Settings</a>\n        </li>\n        <li class="${context.selected_tab === TABS.ROIS ? \'active\' : \'\'}">\n            <a href="${\'#\' + TABS.ROIS}" role="tab">\n                ROIs ${image_config && image_config.image_info ?\n                        \'[\' + image_config.image_info.roi_count + \']\' : \'\'}\n            </a>\n        </li>\n    </ul>\n\n    <div class="disabled-color loading-text"\n         show.bind="image_config === null ||\n                     (!image_config.image_info.ready &&\n                      image_config.image_info.error)">\n            No Image Data\n    </div>\n    <div class="tab-content regions-tabs"\n         show.bind="image_config && image_config.image_info &&\n                    !image_config.image_info.error">\n        <div id="${TABS.INFO}" role="tabpanel"\n             class="tab-pane ${context.selected_tab === TABS.INFO ? \'active\' : \'\'}">\n            <info image_info.bind="image_config.image_info"></info>\n        </div>\n        <div id="${TABS.SETTINGS}" role="tabpanel"\n             class="tab-pane ${context.selected_tab === TABS.SETTINGS ? \'active\' : \'\'}">\n            <settings image_config.bind="image_config"></settings>\n        </div>\n        <div id="${TABS.ROIS}" role="tabpanel"\n             class="tab-pane ${context.selected_tab === TABS.ROIS ? \'active\' : \'\'}">\n            <regions regions_info.bind="image_config.regions_info"></regions>\n        </div>\n    </div>\n\n</template>\n'},"app/thumbnail-slider.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <div class="refresh_thumbnails glyphicon glyphicon-refresh\n                ${requesting_thumbnail_data ?\n                    \'background-color: disabled-color\' : \'\'}"\n         show.bind="!(image_config.image_info.error && !initialized)"\n         click.delegate="refreshThumbnails()"\n         title="Refresh thumbnails">\n    </div>\n\n    <div class="thumbnail-scroll-panel"\n        show.bind="!requesting_thumbnail_data"\n        resize.trigger="panelResized($event)"\n        scroll.trigger="handleScrollEvent($event) & debounce:100">\n\n        <div>\n            \x3c!-- Both the div and the img have data-id for drag-n-drop --\x3e\n            <div repeat.for="thumb of thumbnails" class="thumbnail-wrapper"\n                data-id="${thumb.id}"\n                draggable="true" dragstart.delegate="handleDragStart($event, thumb.type)">\n              \x3c!-- show placeholder 1 x 1 px png if no thumb.url --\x3e\n              <img id="${\'img-thumb-\' + thumb.id}" data-id="${thumb.id}"\n                class="${image_config.image_info.image_id === thumb.id ? \'selected\' : \'\'}\n                    ${thumb.id ? \'\' : \'transparent\'}"\n                src.bind="thumb.url ? thumb.url + \'?version=\' + thumb.revision : \'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=\'"\n                title="${thumb.title}"\n                alt=""\n                click.delegate="onClick(thumb.id)"\n                dblclick.delegate="onDoubleClick(thumb.id, $event)"/>\n            </div>\n        </div>\n\n    </div>\n    <div class="disabled-color" style="position: relative;top: 40%;"\n         show.bind="requesting_thumbnail_data">\n            Gathering<br>Thumbnail<br>Info...\n    </div>\n    <div class="disabled-color" style="position: relative;top: 40%;"\n         show.bind="image_config.image_info.error && !initialized">\n            No Image Data\n    </div>\n</template>\n'},"controls/dimension-slider.html":e=>{e.exports="\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <template if.bind=\"dim === 'z'\">\n        <span class='dim-size'>\n            ${image_config.image_info.projection === INTMAX ?\n                    image_config.image_info.projection_opts.end+1 :\n                    image_config.image_info.dimensions['max_' + dim]}\n        </span>\n        <div class=\"dim-arrows glyphicon glyphicon-chevron-up\"\n             click.delegate=\"onArrowClick(1)\">\n        </div>\n        <div name=\"dim\"><span class='slider-value'></span></div>\n        <div class=\"dim-arrows glyphicon glyphicon-chevron-down\"\n             click.delegate=\"onArrowClick(-1)\">\n        </div>\n        <span class='dim-current'>\n            ${image_config.image_info.projection === INTMAX ?\n                    image_config.image_info.projection_opts.start+1 :\n                    image_config.image_info.dimensions[dim]+1}\n        </span>\n        <span class=\"dim-projection\n                     ${getZProjectionDisabled(player_info.handle, player_info.forwards) ? 'disabled-color' : ''}\"\n              title=\"${getZProjectionDisabled(player_info.handle, player_info.forwards) ? 'Projection disabled' :\n                            image_config.image_info.projection === INTMAX ?\n                                'Turn off projection' : 'Turn on projection'}\"\n              css=\"${image_config.image_info.projection === INTMAX ?\n                        'background-color: rgba(85, 85, 85, 0.50)' : ''}\"\n              click.delegate=\"toggleProjection()\">\n        </span>\n        <div class=\"dim-arrows glyphicon\n                ${player_info.handle !== null && player_info.dim === dim &&\n                  player_info.forwards ? 'glyphicon-stop' : 'glyphicon-play'}\n                ${image_config.image_info.projection === INTMAX ?\n                    'disabled-color' : ''}\"\n             title=\"${image_config.image_info.projection === INTMAX ? 'Play disabled' :\n                    player_info.handle !== null && player_info.dim === dim &&\n                    player_info.forwards ? 'Stop' : 'Play'}\"\n             click.delegate=\"playDimension(true)\">\n        </div>\n        <span class='dim-label'>${dim.toUpperCase()}</span>\n    </template>\n\n    <template if.bind=\"dim === 't'\">\n        <span class='dim-label'>${dim.toUpperCase()}</span>\n        <div class=\"dim-arrows glyphicon\n                ${player_info.handle !== null && player_info.dim === dim &&\n                  player_info.forwards ? 'glyphicon-stop' : 'glyphicon-play'}\"\n              title=\"${player_info.handle !== null && player_info.dim === dim &&\n                player_info.forwards ? 'Stop' : 'Play'}\"\n             click.delegate=\"playDimension(true)\">\n        </div>\n        <span class='dim-current'>${image_config.image_info.dimensions[dim]+1}</span>\n        <div class=\"dim-arrows glyphicon glyphicon-chevron-left\"\n             click.delegate=\"onArrowClick(-1)\">\n        </div>\n        <div name=\"dim\">\n            <span class='slider-value'></span>\n        </div>\n        <div class=\"dim-arrows glyphicon glyphicon-chevron-right\"\n             click.delegate=\"onArrowClick(1)\">\n        </div>\n        <span class='dim-size'>\n            ${image_config.image_info.dimensions['max_' + dim]}\n        </span>\n        <span show.bind=\"image_config.image_info.image_delta_t.length > 0\"\n            title=\"${image_config.image_info.formatDeltaT(image_config.image_info.image_delta_t[image_config.image_info.dimensions[dim]], true)}\"\n            class=\"timestamp\">\n            ${image_config.image_info.formatDeltaT(image_config.image_info.image_delta_t[image_config.image_info.dimensions[dim]])}\n        </span>\n    </template>\n</template>\n"},"info/info.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n\n    <h4 show.bind="image_info.ready"\n        title="${image_info.image_name}">\n        ${image_info.short_image_name}\n    </h4>\n\n    <div show.bind="image_info.ready" class="openwith">\n        <span repeat.for="ow of open_with_links">\n            <hr if.bind="$first" />\n            <span if.bind="$first">Open With:</span>\n            <a target="_blank" href="${ow.url}">${ow.text}</a> ${!$last ? \' | \' : \'\'}\n        </span>\n    </div>\n\n    <div class="well well-sm">\n        <button type="button" class="btn">\n            Image Info\n        </button>\n    </div>\n\n    <table show.bind="image_info.ready" class="table table-condensed">\n        <tr>\n            <td class="col-sm-6 text-weight-bold">Image ID:</td>\n            <td class="col-sm-6">\n                <a href="${image_info.web_url}"\n                   title="Show ${image_info.short_image_name} in webclient"\n                   target="_blank">${image_info.image_id}\n                </a>\n            </td>\n        </tr>\n        <tr show.bind="parent_info !== null">\n            <td class="col-sm-6 text-weight-bold">${parent_info.title}:</td>\n            <td class="col-sm-6">\n                <a href="${parent_info.url}"\n                   title="Show ${parent_info.title} in webclient"\n                   target="_blank">${parent_info.name}\n                </a>\n            </td>\n        </tr>\n        <tr repeat.for="column of columns">\n            <td class="col-sm-6 text-weight-bold">${column.label}</td>\n            <td class="col-sm-6">${column.value}</td>\n        </tr>\n        <tr>\n            <td class="col-sm-6 text-weight-bold">Channels:</td>\n            <td class="col-sm-6">\n                <span repeat.for="channel of image_info.channels">\n                    ${channel.label}${!$last ? \', \' : \'\'}\n                </span>\n            </td>\n        </tr>\n    </table>\n\n    <div class="disabled-color loading-text" show.bind="!image_info.ready">\n        Loading Image Data ...\n     </div>\n\n</template>\n'},"regions/regions-drawing.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <div class="row regions-drawing">\n        <div class="draw-icons draw-select-icon\n                    ${regions_info.is_pending ? \'disabled-color\' : \'\'}\n                    ${regions_info.shape_to_be_drawn === null ?\n                        \'draw-active\' : \'draw-inactive\'}"\n             title="Select shape(s)"\n             style="margin-right: 30px; margin-left: 0"\n             click.delegate="onDrawShape(-1)">\n        </div>\n        <div repeat.for="shape of supported_shapes"\n            class="draw-icons draw-${shape}-icon\n                ${regions_info.is_pending ? \'disabled-color\' : \'\'}\n                ${regions_info.shape_to_be_drawn === shape ?\n                    \'draw-active\' : \'draw-inactive\'}"\n            click.delegate="onDrawShape($index)"\n            title="Draw ${shape}" />\n    </div>\n</template>\n'},"regions/regions-edit.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n        <div class="shapes-edit">\n            <div class="shape-fill-color"><input class="spectrum-input"/></div>\n            <div class="shape-stroke-color"><input class="spectrum-input"/></div>\n            <div class="shape-stroke-width"><input /></div>\n\n            <div class="dropdown rois-dropdown arrow-button"\n                 title="Toggle arrow heads">\n                <button type="button"\n                    class="btn btn-default btn-sm dropdown-toggle"\n                    disabled="disabled"\n                data-toggle="dropdown">&nbsp;</button>\n                <ul class="dropdown-menu">\n                    <li click.delegate="toggleArrow(false)">\n                        <span class="marker_start"></span>\n                        <a href="#">Start</a>\n                    </li>\n                    <li click.delegate="toggleArrow(true)">\n                        <span class="marker_end"></span>\n                        <a href="#">End</a>\n                    </li>\n                </ul>\n            </div>\n\n            <div class="dropdown rois-dropdown">\n                <button type="button"\n                        class="btn btn-default btn-sm dropdown-toggle shape-edit-button\n                               ${regions_info.shape_to_be_drawn !== null ? \'disabled\' : \'\'}"\n                        data-toggle="dropdown">Edit\n                </button>\n                <ul class="dropdown-menu">\n                    <li if.bind="regions_info && regions_info.selected_shapes &&\n                                    regions_info.selected_shapes.length !== 0"\n                        click.delegate="copyShapes()">\n                            <a href="#">Copy</a>\n                    </li>\n                    <li if.bind="regions_info.copied_shapes.length !== 0 &&\n                                 regions_info.image_info.can_annotate"\n                         click.delegate="pasteShapes()">\n                            <a href="#">Paste</a>\n                    </li>\n                    <li click.delegate="selectAllShapes()"><a href="#">Select All</a></li>\n                </ul>\n            </div>\n\n            <button type="button" disabled\n                    click.delegate="deleteShapes()"\n                    class="btn btn-default btn-sm shape-delete-button">Delete\n            </button>\n        </div>\n\n\n        <div class="shapes-edit">\n            <div class="shape-edit-comment">\n                <input placeholder="Comment" class="form-control input-sm" />\n            </div>\n            <div class="shape-font-size"><input /></div>\n        </div>\n        <div class="shapes-edit form-inline">\n            <div class="shape-edit-attachments form-group">\n                <label>Z</label>\n                <input class="form-control input-sm" type="text" dim="z" value="" tabindex="-1"/>\n                <span name="shape-edit-attachments-locks" tabindex="-1"\n                       dim="z" locked="locked" class="dim_locked"></span>\n                <label>T</label>\n                <input class="form-control input-sm" type="text" dim="t" value="" tabindex="-1"/>\n                <span name="shape-edit-attachments-locks" tabindex="-1"\n                      dim="t" locked="locked" class="dim_locked"></span>\n            </div>\n            <span tabindex="1"></span>\n       </div>\n    </div>\n</template>\n'},"regions/regions-list.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n    <require from="./sort"></require>\n        <div if.bind="regions_info.image_info.roi_count > regions_info.roi_page_size"\n            class="pagination-controls">\n            Current Z/T plane has ${ regions_info.roi_count_on_current_plane } ROIs\n        </div>\n        <div if.bind="regions_info.roi_count_on_current_plane > regions_info.roi_page_size"\n            class="pagination-controls">\n            <div style="display: inline-block; width: 165px; white-space: nowrap;">\n                Showing page:\n                <input class="roi_page_number"\n                    change.delegate="handlePageInput($event)"\n                    value="${temp_sliding_page_number !== undefined ? temp_sliding_page_number + 1 :\n                    regions_info.roi_page_number + 1}" />\n                of ${pageCount}\n            </div>\n            <div class="glyphicon glyphicon-chevron-left"\n                click.delegate="setPage(regions_info.roi_page_number - 1)">\n            </div>\n           <input disabled.bind="regions_info.is_pending" type="range"\n             input.delegate="handlePageRangeSlide($event)"\n             change.delegate="handlePageRange($event)"\n            min="0" value="${regions_info.roi_page_number}" max="${pageCount - 1}"\n            style="position: relative; top: 2px; width: 100px; display: inline-block"/>\n            <div class="glyphicon glyphicon-chevron-right"\n                click.delegate="setPage(regions_info.roi_page_number + 1)">\n           </div>\n        </div>\n        <div class="regions-header">\n            <div class="columns-dropdown dropdown">\n                <button type="button"\n                    class="btn btn-default btn-sm dropdown-toggle\n                            glyphicon glyphicon-option-vertical"\n                    style="padding: 0px; top: -2px; right: 0;"\n                    data-toggle="dropdown">\n                </button>\n                <ul class="dropdown-menu">\n                    <li click.delegate="showColumn(\'comments\')">\n                        <span class="show_comments">\n                            ${active_column === \'comments\' ? \'&#10003;\' : \'&nbsp;\'}\n                        </span>\n                        <a href="#">Show Comments</a>\n                    </li>\n                    <li click.delegate="showColumn(\'measurements\')">\n                        <span class="show_measurements">\n                            ${active_column === \'measurements\' ? \'&#10003;\' : \'&nbsp;\'}\n                        </span>\n                        <a href="#">Show Area/Length</a>\n                    </li>\n                </ul>\n            </div>\n            <div class="regions-table-col roi-toggle">\n                <input id="shapes_visibility_toggler"\n                        title="Show/Hide all rois"\n                        checked.one-way="regions_info.visibility_toggles === 0"\n                        show.bind="regions_info.number_of_shapes > 0"\n                        change.delegate="toggleAllShapesVisibility($event)"\n                        type="checkbox" />\n            </div>\n            <div class="regions-table-col shape-show">\n                <label for="shapes_visibility_toggler"\n                        show.bind="regions_info.number_of_shapes > 0">Show</label>\n            </div>\n            <div class="regions-table-col shape-type">&nbsp;</div>\n            <div class="regions-table-col shape-z ${sortCss(sortBy, sortAscending, \'theZ\')}"\n                click.delegate="sort(\'theZ\')">Z</div>\n            <div class="regions-table-col shape-t ${sortCss(sortBy, sortAscending, \'theT\')}"\n                click.delegate="sort(\'theT\')">T</div>\n            <div class="regions-table-col shape-c">C</div>\n            <div class="regions-table-col shape-comment ${sortCss(sortBy, sortAscending, \'shapeText\')}"\n                    click.delegate="sort(\'shapeText\')"\n                    show.bind="active_column === \'comments\'">Comment\n                </div>\n            <div class="regions-table-col shape-area ${sortCss(sortBy, sortAscending, \'area\')}"\n                    click.delegate="sort(\'area\')"\n                    show.bind="active_column === \'measurements\'">\n                    Area (${regions_info.image_info.image_pixels_size.symbol_x ||\n                            \'px\'}&#178;)\n                </div>\n            <div class="regions-table-col shape-length ${sortCss(sortBy, sortAscending, \'length\')}"\n                    click.delegate="sort(\'length\')"\n                    show.bind="active_column === \'measurements\'">\n                    Length (${regions_info.image_info.image_pixels_size.symbol_x ||\n                            \'px\'})\n                </div>\n        </div>\n\n        <div class="disabled-color loading-text"\n            show.bind="!regions_info.ready">Loading Regions...</div>\n\n        <div class="regions-table" show.bind="regions_info.ready">\n            <template repeat.for="[roi_id, roi] of regions_info.data | sort:sortBy:sortAscending">\n                <template repeat.for="[shape_id, shape] of roi.shapes">\n                    <div if.bind="(roi.shapes.size - roi.deleted) > 1 &&\n                                   roi.shapes.size > 1 && $first"\n                        id="${\'roi-\' + roi_id}"\n                        title="${(shape_id > 0 ? \'ROI: \' + roi_id + \', Shape: \' + shape_id : \'Unsaved\') +\n                                    (shape.owner ? \'\\nOwner: \' + shape.owner : \'\')}"\n                        class="regions-table-row"\n                        click.delegate="selectShape(roi_id, true, $event, true)">\n                        <div class="regions-table-col roi-toggle">\n                            <div title="Click to show/hide shapes"\n                                 style="cursor: pointer"\n                                 click.delegate="expandOrCollapseRoi(roi_id, $event)">\n                                 ${roi.show ? \'&#9660;\' : \'&#9658;\'}\n                             </div>\n                         </div>\n                         <div class="regions-table-col shape-show">\n                             <input type="checkbox"\n                                 title="Show/Hide shapes" checked.one-way="regions_info.roi_visibility_toggles[roi_id] === undefined || regions_info.roi_visibility_toggles[roi_id] === 0"\n                                 change.delegate="toggleRoiVisibility(roi_id, $event)"/>\n                         </div>\n                         <div class="regions-table-col shape-type">\n                             (${(roi.shapes.size - roi.deleted)})\n                         </div>\n                        <div class="regions-table-col shape-z"></div>\n                        <div class="regions-table-col shape-t"></div>\n                        <div class="regions-table-col shape-c"></div>\n                        <div class="regions-table-col shape-comment">\n                            ${roi.name}\n                        </div>\n                        <div class="regions-table-col shape-area"></div>\n                        <div class="regions-table-col shape-length"></div>\n                    </div>\n                    <div if.bind="!(shape.deleted && shape.is_new) &&\n                                   !(roi.shapes.size > 1 && !roi.show)"\n                        title="${(shape_id > 0 ? \'ROI: \' + roi_id + \', Shape: \' + shape_id : \'Unsaved\') +\n                                    (shape.owner ? \'\\nOwner: \' + shape.owner : \'\') +\n                                    (shape.type === \'mask\' ? \'\\nMasks cannot be edited\' : \'\')}"\n                        id="${\'roi-\' + shape.shape_id}"\n                        class="regions-table-row"\n                        css="${shape.selected ? \'background-color: #d0d0ff;\' : \'\'}\n                             ${shape.deleted ? \'color: red;\' :\n                                (shape.modified ? \'color: blue;\' : \'\')}\n                             ${hasPermissions(shape) && shape.type !== \'mask\' ?\n                                \'\' : \'opacity: 0.5\'}"\n                        click.delegate="selectShape(shape.shape_id, shape.selected, $event)">\n                        <div class="regions-table-col roi-toggle"></div>\n                        <div class="regions-table-col shape-show">\n                            <input type="checkbox"\n                                title="Show/Hide shape" checked.one-way="shape.visible"\n                                change.delegate="toggleShapeVisibility(shape.shape_id, $event)"/>\n                        </div>\n                        <div class="regions-table-col shape-type ${shape.type.toLowerCase()}-icon\n                            marker-${shape.MarkerStart.toLowerCase()}${shape.MarkerEnd.toLowerCase()}">\n                        </div>\n                        <div class="regions-table-col shape-z">\n                            ${shape.TheZ !== -1 ? (shape.TheZ + 1) : ""}\n                        </div>\n                        <div class="regions-table-col shape-t">\n                            ${shape.TheT !== -1 ? (shape.TheT + 1) : ""}\n                        </div>\n                        <div class="regions-table-col shape-c">\n                            ${shape.TheC !== -1 ? (shape.TheC + 1) : ""}\n                        </div>\n                        <div class="regions-table-col shape-comment"\n                             show.bind="active_column === \'comments\'">\n                                ${shape.Text ? shape.Text : \'\'}\n                        </div>\n                        <div class="regions-table-col shape-area"\n                             show.bind="active_column === \'measurements\'"\n                             title="${shape.Area && shape.Area > 0 ? shape.Area : \'\'}">\n                                ${shape.Area && shape.Area > 0 ? shape.Area : \'\'}\n                        </div>\n                        <div class="regions-table-col shape-length"\n                             show.bind="active_column === \'measurements\'"\n                             title="${shape.Length && shape.Length > 0 ? shape.Length : \'\'}">\n                                ${shape.Length && shape.Length > 0 ? shape.Length : \'\'}\n                        </div>\n                    </div>\n                </template>\n            </template>\n        </div>\n</template>\n'},"regions/regions-planes.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2019 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n    <div show.bind="is_pending">Loading data...</div>\n\n    <div show.bind="!is_pending" style="margin-bottom: 10px">\n        <span>Shapes per Z/T plane: ${min_shape_count}</span>\n        <div class="grid_table" style="display: inline-block; position: relative; top: 4px">\n            <div repeat.for="i of 5" class="col" style="margin-bottom: 0">\n                <div class="grid_cell" title="${ min_shape_count + (i * (max_shape_count - min_shape_count) /4) }"\n                    css="background: ${ getColor(min_shape_count + (i * (max_shape_count - min_shape_count) /4)) }">\n                </div>\n            </div>\n        </div>\n        <span>${max_shape_count}</span>\n    </div>\n\n    <div show.bind="!is_pending">\n        \x3c!-- If sizeT > 1 we have outer loop through T and inner loop through Z --\x3e\n        \x3c!-- We wrap T into multiple tables of 20 columns --\x3e\n        <div if.bind="plane_shape_counts.length>1" class="grid_table pointer" repeat.for="i of ceil(plane_shape_counts.length/20)">\n            \x3c!-- Each table has a Y axis showing Z index --\x3e\n            <div class="col">\n                <div repeat.for="z of plane_shape_counts[0]" class="grid_cell y_axis">\n                    ${plane_shape_counts[0].length - $index}\n                </div>\n                <div class="grid_cell x_axis">\n                    T:\n                </div>\n            \x3c!-- Then we iterate through T... --\x3e\n            </div><div repeat.for="t_col of slice(plane_shape_counts, i*20, (i+1)*20)" class="col"\n                    ref="t_index" t-index="${ (i*20) + $index }">\n                \x3c!-- go through Z --\x3e\n                <div repeat.for="zt_value of reverse(t_col)"\n                    class="grid_cell ${t_index.tIndex == regions_info.image_info.dimensions.t && selectedZ.indexOf(t_col.length - $index - 1) > -1 ? \'selected\' : \'\'}"\n                    ref="z_index" z-index="${ t_col.length - $index - 1 }"\n                    css="background: ${ getColor(zt_value) }"\n                    title="${zt_value} Shapes T: ${ toInt(t_index.tIndex) + 1}, Z: ${ t_col.length - $index }"\n                    click.delegate="handleGridClick($event, z_index.zIndex, t_index.tIndex)">\n                </div>\n                \x3c!-- show T index --\x3e\n                <div class="grid_cell x_axis">\n                    ${toInt(t_index.tIndex) + 1}\n                </div>\n            </div>\n        </div>\n\n        \x3c!-- Alternative layout if single T-index --\x3e\n        <div if.bind="plane_shape_counts.length===1" class="grid_table pointer" repeat.for="i of ceil(plane_shape_counts[0].length/20)">\n            <div class="col">\n                <div class="grid_cell y_axis">\n                </div>\n                <div class="grid_cell x_axis">\n                    Z:\n                </div>\n            </div><div repeat.for="zt_value of slice(plane_shape_counts[0], i*20, (i+1)*20)" class="col"\n                    ref="z_index" z-index="${ (i*20) + $index }">\n                <div\n                    class="grid_cell ${selectedZ.indexOf((i*20) + $index) > -1 ? \'selected\' : \'\'}"\n                    css="background: ${ getColor(zt_value) }"\n                    title="${zt_value} Shapes"\n                    click.delegate="handleGridClick($event, z_index.zIndex, 0)">\n                </div>\n                <div class="grid_cell x_axis">\n                    ${toInt(z_index.zIndex) + 1}\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n'},"regions/regions.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n    <require from="./regions-list"></require>\n    <require from="./regions-drawing"></require>\n    <require from="./regions-edit"></require>\n    <require from="./regions-planes"></require>\n\n    <div class="regions-container">\n        <div class="regions-tools">\n            <div class="shapes-persistence">\n                <div class="btn-group">\n                    <button type="button" class="btn btn-default btn-sm"\n                        disabled.bind="!(regions_info.history &&\n                            regions_info.history.history.length > 0 &&\n                            regions_info.history.historyPointer >= 0 &&\n                            !regions_info.history.hasOnlyNewlyDeleted)"\n                        click.delegate="saveShapes()">Save\n                    </button>\n                    <button type="button"\n                        disabled.bind="!(regions_info.history &&\n                            regions_info.history.history.length > 0 &&\n                            regions_info.history.historyPointer >= 0)"\n                        class="btn btn-default btn-sm"\n                        click.delegate="undoHistory()">Undo\n                    </button>\n                    <button type="button"\n                        disabled.bind="!(regions_info.history &&\n                            regions_info.history.history.length > 0 &&\n                            regions_info.history.historyPointer <\n                            regions_info.history.history.length-1)"\n                        class="btn btn-default btn-sm"\n                        click.delegate="redoHistory()">Redo\n                    </button>\n                </div>\n\n                <div show.bind="regions_info.ready"\n                     class="checkbox comment-checkbox">\n                    <label>\n                        <input style="width: auto;" type="checkbox"\n                               checked.one-way="regions_info.show_comments"\n                               change.delegate="showComments($event)">\n                        Show Comments\n                    </label>\n                </div>\n\n                <button type="button"\n                    show.bind="regions_info.ready"\n                    disabled.bind="!(regions_info.selected_shapes &&\n                        regions_info.selected_shapes.length === 1)"\n                    class="btn btn-link btn-sm"\n                    style="margin-left: 5px; outline: none;"\n                    title="Link to selected ROI${ regions_info.selected_shapes.length === 1 ? \'\' : \' (need to select 1)\'}"\n                    click.delegate="toggleShowRoiLink()">\n                    <span class="glyphicon glyphicon-link" aria-hidden="true"></span>\n                </button>\n            </div>\n\n            <div show.bind="show_roi_link"\n                mouseout.delegate="toggleShowRoiLink()"\n                style="position: absolute; border: solid #ddd 1px; border-radius: 3px; padding: 5px; top: 35px;\n                    right: 5px; z-index: 10; background: #f8f8f8; width: 300px; box-shadow: 2px 2px 5px #ccc;">\n                \x3c!-- NB: we pass shapes.length to function to ensure update https://discourse.aurelia.io/t/array-map-and-join-in-template/3550/4 --\x3e\n                <input id="roi_link_input" style="width:100%" value="${ getRoisLink(regions_info.selected_shapes, regions_info.selected_shapes.length) }"/>\n            </div>\n\n            <regions-edit regions_info.bind="regions_info"></regions-edit>\n\n            <hr show.bind="regions_info !== null &&\n                           regions_info.image_info.can_annotate" />\n            <regions-drawing show.bind="regions_info !== null &&\n                                        regions_info.image_info.can_annotate"\n                             regions_info.bind="regions_info">\n            </regions-drawing>\n            <hr />\n        </div>\n        <ul id="regions-tabs" class="nav nav-tabs small-tabs" role="tablist">\n            <li class="${selected_roi_tab === ROI_TABS.ROI_TABLE ? \'active\' : \'\'}">\n                <a href="#${ ROI_TABS.ROI_TABLE }" role="tab">ROIs</a>\n            </li>\n            <li class="${selected_roi_tab === ROI_TABS.ROI_PLANE_GRID ? \'active\' : \'\'}">\n                <a href="#${ ROI_TABS.ROI_PLANE_GRID }" role="tab">Planes</a>\n            </li>\n        </ul>\n        <div id="regions-tabs-content" class="tab-content">\n            <div id="roi-table"\n                class="tab-pane ${selected_roi_tab === ROI_TABS.ROI_TABLE ? \'active\' : \'\'}">\n                <regions-list regions_info.bind="regions_info" class="regions-list">\n                </regions-list>\n            </div>\n            <div id="roi-plane-grid" role="tabpanel"\n                class="tab-pane ${selected_roi_tab === ROI_TABS.ROI_PLANE_GRID ? \'active\' : \'\'}">\n                <regions-planes regions_info.bind="regions_info" selected_roi_tab.bind="selected_roi_tab">\n                </regions-planes>\n            </div>\n        </div>\n    </div>\n</template>\n'},"settings/channel-range-advanced.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template show.bind="channel.show_advanced_settings">\n    <div class="channel-range-advanced">Map:&nbsp;\n        <div class="dropdown quantization-dropdown">\n            <button type="button"\n                class="btn btn-default btn-sm dropdown-toggle"\n                data-toggle="dropdown">${channel.family}\n                <span class="caret"></span>\n            </button>\n            <ul class="dropdown-menu">\n                <li repeat.for="name of families"\n                    click.delegate="onFamilyChange(name)">${name}\n                </li>\n            </ul>\n        </div>\n        <span class="glyphicon glyphicon-remove"\n                click.delegate="hideAdvancedSettings()"></span>\n    </div>\n    <div show.bind="channel.family &&\n        (channel.family !== \'linear\' && channel.family !== \'logarithmic\')"\n        class="channel-range-advanced">Gamma:&nbsp;\n            <div class="gamma-slider"></div>\n            <input class="gamma-input"/>\n    </div>\n</template>\n'},"settings/channel-range.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n    <div class="btn-group channel-button-group">\n        <button type="button"\n                title="${channel.label}"\n                class="btn btn-default btn-sm pixelated channel"\n                css="${!channel.active ? \'opacity: 0.5\' : \'\'}"\n                click.delegate="toggleChannel()">${channel.label}\n        </button>\n        <button type="button"\n                class="btn btn-default btn-sm dropdown-toggle"\n                style="min-width: 15px;padding: 5px 0px;"\n                data-toggle="dropdown"\n                click.trigger="hideColorPicker()">\n            <span class="caret"></span>\n        </button>\n        <div class="dropdown-menu channel-color">\n            <div\n                style="margin-left: 2px;">\n                <label style="font-weight: normal;">\n                    <input type="checkbox"\n                        disabled.bind="channel.inverted === null"\n                        checked.bind="channel.inverted"\n                        change.delegate="onInvertedToggle()"/>\n                        &nbsp;Invert\n                </label>\n            </div>\n            <hr />\n            <div class="luts">\n                <div class="luts-preview luts-item" style="background-color: #FF0000"\n                    title="red"\n                    click.delegate="onColorChange(\'#FF0000\')">\n                    <div class="luts-name">red</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #00FF00"\n                     title="green"\n                     click.delegate="onColorChange(\'#00FF00\')">\n                    <div class="luts-name">green</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #0000FF"\n                     title="blue"\n                     click.delegate="onColorChange(\'#0000FF\')">\n                    <div class="luts-name">blue</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #FFFFFF"\n                     title="white"\n                     click.delegate="onColorChange(\'#FFFFFF\')">\n                    <div class="luts-name">white</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #FFFF00"\n                     title="yellow"\n                     click.delegate="onColorChange(\'#FFFF00\')">\n                    <div class="luts-name">yellow</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #FF00FF"\n                     title="magenta"\n                     click.delegate="onColorChange(\'#FF00FF\')">\n                    <div class="luts-name">magenta</div>\n                </div>\n                <div class="luts-preview luts-item" style="background-color: #00FFFF"\n                     title="cyan"\n                     click.delegate="onColorChange(\'#00FFFF\')">\n                    <div class="luts-name">cyan</div>\n                </div>\n                <div class="luts-item" repeat.for="[id, lut] of context.luts"\n                     title="${lut.nice_name}"\n                     click.delegate="onColorChange(id)">\n                     <div class="luts-preview pixelated"\n                         css="${lut.index >= 0 ?\n                                \'background-image: url(\\\'\' + context.luts_png.url + \'\\\');\n                                background-size: 100% \' + (context.luts_png.height*2) +\n                                \'px;background-position: 0px -\' + (lut.index*20+1) +\n                                \'px\' : \'\'}">\n                         <div class="luts-name">${lut.nice_name}</div>\n                     </div>\n                </div>\n            </div>\n            <hr/>\n            <div class="luts-color-picker">\n                <span>Color:</span>\n                <input class="spectrum-input" />\n            </div>\n            <template if.bind="channel.family">\n                <hr/>\n                <div click.delegate="showAdvancedSettings()"\n                    style="text-align: center">\n                    Advanced Settings...\n                </div>\n            </template>\n        </div>\n    </div>\n    <input class="channel-start"/>\n    <div class="channel-slider"></div>\n    <input class="channel-end"/>\n</template>\n'},"settings/channel-settings.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n        <require from="./channel-range"></require>\n        <require from="./channel-range-advanced"></require>\n\n        <div repeat.for="channel of image_config.image_info.channels" class="row">\n            <channel-range class="channel-range"\n                index.bind="$index"\n                channel.bind="channel"\n                mode.bind="mode"\n                revision.bind="image_config.revision">\n            </channel-range>\n            <channel-range-advanced if.bind="channel.family"\n                index.bind="$index"\n                channel.bind="channel"\n                mode.bind="mode"\n                families.one-time="image_config.image_info.families"\n                revision.bind="image_config.revision">\n            </channel-range-advanced>\n        </div>\n        <div class="channel-mode btn-group" role="group" data-toggle="buttons">\n            <button value="0" type="button"\n                class="btn btn-default"\n                click.delegate="onModeChange(0)">Min/Max</button>\n            <button value="1" type="button" class="btn btn-default"\n                click.delegate="onModeChange(1)">Full Range</button>\n            <button value="2" type="button" class="btn btn-default"\n                click.delegate="onModeChange(2)">Imported\n            </button>\n        </div>\n</template>\n'},"settings/settings.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n<template>\n    <require from="../utils/converters"></require>\n    <require from="./channel-settings"></require>\n\n    <div class="btn-group save-settings">\n        <button type="button"\n            disabled.bind="!(image_config.image_info.ready &&\n                image_config.image_info.can_annotate &&\n                image_config.history.length > 0 &&\n                image_config.historyPointer >= 0)"\n            class="btn btn-default btn-sm"\n            click.delegate="saveImageSettings()">Save\n        </button>\n        <button type="button"\n            disabled.bind="!(image_config.image_info.ready &&\n                            image_config.image_info.can_annotate)"\n            class="btn btn-default btn-sm"\n            title="Apply and save Image settings to all Images in the Dataset"\n            click.delegate="saveImageSettingsToAll()">Save to All\n        </button>\n    </div>\n\n    <div class="btn-group history">\n        <button type="button" click.delegate="undo()"\n            disabled.bind="!(!image_config.is_movie_playing &&\n                            image_config.history.length > 0 &&\n                            image_config.historyPointer >= 0)"\n            class="btn btn-default btn-sm">Undo</button>\n        <button type="button" click.delegate="redo()"\n            disabled.bind="!(!image_config.is_movie_playing &&\n                            image_config.history.length > 0 &&\n                            image_config.historyPointer < image_config.history.length-1)"\n            class="btn btn-default btn-sm">Redo</button>\n        <button type="button" click.delegate="copy()" class="btn btn-default btn-sm">Copy</button>\n        <button type="button" class="btn btn-default btn-sm"\n            disabled.bind="!(image_config.image_info.ready &&\n                            image_config.image_info.copied_img_rdef)"\n            click.delegate="paste()">Paste</button>\n    </div>\n\n    <div class="checkbox checkbox-settings">\n        <div>\n            <label>\n                <input type="checkbox"\n                    checked.bind="image_config.image_info.model | imageModel"\n                    disabled.bind="!(image_config && image_config.image_info &&\n                                     image_config.image_info.ready)"\n                    change.delegate="onModelChange($event.target.checked)" />\n               Grayscale\n           </label>\n        </div>\n        <div>\n            <label class="${image_config.image_info.ready &&\n                            !image_config.image_info.tiled  ?\n                                \'\' : \'disabled-color\'}">\n            <input type="checkbox"\n                disabled.bind="!(image_config.image_info.ready &&\n                                !image_config.image_info.tiled)"\n                checked.bind="image_config.show_histogram"\n                change.delegate="toggleHistogram($event)" />\n            Histogram\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="checkbox"\n                    checked.one-way="context.interpolate"\n                    disabled.bind="!(image_config && image_config.image_info &&\n                                     image_config.image_info.ready)"\n                    change.delegate="toggleInterpolation($event)" />\n               Interpolate\n           </label>\n        </div>\n    </div>\n\n    <div show.bind="image_config.image_info.ready &&\n                    !image_config.image_info.tiled &&\n                    histogram && histogram.visible" class="row">\n        <div class="histogram"></div>\n    </div>\n\n    <div show.bind="image_config.image_info.ready" class="row">\n        <channel-settings image_config.bind="image_config"></channel-settings>\n    </div>\n\n    <div show.bind="image_config.image_info.ready" class="row">\n        <hr />\n        <div>User Settings:</div>\n        <div class="user-settings">\n            <div repeat.for="rdef of rdefs"\n                class="user-setting"\n                click.delegate="applyUserSetting($index)">\n                <img src.bind="getRdefThumbUrl() + \'/?rdefId=\' + rdef.id + \'&\' + revision" class="img-thumbnail">\n                <div>${rdef.owner.firstName + \' \' + rdef.owner.lastName}</div>\n            </div>\n        </div>\n    </div>\n\n    <div class="disabled-color loading-text"\n         show.bind="!image_config.image_info.ready">Loading Image Data ...\n     </div>\n\n</template>\n'},"viewers/ol3-viewer.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <require from="../controls/dimension-slider"></require>\n    <require from="./viewer-context-menu"></require>\n\n    <div class="${context.useMDI && context.image_configs.size > 1 ?\n                    \'center-row1-mdi\' : \'center-row1\'}\n                ${image_config.image_info.dimensions.max_t > 1 ? \'show-tSlider\' : \'\'}\n                ${image_config.image_info.dimensions.max_z > 1 ? \'show-zSlider\' : \'\'}"\n            drop.delegate="handleDrop($event)"\n            dragover.delegate="handleDragover($event)"\n            dragleave.delegate="handleDragleave($event)"\n            >\n        <dimension-slider\n            if.bind="image_config.image_info.dimensions.max_z > 1"\n            image_config.bind="image_config"\n            dim="z"\n            player_info.bind="player_info"\n            class="plane-slider"\n            css="${context.useMDI && context.image_configs.size > 1 ?\n                    \'margin-top: 25px;margin-bottom: 10px\' : \'\'}">\n        </dimension-slider>\n\n        <div class="viewer">\n              <div id.bind="container" class="viewer-container"></div>\n        </div>\n    </div>\n\n    <div class="${image_config.image_info.dimensions.max_t > 1 ?\n                    \'center-row2\' : \'center-row2-hidden\'}\n                ${image_config.image_info.dimensions.max_z > 1 ?\n                    \'show-zSlider\' : \'\'}">\n            <dimension-slider\n                if.bind="image_config.image_info.dimensions.max_t > 1"\n                image_config.bind="image_config"\n                dim="t"\n                player_info.bind="player_info"\n                class="time-slider"\n            >\n            </dimension-slider>\n    </div>\n    <viewer-context-menu image_config.bind="image_config"></viewer-context-menu>\n</template>\n'},"viewers/viewer-context-menu.html":e=>{e.exports='\x3c!--\n    Copyright (C) 2017 University of Dundee & Open Microscopy Environment.\n    All rights reserved.\n\n    This program is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Affero General Public License as\n    published by the Free Software Foundation, either version 3 of the\n    License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU Affero General Public License for more details.\n\n    You should have received a copy of the GNU Affero General Public License\n    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n--\x3e\n\n<template>\n    <ul class="viewer-context-menu dropdown-menu" role="menu">\n        <li title="Toggle the showing of a popup above selected ROIs">\n            <a click.delegate="enableShapePopup()" tabindex="-1" href="#">\n                Enable ROI Popup\n            </a>\n        </li>\n        <li show.bind="image_config.regions_info.ready"\n            class="${image_config.image_info.can_annotate &&\n                     image_config.regions_info.copied_shapes.length > 0 ?\n                        \'\' : \'disabled-color\'}">\n            <a click.delegate="pasteShapes()"\n               tabindex="-1" href="#">Paste ROI here</a>\n        </li>\n        <li class="${image_config.image_info.ready ? \'\' : \'disabled-color\'}">\n            <a click.delegate="captureViewport()"\n               tabindex="-1" href="#">Save Viewport as PNG</a>\n        </li>\n        <li class="${image_config.image_info.ready ? \'\' : \'disabled-color\'}">\n            <a click.delegate="linkToViewport()"\n               tabindex="-1" href="#">Get Link to Viewport</a>\n        </li>\n    </ul>\n</template>\n'}},i={};function n(e){var s=i[e];if(void 0!==s)return s.exports;var o=i[e]={id:e,loaded:!1,exports:{}};return t[e].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=t,void 0!==t&&(n.m=n.m||t,n.c=n.c||i),n.amdD=function(){throw new Error("define cannot be used indirect")},n.amdO={},e=[],n.O=(t,i,s,o)=>{if(!i){var r=1/0;for(d=0;d<e.length;d++){for(var[i,s,o]=e[d],a=!0,l=0;l<i.length;l++)(!1&o||r>=o)&&Object.keys(n.O).every((e=>n.O[e](i[l])))?i.splice(l--,1):(a=!1,o<r&&(r=o));if(a){e.splice(d--,1);var h=s();void 0!==h&&(t=h)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[i,s,o]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.j=179,(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var s=i.length-1;s>-1&&!e;)e=i[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={179:0};n.O.j=t=>0===e[t];var t=(t,i)=>{var s,o,[r,a,l]=i,h=0;if(r.some((t=>0!==e[t]))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(l)var d=l(n)}for(t&&t(i);h<r.length;h++)o=r[h],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(d)},i=self.webpackChunk=self.webpackChunk||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),n.O(void 0,[216],(()=>n(8140)));var s=n.O(void 0,[216],(()=>n(5939)));s=n.O(s)})();